# Regeneration Field Validation Data

The 2023-06 BHEF field surveys used $\frac{1}{400}$ acre (10.117 m^2^) plots with a 5.89 ft (1.795 m) radius for regeneration sampling.

## Load Field Data

Load the regeneration data, set parameters for processing, and map

```{r regen-dta-ld, results='hide'}
# load Field Validation Data
field_regen = readr::read_csv(
    file = "../data/field_data/Voodoo_regen_data.csv"
  ) %>% 
  dplyr::rename_with(~ .x %>%
      # replace all non alphanumeric with _
      stringr::str_replace_all("[^[:alnum:] ]+", "_") %>%
      # remove any _ at the end of the string
      stringr::str_remove("[_]$") %>% 
      tolower()
  ) %>% 
  dplyr::filter(
    !is.na(plot_id)
    & !is.na(utm_x)
    & !is.na(utm_y)
    & !is.na(regen_size_class)
    & regen_size_class != ""
  ) %>% 
  dplyr::mutate(
    plot_dir_id = paste0(
      stringr::str_pad(plot_id, width = 4, side = "left", pad = "0")
      , "-"
      , tolower(select_the_regen_plot_center_north_or_south)
    )
    , regen_size_class = regen_size_class %>% stringr::str_squish() %>% tolower()
    , regen_size_class_diam = dplyr::case_when(
      stringr::str_detect(regen_size_class, "inch") ~
        regen_size_class %>% 
          stringr::word(1, sep = "inch") %>% 
          stringr::str_squish()
      , T ~ as.character(NA)
    )
  ) %>% 
  dplyr::relocate(plot_dir_id) %>% 
  # remove duplicates
  dplyr::group_by(plot_dir_id, regen_size_class) %>% 
  dplyr::filter(dplyr::row_number()==1) %>% 
  dplyr::ungroup() %>% 
  # separate diameter size class inches 
  tidyr::separate_wider_delim(
    cols = regen_size_class_diam
    , delim = "-"
    , names = c(
        "diam_inch_class_lower"
        , "diam_inch_class_upper"
      )
    , too_few = "align_start"
    , cols_remove = F
  ) %>% 
  sf::st_as_sf(
    coords = c("utm_x", "utm_y")
    , crs = sf::st_crs(treetops_sf_with_dbh)
    , remove=F
  ) %>% 
  # keep only points that are within the uas flight boundary
  sf::st_intersection(las_ctg_dta)
```

```{r regen-dta-str}
# data structure
field_regen %>% 
  dplyr::glimpse()

# count by regen class
field_regen %>% 
  sf::st_drop_geometry() %>% 
  dplyr::count(regen_size_class, regen_size_class_diam) %>% 
  kableExtra::kbl() %>% 
    kableExtra::kable_styling()
```

### Regeneration Field Data Plot Map

```{r regen-dta-map, results='asis', fig.height = 5}
field_regen %>% 
  sf::st_drop_geometry() %>% 
  dplyr::distinct(plot_dir_id, utm_x, utm_y) %>% 
  sf::st_as_sf(coords = c("utm_x", "utm_y"), crs = sf::st_crs(treetops_sf_with_dbh)) %>% 
  dplyr::mutate(x=1) %>% 
mapview::mapview(col.regions = "tan", layer.name = "regen plot", alpha.regions = 0.6) +
mapview::mapview(
  harvests
  , color = "black"
  , lwd = 3
  , alpha.regions = 0
  , label = FALSE
  , legend = FALSE
  , popup = FALSE
)
```

## Create Data to Compare to UAS

The process used below identifies all plots sampled to create a *full* dataset containing all possible diameter size classes sampled in the field including for plots on which there were `0` trees in a particular size class.

```{r clean-field, results='hide'}
# row unique by plot_dir_id, regen_size_class_diam
field_regen_plt_diam =
  dplyr::cross_join(
    # plot ids
    field_regen %>% dplyr::distinct(plot_dir_id, geometry)
    # possible diameter size classes ...
      # ...excludes regen_size_class %in% c("no trees", "<4.5 ft tall")
      # ...includes stringr::str_detect(regen_size_class, "inch")
    , field_regen %>% 
      dplyr::filter(!is.na(regen_size_class_diam)) %>% 
      dplyr::distinct(regen_size_class_diam, diam_inch_class_upper, diam_inch_class_lower)
  ) %>%
  # join with original data
  dplyr::left_join(
    field_regen %>%
      sf::st_drop_geometry() %>% 
      dplyr::select(
        plot_dir_id, regen_size_class_diam
        , number_of_trees_in_size_class, average_tree_height_feet
      )
    , by = dplyr::join_by(plot_dir_id, regen_size_class_diam)
  ) %>% 
  # fill with valid zero data
  dplyr::mutate(
    number_of_trees_in_size_class = dplyr::coalesce(number_of_trees_in_size_class, 0)
    , plot_area_ac = 1/400
    , plot_area_ha = plot_area_ac/2.471
  )

#################################################################################
#################################################################################
# Join tree tops with forest stands
# row unique by suid, plot_dir_id, regen_size_class_diam
#################################################################################
#################################################################################
harvests_regen_plt = harvests %>%
  dplyr::mutate(
    stand_area_m2 = sf::st_area(.) %>% as.numeric()
    , stand_area_ha = stand_area_m2/10000
  ) %>% 
  sf::st_intersection(las_ctg_dta) %>% 
  dplyr::mutate(
    intrsct_stand_area_m2 = sf::st_area(.) %>% as.numeric()
  ) %>% 
  dplyr::filter(round(intrsct_stand_area_m2, 0) == round(stand_area_m2, 0)) %>% 
  dplyr::select(
    suid, forest_commonname, admin_region_code, activity_name
    , treatment_type, treatment_type_grp, date_compl, year_id
    , stand_area_m2, stand_area_ha
  ) %>% 
  sf::st_intersection(field_regen_plt_diam)
```

This data contains a row for every plot surveyed and every diameter size class in the regeneration sampling protocol, including plots with `0` observations for a size class.

```{r clean-field-tab}
field_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::arrange(plot_dir_id,diam_inch_class_lower) %>% 
  dplyr::select(plot_dir_id, regen_size_class_diam, number_of_trees_in_size_class) %>% 
  dplyr::slice_head(n=10) %>% 
  kableExtra::kbl(digits = 1) %>% 
  kableExtra::kable_styling()
```

Summary statistics by regeneration size class

```{r clean-field-tab2}
field_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(regen_size_class_diam) %>% 
  dplyr::summarise(
    number_of_plots = dplyr::n()
    , min_num_trees = min(number_of_trees_in_size_class, na.rm = T)
    , max_num_trees = max(number_of_trees_in_size_class, na.rm = T)
    , mean_num_trees = mean(number_of_trees_in_size_class, na.rm = T)
    , median_num_trees = median(number_of_trees_in_size_class, na.rm = T)
  ) %>% 
  kableExtra::kbl(digits = 1) %>% 
  kableExtra::kable_styling()
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

### Field Regeneration TPA by Size Class

The 2023-06 BHEF field surveys used $\frac{1}{400}$ acre (10.117 m^2^) plots with a 5.89 ft (1.795 m) radius for regeneration sampling. Aggregated across all plots sampled what was the estimated regeneration trees per acre by size class?

```{r regen-tpa-sz}
# total
tpa_temp = field_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(plot_dir_id) %>% 
  dplyr::mutate(plot_area_ac = ifelse(dplyr::row_number()==1,plot_area_ac,0)) %>% 
  dplyr::ungroup() %>% 
  dplyr::summarise(
    tpa = sum(number_of_trees_in_size_class)/sum(plot_area_ac)
  ) %>%
  dplyr::pull(tpa)
# plot
field_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(regen_size_class_diam) %>% 
  dplyr::summarise(
    number_of_plots = dplyr::n()
    , sum_num_trees = sum(number_of_trees_in_size_class)
    , sampled_area_ac = sum(plot_area_ac)
    , sampled_area_ha = sum(plot_area_ha)
  ) %>%
  dplyr::mutate(
    trees_per_ac = sum_num_trees/sampled_area_ac
    , trees_per_ha = sum_num_trees/sampled_area_ha
    , regen_size_class_diam = regen_size_class_diam %>% factor() %>% forcats::fct_rev()
  ) %>% 
  # dplyr::ungroup() %>% dplyr::summarise(trees_per_ac = sum(trees_per_ac))
  # dplyr::select(regen_size_class_diam, number_of_plots, sum_num_trees, trees_per_ac, trees_per_ha) %>% 
  # kableExtra::kbl(digits = 1) %>% 
  # kableExtra::kable_styling()
  ggplot(
    mapping = aes(x = trees_per_ac, y = regen_size_class_diam, fill=trees_per_ac, label = scales::comma(trees_per_ac, accuracy = 0.1))
  ) +
    geom_col(
      width = 0.7, alpha=0.8
    ) +
    geom_text(
      color = "black", size = 3.5
      , hjust = -0.1
    ) +
    scale_fill_viridis_c(option = "mako", direction = -1) +
    scale_x_continuous(expand = expansion(mult = c(0, .12))) +
    labs(
      fill = ""
      , y = "Regeneration Diameter Size Class (in)"
      , x = "Trees per Acre"
      , title = "Field-Based TPA by Regeneration Diameter Size Class"
      , subtitle = paste0(
        "Total TPA: "
        , scales::comma(tpa_temp, accuracy = 1)
      )
    ) +
    theme_light() +
    theme(
      legend.position = "none"
      , axis.title.x = element_text(size=10, face = "bold")
      , axis.title.y = element_text(size=9)
      , axis.text.x = element_blank()
      , axis.text.y = element_text(color = "black",size=12, face = "bold")
      , axis.ticks.x = element_blank()
      , plot.title = element_text(size=10)
      , plot.subtitle = element_text(size=9, face = "bold")
    )
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

### Stand Regeneration TPA Map

```{r regen-tpa-map2}
harvests_regen_plt %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(suid, plot_dir_id) %>% 
  dplyr::mutate(plot_area_ac = ifelse(dplyr::row_number()==1,plot_area_ac,0)) %>% 
  dplyr::group_by(suid) %>% 
  dplyr::summarise(
    tpa = sum(number_of_trees_in_size_class)/sum(plot_area_ac)
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::inner_join(
    harvests
    , by = dplyr::join_by(suid)
  ) %>% 
  sf::st_set_geometry("geom") %>% 
  ggplot(mapping = aes(fill = tpa)) +
    geom_sf(alpha = 0.8) +
    geom_sf_label(mapping = aes(label = scales::comma(tpa, accuracy = 1)), fill = "white") +
    scale_fill_viridis_c(option = "cividis") +
    labs(
      title = "Regeneration Trees per Acre"
      , subtitle = paste0(
        "reneration size diameter size measured: "
        , min(field_regen_plt_diam$diam_inch_class_lower)
        , "-"
        , max(field_regen_plt_diam$diam_inch_class_upper)
        , " inches"
      )
    ) +
    theme_void() +
    theme(
      legend.position = "none"
    )
```

Satellite map regeneration TPA by harvest stand

```{r regen-tpa-map, fig.height = 5}
mapview::mapview(
  bhef_boundary
  , color = "black"
  , lwd = 3
  , alpha.regions = 0
  , layer.name = "BHEF"
  , label = FALSE
  , legend = FALSE
  , popup = FALSE
) +
    mapview::mapview(
      harvests_regen_plt %>% 
        sf::st_drop_geometry() %>% 
        dplyr::group_by(suid, plot_dir_id) %>% 
        dplyr::mutate(plot_area_ac = ifelse(dplyr::row_number()==1,plot_area_ac,0)) %>% 
        dplyr::group_by(suid) %>% 
        dplyr::summarise(
          tpa = sum(number_of_trees_in_size_class)/sum(plot_area_ac)
        ) %>%
        dplyr::ungroup() %>% 
        dplyr::inner_join(
          harvests
          , by = dplyr::join_by(suid)
        ) %>% 
        sf::st_set_geometry("geom")      
      , zcol = "tpa"
      , layer.name = "Regen. TPA" #latex2exp::TeX("Basal Area $ft^{2} \\cdot ac^{-1}$")
      , col.regions = viridis::cividis(n=nrow(harvests)*1.1)
      , alpha.regions = 0.7
      , na.color = "transparent"
      , popup = F
    ) 
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

## UAS Estimated Regeneration Distribution

```{r updt-pred, include=FALSE, eval=TRUE}
pred_mod_quad = pred_mod_quad %>% 
  dplyr::rename_with(
    .cols = !tidyselect::contains("height")
    , .fn = ~paste0(.x, "_cm", recycle0 = T)
  ) %>% 
  calc_imperial_units_fn() 

min_uas_dbh_in = pred_mod_quad %>% 
  dplyr::filter(tree_height_m == min(chm_rast %>% terra::values(), na.rm = T)) %>% 
  dplyr::pull(estimate_in)
```

The UAS data only includes trees `r min(chm_rast %>% terra::values(), na.rm = T)` m (`r round(min(chm_rast %>% terra::values(), na.rm = T)*3.28,1)` ft) and above. The average tree this tall has a diameter of `r min_uas_dbh_in %>% scales::comma(accuracy = 0.01)` inches based on the UAS SfM-derived height to diameter allometry.

```{r uas-ht-dbh-regen, include=F, eval=FALSE}
treetops_sf_with_dbh %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(
    dbh_in < 5
    & is_training_data == F
  ) %>% 
  dplyr::slice_sample(prop = 0.2) %>% 
  ggplot(
    mapping = aes(
      x=tree_height_ft, y = dbh_in
    )
  ) +
  geom_point(
    alpha = 0.6
    , color = "gray"
    , shape = 21
    , show.legend = F
  ) + 
  geom_smooth(
    method = "loess"
    , se = F
    , span = 1
    , lwd = 1.5
    , color = "gray44"
  ) +
  scale_y_continuous(limits = c(0,NA)) +
  scale_x_continuous(limits = c(0,NA)) +
  labs(
    y = "DBH (in)"
    , x = "Tree Ht. (ft)"
    , title = "Height vs DBH of UAS detected trees "
    , subtitle = "for trees predicted at DBH < 5 in"
  ) +
  theme_light()
```

```{r uas-ht-dbh-regen3}
# filter and plot
pred_mod_quad %>% 
  dplyr::filter(lower_b_in < 5) %>% 
  ggplot(
    mapping = aes(
      x=tree_height_ft, y = estimate_in
    )
  ) +
  geom_ribbon(
    mapping = aes(ymin = lower_b_in, ymax = upper_b_in)
    , fill = "gray88"
    , alpha = 0.5
  ) +
  geom_line(
    color = "gray33"
    , lwd = 1
  ) +
  labs(
    y = "DBH (in)"
    , x = "Tree Ht. (ft)"
    , title = "Local height to DBH allometry from SfM-extracted DBH samples"
    , subtitle = "for trees predicted at DBH < 5 in"
  ) +
  theme_light() +
  theme(legend.position = "none")
```

Based on the UAS SfM-derived height to diameter allometry for the area sampled, trees below 5 inches in diameter (i.e. the cutoff for field-based regeneration sampling) have a maximum height of `r pred_mod_quad %>% dplyr::filter(lower_b_in < 5) %>% dplyr::pull(tree_height_ft) %>% max() %>% scales::comma(accuracy = 0.1)` feet with 90% probability. The average tree with a diameter of 5 inches is `r pred_mod_quad %>% dplyr::filter(estimate_in < 5) %>% dplyr::pull(tree_height_ft) %>% max() %>% scales::comma(accuracy=0.1)` feet.

### UAS vs Field Regeneration TPA

```{r uas-fld-regen}
field_uas_regen_comp = harvests_regen_plt %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(
    diam_inch_class_upper > min_uas_dbh_in
  ) %>% 
  dplyr::mutate(
    dplyr::across(
      tidyselect::starts_with("diam_inch_class")
      , .fn = as.numeric
    )
    , num_trees_wt = dplyr::case_when(
      min_uas_dbh_in < diam_inch_class_upper 
      & min_uas_dbh_in >= diam_inch_class_lower ~
        (min_uas_dbh_in - diam_inch_class_lower) /
          (diam_inch_class_upper - diam_inch_class_lower)
      , T ~ 1
    )
  ) %>% 
  dplyr::group_by(suid, regen_size_class_diam) %>% 
  dplyr::summarise(
    number_of_plots = dplyr::n_distinct(plot_dir_id)
    , max_diam_inch_class_upper = max(diam_inch_class_upper)
    , sum_num_trees = sum(number_of_trees_in_size_class*num_trees_wt)
    , sampled_area_ac = sum(plot_area_ac)
  ) %>% 
  dplyr::group_by(suid) %>% 
  dplyr::summarise(
    field_trees_per_ac = sum(sum_num_trees/sampled_area_ac)
    , number_of_plots = max(number_of_plots)
    , max_diam_inch_class_upper = max(max_diam_inch_class_upper)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    min_diam_inch_class_lower = min_uas_dbh_in
  ) %>% 
  dplyr::inner_join(
    harvests_trees %>% 
      sf::st_drop_geometry() %>% 
      dplyr::select(suid, dbh_cm, stand_area_ha, tree_height_m) %>% 
      calc_imperial_units_fn() %>% 
      dplyr::filter(dbh_in < 5) %>% 
      dplyr::group_by(suid) %>% 
      dplyr::summarise(uas_trees_per_ac = dplyr::n()/max(stand_area_ac))
    , by = dplyr::join_by(suid)
  )
```

```{r uas-fld-regentab}
field_uas_regen_comp %>% 
  dplyr::select(suid, field_trees_per_ac, uas_trees_per_ac) %>% 
  dplyr::mutate(
    abs_error = abs(uas_trees_per_ac-field_trees_per_ac)
    , pct_error = abs_error/field_trees_per_ac
  ) %>% 
    kableExtra::kbl(
      caption = paste0(
        "Regeneration TPA prediction performance for trees "
        , field_uas_regen_comp$min_diam_inch_class_lower %>% 
          min() %>% scales::comma(accuracy = .01)
        , " to "
        , field_uas_regen_comp$max_diam_inch_class_upper %>% 
          max() %>% scales::comma(accuracy = .01)
        , " inches in diameter"
      )
      , col.names = c(
        "Harvest Stand"
        , "Field TPA"
        , "UAS TPA"
        , "Abs. Error"
        , "Abs. Percent Error"
      )
      , digits = 2
    ) %>% 
    kableExtra::kable_styling()

```

## Define Functions for Summary

Create plots to combine for report

1) by harvest stand what was the estimated regeneration trees per acre?

```{r stand-regen-class}
plt_regen_dist_fn <- function(my_suid){
  dta = harvests_regen_plt %>% 
    sf::st_drop_geometry() %>% 
    dplyr::filter(suid == my_suid) %>% 
    dplyr::group_by(suid,regen_size_class_diam) %>% 
    dplyr::summarise(
      number_of_plots = dplyr::n()
      , sum_num_trees = sum(number_of_trees_in_size_class)
      , sampled_area_ac = sum(plot_area_ac)
    ) %>% 
    dplyr::group_by(suid) %>% 
    dplyr::mutate(
      trees_per_ac = sum_num_trees/sampled_area_ac
      , stand_trees_per_ac = sum(sum_num_trees)/max(sampled_area_ac)
      , regen_size_class_diam = regen_size_class_diam %>% factor() %>% forcats::fct_rev()
    ) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(
      stand_lab = paste0(
          # suid
          "\nTotal TPA: "
          , scales::comma(stand_trees_per_ac, accuracy = 1)
      ) 
      # factor() %>% forcats::fct_reorder(desc(stand_trees_per_ac))
    )
    ## plt
    ggplot(
      data = dta
      , mapping = aes(
        x = trees_per_ac, y = regen_size_class_diam
        , fill=trees_per_ac
        , label = scales::comma(trees_per_ac, accuracy = 0.1)
      )
    ) +
      geom_col(
        width = 0.7, alpha=0.8
      ) +
      geom_text(
        color = "black", size = 3
        , hjust = -0.1
      ) +
      scale_fill_viridis_c(option = "mako", direction = -1) +
      scale_x_continuous(expand = expansion(mult = c(0, .13))) +
      # facet_wrap(facets = vars(stand_lab), ncol = 3) +
      labs(
        fill = ""
        , y = "Regeneration Diameter Size Class (inches)"
        , x = "Trees per Acre"
        , title = "Trees per Acre by Regeneration Diameter Size Class (inches)"
        # , subtitle = "by harvest unit (with FACTS ID)"
        , subtitle = dta$stand_lab[1]
      ) +
      theme_light() +
      theme(
        legend.position = "none"
        , axis.title.x = element_text(size=10, face = "bold")
        , axis.text.x = element_blank()
        , axis.text.y = element_text(color = "black",size=12, face = "bold")
        , axis.ticks.x = element_blank()
        , plot.title = element_text(size = 10)
        , plot.subtitle = element_text(size = 8)
        # , strip.text = element_text(color = "black", size = 12)
        # , strip.background = element_rect(fill = "gray88")
      )
}
# plt_regen_dist_fn(harvests$suid[2])
```

6) inset map plot

```{r inset-map45}
plt_inset_map_fn <- function(my_suid){
  (
    ggplot() +
      geom_sf(data = bhef_boundary, alpha = 0, lwd = 1, color = "black") +
      geom_sf(data = harvests, alpha = 0, lwd = 0.4, color = "gray") +
      geom_sf(
        data = harvests %>% dplyr::filter(suid == my_suid)
        , fill = "firebrick"
        , alpha = 0.3
        , lwd = 1.5
        , color = "firebrick"
      ) +
      # geom_sf_label(
      #   data = rx_fire
      #   , aes(label = unit)
      #   , label.size = NA
      #   , alpha = 0
      #   , size = 2.5
      # ) +
      xlab("") +
      ylab("") +
      scale_x_continuous(expand = c(0, 0)) +
      scale_y_continuous(expand = c(0, 0)) +
      theme_bw() +
      theme(
        axis.text = element_text(size = 5.5)
        , axis.text.x = element_text(angle = 35)
        , panel.border = element_blank()
      )

  )
}
# plt_inset_map_fn(harvests$suid[4])
```

1) orthomosaic + chm + stand plot

```{r ortho-plt-fn49}
######################################################################################
# function to plot ortho + chm + points + stand
######################################################################################
ortho_plt_fn = function(my_suid){

# convert to stars
  ortho_st = ortho_rast %>%  
    terra::subset(subset = c(1,2,3)) %>%
    terra::crop(
      # stand %>% 
      harvests %>% dplyr::filter(suid==my_suid) %>% 
        sf::st_buffer(20) %>% 
        sf::st_bbox() %>% 
        sf::st_as_sfc() %>% 
        terra::vect()
    ) %>% 
    terra::aggregate(fact = 4, fun = "mean", na.rm = T) %>% 
    stars::st_as_stars()
  
  # convert to rgb
  ortho_rgb <- stars::st_rgb(
    ortho_st[,,,1:3]
    , dimension = 3
    , use_alpha = FALSE
    # , stretch = "histogram"
    , probs = c(0.005, 0.995)
    , stretch = "percent"
  )
  # ggplot
  plt_rgb <- ggplot() +
    stars::geom_stars(data = ortho_rgb[]) +
    scale_fill_identity(na.value = "transparent") + # !!! don't take this out or RGB plot will kill your computer
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    labs(
      x = ""
      , y = ""
    ) +
    theme_void()
  
  # return(plt_rgb)
  
  # pull chm
  chm = chm_rast %>% 
    terra::crop(
      harvests %>% dplyr::filter(suid==my_suid) %>% 
      terra::vect()
    ) %>% 
    terra::mask(
      harvests %>% dplyr::filter(suid==my_suid) %>% 
      terra::vect()
    ) %>% 
    terra::aggregate(fact = 2, fun = "mean", na.rm = T) %>% 
    `*`(3.28) %>% # transform to feet
    as.data.frame(xy=T) %>% 
    rename(f=3)
  
  # combine all plot elements
  plt_combine =
    plt_rgb +
    # overstory
    geom_tile(
      data = chm %>% 
        dplyr::filter(
          f >=
          pred_mod_quad %>%
            dplyr::filter(estimate_in < 5) %>% 
            dplyr::pull(tree_height_ft) %>% max()
        )
      , mapping = aes(x = x, y = y)
      , fill = "gray"
      , alpha = 0.6
      , na.rm = T
    ) +
    # regen
    ggnewscale::new_scale_fill() +
    geom_tile(
      data = chm %>% 
        dplyr::filter(
          f <
          pred_mod_quad %>%
            dplyr::filter(estimate_in < 5) %>% 
            dplyr::pull(tree_height_ft) %>% max()
        )
      , mapping = aes(x = x, y = y, fill = f)
      , na.rm = T
    ) +
    scale_fill_viridis_c(option="plasma", alpha = 0.6, breaks = scales::extended_breaks(n=6), na.value = "transparent") +
    geom_sf(
      data = harvests %>% dplyr::filter(suid==my_suid)
      , alpha = 0
      , lwd = 1.5
      , color = "#b22222"
    ) +
    # geom_sf(
    #   data = treetops_sf_with_dbh %>% 
    #     sf::st_intersection(harvests %>% dplyr::filter(suid==my_suid))
    #   , color = "#330099"
    #   , shape = "."
    # ) +
    labs(
      fill = "regeneration\ncanopy ht. (ft)"
      # , title = "Trees identified within stand boundary"
      # , title = "<span><span style='color:#330099;'><b><i>Trees</i></b></span> identified within <span style='color:#b22222;'><b><i>stand</i></b></span> boundary</span>"
      , title = paste0(
          "Regeneration trees ("
          , scales::comma(
            min(chm_rast %>% terra::values(), na.rm = T)*3.28
            , accuracy = 0.1
          )
          , "-"
          , pred_mod_quad %>%
            dplyr::filter(estimate_in < 5) %>% 
            dplyr::pull(tree_height_ft) %>% max() %>% scales::comma(accuracy = 0.1)
          , " ft) within stand boundary"
      )
      , subtitle = paste0(
        "trees over "
        , pred_mod_quad %>%
            dplyr::filter(estimate_in < 5) %>% 
            dplyr::pull(tree_height_ft) %>% max() %>% scales::comma(accuracy = 0.1)
        , " ft shown in gray"
      )
    ) +
    theme(
      legend.position = "top" # c(0.5,1)
      , legend.direction = "horizontal"
      , legend.margin = margin(0,0,-1,0)
      , legend.text = element_text(size = 8)
      , legend.title = element_text(size = 8)
      # , plot.title = ggtext::element_markdown(size = 10, hjust = 0.5)
      , plot.title = element_text(size = 10, hjust = 0.5)
      , plot.subtitle = element_text(size = 8, hjust = 0.5, face = "italic")
    )
  return(plt_combine)
}
# ortho_plt_fn(harvests$suid[2])
```

81) build report

```{r report-fn79}
report_fn = function(my_suid){
  # generate plots
  ortho_plt_temp = ortho_plt_fn(my_suid) # ortho_plt_fn(harvests$suid[4])
  plt_regen_dist_temp =  plt_regen_dist_fn(my_suid)
  plt_inset_map_temp = plt_inset_map_fn(my_suid) # plt_inset_map_fn(harvests$suid[4])
  
  # plot layout
  # area(t,l,b,r)
  layout_temp = c(
    # map
    area(1, 1, 4, 2)
    # space
    , area(1, 3, 1, 4)
    # distributions 
    , area(2, 3, 2, 4)
    # space
    , area(3, 3, 3, 4)
    # map inset
    , area(4, 3, 4, 3)
  )
  
  # patchwork 
  rpt = ortho_plt_temp +
    patchwork::plot_spacer() +
    plt_regen_dist_temp +
    patchwork::plot_spacer() +
    plt_inset_map_temp +
    patchwork::plot_layout(
      design = layout_temp
      , heights = c(0.001,1,0.1,1)
      , widths = c(0.5,1,0.5,0.5)
    )
  # export
  ggplot2::ggsave(
    filename = paste0(delivery_dir, "/suid_", my_suid, "_regen.pdf")
    , plot = rpt
    , device = "pdf"
    , width = 11, height = 8.5, units = "in"
  )
  return(rpt)
}
```

```{r, include=FALSE, eval=FALSE}
# plot layout
  # area(t,l,b,r)
  layout_temp = c(
    # map
    area(1, 1, 5, 2)
    # space
    , area(1, 3, 1, 4)
    # distributions 
    , area(2, 3, 2, 4)
    # space
    , area(3, 3, 3, 4)
    # map inset
    , area(4, 3, 5, 3)
  )
  # check the layout
  plot(layout_temp)
  
```

## Harvest Unit Regen Summary Reports

```{r print-reports34, results='hide', fig.show='asis', fig.height=8}
# generate and print reports
harvests$suid %>% 
  purrr::map(report_fn) %>% 
  print()
```

```{r pdf-comb47, results='hide'}
# combine all pdfs together
# combine with pdftools
pdftools::pdf_combine(
  sort(list.files(delivery_dir, pattern = "*_regen.pdf$", full.names = TRUE))
  , output = paste0(
    delivery_dir
    , "/BHEF_UAS_202306_regen_report_"
    , gsub("-", "", Sys.Date())
    , ".pdf"
  )
)
```

