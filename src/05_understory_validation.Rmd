# Regeneration Field Validation Data{#ustory_valid}

The 2023-06 BHEF field surveys used $\frac{1}{400}$ acre (10.117 m^2^) plots with a 5.89 ft (1.795 m) radius for regeneration sampling.

## Load Field Data

Load the regeneration data, set parameters for processing, and map

```{r regen-dta-ld, results='hide'}
# load Field Validation Data
field_regen = readr::read_csv(
    file = "../data/field_data/Voodoo_regen_data.csv"
  ) %>% 
  dplyr::rename_with(~ .x %>%
      # replace all non alphanumeric with _
      stringr::str_replace_all("[^[:alnum:] ]+", "_") %>%
      # remove any _ at the end of the string
      stringr::str_remove("[_]$") %>% 
      tolower()
  ) %>% 
  dplyr::filter(
    !is.na(plot_id)
    & !is.na(utm_x)
    & !is.na(utm_y)
    & !is.na(regen_size_class)
    & regen_size_class != ""
  ) %>% 
  dplyr::mutate(
    plot_dir_id = paste0(
      stringr::str_pad(plot_id, width = 4, side = "left", pad = "0")
      , "-"
      , tolower(select_the_regen_plot_center_north_or_south)
    )
    , regen_size_class = regen_size_class %>% stringr::str_squish() %>% tolower()
    , regen_size_class_diam = dplyr::case_when(
      stringr::str_detect(regen_size_class, "inch") ~
        regen_size_class %>% 
          stringr::word(1, sep = "inch") %>% 
          stringr::str_squish()
      , T ~ as.character(NA)
    )
  ) %>% 
  dplyr::relocate(plot_dir_id) %>% 
  # remove duplicates
  dplyr::group_by(plot_dir_id, regen_size_class) %>% 
  dplyr::filter(dplyr::row_number()==1) %>% 
  dplyr::ungroup() %>% 
  # separate diameter size class inches 
  tidyr::separate_wider_delim(
    cols = regen_size_class_diam
    , delim = "-"
    , names = c(
        "diam_inch_class_lower"
        , "diam_inch_class_upper"
      )
    , too_few = "align_start"
    , cols_remove = F
  ) %>% 
  sf::st_as_sf(
    coords = c("utm_x", "utm_y")
    , crs = sf::st_crs(treetops_sf_with_dbh)
    , remove=F
  ) %>% 
  # keep only points that are within the uas flight boundary
  sf::st_intersection(las_ctg_dta)
```

```{r regen-dta-str}
# data structure
field_regen %>% 
  dplyr::glimpse()

# count by regen class
field_regen %>% 
  sf::st_drop_geometry() %>% 
  dplyr::count(regen_size_class, regen_size_class_diam) %>% 
  kableExtra::kbl() %>% 
    kableExtra::kable_styling()
```

### Regeneration Field Data Plot Map

```{r regen-dta-map, results='asis', fig.height = 5}
field_regen %>% 
  sf::st_drop_geometry() %>% 
  dplyr::distinct(plot_dir_id, utm_x, utm_y) %>% 
  sf::st_as_sf(coords = c("utm_x", "utm_y"), crs = sf::st_crs(treetops_sf_with_dbh)) %>% 
  dplyr::mutate(x=1) %>% 
mapview::mapview(col.regions = "tan", layer.name = "regen plot", alpha.regions = 0.6) +
mapview::mapview(
  harvests
  , color = "black"
  , lwd = 3
  , alpha.regions = 0
  , label = FALSE
  , legend = FALSE
  , popup = FALSE
)
```

## Create Data to Compare to UAS

The process used below identifies all plots sampled to create a *full* dataset containing all possible diameter size classes sampled in the field including for plots on which there were `0` trees in a particular size class.

```{r clean-field, results='hide'}
# row unique by plot_dir_id, regen_size_class_diam
field_regen_plt_diam =
  dplyr::cross_join(
    # plot ids
    field_regen %>% dplyr::distinct(plot_dir_id, geometry)
    # possible diameter size classes ...
      # ...excludes regen_size_class %in% c("no trees", "<4.5 ft tall")
      # ...includes stringr::str_detect(regen_size_class, "inch")
    , field_regen %>% 
      dplyr::filter(!is.na(regen_size_class_diam)) %>% 
      dplyr::distinct(regen_size_class_diam, diam_inch_class_upper, diam_inch_class_lower)
  ) %>%
  # join with original data
  dplyr::left_join(
    field_regen %>%
      sf::st_drop_geometry() %>% 
      dplyr::select(
        plot_dir_id, regen_size_class_diam
        , number_of_trees_in_size_class, average_tree_height_feet
      )
    , by = dplyr::join_by(plot_dir_id, regen_size_class_diam)
  ) %>% 
  # fill with valid zero data
  dplyr::mutate(
    number_of_trees_in_size_class = dplyr::coalesce(number_of_trees_in_size_class, 0)
    , plot_area_ac = 1/400
    , plot_area_ha = plot_area_ac/2.471
  )

#################################################################################
#################################################################################
# Join tree tops with forest stands
# row unique by suid, plot_dir_id, regen_size_class_diam
#################################################################################
#################################################################################
harvests_regen_plt_diam = harvests %>%
  dplyr::mutate(
    stand_area_m2 = sf::st_area(.) %>% as.numeric()
    , stand_area_ha = stand_area_m2/10000
  ) %>% 
  sf::st_intersection(las_ctg_dta) %>% 
  dplyr::mutate(
    intrsct_stand_area_m2 = sf::st_area(.) %>% as.numeric()
  ) %>% 
  dplyr::filter(round(intrsct_stand_area_m2, 0) == round(stand_area_m2, 0)) %>% 
  dplyr::select(
    suid, forest_commonname, admin_region_code, activity_name
    , treatment_type, treatment_type_grp, date_compl, year_id
    , stand_area_m2, stand_area_ha
  ) %>% 
  sf::st_intersection(field_regen_plt_diam)
```

This data contains a row for every plot surveyed and every diameter size class in the regeneration sampling protocol, including plots with `0` observations for a size class.

```{r clean-field-tab}
field_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::arrange(plot_dir_id,diam_inch_class_lower) %>% 
  dplyr::select(plot_dir_id, regen_size_class_diam, number_of_trees_in_size_class) %>% 
  dplyr::slice_head(n=10) %>% 
  kableExtra::kbl(digits = 1) %>% 
  kableExtra::kable_styling()
```

Summary statistics by regeneration size class

```{r clean-field-tab2}
field_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(regen_size_class_diam) %>% 
  dplyr::summarise(
    number_of_plots = dplyr::n()
    , min_num_trees = min(number_of_trees_in_size_class, na.rm = T)
    , max_num_trees = max(number_of_trees_in_size_class, na.rm = T)
    , mean_num_trees = mean(number_of_trees_in_size_class, na.rm = T)
    , median_num_trees = median(number_of_trees_in_size_class, na.rm = T)
  ) %>% 
  kableExtra::kbl(digits = 1) %>% 
  kableExtra::kable_styling()
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

### Field Regeneration TPA by Size Class

The 2023-06 BHEF field surveys used $\frac{1}{400}$ acre (10.117 m^2^) plots with a 5.89 ft (1.795 m) radius for regeneration sampling. Aggregated across all plots sampled what was the estimated regeneration trees per acre by size class?

```{r regen-tpa-sz}
# total
tpa_temp = field_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(plot_dir_id) %>% 
  dplyr::mutate(plot_area_ac = ifelse(dplyr::row_number()==1,plot_area_ac,0)) %>% 
  dplyr::ungroup() %>% 
  dplyr::summarise(
    tpa = sum(number_of_trees_in_size_class)/sum(plot_area_ac)
  ) %>%
  dplyr::pull(tpa)
# plot
plt_fld_tpa_diam = 
  field_regen_plt_diam %>% 
    sf::st_drop_geometry() %>% 
    dplyr::group_by(regen_size_class_diam) %>% 
    dplyr::summarise(
      number_of_plots = dplyr::n()
      , sum_num_trees = sum(number_of_trees_in_size_class)
      , sampled_area_ac = sum(plot_area_ac)
      , sampled_area_ha = sum(plot_area_ha)
    ) %>%
    dplyr::ungroup() %>% 
    dplyr::mutate(
      trees_per_ac = sum_num_trees/sampled_area_ac
      , trees_per_ha = sum_num_trees/sampled_area_ha
      , regen_size_class_diam = regen_size_class_diam %>% factor() %>% forcats::fct_rev()
      , pct = trees_per_ac/sum(trees_per_ac)
    ) %>% 
    ggplot(
      mapping = aes(
        x = trees_per_ac, y = regen_size_class_diam
        , fill=trees_per_ac
        , label = paste0(
          scales::comma(trees_per_ac, accuracy = 0.1)
          , "\n"
          , scales::percent(pct, accuracy = 0.1)
        )
      )
    ) +
      geom_col(
        width = 0.7, alpha=0.8
      ) +
      geom_text(
        color = "black", size = 3.5
        , hjust = -0.1
      ) +
      scale_fill_viridis_c(option = "mako", direction = -1) +
      scale_x_continuous(expand = expansion(mult = c(0, .15))) +
      labs(
        fill = ""
        , y = "Regeneration Diameter Size Class (in)"
        , x = "Trees per Acre"
        , title = "Field-Based TPA by Regeneration Diameter Size Class"
        , subtitle = paste0(
          "Total TPA: "
          , scales::comma(tpa_temp, accuracy = 1)
        )
      ) +
      theme_light() +
      theme(
        legend.position = "none"
        , axis.title.x = element_text(size=10, face = "bold")
        , axis.title.y = element_text(size=9)
        , axis.text.x = element_blank()
        , axis.text.y = element_text(color = "black",size=12, face = "bold")
        , axis.ticks.x = element_blank()
        , plot.title = element_text(size=10)
        , plot.subtitle = element_text(size=9, face = "bold")
      )
plt_fld_tpa_diam
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

### Stand Regeneration TPA Map

```{r regen-tpa-map2}
harvests_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(suid, plot_dir_id) %>% 
  dplyr::mutate(plot_area_ac = ifelse(dplyr::row_number()==1,plot_area_ac,0)) %>% 
  dplyr::group_by(suid) %>% 
  dplyr::summarise(
    tpa = sum(number_of_trees_in_size_class)/sum(plot_area_ac)
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::inner_join(
    harvests
    , by = dplyr::join_by(suid)
  ) %>% 
  sf::st_set_geometry("geom") %>% 
  ggplot(mapping = aes(fill = tpa)) +
    geom_sf(alpha = 0.8) +
    geom_sf_label(mapping = aes(label = scales::comma(tpa, accuracy = 1)), fill = "white") +
    scale_fill_viridis_c(option = "cividis") +
    labs(
      title = "Regeneration Trees per Acre"
      , subtitle = paste0(
        "reneration size diameter size measured: "
        , min(field_regen_plt_diam$diam_inch_class_lower)
        , "-"
        , max(field_regen_plt_diam$diam_inch_class_upper)
        , " inches"
      )
    ) +
    theme_void() +
    theme(
      legend.position = "none"
    )
```

```{r regen-tpa-map, fig.height = 5, include=FALSE, eval=F}
# Satellite map regeneration TPA by harvest stand
mapview::mapview(
  bhef_boundary
  , color = "black"
  , lwd = 3
  , alpha.regions = 0
  , layer.name = "BHEF"
  , label = FALSE
  , legend = FALSE
  , popup = FALSE
) +
    mapview::mapview(
      harvests_regen_plt_diam %>% 
        sf::st_drop_geometry() %>% 
        dplyr::group_by(suid, plot_dir_id) %>% 
        dplyr::mutate(plot_area_ac = ifelse(dplyr::row_number()==1,plot_area_ac,0)) %>% 
        dplyr::group_by(suid) %>% 
        dplyr::summarise(
          tpa = sum(number_of_trees_in_size_class)/sum(plot_area_ac)
        ) %>%
        dplyr::ungroup() %>% 
        dplyr::inner_join(
          harvests
          , by = dplyr::join_by(suid)
        ) %>% 
        sf::st_set_geometry("geom")      
      , zcol = "tpa"
      , layer.name = "Regen. TPA" #latex2exp::TeX("Basal Area $ft^{2} \\cdot ac^{-1}$")
      , col.regions = viridis::cividis(n=nrow(harvests)*1.1)
      , alpha.regions = 0.7
      , na.color = "transparent"
      , popup = F
    ) 
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

## UAS Estimated Regeneration

```{r updt-pred, include=FALSE, eval=TRUE}
pred_mod_best = pred_mod_best %>% 
  dplyr::rename_with(
    .cols = !tidyselect::contains("height")
    , .fn = ~paste0(.x, "_cm", recycle0 = T)
  ) %>% 
  calc_imperial_units_fn() 

min_uas_dbh_in = predict(
    mod_best
    , dplyr::tibble(tree_height_m = min(chm_rast %>% terra::values(), na.rm = T))
  ) %>% 
  dplyr::as_tibble() %>% 
  dplyr::rename_with(tolower) %>% 
  dplyr::mutate(dbh_cm = estimate) %>% 
  dplyr::select(dbh_cm) %>% 
  calc_imperial_units_fn() %>% 
  dplyr::pull(dbh_in)
```

The UAS data only includes trees `r round(min(chm_rast %>% terra::values(), na.rm = T), 1)` m (`r round(round(min(chm_rast %>% terra::values(), na.rm = T), 1)*3.28,1)` ft) and above. The average tree this tall has a diameter of `r min_uas_dbh_in %>% scales::comma(accuracy = 0.01)` inches based on the UAS SfM-derived height to diameter allometry.

```{r uas-ht-dbh-regen, include=F, eval=FALSE}
treetops_sf_with_dbh %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(
    dbh_in < 5
    & is_training_data == F
  ) %>% 
  dplyr::slice_sample(prop = 0.2) %>% 
  ggplot(
    mapping = aes(
      x=tree_height_ft, y = dbh_in
    )
  ) +
  geom_point(
    alpha = 0.6
    , color = "gray"
    , shape = 21
    , show.legend = F
  ) + 
  geom_smooth(
    method = "loess"
    , se = F
    , span = 1
    , lwd = 1.5
    , color = "gray44"
  ) +
  scale_y_continuous(limits = c(0,NA)) +
  scale_x_continuous(limits = c(0,NA)) +
  labs(
    y = "DBH (in)"
    , x = "Tree Ht. (ft)"
    , title = "Height vs DBH of UAS detected trees "
    , subtitle = "for trees predicted at DBH < 5 in"
  ) +
  theme_light()
```

```{r uas-ht-dbh-regen3}
# filter and plot
pred_mod_best %>% 
  dplyr::filter(lower_b_in < 5) %>% 
  ggplot(
    mapping = aes(
      x=tree_height_ft, y = estimate_in
    )
  ) +
  geom_ribbon(
    mapping = aes(ymin = lower_b_in, ymax = upper_b_in)
    , fill = "gray88"
    , alpha = 0.5
  ) +
  geom_line(
    color = "gray33"
    , lwd = 1
  ) +
  scale_x_continuous(limits = c(0,NA), breaks=scales::breaks_extended(n=16)) +
  scale_y_continuous(limits = c(0,NA), breaks=scales::breaks_extended(n=8)) +
  labs(
    y = "DBH (in)"
    , x = "Tree Ht. (ft)"
    , title = "Local height to DBH allometry from SfM-extracted DBH samples"
    , subtitle = "for trees predicted at DBH < 5 in"
  ) +
  theme_light() +
  theme(legend.position = "none")
```

Based on the UAS SfM-derived height to diameter allometry for the area sampled, trees below 5 inches in diameter (i.e. the cutoff for field-based regeneration sampling) have a maximum height of `r pred_mod_best %>% dplyr::filter(lower_b_in < 5) %>% dplyr::pull(tree_height_ft) %>% max() %>% scales::comma(accuracy = 0.1)` feet with 90% probability. The average tree with a diameter of 5 inches is `r pred_mod_best %>% dplyr::filter(estimate_in < 5) %>% dplyr::pull(tree_height_ft) %>% max() %>% scales::comma(accuracy=0.1)` feet.

### UAS vs Field Regneration TPA by Size Class

```{r uas-fld-regen-szcl}
tpa_temp = 
  harvests_trees %>% 
    sf::st_drop_geometry() %>% 
    dplyr::select(suid, treeID, dbh_cm, stand_area_ha, tree_height_m) %>% 
    calc_imperial_units_fn() %>% 
    dplyr::inner_join(
      field_regen_plt_diam %>% 
        dplyr::distinct(regen_size_class_diam, diam_inch_class_lower, diam_inch_class_upper) %>% 
        dplyr::mutate(
          dplyr::across(tidyselect::starts_with("diam_inch_class"), as.numeric)
        )
      , by = dplyr::join_by(
        dbh_in < diam_inch_class_upper
        , dbh_in >= diam_inch_class_lower
      )
    ) %>% 
    dplyr::group_by(suid, regen_size_class_diam) %>% 
    dplyr::mutate(stand_area_ac = ifelse(dplyr::row_number()==1,stand_area_ac,0)) %>% 
    dplyr::group_by(regen_size_class_diam) %>% 
    dplyr::summarise(trees_per_ac = dplyr::n()/sum(stand_area_ac)) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(
      tot = sum(trees_per_ac), pct = trees_per_ac/tot
      , regen_size_class_diam = regen_size_class_diam %>% factor() %>% forcats::fct_rev()
    )
# plot
plt_uas_tpa_diam = 
  ggplot(
    data = tpa_temp
    , mapping = aes(
      x = trees_per_ac, y = regen_size_class_diam, fill=trees_per_ac
      , label = paste0(
        scales::comma(trees_per_ac, accuracy = 0.1)
        , "\n"
        , scales::percent(pct, accuracy = 0.1)
      )
    )
  ) +
    geom_col(
      width = 0.7, alpha=0.8
    ) +
    geom_text(
      color = "black", size = 3.5
      , hjust = -0.1
    ) +
    scale_fill_viridis_c(option = "mako", direction = -1) +
    scale_x_continuous(expand = expansion(mult = c(0, .15))) +
    labs(
      fill = ""
      , y = "Regeneration Diameter Size Class (in)"
      , x = "Trees per Acre"
      , title = "UAS-Based TPA by Regeneration Diameter Size Class"
      , subtitle = paste0(
        "Total TPA: "
        , scales::comma(tpa_temp$tot[1], accuracy = 1)
      )
    ) +
    theme_light() +
    theme(
      legend.position = "none"
      , axis.title.x = element_text(size=10, face = "bold")
      , axis.title.y = element_text(size=9)
      , axis.text.x = element_blank()
      , axis.text.y = element_text(color = "black",size=12, face = "bold")
      , axis.ticks.x = element_blank()
      , plot.title = element_text(size=10)
      , plot.subtitle = element_text(size=9, face = "bold")
    )

plt_uas_tpa_diam + plt_fld_tpa_diam +
  labs(
    caption = paste0(
      "*note field-based estimates include trees < "
      , round(min_uas_dbh_in,2)
      , " in. which are excluded from UAS data"
    )
  )
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

### UAS vs Field Regeneration TPA by Stand

```{r uas-fld-regen}
field_uas_regen_comp_temp = harvests_regen_plt_diam %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(
    diam_inch_class_upper > min_uas_dbh_in
  ) %>% 
  dplyr::mutate(
    dplyr::across(
      tidyselect::starts_with("diam_inch_class")
      , .fn = as.numeric
    )
    , num_trees_wt = dplyr::case_when(
      min_uas_dbh_in < diam_inch_class_upper 
      & min_uas_dbh_in >= diam_inch_class_lower ~
        (min_uas_dbh_in - diam_inch_class_lower) /
          (diam_inch_class_upper - diam_inch_class_lower)
      , T ~ 1
    )
  ) %>% 
  dplyr::group_by(suid, regen_size_class_diam) %>% 
  dplyr::summarise(
    number_of_plots = dplyr::n_distinct(plot_dir_id)
    , max_diam_inch_class_upper = max(diam_inch_class_upper)
    , sum_num_trees = sum(number_of_trees_in_size_class*num_trees_wt)
    , sampled_area_ac = sum(plot_area_ac)
  ) %>% 
  dplyr::group_by(suid) %>% 
  dplyr::summarise(
    field_trees_per_ac = sum(sum_num_trees/sampled_area_ac)
    , number_of_plots = max(number_of_plots)
    , max_diam_inch_class_upper = max(max_diam_inch_class_upper)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    min_diam_inch_class_lower = min_uas_dbh_in
  ) %>% 
  dplyr::inner_join(
    harvests_trees %>% 
      sf::st_drop_geometry() %>% 
      dplyr::select(suid, dbh_cm, stand_area_ha, tree_height_m) %>% 
      calc_imperial_units_fn() %>% 
      dplyr::filter(dbh_in < 5) %>% 
      dplyr::group_by(suid) %>% 
      dplyr::summarise(uas_trees_per_ac = dplyr::n()/max(stand_area_ac))
    , by = dplyr::join_by(suid)
  )
```

```{r uas-fld-regentab}
field_uas_regen_comp_temp %>% 
  dplyr::select(suid, field_trees_per_ac, uas_trees_per_ac) %>% 
  dplyr::mutate(
    abs_error = abs(uas_trees_per_ac-field_trees_per_ac)
    , pct_error = abs_error/field_trees_per_ac
  ) %>% 
    kableExtra::kbl(
      caption = paste0(
        "Regeneration TPA prediction performance for trees "
        , field_uas_regen_comp_temp$min_diam_inch_class_lower %>% 
          min() %>% scales::comma(accuracy = .01)
        , " to "
        , field_uas_regen_comp_temp$max_diam_inch_class_upper %>% 
          max() %>% scales::comma(accuracy = .01)
        , " inches in diameter"
      )
      , col.names = c(
        "Harvest Stand"
        , "Field TPA"
        , "UAS TPA"
        , "Abs. Error"
        , "Abs. Percent Error"
      )
      , digits = 2
    ) %>% 
    kableExtra::kable_styling()

```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
remove(field_regen)
gc()
```

### UAS vs Field Regeneration TPA in Sample Plots

Limit the UAS vs Field comparison to the area within the field-based sampling plots.

```{r uas-fld-plt-area}
# aggregate field data to plot level
field_regen_plt_temp = field_regen_plt_diam %>% 
  dplyr::filter(
    diam_inch_class_upper > min_uas_dbh_in
  ) %>% 
  dplyr::mutate(
    dplyr::across(
      tidyselect::starts_with("diam_inch_class")
      , .fn = as.numeric
    )
    , num_trees_wt = dplyr::case_when(
      min_uas_dbh_in < diam_inch_class_upper 
      & min_uas_dbh_in >= diam_inch_class_lower ~
        (min_uas_dbh_in - diam_inch_class_lower) /
          (diam_inch_class_upper - diam_inch_class_lower)
      , T ~ 1
    )
  ) %>% 
  sf::st_set_geometry("geometry") %>% 
  dplyr::group_by(plot_dir_id, plot_area_ac, plot_area_ha, geometry) %>% 
  dplyr::summarise(
    max_diam_inch_class_upper = max(diam_inch_class_upper)
    , sum_num_trees = sum(number_of_trees_in_size_class*num_trees_wt)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    field_trees_per_ac = sum_num_trees/plot_area_ac
    , min_diam_inch_class_lower = min_uas_dbh_in
  ) %>% 
  tidyr::separate_wider_delim(
    cols = plot_dir_id
    , delim = "-"
    , names = c(
        "plot_id"
        , "plot_direction_id"
      )
    , cols_remove = F
  ) %>% 
  sf::st_set_geometry("geometry")
```

Aggregate to plot level by combining the `plot_direction_id` column (e.g. `r field_regen_plt_temp$plot_direction_id %>% unique() %>% paste0(collapse = ", ")`). Buffer the plot points and combine the plot geometry together via `sf::st_bbox` to create and estimated bounding box of the area sampled in the regeneration field sampling. This area will be used to find the UAS detected trees within the bounding box to compare TPA estimates.

```{r uas-fld-plt-area-agg}
field_regen_plt_bbox_temp = field_regen_plt_temp %>% 
  sf::st_buffer(field_regen_plt_temp$plot_area_ha[1]*10000) %>%
  dplyr::group_by(plot_id) %>%
  tidyr::nest() %>% 
  dplyr::mutate(
    bbox = purrr::map(data, function(x){
      x %>% 
      sf::st_bbox() %>% 
      sf::st_as_sfc()
    })
  ) %>% 
  tidyr::unnest(cols = c(data, bbox)) %>% 
  dplyr::group_by(plot_id) %>% 
  dplyr::summarise(
    geometry = sf::st_union(bbox)
    , sum_num_trees = sum(sum_num_trees)
    , sum_plot_area_ac = sum(plot_area_ac)
    , sum_plot_area_ha = sum(plot_area_ha)
  ) %>% 
  dplyr::ungroup() %>% 
  sf::st_set_geometry("geometry") %>% 
  dplyr::mutate(
    field_trees_per_ac = sum_num_trees/sum_plot_area_ac
    , bbox_area_m2 = sf::st_area(geometry) %>% as.numeric()
    , bbox_area_ha = bbox_area_m2/10000
    , bbox_area_ac = bbox_area_ha*2.471
  )
```

```{r regen-bbox-map, results='asis', fig.height = 5}
mapview::mapview(
  field_regen_plt_bbox_temp
  , zcol = "field_trees_per_ac"
  , layer.name = "regen bbox TPA"
  , col.regions = viridis::cividis(n=nrow(harvests)*1.1)
  , alpha.regions = 0.7
  , na.color = "transparent"
  , popup = F
) +
mapview::mapview(
  harvests
  , color = "black"
  , lwd = 3
  , alpha.regions = 0
  , label = FALSE
  , legend = FALSE
  , popup = FALSE
)
```

These boundary box sample areas are `r field_regen_plt_bbox_temp$bbox_area_ac[1] %>% scales::comma(accuracy = 0.01)` acres (`r field_regen_plt_bbox_temp$bbox_area_m2[1] %>% scales::comma(accuracy = 0.1)` m^2^). Join UAS trees within the boundary box of the field regeneration sample plots

```{r uas-fld-plt-area-join}
field_uas_regen_comp_temp = field_regen_plt_bbox_temp %>%
  dplyr::left_join(
    field_regen_plt_bbox_temp %>% 
      sf::st_intersection(
        harvests_trees %>% 
          dplyr::select(treeID, dbh_cm) %>% 
          calc_imperial_units_fn() %>% 
          dplyr::filter(dbh_in < 5)
      ) %>% 
      sf::st_drop_geometry() %>% 
      dplyr::group_by(plot_id, bbox_area_ac) %>% 
      dplyr::summarise(uas_num_trees = dplyr::n()) %>% 
      dplyr::ungroup() %>% 
      dplyr::mutate(uas_trees_per_ac = uas_num_trees/bbox_area_ac) %>% 
      dplyr::select(plot_id, uas_trees_per_ac)
    , by = dplyr::join_by(plot_id)
  ) %>% 
  dplyr::mutate(
    uas_trees_per_ac = dplyr::coalesce(uas_trees_per_ac, 0)
  ) 
```

### UAS vs Field Regeneration TPA Correlation

What is the relationship between the UAS-based and the Field-based regeneration TPA estimates at the level of the field sampling plot?

```{r fld-uas-lm-line}
ggplot(
  data = field_uas_regen_comp_temp
  , mapping = aes(
    x = uas_trees_per_ac
    , y = field_trees_per_ac
  )
) +
  geom_smooth(method = "lm", color = "gray66", se = F) +
  geom_point(color = "gray22") +
  ggpubr::stat_regline_equation(
    aes(label =  paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~~~"))
  ) +
  scale_x_continuous(limits = c(0,NA), labels = scales::comma_format(accuracy = 1)) +
  scale_y_continuous(limits = c(0,NA), labels = scales::comma_format(accuracy = 1)) +
  labs(
    x = "UAS-based regeneration TPA"
    , y = "Field-based regeneration TPA"
    , title = "UAS vs Field regeneration TPA estimates at the sample plot level"
  ) +
  theme_bw() +
  theme(legend.position = "none")
```

### UAS Regeneration TPA Reliability

```{r regen-dta-sum-rmse, results='asis'}
data.frame(
  mae_tpa = Metrics::mae(
    field_uas_regen_comp_temp$field_trees_per_ac
    , field_uas_regen_comp_temp$uas_trees_per_ac
  ) %>% scales::comma(accuracy = 0.1)
  , smape_tpa = Metrics::smape(
    field_uas_regen_comp_temp$field_trees_per_ac
    , field_uas_regen_comp_temp$uas_trees_per_ac
  ) %>% scales::percent(accuracy = 0.1)
  , rmse_tpa = Metrics::rmse(
    field_uas_regen_comp_temp$field_trees_per_ac
    , field_uas_regen_comp_temp$uas_trees_per_ac
  ) %>% scales::comma(accuracy = 0.1)
  , n = nrow(field_uas_regen_comp_temp) %>% scales::comma(accuracy = 1)
) %>% 
    kableExtra::kbl(
      caption = "UAS regeneration TPA prediction performance"
      , col.names = c(
        "Mean Abs. Error"
        , "Sym. Mean Abs. Percent Error"
        , "Root Mean Squared Error"
        , "N"
      )
    ) %>% 
    kableExtra::kable_styling()
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(field_regen_plt_diam, plt_fld_tpa_diam, plt_uas_tpa_diam)
remove(list = ls()[grep("_temp",ls())])
gc()

# check_ls_size_fn(ls()) %>% 
#   dplyr::slice_head(n=20)
```

