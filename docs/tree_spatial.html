<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 9 UAS Tree Spatial Arrangement and ICO Example | Black Hills Experimental Forest UAS Mission Data Summary</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 9 UAS Tree Spatial Arrangement and ICO Example | Black Hills Experimental Forest UAS Mission Data Summary" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 9 UAS Tree Spatial Arrangement and ICO Example | Black Hills Experimental Forest UAS Mission Data Summary" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="silv.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/elev. (ft)_df2bec-1/data_stars_elevft5ce72d.txt"></script>
<script src="libs/joda-0.0.1/joda.js"></script>
<script src="libs/joda-0.0.1/addImageQuery-bindings.js"></script>
<script src="libs/canopy ht. (ft)_06c382-1/data_stars_canopyhtft12a074.txt"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="objective.html"><a href="objective.html"><i class="fa fa-check"></i><b>2</b> Objective</a></li>
<li class="chapter" data-level="3" data-path="data_prep.html"><a href="data_prep.html"><i class="fa fa-check"></i><b>3</b> Data Preparation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data_prep.html"><a href="data_prep.html#data-load"><i class="fa fa-check"></i><b>3.1</b> Data Load</a></li>
<li class="chapter" data-level="3.2" data-path="data_prep.html"><a href="data_prep.html#load-orthomosaic-rasters"><i class="fa fa-check"></i><b>3.2</b> Load orthomosaic rasters</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="local_mod.html"><a href="local_mod.html"><i class="fa fa-check"></i><b>4</b> Local DBH to Height Model</a>
<ul>
<li class="chapter" data-level="4.1" data-path="local_mod.html"><a href="local_mod.html#random-forest-model"><i class="fa fa-check"></i><b>4.1</b> Random Forest Model</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="local_mod.html"><a href="local_mod.html#training-vs-non-training-dbh"><i class="fa fa-check"></i><b>4.1.1</b> Training vs Non-Training DBH</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="local_mod.html"><a href="local_mod.html#linear-model"><i class="fa fa-check"></i><b>4.2</b> Linear Model</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="local_mod.html"><a href="local_mod.html#model-parameter-estimates"><i class="fa fa-check"></i><b>4.2.1</b> Model Parameter Estimates</a></li>
<li class="chapter" data-level="4.2.2" data-path="local_mod.html"><a href="local_mod.html#sfm-derived-height-to-dbh-allometry"><i class="fa fa-check"></i><b>4.2.2</b> SfM-derived Height to DBH Allometry</a></li>
<li class="chapter" data-level="4.2.3" data-path="local_mod.html"><a href="local_mod.html#training-vs-non-training-dbh-1"><i class="fa fa-check"></i><b>4.2.3</b> Training vs Non-Training DBH</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="local_mod.html"><a href="local_mod.html#quadratic-model"><i class="fa fa-check"></i><b>4.3</b> Quadratic Model</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="local_mod.html"><a href="local_mod.html#model-parameter-estimates-1"><i class="fa fa-check"></i><b>4.3.1</b> Model Parameter Estimates</a></li>
<li class="chapter" data-level="4.3.2" data-path="local_mod.html"><a href="local_mod.html#sfm-derived-height-to-dbh-allometry-1"><i class="fa fa-check"></i><b>4.3.2</b> SfM-derived Height to DBH Allometry</a></li>
<li class="chapter" data-level="4.3.3" data-path="local_mod.html"><a href="local_mod.html#training-vs-non-training-dbh-2"><i class="fa fa-check"></i><b>4.3.3</b> Training vs Non-Training DBH</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="local_mod.html"><a href="local_mod.html#no-intercept-quadratic-model"><i class="fa fa-check"></i><b>4.4</b> No Intercept Quadratic Model</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="local_mod.html"><a href="local_mod.html#model-parameter-estimates-2"><i class="fa fa-check"></i><b>4.4.1</b> Model Parameter Estimates</a></li>
<li class="chapter" data-level="4.4.2" data-path="local_mod.html"><a href="local_mod.html#sfm-derived-height-to-dbh-allometry-2"><i class="fa fa-check"></i><b>4.4.2</b> SfM-derived Height to DBH Allometry</a></li>
<li class="chapter" data-level="4.4.3" data-path="local_mod.html"><a href="local_mod.html#training-vs-non-training-dbh-3"><i class="fa fa-check"></i><b>4.4.3</b> Training vs Non-Training DBH</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="local_mod.html"><a href="local_mod.html#nonlinear-power-model"><i class="fa fa-check"></i><b>4.5</b> Nonlinear Power Model</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="local_mod.html"><a href="local_mod.html#model-parameter-estimates-3"><i class="fa fa-check"></i><b>4.5.1</b> Model Parameter Estimates</a></li>
<li class="chapter" data-level="4.5.2" data-path="local_mod.html"><a href="local_mod.html#sfm-derived-height-to-dbh-allometry-3"><i class="fa fa-check"></i><b>4.5.2</b> SfM-derived Height to DBH Allometry</a></li>
<li class="chapter" data-level="4.5.3" data-path="local_mod.html"><a href="local_mod.html#training-vs-non-training-dbh-4"><i class="fa fa-check"></i><b>4.5.3</b> Training vs Non-Training DBH</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="local_mod.html"><a href="local_mod.html#nonlinear-weibull-model"><i class="fa fa-check"></i><b>4.6</b> Nonlinear Weibull Model</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="local_mod.html"><a href="local_mod.html#model-parameter-estimates-4"><i class="fa fa-check"></i><b>4.6.1</b> Model Parameter Estimates</a></li>
<li class="chapter" data-level="4.6.2" data-path="local_mod.html"><a href="local_mod.html#sfm-derived-height-to-dbh-allometry-4"><i class="fa fa-check"></i><b>4.6.2</b> SfM-derived Height to DBH Allometry</a></li>
<li class="chapter" data-level="4.6.3" data-path="local_mod.html"><a href="local_mod.html#training-vs-non-training-dbh-5"><i class="fa fa-check"></i><b>4.6.3</b> Training vs Non-Training DBH</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="local_mod.html"><a href="local_mod.html#model-comparison"><i class="fa fa-check"></i><b>4.7</b> Model Comparison</a></li>
<li class="chapter" data-level="4.8" data-path="local_mod.html"><a href="local_mod.html#update-dbh-to-best-model"><i class="fa fa-check"></i><b>4.8</b> Update DBH to best model</a></li>
<li class="chapter" data-level="4.9" data-path="local_mod.html"><a href="local_mod.html#combine-harvest-units-with-tree-locations"><i class="fa fa-check"></i><b>4.9</b> Combine harvest units with tree locations</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html"><i class="fa fa-check"></i><b>5</b> Exploratory Analysis</a>
<ul>
<li class="chapter" data-level="5.1" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#study-location-map"><i class="fa fa-check"></i><b>5.1</b> Study Location Map</a></li>
<li class="chapter" data-level="5.2" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#digital-terrain-model-dtm-map"><i class="fa fa-check"></i><b>5.2</b> Digital Terrain Model (DTM) Map</a></li>
<li class="chapter" data-level="5.3" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#canopy-height-model-chm-map"><i class="fa fa-check"></i><b>5.3</b> Canopy height model (CHM) Map</a></li>
<li class="chapter" data-level="5.4" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#dbh-distribution"><i class="fa fa-check"></i><b>5.4</b> DBH Distribution</a></li>
<li class="chapter" data-level="5.5" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#height-distribution"><i class="fa fa-check"></i><b>5.5</b> Height Distribution</a></li>
<li class="chapter" data-level="5.6" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#relationship-between-height-and-dbh"><i class="fa fa-check"></i><b>5.6</b> Relationship between height and DBH</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ostory_valid.html"><a href="ostory_valid.html"><i class="fa fa-check"></i><b>6</b> Overstory Field Validation Data</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ostory_valid.html"><a href="ostory_valid.html#load-field-data"><i class="fa fa-check"></i><b>6.1</b> Load Field Data</a></li>
<li class="chapter" data-level="6.2" data-path="ostory_valid.html"><a href="ostory_valid.html#build-uas-field-validation-data"><i class="fa fa-check"></i><b>6.2</b> Build UAS-Field Validation Data</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ostory_valid.html"><a href="ostory_valid.html#true-positive-identification"><i class="fa fa-check"></i><b>6.2.1</b> True Positive Identification</a></li>
<li class="chapter" data-level="6.2.2" data-path="ostory_valid.html"><a href="ostory_valid.html#combine-with-commission-and-omission"><i class="fa fa-check"></i><b>6.2.2</b> Combine with Commission and Omission</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ostory_valid.html"><a href="ostory_valid.html#summary-of-validation-data"><i class="fa fa-check"></i><b>6.3</b> Summary of Validation Data</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="ostory_valid.html"><a href="ostory_valid.html#true-positive-commission-ommission"><i class="fa fa-check"></i><b>6.3.1</b> True Positive, Commission, Ommission</a></li>
<li class="chapter" data-level="6.3.2" data-path="ostory_valid.html"><a href="ostory_valid.html#f-score"><i class="fa fa-check"></i><b>6.3.2</b> F-score</a></li>
<li class="chapter" data-level="6.3.3" data-path="ostory_valid.html"><a href="ostory_valid.html#height-vs.-dbh-of-tp-co-om"><i class="fa fa-check"></i><b>6.3.3</b> Height vs. DBH of <span class="math inline">\(Tp\)</span>, <span class="math inline">\(Co\)</span>, <span class="math inline">\(Om\)</span></a></li>
<li class="chapter" data-level="6.3.4" data-path="ostory_valid.html"><a href="ostory_valid.html#height-and-dbh-distribution-tp-co-om"><i class="fa fa-check"></i><b>6.3.4</b> Height and DBH Distribution <span class="math inline">\(Tp\)</span>, <span class="math inline">\(Co\)</span>, <span class="math inline">\(Om\)</span></a></li>
<li class="chapter" data-level="6.3.5" data-path="ostory_valid.html"><a href="ostory_valid.html#detected-overstory-tp-height-difference"><i class="fa fa-check"></i><b>6.3.5</b> Detected Overstory (<span class="math inline">\(TP\)</span>) Height Difference</a></li>
<li class="chapter" data-level="6.3.6" data-path="ostory_valid.html"><a href="ostory_valid.html#detected-overstory-tp-dbh-difference"><i class="fa fa-check"></i><b>6.3.6</b> Detected Overstory (<span class="math inline">\(TP\)</span>) DBH Difference</a></li>
<li class="chapter" data-level="6.3.7" data-path="ostory_valid.html"><a href="ostory_valid.html#detected-overstory-tp-reliability"><i class="fa fa-check"></i><b>6.3.7</b> Detected Overstory (<span class="math inline">\(TP\)</span>) Reliability</a></li>
<li class="chapter" data-level="6.3.8" data-path="ostory_valid.html"><a href="ostory_valid.html#detected-overstory-tp-distribution-comparison"><i class="fa fa-check"></i><b>6.3.8</b> Detected Overstory (<span class="math inline">\(TP\)</span>) Distribution Comparison</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="ostory_valid.html"><a href="ostory_valid.html#commission-and-omission-locations"><i class="fa fa-check"></i><b>6.4</b> Commission and Omission Locations</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="ostory_valid.html"><a href="ostory_valid.html#othomosaic-commission-and-omission-locations"><i class="fa fa-check"></i><b>6.4.1</b> Othomosaic Commission and Omission Locations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ustory_valid.html"><a href="ustory_valid.html"><i class="fa fa-check"></i><b>7</b> Regeneration Field Validation Data</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ustory_valid.html"><a href="ustory_valid.html#load-field-data-1"><i class="fa fa-check"></i><b>7.1</b> Load Field Data</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="ustory_valid.html"><a href="ustory_valid.html#regeneration-field-data-plot-map"><i class="fa fa-check"></i><b>7.1.1</b> Regeneration Field Data Plot Map</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ustory_valid.html"><a href="ustory_valid.html#create-data-to-compare-to-uas"><i class="fa fa-check"></i><b>7.2</b> Create Data to Compare to UAS</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ustory_valid.html"><a href="ustory_valid.html#field-regeneration-tpa-by-size-class"><i class="fa fa-check"></i><b>7.2.1</b> Field Regeneration TPA by Size Class</a></li>
<li class="chapter" data-level="7.2.2" data-path="ustory_valid.html"><a href="ustory_valid.html#stand-regeneration-tpa-map"><i class="fa fa-check"></i><b>7.2.2</b> Stand Regeneration TPA Map</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ustory_valid.html"><a href="ustory_valid.html#uas-estimated-regeneration"><i class="fa fa-check"></i><b>7.3</b> UAS Estimated Regeneration</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="ustory_valid.html"><a href="ustory_valid.html#uas-vs-field-regneration-tpa-by-size-class"><i class="fa fa-check"></i><b>7.3.1</b> UAS vs Field Regneration TPA by Size Class</a></li>
<li class="chapter" data-level="7.3.2" data-path="ustory_valid.html"><a href="ustory_valid.html#uas-vs-field-regeneration-tpa-by-stand"><i class="fa fa-check"></i><b>7.3.2</b> UAS vs Field Regeneration TPA by Stand</a></li>
<li class="chapter" data-level="7.3.3" data-path="ustory_valid.html"><a href="ustory_valid.html#uas-vs-field-regeneration-tpa-in-sample-plots"><i class="fa fa-check"></i><b>7.3.3</b> UAS vs Field Regeneration TPA in Sample Plots</a></li>
<li class="chapter" data-level="7.3.4" data-path="ustory_valid.html"><a href="ustory_valid.html#uas-vs-field-regeneration-tpa-correlation"><i class="fa fa-check"></i><b>7.3.4</b> UAS vs Field Regeneration TPA Correlation</a></li>
<li class="chapter" data-level="7.3.5" data-path="ustory_valid.html"><a href="ustory_valid.html#uas-regeneration-tpa-reliability"><i class="fa fa-check"></i><b>7.3.5</b> UAS Regeneration TPA Reliability</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="silv.html"><a href="silv.html"><i class="fa fa-check"></i><b>8</b> Silvicultural Metrics</a>
<ul>
<li class="chapter" data-level="8.1" data-path="silv.html"><a href="silv.html#overstory-summary"><i class="fa fa-check"></i><b>8.1</b> Overstory Summary</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="silv.html"><a href="silv.html#distribution-of-silvicultural-metrics"><i class="fa fa-check"></i><b>8.1.1</b> Distribution of silvicultural metrics</a></li>
<li class="chapter" data-level="8.1.2" data-path="silv.html"><a href="silv.html#overstory-stand-basal-area-map"><i class="fa fa-check"></i><b>8.1.2</b> Overstory Stand Basal Area Map</a></li>
<li class="chapter" data-level="8.1.3" data-path="silv.html"><a href="silv.html#stand-qmd-map"><i class="fa fa-check"></i><b>8.1.3</b> Stand QMD Map</a></li>
<li class="chapter" data-level="8.1.4" data-path="silv.html"><a href="silv.html#overstory-dbh-distrubtion"><i class="fa fa-check"></i><b>8.1.4</b> Overstory DBH Distrubtion</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="silv.html"><a href="silv.html#height-distribution-1"><i class="fa fa-check"></i><b>8.2</b> Height Distribution</a></li>
<li class="chapter" data-level="8.3" data-path="silv.html"><a href="silv.html#understory-summary"><i class="fa fa-check"></i><b>8.3</b> Understory Summary</a></li>
<li class="chapter" data-level="8.4" data-path="silv.html"><a href="silv.html#define-functions-for-stand-summary"><i class="fa fa-check"></i><b>8.4</b> Define Functions for Stand Summary</a></li>
<li class="chapter" data-level="8.5" data-path="silv.html"><a href="silv.html#harvest-unit-summary-reports"><i class="fa fa-check"></i><b>8.5</b> Harvest Unit Summary Reports</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="tree_spatial.html"><a href="tree_spatial.html"><i class="fa fa-check"></i><b>9</b> UAS Tree Spatial Arrangement and ICO Example</a>
<ul>
<li class="chapter" data-level="9.1" data-path="tree_spatial.html"><a href="tree_spatial.html#example-tree-clump-grouping"><i class="fa fa-check"></i><b>9.1</b> Example Tree Clump Grouping</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="tree_spatial.html"><a href="tree_spatial.html#orthomosaic-from-uas"><i class="fa fa-check"></i><b>9.1.1</b> Orthomosaic from UAS</a></li>
<li class="chapter" data-level="9.1.2" data-path="tree_spatial.html"><a href="tree_spatial.html#itd"><i class="fa fa-check"></i><b>9.1.2</b> ITD</a></li>
<li class="chapter" data-level="9.1.3" data-path="tree_spatial.html"><a href="tree_spatial.html#tree-groups"><i class="fa fa-check"></i><b>9.1.3</b> Tree Groups</a></li>
<li class="chapter" data-level="9.1.4" data-path="tree_spatial.html"><a href="tree_spatial.html#within-clump-distance"><i class="fa fa-check"></i><b>9.1.4</b> Within Clump Distance</a></li>
<li class="chapter" data-level="9.1.5" data-path="tree_spatial.html"><a href="tree_spatial.html#clump_sum"><i class="fa fa-check"></i><b>9.1.5</b> Clump Polygons and Metrics</a></li>
<li class="chapter" data-level="9.1.6" data-path="tree_spatial.html"><a href="tree_spatial.html#clump-spacing"><i class="fa fa-check"></i><b>9.1.6</b> Clump Spacing</a></li>
<li class="chapter" data-level="9.1.7" data-path="tree_spatial.html"><a href="tree_spatial.html#clump_metrics"><i class="fa fa-check"></i><b>9.1.7</b> Clump Metrics</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="tree_spatial.html"><a href="tree_spatial.html#ico-implementation"><i class="fa fa-check"></i><b>9.2</b> ICO Implementation</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="tree_spatial.html"><a href="tree_spatial.html#determine-the-stand-average-density-target"><i class="fa fa-check"></i><b>9.2.1</b> 3. Determine the stand average density target</a></li>
<li class="chapter" data-level="9.2.2" data-path="tree_spatial.html"><a href="tree_spatial.html#set_targets"><i class="fa fa-check"></i><b>9.2.2</b> 5. Obtain targets for clump proportions</a></li>
<li class="chapter" data-level="9.2.3" data-path="tree_spatial.html"><a href="tree_spatial.html#select-target-clump-proportions-for-your-stand"><i class="fa fa-check"></i><b>9.2.3</b> 6. Select target clump proportions for your stand</a></li>
<li class="chapter" data-level="9.2.4" data-path="tree_spatial.html"><a href="tree_spatial.html#combine-clump-and-opening-targets-with-leave-tree-criteria-into-marking-guidelines"><i class="fa fa-check"></i><b>9.2.4</b> 8. Combine clump and opening targets with leave tree criteria into marking guidelines</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="tree_spatial.html"><a href="tree_spatial.html#implement"><i class="fa fa-check"></i><b>9.3</b> Full ICO Prescription Process</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Black Hills Experimental Forest UAS Mission Data Summary</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tree_spatial" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Section 9</span> UAS Tree Spatial Arrangement and ICO Example<a href="tree_spatial.html#tree_spatial" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this section, we’ll outline the steps needed to start with a UAS tree list, identify tree clump grouping, set prescription targets and generate cut/leave trees to define a prescription.</p>
<div id="example-tree-clump-grouping" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Example Tree Clump Grouping<a href="tree_spatial.html#example-tree-clump-grouping" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s go through the tree clump grouping process for a single stand</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="tree_spatial.html#cb95-1" tabindex="-1"></a><span class="co"># focus on one harvest unit</span></span>
<span id="cb95-2"><a href="tree_spatial.html#cb95-2" tabindex="-1"></a>  my_suid <span class="ot">=</span> harvests<span class="sc">$</span>suid[<span class="dv">6</span>]</span>
<span id="cb95-3"><a href="tree_spatial.html#cb95-3" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-4"><a href="tree_spatial.html#cb95-4" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-5"><a href="tree_spatial.html#cb95-5" tabindex="-1"></a><span class="co"># what is overstory?</span></span>
<span id="cb95-6"><a href="tree_spatial.html#cb95-6" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-7"><a href="tree_spatial.html#cb95-7" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-8"><a href="tree_spatial.html#cb95-8" tabindex="-1"></a>  <span class="co">#!!!!! fill in one...if both filled in will use DBH</span></span>
<span id="cb95-9"><a href="tree_spatial.html#cb95-9" tabindex="-1"></a>  <span class="co"># determine overstory by height</span></span>
<span id="cb95-10"><a href="tree_spatial.html#cb95-10" tabindex="-1"></a>  ostory_ht_m <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>) <span class="co"># m = ft / 3.281</span></span>
<span id="cb95-11"><a href="tree_spatial.html#cb95-11" tabindex="-1"></a>  <span class="co"># determine overstory by diameter</span></span>
<span id="cb95-12"><a href="tree_spatial.html#cb95-12" tabindex="-1"></a>  ostory_dbh_cm <span class="ot">=</span> <span class="dv">5</span><span class="sc">*</span><span class="fl">2.54</span> <span class="co"># cm = in * 2.54</span></span>
<span id="cb95-13"><a href="tree_spatial.html#cb95-13" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-14"><a href="tree_spatial.html#cb95-14" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-15"><a href="tree_spatial.html#cb95-15" tabindex="-1"></a><span class="co"># clump spacing</span></span>
<span id="cb95-16"><a href="tree_spatial.html#cb95-16" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-17"><a href="tree_spatial.html#cb95-17" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb95-18"><a href="tree_spatial.html#cb95-18" tabindex="-1"></a>  <span class="co"># maximum distance between trees for determining tree clumps</span></span>
<span id="cb95-19"><a href="tree_spatial.html#cb95-19" tabindex="-1"></a>    <span class="co"># stems within 6 m of one another were considered to have the potential for developing interlocking crowns</span></span>
<span id="cb95-20"><a href="tree_spatial.html#cb95-20" tabindex="-1"></a>  tree_clump_dist_m <span class="ot">=</span> <span class="dv">6</span></span></code></pre></div>
<p>Check the stand location</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="tree_spatial.html#cb96-1" tabindex="-1"></a><span class="co"># where is this</span></span>
<span id="cb96-2"><a href="tree_spatial.html#cb96-2" tabindex="-1"></a>mapview<span class="sc">::</span><span class="fu">mapview</span>(harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid), <span class="at">layer.name =</span> <span class="st">&quot;BHEF&quot;</span>, <span class="at">label =</span> <span class="cn">FALSE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>, <span class="at">popup =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-7ef3aa3d053d461cab49" style="width:1008px;height:672px;"></div>
<script type="application/json" data-for="htmlwidget-7ef3aa3d053d461cab49">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["polygon",420]},{"method":"addPolygons","args":[[[[{"lng":[-103.61499635,-103.6148624503738,-103.614905962,-103.6148546889099,-103.6148318851605,-103.614896326,-103.614977554,-103.615024246,-103.615072903,-103.615122253,-103.615155623,-103.615188821,-103.615226249,-103.615271526,-103.615304763,-103.615336034,-103.615362019,-103.615396975,-103.615399023,-103.61543165,-103.615438602,-103.615466859,-103.615471354,-103.615514272,-103.61553469,-103.615552267,-103.615565888,-103.615572211,-103.61557305,-103.615597927,-103.615617591,-103.615594257,-103.615576613,-103.615564106,-103.615572301,-103.615564633,-103.615568688,-103.61556887,-103.615569836,-103.615574768,-103.61559199,-103.615588249,-103.615595635,-103.615613526,-103.615640311,-103.615663897,-103.6156926,-103.615741279,-103.615789942,-103.615839842,-103.615887572,-103.615923543,-103.615953977,-103.615968033,-103.615994069,-103.61601783,-103.616030113,-103.616051537,-103.616077338,-103.61610477,-103.616132729,-103.616157779,-103.616180841,-103.616218936,-103.616268879,-103.616291906,-103.616316024,-103.616373873,-103.61641838,-103.61646535,-103.616511609,-103.616550018,-103.616585994,-103.616617974,-103.616655631,-103.616692822,-103.616731023,-103.616770866,-103.616807412,-103.616857143,-103.616896425,-103.616926178,-103.616966347,-103.617021212,-103.617085703,-103.617104642,-103.617130886,-103.617179434,-103.617253043,-103.617289399,-103.617336565,-103.617370936,-103.617385639,-103.617389509,-103.617400844,-103.617387992,-103.617390473,-103.617382474,-103.617378477,-103.617380627,-103.617381855,-103.617380492,-103.617388626,-103.617418394,-103.617436227,-103.617474671,-103.617488446,-103.617481668,-103.617456895,-103.617447324,-103.61743816,-103.617431783,-103.617420491,-103.617422883,-103.61742616,-103.617433183,-103.617443867,-103.617456787,-103.617469397,-103.61748903,-103.617583803,-103.61762084,-103.617698516,-103.617742231,-103.617788694,-103.617837149,-103.617885191,-103.61793517,-103.618002149,-103.618056256,-103.618114925,-103.618166886,-103.61821469,-103.618265144,-103.61831574,-103.618365322,-103.618439089,-103.618468767,-103.618507918,-103.618527191,-103.618557279,-103.618579266,-103.618599543,-103.618603039,-103.618612405,-103.618632746,-103.61863484,-103.618656176,-103.618651694,-103.618640588,-103.61863775,-103.618611818,-103.618591713,-103.618571443,-103.618541411,-103.618498917,-103.61846651,-103.618422187,-103.618372577,-103.6183215,-103.618274107,-103.61822368,-103.61816754,-103.618113797,-103.618057156,-103.618000321,-103.617934886,-103.617870705,-103.617807694,-103.617743661,-103.617667041,-103.617597322,-103.617529992,-103.617461034,-103.617393798,-103.617323916,-103.617255059,-103.617185142,-103.617117138,-103.617045257,-103.616976856,-103.616909652,-103.616838942,-103.616772149,-103.616705483,-103.616643142,-103.616580985,-103.616517592,-103.616452295,-103.616383219,-103.61631115,-103.616238823,-103.616170123,-103.616099016,-103.616035999,-103.615966992,-103.615897345,-103.615829746,-103.615767673,-103.615707405,-103.615651315,-103.615582176,-103.615517418,-103.615445252,-103.615371581,-103.615297752,-103.615223026,-103.615146295,-103.615070447,-103.6149970695087,-103.61499635],"lat":[44.14645179300004,44.14177281563305,44.14162132199998,44.14150158675973,44.14070468828182,44.14068819400001,44.14071233700002,44.14078150000001,44.14083185599997,44.14085906999998,44.14089120400001,44.140948175,44.14097410599999,44.14100218999999,44.14104164399998,44.14109385299998,44.14112547600001,44.141185849,44.14121267500001,44.14125782399998,44.14130601199997,44.14134536799998,44.14136483800002,44.14140073300001,44.14145028799998,44.14146919199998,44.14153675099999,44.14157499100003,44.14162309599998,44.141666294,44.141709123,44.14172553999998,44.141759793,44.14178471200001,44.14180659700003,44.141848272,44.14188490499999,44.141926624,44.14196641199999,44.14200882799997,44.14205224499999,44.14208263400001,44.14212512599999,44.14213316399997,44.14218462899998,44.14220590600001,44.142243033,44.14224718100002,44.14225100599997,44.14225359300002,44.14224727099997,44.142236889,44.14221314299999,44.14217650499999,44.14214373399999,44.14210707799997,44.14206255300002,44.14202555399999,44.14199038800001,44.14195975899997,44.14191787099998,44.14189646599998,44.14187101599999,44.14185626599999,44.14184702599999,44.14183055500002,44.14181330399998,44.14183205699999,44.141846682,44.14186912899999,44.14189798199997,44.14192105299997,44.14194863300003,44.14197024100002,44.14199822699999,44.14201592199998,44.14203752999997,44.14204945300002,44.14207477399998,44.14209402199998,44.14211188199999,44.14213222599999,44.14215515799998,44.14219772799998,44.14223614600001,44.142248355,44.142270623,44.142295654,44.14231985599997,44.142333619,44.14235617199999,44.142391567,44.142428978,44.14244314500001,44.14247517,44.14251748200001,44.142545379,44.142552771,44.14257307700001,44.142593331,44.14261329200002,44.14264275199998,44.142687411,44.14272131899996,44.14273506099998,44.14275712400002,44.14276076399999,44.14279886999997,44.14282874700001,44.14287466399998,44.14292701499999,44.14297397000001,44.14301690000003,44.14306420200001,44.14311800899997,44.14316713599998,44.143229415,44.14327745200002,44.14331598899997,44.14336510700002,44.143517884,44.14356110099999,44.14363620199997,44.14368668499998,44.143736853,44.143784175,44.14382605399999,44.14385735600001,44.14391473900002,44.143965364,44.14400858099998,44.14405945800001,44.14410386899998,44.14415090900003,44.14418378800002,44.14423052,44.144270775,44.14433143700001,44.14438271400001,44.14440896999996,44.14446170500002,44.14451373600002,44.14457155799999,44.144632768,44.14468969599999,44.14475113200001,44.144808769,44.14487220500001,44.144929805,44.14498519300002,44.14504691600002,44.145094953,44.14515519899999,44.14521939100002,44.14527542000001,44.145333101,44.14538384600002,44.14543409800001,44.145477695,44.14552319900002,44.145569383,44.145610906,44.14564455599998,44.145676751,44.14571378400001,44.14574826299997,44.14578427100002,44.14581643000002,44.145846273,44.145877987,44.14590744899999,44.14593968499998,44.14596888099999,44.14600257500001,44.14603881499998,44.14607275899998,44.14610343700001,44.14613632700002,44.14617101499999,44.14620369599999,44.146235897,44.14626565899998,44.146299016,44.14633258100001,44.14636233599998,44.14639126399998,44.14641289399998,44.14644243800001,44.146467873,44.14649233199997,44.14651517099997,44.14653501100003,44.14655332400002,44.14656903500003,44.14658664900002,44.14659948299998,44.14661253899998,44.14661874400002,44.14661980699997,44.14662509599997,44.14662661599999,44.14663186100001,44.14663286000002,44.14663195100001,44.14662746599999,44.14662393100001,44.14662284899998,44.14661349400001,44.14660181099998,44.14658534816522,44.14645179300004]}]]],null,"BHEF",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"polygon","stroke":true,"color":"#333333","weight":0.5,"opacity":0.9,"fill":true,"fillColor":"#6666FF","fillOpacity":0.6,"smoothFactor":1,"noClip":false},null,{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},{"stroke":true,"weight":1,"opacity":0.9,"fillOpacity":0.84,"bringToFront":false,"sendToBack":false}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addLayersControl","args":[["Esri.WorldImagery","OpenStreetMap"],"BHEF",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]}],"limits":{"lat":[44.14068819400001,44.14663286000002],"lng":[-103.618656176,-103.6148318851605]},"fitBounds":[44.14068819400001,-103.618656176,44.14663286000002,-103.6148318851605,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<div id="orthomosaic-from-uas" class="section level3 hasAnchor" number="9.1.1">
<h3><span class="header-section-number">9.1.1</span> Orthomosaic from UAS<a href="tree_spatial.html#orthomosaic-from-uas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="tree_spatial.html#cb97-1" tabindex="-1"></a><span class="do">######################################################################################</span></span>
<span id="cb97-2"><a href="tree_spatial.html#cb97-2" tabindex="-1"></a><span class="co"># function to plot ortho + stand</span></span>
<span id="cb97-3"><a href="tree_spatial.html#cb97-3" tabindex="-1"></a><span class="do">######################################################################################</span></span>
<span id="cb97-4"><a href="tree_spatial.html#cb97-4" tabindex="-1"></a>ortho_plt_fn <span class="ot">=</span> <span class="cf">function</span>(my_suid){</span>
<span id="cb97-5"><a href="tree_spatial.html#cb97-5" tabindex="-1"></a><span class="co"># convert to stars</span></span>
<span id="cb97-6"><a href="tree_spatial.html#cb97-6" tabindex="-1"></a>  ortho_st <span class="ot">=</span> ortho_rast <span class="sc">%&gt;%</span>  </span>
<span id="cb97-7"><a href="tree_spatial.html#cb97-7" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb97-8"><a href="tree_spatial.html#cb97-8" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb97-9"><a href="tree_spatial.html#cb97-9" tabindex="-1"></a>      <span class="co"># stand %&gt;% </span></span>
<span id="cb97-10"><a href="tree_spatial.html#cb97-10" tabindex="-1"></a>      harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid) <span class="sc">%&gt;%</span> </span>
<span id="cb97-11"><a href="tree_spatial.html#cb97-11" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb97-12"><a href="tree_spatial.html#cb97-12" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb97-13"><a href="tree_spatial.html#cb97-13" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb97-14"><a href="tree_spatial.html#cb97-14" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb97-15"><a href="tree_spatial.html#cb97-15" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-16"><a href="tree_spatial.html#cb97-16" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="dv">2</span>, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb97-17"><a href="tree_spatial.html#cb97-17" tabindex="-1"></a>    stars<span class="sc">::</span><span class="fu">st_as_stars</span>()</span>
<span id="cb97-18"><a href="tree_spatial.html#cb97-18" tabindex="-1"></a>  </span>
<span id="cb97-19"><a href="tree_spatial.html#cb97-19" tabindex="-1"></a>  <span class="co"># convert to rgb</span></span>
<span id="cb97-20"><a href="tree_spatial.html#cb97-20" tabindex="-1"></a>  ortho_rgb <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">st_rgb</span>(</span>
<span id="cb97-21"><a href="tree_spatial.html#cb97-21" tabindex="-1"></a>    ortho_st[,,,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb97-22"><a href="tree_spatial.html#cb97-22" tabindex="-1"></a>    , <span class="at">dimension =</span> <span class="dv">3</span></span>
<span id="cb97-23"><a href="tree_spatial.html#cb97-23" tabindex="-1"></a>    , <span class="at">use_alpha =</span> <span class="cn">FALSE</span></span>
<span id="cb97-24"><a href="tree_spatial.html#cb97-24" tabindex="-1"></a>    <span class="co"># , stretch = &quot;histogram&quot;</span></span>
<span id="cb97-25"><a href="tree_spatial.html#cb97-25" tabindex="-1"></a>    , <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.995</span>)</span>
<span id="cb97-26"><a href="tree_spatial.html#cb97-26" tabindex="-1"></a>    , <span class="at">stretch =</span> <span class="st">&quot;percent&quot;</span></span>
<span id="cb97-27"><a href="tree_spatial.html#cb97-27" tabindex="-1"></a>  )</span>
<span id="cb97-28"><a href="tree_spatial.html#cb97-28" tabindex="-1"></a>  <span class="co"># ggplot</span></span>
<span id="cb97-29"><a href="tree_spatial.html#cb97-29" tabindex="-1"></a>  plt_rgb <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb97-30"><a href="tree_spatial.html#cb97-30" tabindex="-1"></a>    stars<span class="sc">::</span><span class="fu">geom_stars</span>(<span class="at">data =</span> ortho_rgb[]) <span class="sc">+</span></span>
<span id="cb97-31"><a href="tree_spatial.html#cb97-31" tabindex="-1"></a>    <span class="fu">scale_fill_identity</span>(<span class="at">na.value =</span> <span class="st">&quot;transparent&quot;</span>) <span class="sc">+</span> <span class="co"># !!! don&#39;t take this out or RGB plot will kill your computer</span></span>
<span id="cb97-32"><a href="tree_spatial.html#cb97-32" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb97-33"><a href="tree_spatial.html#cb97-33" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb97-34"><a href="tree_spatial.html#cb97-34" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb97-35"><a href="tree_spatial.html#cb97-35" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb97-36"><a href="tree_spatial.html#cb97-36" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb97-37"><a href="tree_spatial.html#cb97-37" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb97-38"><a href="tree_spatial.html#cb97-38" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span>
<span id="cb97-39"><a href="tree_spatial.html#cb97-39" tabindex="-1"></a>  </span>
<span id="cb97-40"><a href="tree_spatial.html#cb97-40" tabindex="-1"></a>  <span class="co"># return(plt_rgb)</span></span>
<span id="cb97-41"><a href="tree_spatial.html#cb97-41" tabindex="-1"></a>  <span class="co"># combine all plot elements</span></span>
<span id="cb97-42"><a href="tree_spatial.html#cb97-42" tabindex="-1"></a>  plt_combine <span class="ot">=</span> plt_rgb <span class="sc">+</span></span>
<span id="cb97-43"><a href="tree_spatial.html#cb97-43" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb97-44"><a href="tree_spatial.html#cb97-44" tabindex="-1"></a>      <span class="at">data =</span> harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid)</span>
<span id="cb97-45"><a href="tree_spatial.html#cb97-45" tabindex="-1"></a>      , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb97-46"><a href="tree_spatial.html#cb97-46" tabindex="-1"></a>      , <span class="at">lwd =</span> <span class="fl">1.5</span></span>
<span id="cb97-47"><a href="tree_spatial.html#cb97-47" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;#b22222&quot;</span></span>
<span id="cb97-48"><a href="tree_spatial.html#cb97-48" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb97-49"><a href="tree_spatial.html#cb97-49" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb97-50"><a href="tree_spatial.html#cb97-50" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span> <span class="co"># c(0.5,1)</span></span>
<span id="cb97-51"><a href="tree_spatial.html#cb97-51" tabindex="-1"></a>      , <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span></span>
<span id="cb97-52"><a href="tree_spatial.html#cb97-52" tabindex="-1"></a>      , <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb97-53"><a href="tree_spatial.html#cb97-53" tabindex="-1"></a>      , <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb97-54"><a href="tree_spatial.html#cb97-54" tabindex="-1"></a>      , <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb97-55"><a href="tree_spatial.html#cb97-55" tabindex="-1"></a>      , <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb97-56"><a href="tree_spatial.html#cb97-56" tabindex="-1"></a>      <span class="co"># , plot.title = ggtext::element_markdown(size = 10, hjust = 0.5)</span></span>
<span id="cb97-57"><a href="tree_spatial.html#cb97-57" tabindex="-1"></a>      , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb97-58"><a href="tree_spatial.html#cb97-58" tabindex="-1"></a>      , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)</span>
<span id="cb97-59"><a href="tree_spatial.html#cb97-59" tabindex="-1"></a>    )</span>
<span id="cb97-60"><a href="tree_spatial.html#cb97-60" tabindex="-1"></a>  <span class="fu">return</span>(plt_combine)</span>
<span id="cb97-61"><a href="tree_spatial.html#cb97-61" tabindex="-1"></a>}</span>
<span id="cb97-62"><a href="tree_spatial.html#cb97-62" tabindex="-1"></a><span class="co"># PLOT IT</span></span>
<span id="cb97-63"><a href="tree_spatial.html#cb97-63" tabindex="-1"></a><span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb97-64"><a href="tree_spatial.html#cb97-64" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb97-65"><a href="tree_spatial.html#cb97-65" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">stand boundary</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb97-66"><a href="tree_spatial.html#cb97-66" tabindex="-1"></a>    <span class="co"># subtitle = &quot;&lt;span style=&#39;color:#b22222;&#39;&gt;&lt;b&gt;&lt;i&gt;stand boundary&lt;/i&gt;&lt;/b&gt;&lt;/span&gt;&quot;</span></span>
<span id="cb97-67"><a href="tree_spatial.html#cb97-67" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-68"><a href="tree_spatial.html#cb97-68" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb97-69"><a href="tree_spatial.html#cb97-69" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">9.5</span>, <span class="at">color =</span> <span class="st">&quot;#b22222&quot;</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb97-70"><a href="tree_spatial.html#cb97-70" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-31-1.png" width="1008" /></p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="tree_spatial.html#cb98-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb98-2"><a href="tree_spatial.html#cb98-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_01.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>plot with CHM</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="tree_spatial.html#cb99-1" tabindex="-1"></a><span class="co"># chm</span></span>
<span id="cb99-2"><a href="tree_spatial.html#cb99-2" tabindex="-1"></a>  chm_temp <span class="ot">=</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb99-3"><a href="tree_spatial.html#cb99-3" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb99-4"><a href="tree_spatial.html#cb99-4" tabindex="-1"></a>      harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid) <span class="sc">%&gt;%</span> </span>
<span id="cb99-5"><a href="tree_spatial.html#cb99-5" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb99-6"><a href="tree_spatial.html#cb99-6" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb99-7"><a href="tree_spatial.html#cb99-7" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb99-8"><a href="tree_spatial.html#cb99-8" tabindex="-1"></a>      harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid) <span class="sc">%&gt;%</span> </span>
<span id="cb99-9"><a href="tree_spatial.html#cb99-9" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb99-10"><a href="tree_spatial.html#cb99-10" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb99-11"><a href="tree_spatial.html#cb99-11" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="dv">2</span>, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb99-12"><a href="tree_spatial.html#cb99-12" tabindex="-1"></a>    <span class="st">`</span><span class="at">*</span><span class="st">`</span>(<span class="fl">3.28</span>) <span class="sc">%&gt;%</span> <span class="co"># transform to feet</span></span>
<span id="cb99-13"><a href="tree_spatial.html#cb99-13" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb99-14"><a href="tree_spatial.html#cb99-14" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb99-15"><a href="tree_spatial.html#cb99-15" tabindex="-1"></a>  </span>
<span id="cb99-16"><a href="tree_spatial.html#cb99-16" tabindex="-1"></a>  <span class="co"># plot it</span></span>
<span id="cb99-17"><a href="tree_spatial.html#cb99-17" tabindex="-1"></a>  plt_chm_temp <span class="ot">=</span> <span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb99-18"><a href="tree_spatial.html#cb99-18" tabindex="-1"></a>    <span class="co"># chm</span></span>
<span id="cb99-19"><a href="tree_spatial.html#cb99-19" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb99-20"><a href="tree_spatial.html#cb99-20" tabindex="-1"></a>    <span class="fu">geom_tile</span>(</span>
<span id="cb99-21"><a href="tree_spatial.html#cb99-21" tabindex="-1"></a>      <span class="at">data =</span> chm_temp</span>
<span id="cb99-22"><a href="tree_spatial.html#cb99-22" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> f)</span>
<span id="cb99-23"><a href="tree_spatial.html#cb99-23" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb99-24"><a href="tree_spatial.html#cb99-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb99-25"><a href="tree_spatial.html#cb99-25" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">option=</span><span class="st">&quot;plasma&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">6</span>), <span class="at">na.value =</span> <span class="st">&quot;transparent&quot;</span>) <span class="sc">+</span></span>
<span id="cb99-26"><a href="tree_spatial.html#cb99-26" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;CHM (ft)&quot;</span>)</span>
<span id="cb99-27"><a href="tree_spatial.html#cb99-27" tabindex="-1"></a></span>
<span id="cb99-28"><a href="tree_spatial.html#cb99-28" tabindex="-1"></a><span class="co"># PLOT IT</span></span>
<span id="cb99-29"><a href="tree_spatial.html#cb99-29" tabindex="-1"></a>plt_chm_temp</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-32-1.png" width="1008" /></p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="tree_spatial.html#cb100-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb100-2"><a href="tree_spatial.html#cb100-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_02.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
</div>
<div id="itd" class="section level3 hasAnchor" number="9.1.2">
<h3><span class="header-section-number">9.1.2</span> ITD<a href="tree_spatial.html#itd" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>individual trees detected from <code>lidR::locate_trees()</code></p>
<p>Height</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="tree_spatial.html#cb101-1" tabindex="-1"></a>plt_ttops_temp <span class="ot">=</span> <span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb101-2"><a href="tree_spatial.html#cb101-2" tabindex="-1"></a>    <span class="co"># treetops</span></span>
<span id="cb101-3"><a href="tree_spatial.html#cb101-3" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb101-4"><a href="tree_spatial.html#cb101-4" tabindex="-1"></a>      <span class="at">data =</span> harvests_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid)</span>
<span id="cb101-5"><a href="tree_spatial.html#cb101-5" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> tree_height_ft)</span>
<span id="cb101-6"><a href="tree_spatial.html#cb101-6" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb101-7"><a href="tree_spatial.html#cb101-7" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb101-8"><a href="tree_spatial.html#cb101-8" tabindex="-1"></a>    <span class="fu">scale_color_viridis_c</span>(<span class="at">option=</span><span class="st">&quot;plasma&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb101-9"><a href="tree_spatial.html#cb101-9" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;Individual Tree</span><span class="sc">\n</span><span class="st">Ht. (ft)&quot;</span>)</span>
<span id="cb101-10"><a href="tree_spatial.html#cb101-10" tabindex="-1"></a></span>
<span id="cb101-11"><a href="tree_spatial.html#cb101-11" tabindex="-1"></a><span class="co"># PLOT IT</span></span>
<span id="cb101-12"><a href="tree_spatial.html#cb101-12" tabindex="-1"></a>plt_ttops_temp</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-34-1.png" width="1008" /></p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="tree_spatial.html#cb102-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb102-2"><a href="tree_spatial.html#cb102-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_03.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>overstory/understory</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="tree_spatial.html#cb103-1" tabindex="-1"></a>plt_ttops_temp <span class="ot">=</span> <span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb103-2"><a href="tree_spatial.html#cb103-2" tabindex="-1"></a>    <span class="co"># treetops</span></span>
<span id="cb103-3"><a href="tree_spatial.html#cb103-3" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb103-4"><a href="tree_spatial.html#cb103-4" tabindex="-1"></a>      <span class="at">data =</span> harvests_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid) <span class="sc">%&gt;%</span></span>
<span id="cb103-5"><a href="tree_spatial.html#cb103-5" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-6"><a href="tree_spatial.html#cb103-6" tabindex="-1"></a>          <span class="at">ostory =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb103-7"><a href="tree_spatial.html#cb103-7" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_dbh_cm)) <span class="sc">&amp;</span></span>
<span id="cb103-8"><a href="tree_spatial.html#cb103-8" tabindex="-1"></a>              dbh_cm<span class="sc">&gt;=</span><span class="fu">as.numeric</span>(ostory_dbh_cm) <span class="sc">~</span> <span class="st">&quot;overstory&quot;</span></span>
<span id="cb103-9"><a href="tree_spatial.html#cb103-9" tabindex="-1"></a>            , <span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_ht_m)) <span class="sc">&amp;</span></span>
<span id="cb103-10"><a href="tree_spatial.html#cb103-10" tabindex="-1"></a>              tree_height_m<span class="sc">&gt;=</span><span class="fu">as.numeric</span>(ostory_ht_m) <span class="sc">~</span> <span class="st">&quot;overstory&quot;</span></span>
<span id="cb103-11"><a href="tree_spatial.html#cb103-11" tabindex="-1"></a>            , <span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_dbh_cm)) <span class="sc">&amp;</span></span>
<span id="cb103-12"><a href="tree_spatial.html#cb103-12" tabindex="-1"></a>              <span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_ht_m)) <span class="sc">&amp;</span></span>
<span id="cb103-13"><a href="tree_spatial.html#cb103-13" tabindex="-1"></a>              dbh_cm<span class="sc">&gt;=</span><span class="dv">5</span><span class="sc">*</span><span class="fl">2.54</span> <span class="sc">~</span> <span class="st">&quot;overstory&quot;</span></span>
<span id="cb103-14"><a href="tree_spatial.html#cb103-14" tabindex="-1"></a>            , T <span class="sc">~</span> <span class="st">&quot;understory&quot;</span></span>
<span id="cb103-15"><a href="tree_spatial.html#cb103-15" tabindex="-1"></a>          )</span>
<span id="cb103-16"><a href="tree_spatial.html#cb103-16" tabindex="-1"></a>          , <span class="at">ostory_sz =</span> <span class="fu">ifelse</span>(ostory<span class="sc">==</span><span class="st">&quot;overstory&quot;</span>,<span class="fl">0.51</span>,<span class="fl">0.5</span>)</span>
<span id="cb103-17"><a href="tree_spatial.html#cb103-17" tabindex="-1"></a>        )</span>
<span id="cb103-18"><a href="tree_spatial.html#cb103-18" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> ostory)</span>
<span id="cb103-19"><a href="tree_spatial.html#cb103-19" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb103-20"><a href="tree_spatial.html#cb103-20" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb103-21"><a href="tree_spatial.html#cb103-21" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;navy&quot;</span>,<span class="st">&quot;gray&quot;</span>)) <span class="sc">+</span></span>
<span id="cb103-22"><a href="tree_spatial.html#cb103-22" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-23"><a href="tree_spatial.html#cb103-23" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="cn">NA</span>), <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="fl">6.5</span>,<span class="dv">0</span>,<span class="fl">6.5</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb103-24"><a href="tree_spatial.html#cb103-24" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="st">&quot;none&quot;</span>, <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)))</span>
<span id="cb103-25"><a href="tree_spatial.html#cb103-25" tabindex="-1"></a></span>
<span id="cb103-26"><a href="tree_spatial.html#cb103-26" tabindex="-1"></a><span class="co"># PLOT IT</span></span>
<span id="cb103-27"><a href="tree_spatial.html#cb103-27" tabindex="-1"></a>plt_ttops_temp</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-35-1.png" width="1008" /></p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="tree_spatial.html#cb104-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb104-2"><a href="tree_spatial.html#cb104-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_04.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
</div>
<div id="tree-groups" class="section level3 hasAnchor" number="9.1.3">
<h3><span class="header-section-number">9.1.3</span> Tree Groups<a href="tree_spatial.html#tree-groups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Identify tree groups using <code>dbscan::dbscan()</code> as outlined by <a href="https://scholar.google.com/scholar?oi=bibs&amp;hl=en&amp;cluster=8254459212692276263">Hanna et al. (2024)</a>:</p>
<blockquote>
<p>To evaluate the ability of UAS-extracted trees to characterize horizontal and vertical heterogeneity tree arrangement, clusters of trees were identifed within the stem-mapped and UAS trees. A cluster of trees was defned as two or more trees with the potential for interlocking crowns. Overstory trees on the stem maps generally had a crown radius of ~3.0 m, so stems within 6 m of one another were considered to have the potential for developing interlocking crowns. Density-based spatial clustering of applications with noise (DBSCAN) from the fpr package (Hahsler et al., 2019) in R was used to assign trees to unique clusters, including individual trees that were assigned by themselves if they did not have the potential to develop interlocking crowns (&gt;6 m from another tree). (p. 529)</p>
</blockquote>
<blockquote>
<p>To analyze the efect of tree aggregation on tree attributes, the identifed trees and clusters were designated as an “individual” or as a cluster consisting of 2-4, 5-9, 10-15, and &gt;15 trees. We then calculated the number of clusters, the percent of stand basal area, the height coefcient of variation, and the canopy area within the cluster size classes for each site. (p. 529-530)</p>
</blockquote>
<p>With repect to clump size groupings, <a href="https://scholarworks.umt.edu/ico/3">Churchill et al. (2016)</a> note that:</p>
<blockquote>
<p>Proportions for clump sizes should be lumped into four or five bins for operational simplicity. We use 4 or 5 bins (Fig 5): individual trees, small clumps (2-4 trees), medium clumps (5-9 trees), and large clumps (10-20+ trees). Note that when instructed to leave a large clump (e.g. 10-20 trees), marking crews often have difficulty leaving the upper end of the size range (e.g. an 18, 19, or 20 tree clump). Thus adding a fifth bin for “super clumps” may be necessary (e.g. 15-20 trees or 20-25+ trees), especially if the upper size range of clumps is desired. (p. 12-13)</p>
</blockquote>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="tree_spatial.html#cb105-1" tabindex="-1"></a><span class="co"># filter trees spatially based on unit id</span></span>
<span id="cb105-2"><a href="tree_spatial.html#cb105-2" tabindex="-1"></a>ttops_temp <span class="ot">=</span> harvests_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid) <span class="sc">%&gt;%</span> </span>
<span id="cb105-3"><a href="tree_spatial.html#cb105-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb105-4"><a href="tree_spatial.html#cb105-4" tabindex="-1"></a>    <span class="at">ostory =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb105-5"><a href="tree_spatial.html#cb105-5" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_dbh_cm)) <span class="sc">&amp;</span></span>
<span id="cb105-6"><a href="tree_spatial.html#cb105-6" tabindex="-1"></a>        dbh_cm<span class="sc">&gt;=</span><span class="fu">as.numeric</span>(ostory_dbh_cm) <span class="sc">~</span> <span class="st">&quot;overstory&quot;</span></span>
<span id="cb105-7"><a href="tree_spatial.html#cb105-7" tabindex="-1"></a>      , <span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_ht_m)) <span class="sc">&amp;</span></span>
<span id="cb105-8"><a href="tree_spatial.html#cb105-8" tabindex="-1"></a>        tree_height_m<span class="sc">&gt;=</span><span class="fu">as.numeric</span>(ostory_ht_m) <span class="sc">~</span> <span class="st">&quot;overstory&quot;</span></span>
<span id="cb105-9"><a href="tree_spatial.html#cb105-9" tabindex="-1"></a>      , <span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_dbh_cm)) <span class="sc">&amp;</span></span>
<span id="cb105-10"><a href="tree_spatial.html#cb105-10" tabindex="-1"></a>        <span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_ht_m)) <span class="sc">&amp;</span></span>
<span id="cb105-11"><a href="tree_spatial.html#cb105-11" tabindex="-1"></a>        dbh_cm<span class="sc">&gt;=</span><span class="dv">5</span><span class="sc">*</span><span class="fl">2.54</span> <span class="sc">~</span> <span class="st">&quot;overstory&quot;</span></span>
<span id="cb105-12"><a href="tree_spatial.html#cb105-12" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="st">&quot;understory&quot;</span></span>
<span id="cb105-13"><a href="tree_spatial.html#cb105-13" tabindex="-1"></a>    )</span>
<span id="cb105-14"><a href="tree_spatial.html#cb105-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb105-15"><a href="tree_spatial.html#cb105-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(ostory<span class="sc">==</span><span class="st">&quot;overstory&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb105-16"><a href="tree_spatial.html#cb105-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb105-17"><a href="tree_spatial.html#cb105-17" tabindex="-1"></a>    <span class="at">X =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb105-18"><a href="tree_spatial.html#cb105-18" tabindex="-1"></a>    , <span class="at">Y =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb105-19"><a href="tree_spatial.html#cb105-19" tabindex="-1"></a>  )</span>
<span id="cb105-20"><a href="tree_spatial.html#cb105-20" tabindex="-1"></a><span class="do">#############################################################################</span></span>
<span id="cb105-21"><a href="tree_spatial.html#cb105-21" tabindex="-1"></a><span class="do">##### Identify clusters in each stem map plot                           #####</span></span>
<span id="cb105-22"><a href="tree_spatial.html#cb105-22" tabindex="-1"></a><span class="do">#############################################################################</span></span>
<span id="cb105-23"><a href="tree_spatial.html#cb105-23" tabindex="-1"></a><span class="do">### Place trees into clusters using an inter-tree distance of 6 m</span></span>
<span id="cb105-24"><a href="tree_spatial.html#cb105-24" tabindex="-1"></a>my_dbscan_temp <span class="ot">=</span>  ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb105-25"><a href="tree_spatial.html#cb105-25" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb105-26"><a href="tree_spatial.html#cb105-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y) <span class="sc">%&gt;%</span> </span>
<span id="cb105-27"><a href="tree_spatial.html#cb105-27" tabindex="-1"></a>  dbscan<span class="sc">::</span><span class="fu">dbscan</span>(<span class="at">eps =</span> tree_clump_dist_m, <span class="at">minPts =</span> <span class="dv">2</span>)</span>
<span id="cb105-28"><a href="tree_spatial.html#cb105-28" tabindex="-1"></a></span>
<span id="cb105-29"><a href="tree_spatial.html#cb105-29" tabindex="-1"></a><span class="co"># my_dbscan_temp %&gt;% str()</span></span>
<span id="cb105-30"><a href="tree_spatial.html#cb105-30" tabindex="-1"></a></span>
<span id="cb105-31"><a href="tree_spatial.html#cb105-31" tabindex="-1"></a><span class="do">### append cluster ID to trees</span></span>
<span id="cb105-32"><a href="tree_spatial.html#cb105-32" tabindex="-1"></a>ttops_temp<span class="sc">$</span>dbscan_cluster <span class="ot">=</span> my_dbscan_temp<span class="sc">$</span>cluster</span>
<span id="cb105-33"><a href="tree_spatial.html#cb105-33" tabindex="-1"></a><span class="co"># ttops_temp$cluster %&gt;% summary()</span></span>
<span id="cb105-34"><a href="tree_spatial.html#cb105-34" tabindex="-1"></a><span class="co"># ttops_temp %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(cluster) %&gt;% dplyr::arrange(desc(n)) %&gt;% dplyr::slice_head(n=11)</span></span>
<span id="cb105-35"><a href="tree_spatial.html#cb105-35" tabindex="-1"></a></span>
<span id="cb105-36"><a href="tree_spatial.html#cb105-36" tabindex="-1"></a><span class="do">### cluster metrics</span></span>
<span id="cb105-37"><a href="tree_spatial.html#cb105-37" tabindex="-1"></a>ttops_temp <span class="ot">=</span> ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb105-38"><a href="tree_spatial.html#cb105-38" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(dbscan_cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb105-39"><a href="tree_spatial.html#cb105-39" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb105-40"><a href="tree_spatial.html#cb105-40" tabindex="-1"></a>    <span class="co"># unique dbscan_cluster for individuals</span></span>
<span id="cb105-41"><a href="tree_spatial.html#cb105-41" tabindex="-1"></a>    <span class="at">clump_id =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb105-42"><a href="tree_spatial.html#cb105-42" tabindex="-1"></a>      dbscan_cluster <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">max</span>(my_dbscan_temp<span class="sc">$</span>cluster)<span class="sc">+</span>dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb105-43"><a href="tree_spatial.html#cb105-43" tabindex="-1"></a>      , T <span class="sc">~</span> dbscan_cluster</span>
<span id="cb105-44"><a href="tree_spatial.html#cb105-44" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb105-45"><a href="tree_spatial.html#cb105-45" tabindex="-1"></a>    <span class="fu">factor</span>()</span>
<span id="cb105-46"><a href="tree_spatial.html#cb105-46" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb105-47"><a href="tree_spatial.html#cb105-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb105-48"><a href="tree_spatial.html#cb105-48" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb105-49"><a href="tree_spatial.html#cb105-49" tabindex="-1"></a>    <span class="at">dbscan_cluster =</span> <span class="fu">factor</span>(dbscan_cluster)</span>
<span id="cb105-50"><a href="tree_spatial.html#cb105-50" tabindex="-1"></a>    , <span class="at">clump_n_trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb105-51"><a href="tree_spatial.html#cb105-51" tabindex="-1"></a>    , <span class="at">clump_n_trees_grp =</span> <span class="fu">cut</span>(</span>
<span id="cb105-52"><a href="tree_spatial.html#cb105-52" tabindex="-1"></a>        clump_n_trees</span>
<span id="cb105-53"><a href="tree_spatial.html#cb105-53" tabindex="-1"></a>        ,<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="cn">Inf</span>)</span>
<span id="cb105-54"><a href="tree_spatial.html#cb105-54" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>,<span class="st">&quot;2-4 trees&quot;</span>,<span class="st">&quot;5-9 trees&quot;</span>,<span class="st">&quot;10-15 trees&quot;</span>,<span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb105-55"><a href="tree_spatial.html#cb105-55" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb105-56"><a href="tree_spatial.html#cb105-56" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb105-57"><a href="tree_spatial.html#cb105-57" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb105-58"><a href="tree_spatial.html#cb105-58" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>,<span class="st">&quot;2-4 trees&quot;</span>,<span class="st">&quot;5-9 trees&quot;</span>,<span class="st">&quot;10-15 trees&quot;</span>,<span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb105-59"><a href="tree_spatial.html#cb105-59" tabindex="-1"></a>      )</span>
<span id="cb105-60"><a href="tree_spatial.html#cb105-60" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb105-61"><a href="tree_spatial.html#cb105-61" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb105-62"><a href="tree_spatial.html#cb105-62" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb105-63"><a href="tree_spatial.html#cb105-63" tabindex="-1"></a>ttops_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 2,127
## Columns: 61
## $ suid                      &lt;chr&gt; &quot;0203088082660001000&quot;, &quot;0203088082660001000&quot;…
## $ forest_commonname         &lt;chr&gt; &quot;Black Hills National Forest&quot;, &quot;Black Hills …
## $ admin_region_code         &lt;chr&gt; &quot;02&quot;, &quot;02&quot;, &quot;02&quot;, &quot;02&quot;, &quot;02&quot;, &quot;02&quot;, &quot;02&quot;, &quot;0…
## $ activity_name             &lt;chr&gt; &quot;Single-tree Selection Cut&quot;, &quot;Single-tree Se…
## $ treatment_type            &lt;chr&gt; &quot;Single-tree selectio&quot;, &quot;Single-tree selecti…
## $ treatment_type_grp        &lt;chr&gt; &quot;Single-tree/Group Selection Cut&quot;, &quot;Single-t…
## $ date_compl                &lt;date&gt; 2021-06-01, 2021-06-01, 2021-06-01, 2021-06…
## $ year_id                   &lt;dbl&gt; 2021, 2021, 2021, 2021, 2021, 2021, 2021, 20…
## $ stand_area_m2             &lt;dbl&gt; 122161.5, 122161.5, 122161.5, 122161.5, 1221…
## $ stand_area_ha             &lt;dbl&gt; 12.21615, 12.21615, 12.21615, 12.21615, 12.2…
## $ treeID                    &lt;chr&gt; &quot;14552_610693.9_4889086.6&quot;, &quot;14644_610749.4_…
## $ tree_height_m             &lt;dbl&gt; 13.338, 8.104, 7.523, 7.951, 10.099, 9.421, …
## $ crown_area_m2             &lt;dbl&gt; 14.4375, 11.4375, 9.9375, 20.8750, 9.1250, 1…
## $ comp_trees_per_ha         &lt;dbl&gt; 254.7643, 127.3822, 254.7643, 382.1465, 127.…
## $ comp_relative_tree_height &lt;dbl&gt; 100.00000, 100.00000, 100.00000, 66.28595, 1…
## $ comp_dist_to_nearest_m    &lt;dbl&gt; 4.527693, 6.932712, 4.123106, 3.783186, 6.93…
## $ mean_crown_ht_m           &lt;dbl&gt; 10.416134, 4.533062, 4.840354, 4.106737, 8.0…
## $ median_crown_ht_m         &lt;dbl&gt; 10.855000, 5.097000, 4.936000, 4.018000, 8.3…
## $ min_crown_ht_m            &lt;dbl&gt; 4.504333, 1.371000, 1.392000, 1.372000, 4.98…
## $ reg_est_dbh_cm            &lt;dbl&gt; 24.04701, 13.06371, 11.95876, 12.85215, 17.0…
## $ reg_est_lower_dbh_cm      &lt;dbl&gt; 14.904274, 8.132362, 7.403700, 7.957194, 10.…
## $ reg_est_upper_dbh_cm      &lt;dbl&gt; 35.00581, 19.03814, 17.25921, 18.71577, 24.8…
## $ is_training_data          &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FA…
## $ dbh_cm                    &lt;dbl&gt; 27.45837, 15.22910, 13.87139, 15.03349, 19.9…
## $ dbh_m                     &lt;dbl&gt; 0.2745837, 0.1522910, 0.1387139, 0.1503349, …
## $ radius_m                  &lt;dbl&gt; 0.13729187, 0.07614551, 0.06935696, 0.075167…
## $ basal_area_m2             &lt;dbl&gt; 0.05921606, 0.01821539, 0.01511228, 0.017750…
## $ mod_lin_est_dbh_cm        &lt;dbl&gt; 27.45837, 15.22910, 13.87139, 15.03349, 19.9…
## $ mod_quad_est_dbh_cm       &lt;dbl&gt; 27.18101, 17.03401, 16.06475, 16.84068, 20.5…
## $ mod_quad_noint_est_dbh_cm &lt;dbl&gt; 26.630361, 10.428490, 9.063097, 10.147398, 1…
## $ mod_pwr_est_dbh_cm        &lt;dbl&gt; 27.22240, 16.45572, 15.37924, 16.27028, 20.2…
## $ mod_weib_est_dbh_cm       &lt;dbl&gt; 27.78981, 13.64749, 12.12533, 13.35646, 18.8…
## $ mod_rf_est_dbh_cm         &lt;dbl&gt; 28.24706, 26.12541, 21.28572, 21.98804, 21.3…
## $ reg_est_dbh_in            &lt;dbl&gt; 9.474521, 5.147103, 4.711751, 5.063749, 6.70…
## $ reg_est_lower_dbh_in      &lt;dbl&gt; 5.872284, 3.204150, 2.917058, 3.135134, 4.12…
## $ reg_est_upper_dbh_in      &lt;dbl&gt; 13.792290, 7.501026, 6.800127, 7.374013, 9.7…
## $ dbh_in                    &lt;dbl&gt; 10.818599, 6.000266, 5.465329, 5.923196, 7.8…
## $ mod_lin_est_dbh_in        &lt;dbl&gt; 10.818599, 6.000266, 5.465329, 5.923196, 7.8…
## $ mod_quad_est_dbh_in       &lt;dbl&gt; 10.709316, 6.711400, 6.329510, 6.635229, 8.0…
## $ mod_quad_noint_est_dbh_in &lt;dbl&gt; 10.492362, 4.108825, 3.570860, 3.998075, 6.2…
## $ mod_pwr_est_dbh_in        &lt;dbl&gt; 10.725627, 6.483554, 6.059419, 6.410490, 7.9…
## $ mod_weib_est_dbh_in       &lt;dbl&gt; 10.949186, 5.377112, 4.777382, 5.262443, 7.4…
## $ mod_rf_est_dbh_in         &lt;dbl&gt; 11.129343, 10.293411, 8.386573, 8.663287, 8.…
## $ tree_height_ft            &lt;dbl&gt; 43.74864, 26.58112, 24.67544, 26.07928, 33.1…
## $ comp_dist_to_nearest_ft   &lt;dbl&gt; 14.850832, 22.739296, 13.523786, 12.408852, …
## $ mean_crown_ht_ft          &lt;dbl&gt; 34.16492, 14.86844, 15.87636, 13.47010, 26.4…
## $ median_crown_ht_ft        &lt;dbl&gt; 35.60440, 16.71816, 16.19008, 13.17904, 27.4…
## $ min_crown_ht_ft           &lt;dbl&gt; 14.77421, 4.49688, 4.56576, 4.50016, 16.3606…
## $ dbh_ft                    &lt;dbl&gt; 0.9006347, 0.4995145, 0.4549817, 0.4930986, …
## $ radius_ft                 &lt;dbl&gt; 0.4503173, 0.2497573, 0.2274908, 0.2465493, …
## $ comp_trees_per_ac         &lt;dbl&gt; 103.17954, 51.58977, 103.17954, 154.76931, 5…
## $ crown_area_ft2            &lt;dbl&gt; 155.40525, 123.11325, 106.96725, 224.69850, …
## $ basal_area_ft2            &lt;dbl&gt; 0.6374017, 0.1960705, 0.1626686, 0.1910660, …
## $ geom                      &lt;POINT [m]&gt; POINT (610693.9 4889087), POINT (61074…
## $ ostory                    &lt;chr&gt; &quot;overstory&quot;, &quot;overstory&quot;, &quot;overstory&quot;, &quot;over…
## $ X                         &lt;dbl&gt; 610693.9, 610749.4, 610720.1, 610706.1, 6107…
## $ Y                         &lt;dbl&gt; 4889087, 4889085, 4889085, 4889084, 4889082,…
## $ dbscan_cluster            &lt;fct&gt; 0, 0, 0, 1, 0, 0, 1, 2, 3, 0, 3, 0, 0, 0, 2,…
## $ clump_id                  &lt;fct&gt; 268, 269, 270, 1, 271, 272, 1, 2, 3, 273, 3,…
## $ clump_n_trees             &lt;int&gt; 1, 1, 1, 2, 1, 1, 2, 3, 20, 1, 20, 1, 1, 1, …
## $ clump_n_trees_grp         &lt;ord&gt; Individual, Individual, Individual, 2-4 tree…</code></pre>
<p>plot overstory tree clumps</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="tree_spatial.html#cb107-1" tabindex="-1"></a>plt_grps_temp <span class="ot">=</span> <span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb107-2"><a href="tree_spatial.html#cb107-2" tabindex="-1"></a>    <span class="co"># treetops</span></span>
<span id="cb107-3"><a href="tree_spatial.html#cb107-3" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb107-4"><a href="tree_spatial.html#cb107-4" tabindex="-1"></a>      <span class="at">data =</span> ttops_temp</span>
<span id="cb107-5"><a href="tree_spatial.html#cb107-5" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> dbscan_cluster)</span>
<span id="cb107-6"><a href="tree_spatial.html#cb107-6" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb107-7"><a href="tree_spatial.html#cb107-7" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb107-8"><a href="tree_spatial.html#cb107-8" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb107-9"><a href="tree_spatial.html#cb107-9" tabindex="-1"></a>      <span class="st">&quot;white&quot;</span></span>
<span id="cb107-10"><a href="tree_spatial.html#cb107-10" tabindex="-1"></a>      , <span class="co"># get random list of colors from viridis and avoid whites</span></span>
<span id="cb107-11"><a href="tree_spatial.html#cb107-11" tabindex="-1"></a>        <span class="fu">c</span>(</span>
<span id="cb107-12"><a href="tree_spatial.html#cb107-12" tabindex="-1"></a>          viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>())</span>
<span id="cb107-13"><a href="tree_spatial.html#cb107-13" tabindex="-1"></a>          , viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>(), <span class="at">end =</span> <span class="fl">0.95</span>)</span>
<span id="cb107-14"><a href="tree_spatial.html#cb107-14" tabindex="-1"></a>          , viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>(), <span class="at">end =</span> <span class="fl">0.9</span>)</span>
<span id="cb107-15"><a href="tree_spatial.html#cb107-15" tabindex="-1"></a>          , viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>(), <span class="at">end =</span> <span class="fl">0.9</span>)</span>
<span id="cb107-16"><a href="tree_spatial.html#cb107-16" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb107-17"><a href="tree_spatial.html#cb107-17" tabindex="-1"></a>          <span class="fu">sample</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb107-18"><a href="tree_spatial.html#cb107-18" tabindex="-1"></a>          .[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb107-19"><a href="tree_spatial.html#cb107-19" tabindex="-1"></a>      )</span>
<span id="cb107-20"><a href="tree_spatial.html#cb107-20" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb107-21"><a href="tree_spatial.html#cb107-21" tabindex="-1"></a>    <span class="co"># scale_color_viridis_d(&quot;turbo&quot;) +</span></span>
<span id="cb107-22"><a href="tree_spatial.html#cb107-22" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st"> overstory tree groups</span><span class="sc">\n</span><span class="st">(individual trees in white)&quot;</span>) <span class="sc">+</span></span>
<span id="cb107-23"><a href="tree_spatial.html#cb107-23" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb107-24"><a href="tree_spatial.html#cb107-24" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb107-25"><a href="tree_spatial.html#cb107-25" tabindex="-1"></a>      , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">9.5</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb107-26"><a href="tree_spatial.html#cb107-26" tabindex="-1"></a>    )</span>
<span id="cb107-27"><a href="tree_spatial.html#cb107-27" tabindex="-1"></a></span>
<span id="cb107-28"><a href="tree_spatial.html#cb107-28" tabindex="-1"></a><span class="co"># PLOT IT</span></span>
<span id="cb107-29"><a href="tree_spatial.html#cb107-29" tabindex="-1"></a>plt_grps_temp</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-38-1.png" width="1008" /></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="tree_spatial.html#cb108-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb108-2"><a href="tree_spatial.html#cb108-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_05.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>and plot overstory tree clumps by number of trees</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="tree_spatial.html#cb109-1" tabindex="-1"></a>plt_grps_temp <span class="ot">=</span> <span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb109-2"><a href="tree_spatial.html#cb109-2" tabindex="-1"></a>    <span class="co"># treetops</span></span>
<span id="cb109-3"><a href="tree_spatial.html#cb109-3" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb109-4"><a href="tree_spatial.html#cb109-4" tabindex="-1"></a>      <span class="at">data =</span> ttops_temp</span>
<span id="cb109-5"><a href="tree_spatial.html#cb109-5" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> clump_n_trees_grp)</span>
<span id="cb109-6"><a href="tree_spatial.html#cb109-6" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb109-7"><a href="tree_spatial.html#cb109-7" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb109-8"><a href="tree_spatial.html#cb109-8" tabindex="-1"></a>    <span class="fu">scale_color_viridis_d</span>(<span class="at">option=</span><span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb109-9"><a href="tree_spatial.html#cb109-9" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb109-10"><a href="tree_spatial.html#cb109-10" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="cn">NA</span>), <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="fl">6.5</span>,<span class="dv">0</span>,<span class="fl">6.5</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb109-11"><a href="tree_spatial.html#cb109-11" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="st">&quot;none&quot;</span>, <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)))</span>
<span id="cb109-12"><a href="tree_spatial.html#cb109-12" tabindex="-1"></a></span>
<span id="cb109-13"><a href="tree_spatial.html#cb109-13" tabindex="-1"></a><span class="co"># PLOT IT</span></span>
<span id="cb109-14"><a href="tree_spatial.html#cb109-14" tabindex="-1"></a>plt_grps_temp</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-39-1.png" width="1008" /></p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="tree_spatial.html#cb110-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb110-2"><a href="tree_spatial.html#cb110-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_06.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
</div>
<div id="within-clump-distance" class="section level3 hasAnchor" number="9.1.4">
<h3><span class="header-section-number">9.1.4</span> Within Clump Distance<a href="tree_spatial.html#within-clump-distance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Determine nearest neighbor distance for the stand and within clusters. Some combination of these metrics has been used to describe relative aggregation. (<em>source?</em>)</p>
<p>Calculate the distance to the nearest tree within each clump</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="tree_spatial.html#cb111-1" tabindex="-1"></a>ttops_temp <span class="ot">=</span></span>
<span id="cb111-2"><a href="tree_spatial.html#cb111-2" tabindex="-1"></a>  ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb111-3"><a href="tree_spatial.html#cb111-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id) <span class="sc">%&gt;%</span></span>
<span id="cb111-4"><a href="tree_spatial.html#cb111-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb111-5"><a href="tree_spatial.html#cb111-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb111-6"><a href="tree_spatial.html#cb111-6" tabindex="-1"></a>    <span class="at">distance_clump_nn_m =</span> purrr<span class="sc">::</span><span class="fu">map</span>(data, <span class="cf">function</span>(x){</span>
<span id="cb111-7"><a href="tree_spatial.html#cb111-7" tabindex="-1"></a>      <span class="co"># get index of nearest neighbor</span></span>
<span id="cb111-8"><a href="tree_spatial.html#cb111-8" tabindex="-1"></a>      i <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_nearest_feature</span>(x)</span>
<span id="cb111-9"><a href="tree_spatial.html#cb111-9" tabindex="-1"></a>      <span class="co"># get dist</span></span>
<span id="cb111-10"><a href="tree_spatial.html#cb111-10" tabindex="-1"></a>      d <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(x, x[i,], <span class="at">by_element=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb111-11"><a href="tree_spatial.html#cb111-11" tabindex="-1"></a>      <span class="fu">return</span>(d)</span>
<span id="cb111-12"><a href="tree_spatial.html#cb111-12" tabindex="-1"></a>    })</span>
<span id="cb111-13"><a href="tree_spatial.html#cb111-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb111-14"><a href="tree_spatial.html#cb111-14" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(data, distance_clump_nn_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb111-15"><a href="tree_spatial.html#cb111-15" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geom&quot;</span>) <span class="sc">%&gt;%</span> <span class="co"># set it cuz it got lost </span></span>
<span id="cb111-16"><a href="tree_spatial.html#cb111-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb111-17"><a href="tree_spatial.html#cb111-17" tabindex="-1"></a>  <span class="co"># ggplot() + geom_point(aes(x=X,y=Y,color = distance_clump_nn_m)) + theme_light()</span></span></code></pre></div>
<p>plot it</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="tree_spatial.html#cb112-1" tabindex="-1"></a><span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb112-2"><a href="tree_spatial.html#cb112-2" tabindex="-1"></a>    <span class="co"># treetops</span></span>
<span id="cb112-3"><a href="tree_spatial.html#cb112-3" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb112-4"><a href="tree_spatial.html#cb112-4" tabindex="-1"></a>      <span class="at">data =</span> ttops_temp</span>
<span id="cb112-5"><a href="tree_spatial.html#cb112-5" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> distance_clump_nn_m)</span>
<span id="cb112-6"><a href="tree_spatial.html#cb112-6" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb112-7"><a href="tree_spatial.html#cb112-7" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb112-8"><a href="tree_spatial.html#cb112-8" tabindex="-1"></a>    <span class="fu">scale_color_viridis_c</span>(<span class="at">option=</span><span class="st">&quot;viridis&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span> </span>
<span id="cb112-9"><a href="tree_spatial.html#cb112-9" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;within clump</span><span class="sc">\n</span><span class="st">N.N. dist. (m)&quot;</span>)</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-41-1.png" width="1008" /></p>
<div id="clump_trees" class="section level4 hasAnchor" number="9.1.4.1">
<h4><span class="header-section-number">9.1.4.1</span> Create function to get tree list with clumps<a href="tree_spatial.html#clump_trees" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>first, create a general function to apply <code>dbscan::dbscan</code> to point data of class <code>sf</code></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="tree_spatial.html#cb113-1" tabindex="-1"></a><span class="co"># function to clump data that are sf points</span></span>
<span id="cb113-2"><a href="tree_spatial.html#cb113-2" tabindex="-1"></a>sp_clump_points <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb113-3"><a href="tree_spatial.html#cb113-3" tabindex="-1"></a>  x <span class="co"># point data of class `sf` </span></span>
<span id="cb113-4"><a href="tree_spatial.html#cb113-4" tabindex="-1"></a>  , <span class="at">clump_dist_m =</span> <span class="dv">6</span> <span class="co"># size (radius) of the epsilon neighborhood = maximum distance between points to add to clump</span></span>
<span id="cb113-5"><a href="tree_spatial.html#cb113-5" tabindex="-1"></a>  , <span class="at">clump_breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="cn">Inf</span>) <span class="co"># where to break the clump size groups</span></span>
<span id="cb113-6"><a href="tree_spatial.html#cb113-6" tabindex="-1"></a>  , <span class="at">clump_labels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>,<span class="st">&quot;2-4 trees&quot;</span>,<span class="st">&quot;5-9 trees&quot;</span>,<span class="st">&quot;10-15 trees&quot;</span>,<span class="st">&quot;&gt;15 trees&quot;</span>) <span class="co"># what to name the clump size groups</span></span>
<span id="cb113-7"><a href="tree_spatial.html#cb113-7" tabindex="-1"></a>) {</span>
<span id="cb113-8"><a href="tree_spatial.html#cb113-8" tabindex="-1"></a>  <span class="co"># get points as x,y</span></span>
<span id="cb113-9"><a href="tree_spatial.html#cb113-9" tabindex="-1"></a>    point_clusters <span class="ot">=</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb113-10"><a href="tree_spatial.html#cb113-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb113-11"><a href="tree_spatial.html#cb113-11" tabindex="-1"></a>        <span class="at">X =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb113-12"><a href="tree_spatial.html#cb113-12" tabindex="-1"></a>        , <span class="at">Y =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb113-13"><a href="tree_spatial.html#cb113-13" tabindex="-1"></a>      )</span>
<span id="cb113-14"><a href="tree_spatial.html#cb113-14" tabindex="-1"></a>    <span class="do">#############################################################################</span></span>
<span id="cb113-15"><a href="tree_spatial.html#cb113-15" tabindex="-1"></a>    <span class="do">##### Identify clusters in each stem map plot                           #####</span></span>
<span id="cb113-16"><a href="tree_spatial.html#cb113-16" tabindex="-1"></a>    <span class="do">#############################################################################</span></span>
<span id="cb113-17"><a href="tree_spatial.html#cb113-17" tabindex="-1"></a>    <span class="do">### Place trees into clusters using an inter-tree distance of 6 m</span></span>
<span id="cb113-18"><a href="tree_spatial.html#cb113-18" tabindex="-1"></a>    my_dbscan_temp <span class="ot">=</span>  point_clusters <span class="sc">%&gt;%</span> </span>
<span id="cb113-19"><a href="tree_spatial.html#cb113-19" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb113-20"><a href="tree_spatial.html#cb113-20" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y) <span class="sc">%&gt;%</span> </span>
<span id="cb113-21"><a href="tree_spatial.html#cb113-21" tabindex="-1"></a>      dbscan<span class="sc">::</span><span class="fu">dbscan</span>(<span class="at">eps =</span> clump_dist_m, <span class="at">minPts =</span> <span class="dv">2</span>)</span>
<span id="cb113-22"><a href="tree_spatial.html#cb113-22" tabindex="-1"></a>    </span>
<span id="cb113-23"><a href="tree_spatial.html#cb113-23" tabindex="-1"></a>    <span class="co"># my_dbscan_temp %&gt;% str()</span></span>
<span id="cb113-24"><a href="tree_spatial.html#cb113-24" tabindex="-1"></a>    </span>
<span id="cb113-25"><a href="tree_spatial.html#cb113-25" tabindex="-1"></a>    <span class="do">### append cluster ID to tree points</span></span>
<span id="cb113-26"><a href="tree_spatial.html#cb113-26" tabindex="-1"></a>    point_clusters<span class="sc">$</span>dbscan_cluster <span class="ot">=</span> my_dbscan_temp<span class="sc">$</span>cluster</span>
<span id="cb113-27"><a href="tree_spatial.html#cb113-27" tabindex="-1"></a>    <span class="co"># point_clusters$cluster %&gt;% summary()</span></span>
<span id="cb113-28"><a href="tree_spatial.html#cb113-28" tabindex="-1"></a>    <span class="co"># point_clusters %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(cluster) %&gt;% dplyr::arrange(desc(n)) %&gt;% dplyr::slice_head(n=11)</span></span>
<span id="cb113-29"><a href="tree_spatial.html#cb113-29" tabindex="-1"></a>  </span>
<span id="cb113-30"><a href="tree_spatial.html#cb113-30" tabindex="-1"></a>  <span class="do">### cluster metrics</span></span>
<span id="cb113-31"><a href="tree_spatial.html#cb113-31" tabindex="-1"></a>  point_clusters <span class="ot">=</span> point_clusters <span class="sc">%&gt;%</span> </span>
<span id="cb113-32"><a href="tree_spatial.html#cb113-32" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(dbscan_cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb113-33"><a href="tree_spatial.html#cb113-33" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb113-34"><a href="tree_spatial.html#cb113-34" tabindex="-1"></a>      <span class="co"># unique dbscan_cluster for individuals</span></span>
<span id="cb113-35"><a href="tree_spatial.html#cb113-35" tabindex="-1"></a>      <span class="at">clump_id =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb113-36"><a href="tree_spatial.html#cb113-36" tabindex="-1"></a>        dbscan_cluster <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">max</span>(my_dbscan_temp<span class="sc">$</span>cluster)<span class="sc">+</span>dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb113-37"><a href="tree_spatial.html#cb113-37" tabindex="-1"></a>        , T <span class="sc">~</span> dbscan_cluster</span>
<span id="cb113-38"><a href="tree_spatial.html#cb113-38" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb113-39"><a href="tree_spatial.html#cb113-39" tabindex="-1"></a>      <span class="fu">factor</span>()</span>
<span id="cb113-40"><a href="tree_spatial.html#cb113-40" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb113-41"><a href="tree_spatial.html#cb113-41" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb113-42"><a href="tree_spatial.html#cb113-42" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb113-43"><a href="tree_spatial.html#cb113-43" tabindex="-1"></a>      <span class="at">dbscan_cluster =</span> <span class="fu">factor</span>(dbscan_cluster)</span>
<span id="cb113-44"><a href="tree_spatial.html#cb113-44" tabindex="-1"></a>      , <span class="at">clump_n_trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb113-45"><a href="tree_spatial.html#cb113-45" tabindex="-1"></a>      , <span class="at">clump_n_trees_grp =</span> <span class="fu">cut</span>(</span>
<span id="cb113-46"><a href="tree_spatial.html#cb113-46" tabindex="-1"></a>          clump_n_trees</span>
<span id="cb113-47"><a href="tree_spatial.html#cb113-47" tabindex="-1"></a>          , <span class="at">breaks =</span> clump_breaks</span>
<span id="cb113-48"><a href="tree_spatial.html#cb113-48" tabindex="-1"></a>          , <span class="at">labels =</span> clump_labels</span>
<span id="cb113-49"><a href="tree_spatial.html#cb113-49" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb113-50"><a href="tree_spatial.html#cb113-50" tabindex="-1"></a>        <span class="fu">factor</span>(</span>
<span id="cb113-51"><a href="tree_spatial.html#cb113-51" tabindex="-1"></a>          <span class="at">ordered =</span> T</span>
<span id="cb113-52"><a href="tree_spatial.html#cb113-52" tabindex="-1"></a>          , <span class="at">levels =</span> clump_labels</span>
<span id="cb113-53"><a href="tree_spatial.html#cb113-53" tabindex="-1"></a>        )</span>
<span id="cb113-54"><a href="tree_spatial.html#cb113-54" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb113-55"><a href="tree_spatial.html#cb113-55" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb113-56"><a href="tree_spatial.html#cb113-56" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tree_clump_dist_m =</span> clump_dist_m)</span>
<span id="cb113-57"><a href="tree_spatial.html#cb113-57" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb113-58"><a href="tree_spatial.html#cb113-58" tabindex="-1"></a>  <span class="fu">return</span>(point_clusters)</span>
<span id="cb113-59"><a href="tree_spatial.html#cb113-59" tabindex="-1"></a>}</span></code></pre></div>
<p>function specific to this project to filter the tree points attached to harvest bounds and apply the <code>sp_clump_points</code> function</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="tree_spatial.html#cb114-1" tabindex="-1"></a><span class="co"># create function to pass a unit id and return list of trees with clump groupings</span></span>
<span id="cb114-2"><a href="tree_spatial.html#cb114-2" tabindex="-1"></a>get_tree_clumps <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb114-3"><a href="tree_spatial.html#cb114-3" tabindex="-1"></a>    my_suid</span>
<span id="cb114-4"><a href="tree_spatial.html#cb114-4" tabindex="-1"></a>    , <span class="at">tree_clump_dist_m=</span><span class="dv">6</span></span>
<span id="cb114-5"><a href="tree_spatial.html#cb114-5" tabindex="-1"></a>    , <span class="at">ostory_ht_m =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb114-6"><a href="tree_spatial.html#cb114-6" tabindex="-1"></a>    , <span class="at">ostory_dbh_cm =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb114-7"><a href="tree_spatial.html#cb114-7" tabindex="-1"></a>){</span>
<span id="cb114-8"><a href="tree_spatial.html#cb114-8" tabindex="-1"></a>  <span class="co"># check ostory definition</span></span>
<span id="cb114-9"><a href="tree_spatial.html#cb114-9" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_dbh_cm)) <span class="sc">&amp;</span> <span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_ht_m))){</span>
<span id="cb114-10"><a href="tree_spatial.html#cb114-10" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;`ostory_dbh_cm` and `ostory_ht_m` are not set...using `ostory_dbh_cm` = 12.7&quot;</span>)</span>
<span id="cb114-11"><a href="tree_spatial.html#cb114-11" tabindex="-1"></a>    ostory_dbh_cm <span class="ot">=</span> <span class="dv">5</span><span class="sc">*</span><span class="fl">2.54</span></span>
<span id="cb114-12"><a href="tree_spatial.html#cb114-12" tabindex="-1"></a>    <span class="co"># filter data</span></span>
<span id="cb114-13"><a href="tree_spatial.html#cb114-13" tabindex="-1"></a>    ttops_temp <span class="ot">=</span> harvests_trees <span class="sc">%&gt;%</span> </span>
<span id="cb114-14"><a href="tree_spatial.html#cb114-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb114-15"><a href="tree_spatial.html#cb114-15" tabindex="-1"></a>        suid<span class="sc">==</span>my_suid</span>
<span id="cb114-16"><a href="tree_spatial.html#cb114-16" tabindex="-1"></a>        <span class="sc">&amp;</span> dbh_cm<span class="sc">&gt;=</span><span class="fu">as.numeric</span>(ostory_dbh_cm)</span>
<span id="cb114-17"><a href="tree_spatial.html#cb114-17" tabindex="-1"></a>      )</span>
<span id="cb114-18"><a href="tree_spatial.html#cb114-18" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ostory_dbh_cm))){</span>
<span id="cb114-19"><a href="tree_spatial.html#cb114-19" tabindex="-1"></a>    <span class="co"># filter data</span></span>
<span id="cb114-20"><a href="tree_spatial.html#cb114-20" tabindex="-1"></a>    ttops_temp <span class="ot">=</span> harvests_trees <span class="sc">%&gt;%</span> </span>
<span id="cb114-21"><a href="tree_spatial.html#cb114-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb114-22"><a href="tree_spatial.html#cb114-22" tabindex="-1"></a>        suid<span class="sc">==</span>my_suid</span>
<span id="cb114-23"><a href="tree_spatial.html#cb114-23" tabindex="-1"></a>        <span class="sc">&amp;</span> dbh_cm<span class="sc">&gt;=</span><span class="fu">as.numeric</span>(ostory_dbh_cm)</span>
<span id="cb114-24"><a href="tree_spatial.html#cb114-24" tabindex="-1"></a>      )</span>
<span id="cb114-25"><a href="tree_spatial.html#cb114-25" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb114-26"><a href="tree_spatial.html#cb114-26" tabindex="-1"></a>    <span class="co"># filter data</span></span>
<span id="cb114-27"><a href="tree_spatial.html#cb114-27" tabindex="-1"></a>    ttops_temp <span class="ot">=</span> harvests_trees <span class="sc">%&gt;%</span> </span>
<span id="cb114-28"><a href="tree_spatial.html#cb114-28" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb114-29"><a href="tree_spatial.html#cb114-29" tabindex="-1"></a>        suid<span class="sc">==</span>my_suid</span>
<span id="cb114-30"><a href="tree_spatial.html#cb114-30" tabindex="-1"></a>        <span class="sc">&amp;</span> tree_height_m<span class="sc">&gt;=</span><span class="fu">as.numeric</span>(ostory_ht_m)</span>
<span id="cb114-31"><a href="tree_spatial.html#cb114-31" tabindex="-1"></a>      )</span>
<span id="cb114-32"><a href="tree_spatial.html#cb114-32" tabindex="-1"></a>  }</span>
<span id="cb114-33"><a href="tree_spatial.html#cb114-33" tabindex="-1"></a>  </span>
<span id="cb114-34"><a href="tree_spatial.html#cb114-34" tabindex="-1"></a>  <span class="do">### Place trees into clusters using an inter-tree distance of 6 m</span></span>
<span id="cb114-35"><a href="tree_spatial.html#cb114-35" tabindex="-1"></a>  ttops_temp <span class="ot">=</span> <span class="fu">sp_clump_points</span>(</span>
<span id="cb114-36"><a href="tree_spatial.html#cb114-36" tabindex="-1"></a>    <span class="at">x =</span> ttops_temp</span>
<span id="cb114-37"><a href="tree_spatial.html#cb114-37" tabindex="-1"></a>    , <span class="at">clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb114-38"><a href="tree_spatial.html#cb114-38" tabindex="-1"></a>  )</span>
<span id="cb114-39"><a href="tree_spatial.html#cb114-39" tabindex="-1"></a>  </span>
<span id="cb114-40"><a href="tree_spatial.html#cb114-40" tabindex="-1"></a>  <span class="co"># add distance to nearest within clump</span></span>
<span id="cb114-41"><a href="tree_spatial.html#cb114-41" tabindex="-1"></a>  ttops_temp <span class="ot">=</span></span>
<span id="cb114-42"><a href="tree_spatial.html#cb114-42" tabindex="-1"></a>    ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb114-43"><a href="tree_spatial.html#cb114-43" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id) <span class="sc">%&gt;%</span></span>
<span id="cb114-44"><a href="tree_spatial.html#cb114-44" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">nest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb114-45"><a href="tree_spatial.html#cb114-45" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb114-46"><a href="tree_spatial.html#cb114-46" tabindex="-1"></a>      <span class="at">distance_clump_nn_m =</span> purrr<span class="sc">::</span><span class="fu">map</span>(data, <span class="cf">function</span>(x){</span>
<span id="cb114-47"><a href="tree_spatial.html#cb114-47" tabindex="-1"></a>        <span class="co"># get index of nearest neighbor</span></span>
<span id="cb114-48"><a href="tree_spatial.html#cb114-48" tabindex="-1"></a>        i <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_nearest_feature</span>(x)</span>
<span id="cb114-49"><a href="tree_spatial.html#cb114-49" tabindex="-1"></a>        <span class="co"># get dist</span></span>
<span id="cb114-50"><a href="tree_spatial.html#cb114-50" tabindex="-1"></a>        d <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(x, x[i,], <span class="at">by_element=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb114-51"><a href="tree_spatial.html#cb114-51" tabindex="-1"></a>        <span class="fu">return</span>(d)</span>
<span id="cb114-52"><a href="tree_spatial.html#cb114-52" tabindex="-1"></a>      })</span>
<span id="cb114-53"><a href="tree_spatial.html#cb114-53" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb114-54"><a href="tree_spatial.html#cb114-54" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(data, distance_clump_nn_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb114-55"><a href="tree_spatial.html#cb114-55" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geom&quot;</span>) <span class="sc">%&gt;%</span> <span class="co"># set it cuz it got lost </span></span>
<span id="cb114-56"><a href="tree_spatial.html#cb114-56" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb114-57"><a href="tree_spatial.html#cb114-57" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb114-58"><a href="tree_spatial.html#cb114-58" tabindex="-1"></a>      <span class="at">tree_clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb114-59"><a href="tree_spatial.html#cb114-59" tabindex="-1"></a>      , <span class="at">clump_id_duplicate =</span> clump_id <span class="co"># can use this even after nesting data by clump_id</span></span>
<span id="cb114-60"><a href="tree_spatial.html#cb114-60" tabindex="-1"></a>      <span class="co"># , ostory_ht_m = ifelse(is.na(ostory_ht_m), as.numeric(NA), as.numeric(ostory_ht_m))</span></span>
<span id="cb114-61"><a href="tree_spatial.html#cb114-61" tabindex="-1"></a>      <span class="co"># , ostory_dbh_cm = ifelse(is.na(ostory_dbh_cm), as.numeric(NA), as.numeric(ostory_dbh_cm))</span></span>
<span id="cb114-62"><a href="tree_spatial.html#cb114-62" tabindex="-1"></a>    )</span>
<span id="cb114-63"><a href="tree_spatial.html#cb114-63" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb114-64"><a href="tree_spatial.html#cb114-64" tabindex="-1"></a>  <span class="fu">return</span>(ttops_temp)</span>
<span id="cb114-65"><a href="tree_spatial.html#cb114-65" tabindex="-1"></a>}</span>
<span id="cb114-66"><a href="tree_spatial.html#cb114-66" tabindex="-1"></a><span class="co"># call it</span></span>
<span id="cb114-67"><a href="tree_spatial.html#cb114-67" tabindex="-1"></a>ttops_temp <span class="ot">=</span> <span class="fu">get_tree_clumps</span>(</span>
<span id="cb114-68"><a href="tree_spatial.html#cb114-68" tabindex="-1"></a>  <span class="at">my_suid =</span> my_suid</span>
<span id="cb114-69"><a href="tree_spatial.html#cb114-69" tabindex="-1"></a>  , <span class="at">tree_clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb114-70"><a href="tree_spatial.html#cb114-70" tabindex="-1"></a>  , <span class="at">ostory_dbh_cm =</span> ostory_dbh_cm</span>
<span id="cb114-71"><a href="tree_spatial.html#cb114-71" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="clump_sum" class="section level3 hasAnchor" number="9.1.5">
<h3><span class="header-section-number">9.1.5</span> Clump Polygons and Metrics<a href="tree_spatial.html#clump_sum" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><a href="https://scholarworks.umt.edu/ico/3">Churchill et al. (2016)</a> provide instructions for implementing the clump identification (Plotkin et al. 2002) in ArcGIS:</p>
<blockquote>
<p>Use the Buffer tool (in the Proximity toolset within the Analysis toolbox) to create a buffer of distance d/2, one half the inter-tree distance, around each point. This quantity d/2 is meant to approximate the crown radius of a “typical” overstory tree. Set the Dissolve Type option to ALL, which dissolves overlapping buffers, creating a reduced set of spatially non-overlapping polygons stored as a multipart polygon feature…<a href="https://scholar.google.com/scholar?cluster=15721451396848616769&amp;oi=gsb&amp;hl=en&amp;as_sdt=0,6">Sanchez Meador et al. (2011)</a> provide some useful examples of how clump attributes can be summarized…The method described here can be modified to use measured or modeled crown radii for each tree in place of d/2 (p.36)</p>
</blockquote>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="tree_spatial.html#cb115-1" tabindex="-1"></a><span class="co"># create function to pass a return from sp_clump_points/get_tree_clumps and create clump polygons with summary stats</span></span>
<span id="cb115-2"><a href="tree_spatial.html#cb115-2" tabindex="-1"></a>get_clump_summary <span class="ot">=</span> <span class="cf">function</span>(dta){</span>
<span id="cb115-3"><a href="tree_spatial.html#cb115-3" tabindex="-1"></a>  <span class="co"># get tree_clump_dist_m</span></span>
<span id="cb115-4"><a href="tree_spatial.html#cb115-4" tabindex="-1"></a>  tree_clump_dist_m <span class="ot">=</span> <span class="fu">min</span>(dta<span class="sc">$</span>tree_clump_dist_m, <span class="at">na.rm =</span> T)</span>
<span id="cb115-5"><a href="tree_spatial.html#cb115-5" tabindex="-1"></a>  <span class="co"># create clump polys and summary</span></span>
<span id="cb115-6"><a href="tree_spatial.html#cb115-6" tabindex="-1"></a>  clump_polys_temp <span class="ot">=</span> </span>
<span id="cb115-7"><a href="tree_spatial.html#cb115-7" tabindex="-1"></a>    dta <span class="sc">%&gt;%</span> </span>
<span id="cb115-8"><a href="tree_spatial.html#cb115-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb115-9"><a href="tree_spatial.html#cb115-9" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb115-10"><a href="tree_spatial.html#cb115-10" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_buffer</span>(tree_clump_dist_m<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb115-11"><a href="tree_spatial.html#cb115-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(suid, clump_id, dbscan_cluster, clump_n_trees_grp) <span class="sc">%&gt;%</span></span>
<span id="cb115-12"><a href="tree_spatial.html#cb115-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb115-13"><a href="tree_spatial.html#cb115-13" tabindex="-1"></a>        <span class="co"># union buffered tree points</span></span>
<span id="cb115-14"><a href="tree_spatial.html#cb115-14" tabindex="-1"></a>        <span class="at">geometry =</span> sf<span class="sc">::</span><span class="fu">st_union</span>(geometry)</span>
<span id="cb115-15"><a href="tree_spatial.html#cb115-15" tabindex="-1"></a>        <span class="co"># summary metrics</span></span>
<span id="cb115-16"><a href="tree_spatial.html#cb115-16" tabindex="-1"></a>        , <span class="at">n_trees =</span> dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(treeID)</span>
<span id="cb115-17"><a href="tree_spatial.html#cb115-17" tabindex="-1"></a>        , <span class="at">mean_dbh_cm =</span> <span class="fu">mean</span>(dbh_cm, <span class="at">na.rm =</span> T)</span>
<span id="cb115-18"><a href="tree_spatial.html#cb115-18" tabindex="-1"></a>        , <span class="at">mean_tree_height_m =</span> <span class="fu">mean</span>(tree_height_m, <span class="at">na.rm =</span> T)</span>
<span id="cb115-19"><a href="tree_spatial.html#cb115-19" tabindex="-1"></a>        , <span class="at">loreys_height_m =</span> <span class="fu">sum</span>(basal_area_m2<span class="sc">*</span>tree_height_m, <span class="at">na.rm =</span> T) <span class="sc">/</span> <span class="fu">sum</span>(basal_area_m2, <span class="at">na.rm =</span> T)</span>
<span id="cb115-20"><a href="tree_spatial.html#cb115-20" tabindex="-1"></a>        , <span class="at">basal_area_m2 =</span> <span class="fu">sum</span>(basal_area_m2, <span class="at">na.rm =</span> T)</span>
<span id="cb115-21"><a href="tree_spatial.html#cb115-21" tabindex="-1"></a>        , <span class="at">sum_dbh_cm_sq =</span> <span class="fu">sum</span>(dbh_cm<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb115-22"><a href="tree_spatial.html#cb115-22" tabindex="-1"></a>        , <span class="at">.groups =</span> <span class="st">&quot;drop_last&quot;</span></span>
<span id="cb115-23"><a href="tree_spatial.html#cb115-23" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb115-24"><a href="tree_spatial.html#cb115-24" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb115-25"><a href="tree_spatial.html#cb115-25" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb115-26"><a href="tree_spatial.html#cb115-26" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb115-27"><a href="tree_spatial.html#cb115-27" tabindex="-1"></a>        <span class="at">clump_area_ha =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(geometry) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">/</span><span class="st">`</span>(<span class="dv">10000</span>)</span>
<span id="cb115-28"><a href="tree_spatial.html#cb115-28" tabindex="-1"></a>        , <span class="at">trees_per_ha =</span> (n_trees<span class="sc">/</span>clump_area_ha)</span>
<span id="cb115-29"><a href="tree_spatial.html#cb115-29" tabindex="-1"></a>        , <span class="at">basal_area_m2_per_ha =</span> (basal_area_m2<span class="sc">/</span>clump_area_ha)</span>
<span id="cb115-30"><a href="tree_spatial.html#cb115-30" tabindex="-1"></a>        , <span class="at">pct_stand_basal_area =</span> basal_area_m2<span class="sc">/</span><span class="fu">sum</span>(basal_area_m2)</span>
<span id="cb115-31"><a href="tree_spatial.html#cb115-31" tabindex="-1"></a>        , <span class="at">pct_stand_n_trees =</span> n_trees<span class="sc">/</span><span class="fu">sum</span>(n_trees)</span>
<span id="cb115-32"><a href="tree_spatial.html#cb115-32" tabindex="-1"></a>        , <span class="at">qmd_cm =</span> <span class="fu">sqrt</span>(sum_dbh_cm_sq<span class="sc">/</span>n_trees)</span>
<span id="cb115-33"><a href="tree_spatial.html#cb115-33" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb115-34"><a href="tree_spatial.html#cb115-34" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(sum_dbh_cm_sq)) <span class="sc">%&gt;%</span></span>
<span id="cb115-35"><a href="tree_spatial.html#cb115-35" tabindex="-1"></a>      <span class="co"># convert to imperial units</span></span>
<span id="cb115-36"><a href="tree_spatial.html#cb115-36" tabindex="-1"></a>      <span class="fu">calc_imperial_units_fn</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb115-37"><a href="tree_spatial.html#cb115-37" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tree_clump_dist_m =</span> tree_clump_dist_m)</span>
<span id="cb115-38"><a href="tree_spatial.html#cb115-38" tabindex="-1"></a>  <span class="co"># calculate distance between clumps</span></span>
<span id="cb115-39"><a href="tree_spatial.html#cb115-39" tabindex="-1"></a>  clump_polys_temp <span class="ot">=</span> clump_polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb115-40"><a href="tree_spatial.html#cb115-40" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb115-41"><a href="tree_spatial.html#cb115-41" tabindex="-1"></a>      <span class="at">nearest =</span> sf<span class="sc">::</span><span class="fu">st_nearest_feature</span>(clump_polys_temp)</span>
<span id="cb115-42"><a href="tree_spatial.html#cb115-42" tabindex="-1"></a>      , <span class="at">distance_nearest_clump_m =</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(</span>
<span id="cb115-43"><a href="tree_spatial.html#cb115-43" tabindex="-1"></a>          clump_polys_temp</span>
<span id="cb115-44"><a href="tree_spatial.html#cb115-44" tabindex="-1"></a>          , clump_polys_temp[nearest,]</span>
<span id="cb115-45"><a href="tree_spatial.html#cb115-45" tabindex="-1"></a>          , <span class="at">by_element=</span><span class="cn">TRUE</span></span>
<span id="cb115-46"><a href="tree_spatial.html#cb115-46" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb115-47"><a href="tree_spatial.html#cb115-47" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb115-48"><a href="tree_spatial.html#cb115-48" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb115-49"><a href="tree_spatial.html#cb115-49" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(nearest))</span>
<span id="cb115-50"><a href="tree_spatial.html#cb115-50" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb115-51"><a href="tree_spatial.html#cb115-51" tabindex="-1"></a>  <span class="fu">return</span>(clump_polys_temp)</span>
<span id="cb115-52"><a href="tree_spatial.html#cb115-52" tabindex="-1"></a>}</span>
<span id="cb115-53"><a href="tree_spatial.html#cb115-53" tabindex="-1"></a><span class="co"># get it</span></span>
<span id="cb115-54"><a href="tree_spatial.html#cb115-54" tabindex="-1"></a><span class="co"># get_clump_summary(</span></span>
<span id="cb115-55"><a href="tree_spatial.html#cb115-55" tabindex="-1"></a><span class="co">#   dta = get_tree_clumps(my_suid = my_suid, tree_clump_dist_m = tree_clump_dist_m)</span></span>
<span id="cb115-56"><a href="tree_spatial.html#cb115-56" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb115-57"><a href="tree_spatial.html#cb115-57" tabindex="-1"></a>clump_polys_temp <span class="ot">=</span> <span class="fu">get_clump_summary</span>(ttops_temp)</span>
<span id="cb115-58"><a href="tree_spatial.html#cb115-58" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb115-59"><a href="tree_spatial.html#cb115-59" tabindex="-1"></a>clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 464
## Columns: 26
## $ suid                     &lt;chr&gt; &quot;0203088082660001000&quot;, &quot;0203088082660001000&quot;,…
## $ clump_id                 &lt;fct&gt; 268, 269, 270, 271, 272, 273, 274, 275, 276, …
## $ dbscan_cluster           &lt;fct&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
## $ clump_n_trees_grp        &lt;ord&gt; Individual, Individual, Individual, Individua…
## $ geometry                 &lt;POLYGON [m]&gt; POLYGON ((610696.9 4889087,..., POLYG…
## $ n_trees                  &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
## $ mean_dbh_cm              &lt;dbl&gt; 27.45837, 15.22910, 13.87139, 19.98412, 18.31…
## $ mean_tree_height_m       &lt;dbl&gt; 13.338, 8.104, 7.523, 10.099, 9.421, 12.864, …
## $ loreys_height_m          &lt;dbl&gt; 13.338, 8.104, 7.523, 10.099, 9.421, 12.864, …
## $ basal_area_m2            &lt;dbl&gt; 0.05921606, 0.01821539, 0.01511228, 0.0313660…
## $ clump_area_ha            &lt;dbl&gt; 0.002826142, 0.002826142, 0.002826142, 0.0028…
## $ trees_per_ha             &lt;dbl&gt; 353.8393, 353.8393, 353.8393, 353.8393, 353.8…
## $ basal_area_m2_per_ha     &lt;dbl&gt; 20.952969, 6.445321, 5.347319, 11.098543, 9.3…
## $ pct_stand_basal_area     &lt;dbl&gt; 0.0005432558, 0.0001671103, 0.0001386420, 0.0…
## $ pct_stand_n_trees        &lt;dbl&gt; 0.0004701457, 0.0004701457, 0.0004701457, 0.0…
## $ qmd_cm                   &lt;dbl&gt; 27.45837, 15.22910, 13.87139, 19.98412, 18.31…
## $ mean_dbh_in              &lt;dbl&gt; 10.818599, 6.000266, 5.465329, 7.873743, 7.21…
## $ qmd_in                   &lt;dbl&gt; 10.818599, 6.000266, 5.465329, 7.873743, 7.21…
## $ mean_tree_height_ft      &lt;dbl&gt; 43.74864, 26.58112, 24.67544, 33.12472, 30.90…
## $ loreys_height_ft         &lt;dbl&gt; 43.74864, 26.58112, 24.67544, 33.12472, 30.90…
## $ basal_area_ft2_per_ac    &lt;dbl&gt; 91.33399, 28.09515, 23.30896, 48.37855, 40.63…
## $ trees_per_ac             &lt;dbl&gt; 143.3049, 143.3049, 143.3049, 143.3049, 143.3…
## $ clump_area_ac            &lt;dbl&gt; 0.006983396, 0.006983396, 0.006983396, 0.0069…
## $ basal_area_ft2           &lt;dbl&gt; 0.6374017, 0.1960705, 0.1626686, 0.3376242, 0…
## $ tree_clump_dist_m        &lt;dbl&gt; 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, …
## $ distance_nearest_clump_m &lt;dbl&gt; 0.021675089, 0.934747368, 4.205774953, 0.9347…</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="tree_spatial.html#cb117-1" tabindex="-1"></a><span class="co"># do these numbers match</span></span>
<span id="cb117-2"><a href="tree_spatial.html#cb117-2" tabindex="-1"></a><span class="fu">identical</span>(</span>
<span id="cb117-3"><a href="tree_spatial.html#cb117-3" tabindex="-1"></a>  <span class="co"># clump polys</span></span>
<span id="cb117-4"><a href="tree_spatial.html#cb117-4" tabindex="-1"></a>  <span class="fu">nrow</span>(clump_polys_temp)</span>
<span id="cb117-5"><a href="tree_spatial.html#cb117-5" tabindex="-1"></a>  <span class="co"># clumps in tree list data</span></span>
<span id="cb117-6"><a href="tree_spatial.html#cb117-6" tabindex="-1"></a>  , ttops_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(clump_id) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb117-7"><a href="tree_spatial.html#cb117-7" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>plot it</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="tree_spatial.html#cb119-1" tabindex="-1"></a><span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb119-2"><a href="tree_spatial.html#cb119-2" tabindex="-1"></a>  <span class="co"># clumps</span></span>
<span id="cb119-3"><a href="tree_spatial.html#cb119-3" tabindex="-1"></a>  ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb119-4"><a href="tree_spatial.html#cb119-4" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb119-5"><a href="tree_spatial.html#cb119-5" tabindex="-1"></a>    <span class="at">data =</span> clump_polys_temp</span>
<span id="cb119-6"><a href="tree_spatial.html#cb119-6" tabindex="-1"></a>    , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> dbscan_cluster)</span>
<span id="cb119-7"><a href="tree_spatial.html#cb119-7" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.9</span></span>
<span id="cb119-8"><a href="tree_spatial.html#cb119-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb119-9"><a href="tree_spatial.html#cb119-9" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb119-10"><a href="tree_spatial.html#cb119-10" tabindex="-1"></a>    <span class="st">&quot;white&quot;</span></span>
<span id="cb119-11"><a href="tree_spatial.html#cb119-11" tabindex="-1"></a>    , <span class="co"># get random list of colors from viridis and avoid whites</span></span>
<span id="cb119-12"><a href="tree_spatial.html#cb119-12" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb119-13"><a href="tree_spatial.html#cb119-13" tabindex="-1"></a>        viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>())</span>
<span id="cb119-14"><a href="tree_spatial.html#cb119-14" tabindex="-1"></a>        , viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>(), <span class="at">end =</span> <span class="fl">0.95</span>)</span>
<span id="cb119-15"><a href="tree_spatial.html#cb119-15" tabindex="-1"></a>        , viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>(), <span class="at">end =</span> <span class="fl">0.9</span>)</span>
<span id="cb119-16"><a href="tree_spatial.html#cb119-16" tabindex="-1"></a>        , viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">/</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">round</span>(), <span class="at">end =</span> <span class="fl">0.9</span>)</span>
<span id="cb119-17"><a href="tree_spatial.html#cb119-17" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb119-18"><a href="tree_spatial.html#cb119-18" tabindex="-1"></a>        <span class="fu">sample</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb119-19"><a href="tree_spatial.html#cb119-19" tabindex="-1"></a>        .[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(ttops_temp<span class="sc">$</span>dbscan_cluster))<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb119-20"><a href="tree_spatial.html#cb119-20" tabindex="-1"></a>    )</span>
<span id="cb119-21"><a href="tree_spatial.html#cb119-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb119-22"><a href="tree_spatial.html#cb119-22" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st"> overstory tree group polygons</span><span class="sc">\n</span><span class="st">(individual trees in white)&quot;</span>) <span class="sc">+</span></span>
<span id="cb119-23"><a href="tree_spatial.html#cb119-23" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb119-24"><a href="tree_spatial.html#cb119-24" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb119-25"><a href="tree_spatial.html#cb119-25" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">9.5</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb119-26"><a href="tree_spatial.html#cb119-26" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-46-1.png" width="1008" /></p>
<p>check the distance between clumps</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="tree_spatial.html#cb120-1" tabindex="-1"></a><span class="fu">ortho_plt_fn</span>(my_suid) <span class="sc">+</span></span>
<span id="cb120-2"><a href="tree_spatial.html#cb120-2" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb120-3"><a href="tree_spatial.html#cb120-3" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb120-4"><a href="tree_spatial.html#cb120-4" tabindex="-1"></a>      <span class="at">data =</span> clump_polys_temp</span>
<span id="cb120-5"><a href="tree_spatial.html#cb120-5" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> distance_nearest_clump_m)</span>
<span id="cb120-6"><a href="tree_spatial.html#cb120-6" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb120-7"><a href="tree_spatial.html#cb120-7" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb120-8"><a href="tree_spatial.html#cb120-8" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">option=</span><span class="st">&quot;viridis&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span> </span>
<span id="cb120-9"><a href="tree_spatial.html#cb120-9" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;nearest clump</span><span class="sc">\n</span><span class="st">dist. (m)&quot;</span>)</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-47-1.png" width="1008" /></p>
</div>
<div id="clump-spacing" class="section level3 hasAnchor" number="9.1.6">
<h3><span class="header-section-number">9.1.6</span> Clump Spacing<a href="tree_spatial.html#clump-spacing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>See <a href="https://scholarworks.umt.edu/ico/3">Churchill et al. (2016)</a> Figure 4 (p.10) and <a href="https://scholar.google.com/scholar?cluster=14613232085713826018&amp;hl=en&amp;as_sdt=0,6">Matonis and Binkley (2018)</a> who “calculated coverage of mosaic-meadows (percentage of stand &gt; 6 m from overstory trees)” (p. 124)</p>
<p>Since we already buffered the tree points to approximate the crown radius, we’ll continue to use our <span class="math inline">\(d/2\)</span> where <span class="math inline">\(d\)</span> is maximum distance between trees for determining tree clumps and is meant to approximate the crown radius of a “typical” overstory tree</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="tree_spatial.html#cb121-1" tabindex="-1"></a><span class="co"># create function to pass a return from get_clump_summary() and get a distance raster</span></span>
<span id="cb121-2"><a href="tree_spatial.html#cb121-2" tabindex="-1"></a>get_clump_dist_rast <span class="ot">=</span> <span class="cf">function</span>(dta){</span>
<span id="cb121-3"><a href="tree_spatial.html#cb121-3" tabindex="-1"></a>  <span class="co"># get tree_clump_dist_m</span></span>
<span id="cb121-4"><a href="tree_spatial.html#cb121-4" tabindex="-1"></a>  tree_clump_dist_m <span class="ot">=</span> <span class="fu">min</span>(dta<span class="sc">$</span>tree_clump_dist_m, <span class="at">na.rm =</span> T)</span>
<span id="cb121-5"><a href="tree_spatial.html#cb121-5" tabindex="-1"></a>  <span class="co"># suid</span></span>
<span id="cb121-6"><a href="tree_spatial.html#cb121-6" tabindex="-1"></a>  my_suid <span class="ot">=</span> dta<span class="sc">$</span>suid[<span class="dv">1</span>]</span>
<span id="cb121-7"><a href="tree_spatial.html#cb121-7" tabindex="-1"></a>  <span class="co"># rasterize the clump polygons and then calculate distance between clumps as raster</span></span>
<span id="cb121-8"><a href="tree_spatial.html#cb121-8" tabindex="-1"></a>  dist_rast <span class="ot">=</span> </span>
<span id="cb121-9"><a href="tree_spatial.html#cb121-9" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb121-10"><a href="tree_spatial.html#cb121-10" tabindex="-1"></a>        <span class="at">x =</span> dta <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb121-11"><a href="tree_spatial.html#cb121-11" tabindex="-1"></a>        , <span class="at">y =</span> dta <span class="sc">%&gt;%</span> </span>
<span id="cb121-12"><a href="tree_spatial.html#cb121-12" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb121-13"><a href="tree_spatial.html#cb121-13" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">rast</span>(<span class="at">res =</span> <span class="fl">0.2</span>)</span>
<span id="cb121-14"><a href="tree_spatial.html#cb121-14" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb121-15"><a href="tree_spatial.html#cb121-15" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">distance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb121-16"><a href="tree_spatial.html#cb121-16" tabindex="-1"></a>      <span class="co"># crop it to stand extent</span></span>
<span id="cb121-17"><a href="tree_spatial.html#cb121-17" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb121-18"><a href="tree_spatial.html#cb121-18" tabindex="-1"></a>        harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid) <span class="sc">%&gt;%</span> </span>
<span id="cb121-19"><a href="tree_spatial.html#cb121-19" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb121-20"><a href="tree_spatial.html#cb121-20" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb121-21"><a href="tree_spatial.html#cb121-21" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb121-22"><a href="tree_spatial.html#cb121-22" tabindex="-1"></a>        harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid<span class="sc">==</span>my_suid) <span class="sc">%&gt;%</span> </span>
<span id="cb121-23"><a href="tree_spatial.html#cb121-23" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb121-24"><a href="tree_spatial.html#cb121-24" tabindex="-1"></a>      )</span>
<span id="cb121-25"><a href="tree_spatial.html#cb121-25" tabindex="-1"></a>  <span class="do">######### part 2</span></span>
<span id="cb121-26"><a href="tree_spatial.html#cb121-26" tabindex="-1"></a>  <span class="co"># now create openings vector data</span></span>
<span id="cb121-27"><a href="tree_spatial.html#cb121-27" tabindex="-1"></a>  openings_vect <span class="ot">=</span> </span>
<span id="cb121-28"><a href="tree_spatial.html#cb121-28" tabindex="-1"></a>    dist_rast <span class="sc">%&gt;%</span> </span>
<span id="cb121-29"><a href="tree_spatial.html#cb121-29" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">classify</span>(<span class="at">rcl =</span> <span class="fu">c</span>(tree_clump_dist_m<span class="sc">/</span><span class="dv">2</span>,<span class="cn">Inf</span>), <span class="at">others =</span> <span class="cn">NA</span>, <span class="at">include.lowest =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb121-30"><a href="tree_spatial.html#cb121-30" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb121-31"><a href="tree_spatial.html#cb121-31" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb121-32"><a href="tree_spatial.html#cb121-32" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb121-33"><a href="tree_spatial.html#cb121-33" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">layer =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb121-34"><a href="tree_spatial.html#cb121-34" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb121-35"><a href="tree_spatial.html#cb121-35" tabindex="-1"></a>        <span class="at">openining_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(geometry) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb121-36"><a href="tree_spatial.html#cb121-36" tabindex="-1"></a>        , <span class="at">suid =</span> my_suid</span>
<span id="cb121-37"><a href="tree_spatial.html#cb121-37" tabindex="-1"></a>        , <span class="at">tree_clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb121-38"><a href="tree_spatial.html#cb121-38" tabindex="-1"></a>      )</span>
<span id="cb121-39"><a href="tree_spatial.html#cb121-39" tabindex="-1"></a>  </span>
<span id="cb121-40"><a href="tree_spatial.html#cb121-40" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb121-41"><a href="tree_spatial.html#cb121-41" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">dist_rast =</span> dist_rast, <span class="at">openings_vect =</span> openings_vect))</span>
<span id="cb121-42"><a href="tree_spatial.html#cb121-42" tabindex="-1"></a>}</span>
<span id="cb121-43"><a href="tree_spatial.html#cb121-43" tabindex="-1"></a><span class="co"># get it</span></span>
<span id="cb121-44"><a href="tree_spatial.html#cb121-44" tabindex="-1"></a>dist_rast_temp <span class="ot">=</span> <span class="fu">get_clump_dist_rast</span>(clump_polys_temp)</span>
<span id="cb121-45"><a href="tree_spatial.html#cb121-45" tabindex="-1"></a>dist_rast_temp</span></code></pre></div>
<pre><code>## $dist_rast
## class       : SpatRaster 
## dimensions  : 3259, 1565, 1  (nrow, ncol, nlyr)
## resolution  : 0.2, 0.2  (x, y)
## extent      : 610479.1, 610792.1, 4888438, 4889090  (xmin, xmax, ymin, ymax)
## coord. ref. : NAD83 / UTM zone 13N (EPSG:26913) 
## source(s)   : memory
## name        :    layer 
## min value   :  0.00000 
## max value   : 19.20521 
## 
## $openings_vect
## Simple feature collection with 286 features and 4 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 610479.1 ymin: 4888438 xmax: 610791.5 ymax: 4889090
## Projected CRS: NAD83 / UTM zone 13N
## First 10 features:
##     layer                       geometry openining_area_m2                suid
## 1       1 POLYGON ((610700.9 4889089,...              6.60 0203088082660001000
## 1.1     2 POLYGON ((610684.7 4889085,...              0.04 0203088082660001000
## 1.2     3 POLYGON ((610707.9 4889090,...             18.20 0203088082660001000
## 1.3     4 POLYGON ((610697.3 4889082,...              0.56 0203088082660001000
## 1.4     5 POLYGON ((610724.1 4889090,...            114.52 0203088082660001000
## 1.5     6 POLYGON ((610717.1 4889080,...             14.48 0203088082660001000
## 1.6     7 POLYGON ((610702.9 4889075,...              0.04 0203088082660001000
## 1.7     8 POLYGON ((610684.3 4889085,...            124.72 0203088082660001000
## 1.8     9 POLYGON ((610702.1 4889072,...              2.76 0203088082660001000
## 1.9    10 POLYGON ((610753.5 4889090,...            167.40 0203088082660001000
##     tree_clump_dist_m
## 1                   6
## 1.1                 6
## 1.2                 6
## 1.3                 6
## 1.4                 6
## 1.5                 6
## 1.6                 6
## 1.7                 6
## 1.8                 6
## 1.9                 6</code></pre>
<p>plot the distance raster and openings vector data we just got with overlaid tree clumps and tree points</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="tree_spatial.html#cb123-1" tabindex="-1"></a>plt_fnl_temp <span class="ot">=</span> </span>
<span id="cb123-2"><a href="tree_spatial.html#cb123-2" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb123-3"><a href="tree_spatial.html#cb123-3" tabindex="-1"></a>    <span class="co"># distance</span></span>
<span id="cb123-4"><a href="tree_spatial.html#cb123-4" tabindex="-1"></a>    <span class="fu">geom_tile</span>(</span>
<span id="cb123-5"><a href="tree_spatial.html#cb123-5" tabindex="-1"></a>      <span class="at">data =</span> dist_rast_temp<span class="sc">$</span>dist_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="dv">2</span>, <span class="at">cores =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb123-6"><a href="tree_spatial.html#cb123-6" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">fill =</span> f)</span>
<span id="cb123-7"><a href="tree_spatial.html#cb123-7" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb123-8"><a href="tree_spatial.html#cb123-8" tabindex="-1"></a>    <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb123-9"><a href="tree_spatial.html#cb123-9" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;YlOrRd&quot;</span></span>
<span id="cb123-10"><a href="tree_spatial.html#cb123-10" tabindex="-1"></a>      , <span class="at">na.value =</span> <span class="st">&quot;transparent&quot;</span></span>
<span id="cb123-11"><a href="tree_spatial.html#cb123-11" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb123-12"><a href="tree_spatial.html#cb123-12" tabindex="-1"></a>      , <span class="at">name =</span> <span class="st">&quot;distance to</span><span class="sc">\n</span><span class="st">nearest tree (m)&quot;</span></span>
<span id="cb123-13"><a href="tree_spatial.html#cb123-13" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb123-14"><a href="tree_spatial.html#cb123-14" tabindex="-1"></a>    <span class="co"># openings</span></span>
<span id="cb123-15"><a href="tree_spatial.html#cb123-15" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> dist_rast_temp<span class="sc">$</span>openings_vect, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> openining_area_m2), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb123-16"><a href="tree_spatial.html#cb123-16" tabindex="-1"></a>    <span class="fu">scale_color_gradient</span>(</span>
<span id="cb123-17"><a href="tree_spatial.html#cb123-17" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">&quot;gray77&quot;</span>, <span class="at">high =</span> <span class="st">&quot;gray11&quot;</span></span>
<span id="cb123-18"><a href="tree_spatial.html#cb123-18" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb123-19"><a href="tree_spatial.html#cb123-19" tabindex="-1"></a>      , <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;opening</span><span class="sc">\n</span><span class="st">area ($</span><span class="sc">\\</span><span class="st">m^2$)&quot;</span>)</span>
<span id="cb123-20"><a href="tree_spatial.html#cb123-20" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">11500</span>)</span>
<span id="cb123-21"><a href="tree_spatial.html#cb123-21" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb123-22"><a href="tree_spatial.html#cb123-22" tabindex="-1"></a>    <span class="co"># clumps</span></span>
<span id="cb123-23"><a href="tree_spatial.html#cb123-23" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb123-24"><a href="tree_spatial.html#cb123-24" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb123-25"><a href="tree_spatial.html#cb123-25" tabindex="-1"></a>      <span class="at">data =</span> clump_polys_temp</span>
<span id="cb123-26"><a href="tree_spatial.html#cb123-26" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_n_trees_grp)</span>
<span id="cb123-27"><a href="tree_spatial.html#cb123-27" tabindex="-1"></a>      , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb123-28"><a href="tree_spatial.html#cb123-28" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb123-29"><a href="tree_spatial.html#cb123-29" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_d</span>(<span class="at">option=</span><span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">&quot;clump size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb123-30"><a href="tree_spatial.html#cb123-30" tabindex="-1"></a>    <span class="co"># tree points</span></span>
<span id="cb123-31"><a href="tree_spatial.html#cb123-31" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> ttops_temp, <span class="at">color =</span> <span class="st">&quot;gray88&quot;</span>, <span class="at">shape =</span> <span class="st">&quot;.&quot;</span>) <span class="sc">+</span></span>
<span id="cb123-32"><a href="tree_spatial.html#cb123-32" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="tree_spatial.html#cb125-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb125-2"><a href="tree_spatial.html#cb125-2" tabindex="-1"></a>plt_fnl_temp</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-49-1.png" width="1008" /></p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="tree_spatial.html#cb126-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb126-2"><a href="tree_spatial.html#cb126-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_07.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>highlight the openings</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="tree_spatial.html#cb127-1" tabindex="-1"></a>plt_open_temp <span class="ot">=</span> </span>
<span id="cb127-2"><a href="tree_spatial.html#cb127-2" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb127-3"><a href="tree_spatial.html#cb127-3" tabindex="-1"></a>      <span class="co"># clumps</span></span>
<span id="cb127-4"><a href="tree_spatial.html#cb127-4" tabindex="-1"></a>      <span class="fu">geom_sf</span>(</span>
<span id="cb127-5"><a href="tree_spatial.html#cb127-5" tabindex="-1"></a>        <span class="at">data =</span> clump_polys_temp</span>
<span id="cb127-6"><a href="tree_spatial.html#cb127-6" tabindex="-1"></a>        , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_n_trees_grp)</span>
<span id="cb127-7"><a href="tree_spatial.html#cb127-7" tabindex="-1"></a>        , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb127-8"><a href="tree_spatial.html#cb127-8" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb127-9"><a href="tree_spatial.html#cb127-9" tabindex="-1"></a>      <span class="fu">scale_fill_viridis_d</span>(<span class="at">option=</span><span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">&quot;clump size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb127-10"><a href="tree_spatial.html#cb127-10" tabindex="-1"></a>      <span class="co"># openings</span></span>
<span id="cb127-11"><a href="tree_spatial.html#cb127-11" tabindex="-1"></a>      ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb127-12"><a href="tree_spatial.html#cb127-12" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> dist_rast_temp<span class="sc">$</span>openings_vect, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> openining_area_m2), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb127-13"><a href="tree_spatial.html#cb127-13" tabindex="-1"></a>      <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb127-14"><a href="tree_spatial.html#cb127-14" tabindex="-1"></a>        <span class="at">low =</span> <span class="st">&quot;gray77&quot;</span>, <span class="at">high =</span> <span class="st">&quot;gray11&quot;</span></span>
<span id="cb127-15"><a href="tree_spatial.html#cb127-15" tabindex="-1"></a>        , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb127-16"><a href="tree_spatial.html#cb127-16" tabindex="-1"></a>        , <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;opening</span><span class="sc">\n</span><span class="st">area ($</span><span class="sc">\\</span><span class="st">m^2$)&quot;</span>)</span>
<span id="cb127-17"><a href="tree_spatial.html#cb127-17" tabindex="-1"></a>        , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">11500</span>)</span>
<span id="cb127-18"><a href="tree_spatial.html#cb127-18" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb127-19"><a href="tree_spatial.html#cb127-19" tabindex="-1"></a>      <span class="co"># tree points</span></span>
<span id="cb127-20"><a href="tree_spatial.html#cb127-20" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> ttops_temp, <span class="at">color =</span> <span class="st">&quot;gray88&quot;</span>, <span class="at">shape =</span> <span class="st">&quot;.&quot;</span>) <span class="sc">+</span></span>
<span id="cb127-21"><a href="tree_spatial.html#cb127-21" tabindex="-1"></a>      <span class="fu">theme_void</span>()</span>
<span id="cb127-22"><a href="tree_spatial.html#cb127-22" tabindex="-1"></a>plt_open_temp</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-50-1.png" width="1008" /></p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="tree_spatial.html#cb128-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb128-2"><a href="tree_spatial.html#cb128-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_08.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>combine them?</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="tree_spatial.html#cb129-1" tabindex="-1"></a>plt_fnl_temp <span class="sc">+</span> (plt_open_temp <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>))</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-51-1.png" width="1008" /></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="tree_spatial.html#cb130-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb130-2"><a href="tree_spatial.html#cb130-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_09.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
</div>
<div id="clump_metrics" class="section level3 hasAnchor" number="9.1.7">
<h3><span class="header-section-number">9.1.7</span> Clump Metrics<a href="tree_spatial.html#clump_metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>create a function to summarize by number of tree clump grouping variable</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="tree_spatial.html#cb131-1" tabindex="-1"></a><span class="co"># create a function to summarize by number of tree clump grouping</span></span>
<span id="cb131-2"><a href="tree_spatial.html#cb131-2" tabindex="-1"></a>get_clump_n_trees_grp_summary <span class="ot">=</span> <span class="cf">function</span>(trees, clumps){</span>
<span id="cb131-3"><a href="tree_spatial.html#cb131-3" tabindex="-1"></a>  <span class="co"># get area of harvest unit</span></span>
<span id="cb131-4"><a href="tree_spatial.html#cb131-4" tabindex="-1"></a>  <span class="co">#...will use this area in the area calculations such that...</span></span>
<span id="cb131-5"><a href="tree_spatial.html#cb131-5" tabindex="-1"></a>  <span class="co">#...TPA = trees in a certain group size across the whole stand area</span></span>
<span id="cb131-6"><a href="tree_spatial.html#cb131-6" tabindex="-1"></a>  harvest_area_m2 <span class="ot">=</span> harvests <span class="sc">%&gt;%</span> </span>
<span id="cb131-7"><a href="tree_spatial.html#cb131-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(suid <span class="sc">==</span> trees<span class="sc">$</span>suid[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb131-8"><a href="tree_spatial.html#cb131-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(harvest_area_m2) <span class="sc">%&gt;%</span> </span>
<span id="cb131-9"><a href="tree_spatial.html#cb131-9" tabindex="-1"></a>    .[<span class="dv">1</span>]</span>
<span id="cb131-10"><a href="tree_spatial.html#cb131-10" tabindex="-1"></a>  <span class="co"># collapse and calculate silv metrics</span></span>
<span id="cb131-11"><a href="tree_spatial.html#cb131-11" tabindex="-1"></a>  dta <span class="ot">=</span> trees <span class="sc">%&gt;%</span> </span>
<span id="cb131-12"><a href="tree_spatial.html#cb131-12" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-13"><a href="tree_spatial.html#cb131-13" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(suid,stand_area_ha,clump_n_trees_grp) <span class="sc">%&gt;%</span></span>
<span id="cb131-14"><a href="tree_spatial.html#cb131-14" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb131-15"><a href="tree_spatial.html#cb131-15" tabindex="-1"></a>      <span class="co"># summary metrics</span></span>
<span id="cb131-16"><a href="tree_spatial.html#cb131-16" tabindex="-1"></a>      <span class="at">n_trees =</span> dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(treeID)</span>
<span id="cb131-17"><a href="tree_spatial.html#cb131-17" tabindex="-1"></a>      , <span class="at">mean_dbh_cm =</span> <span class="fu">mean</span>(dbh_cm, <span class="at">na.rm =</span> T)</span>
<span id="cb131-18"><a href="tree_spatial.html#cb131-18" tabindex="-1"></a>      , <span class="at">mean_tree_height_m =</span> <span class="fu">mean</span>(tree_height_m, <span class="at">na.rm =</span> T)</span>
<span id="cb131-19"><a href="tree_spatial.html#cb131-19" tabindex="-1"></a>      , <span class="at">loreys_height_m =</span> <span class="fu">sum</span>(basal_area_m2<span class="sc">*</span>tree_height_m, <span class="at">na.rm =</span> T) <span class="sc">/</span> <span class="fu">sum</span>(basal_area_m2, <span class="at">na.rm =</span> T)</span>
<span id="cb131-20"><a href="tree_spatial.html#cb131-20" tabindex="-1"></a>      , <span class="at">basal_area_m2 =</span> <span class="fu">sum</span>(basal_area_m2, <span class="at">na.rm =</span> T)</span>
<span id="cb131-21"><a href="tree_spatial.html#cb131-21" tabindex="-1"></a>      , <span class="at">sum_dbh_cm_sq =</span> <span class="fu">sum</span>(dbh_cm<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb131-22"><a href="tree_spatial.html#cb131-22" tabindex="-1"></a>      , <span class="at">.groups =</span> <span class="st">&quot;drop_last&quot;</span></span>
<span id="cb131-23"><a href="tree_spatial.html#cb131-23" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb131-24"><a href="tree_spatial.html#cb131-24" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-25"><a href="tree_spatial.html#cb131-25" tabindex="-1"></a>    <span class="co"># attach clump area</span></span>
<span id="cb131-26"><a href="tree_spatial.html#cb131-26" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb131-27"><a href="tree_spatial.html#cb131-27" tabindex="-1"></a>      clumps <span class="sc">%&gt;%</span> </span>
<span id="cb131-28"><a href="tree_spatial.html#cb131-28" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-29"><a href="tree_spatial.html#cb131-29" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(suid,clump_n_trees_grp) <span class="sc">%&gt;%</span></span>
<span id="cb131-30"><a href="tree_spatial.html#cb131-30" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb131-31"><a href="tree_spatial.html#cb131-31" tabindex="-1"></a>          <span class="at">clump_area_ha =</span> <span class="fu">sum</span>(clump_area_ha)</span>
<span id="cb131-32"><a href="tree_spatial.html#cb131-32" tabindex="-1"></a>          , <span class="at">stand_n_clumps =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb131-33"><a href="tree_spatial.html#cb131-33" tabindex="-1"></a>          , <span class="at">.groups =</span> <span class="st">&quot;drop_last&quot;</span></span>
<span id="cb131-34"><a href="tree_spatial.html#cb131-34" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb131-35"><a href="tree_spatial.html#cb131-35" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb131-36"><a href="tree_spatial.html#cb131-36" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(suid, clump_n_trees_grp)</span>
<span id="cb131-37"><a href="tree_spatial.html#cb131-37" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb131-38"><a href="tree_spatial.html#cb131-38" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb131-39"><a href="tree_spatial.html#cb131-39" tabindex="-1"></a>      <span class="at">trees_per_ha =</span> (n_trees<span class="sc">/</span>stand_area_ha) <span class="co"># (n_trees/clump_area_ha) ... this was not right</span></span>
<span id="cb131-40"><a href="tree_spatial.html#cb131-40" tabindex="-1"></a>      , <span class="at">basal_area_m2_per_ha =</span> (basal_area_m2<span class="sc">/</span>stand_area_ha) <span class="co"># (basal_area_m2/clump_area_ha) ... this was not right</span></span>
<span id="cb131-41"><a href="tree_spatial.html#cb131-41" tabindex="-1"></a>      , <span class="at">qmd_cm =</span> <span class="fu">sqrt</span>(sum_dbh_cm_sq<span class="sc">/</span>n_trees)</span>
<span id="cb131-42"><a href="tree_spatial.html#cb131-42" tabindex="-1"></a>      <span class="co"># stand calcs</span></span>
<span id="cb131-43"><a href="tree_spatial.html#cb131-43" tabindex="-1"></a>      , <span class="at">stand_trees_per_ha =</span> <span class="fu">sum</span>(n_trees)<span class="sc">/</span>stand_area_ha</span>
<span id="cb131-44"><a href="tree_spatial.html#cb131-44" tabindex="-1"></a>      , <span class="at">stand_basal_area_m2 =</span> <span class="fu">sum</span>(basal_area_m2)</span>
<span id="cb131-45"><a href="tree_spatial.html#cb131-45" tabindex="-1"></a>      , <span class="at">stand_basal_area_m2_per_ha =</span> <span class="fu">sum</span>(basal_area_m2)<span class="sc">/</span>stand_area_ha</span>
<span id="cb131-46"><a href="tree_spatial.html#cb131-46" tabindex="-1"></a>      , <span class="at">pct_stand_basal_area =</span> basal_area_m2<span class="sc">/</span>stand_basal_area_m2</span>
<span id="cb131-47"><a href="tree_spatial.html#cb131-47" tabindex="-1"></a>      , <span class="at">pct_stand_n_trees =</span> n_trees<span class="sc">/</span><span class="fu">sum</span>(n_trees)</span>
<span id="cb131-48"><a href="tree_spatial.html#cb131-48" tabindex="-1"></a>      , <span class="at">stand_qmd_cm =</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(trees<span class="sc">$</span>dbh_cm<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)<span class="sc">/</span><span class="fu">sum</span>(n_trees))</span>
<span id="cb131-49"><a href="tree_spatial.html#cb131-49" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb131-50"><a href="tree_spatial.html#cb131-50" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(sum_dbh_cm_sq)) <span class="sc">%&gt;%</span></span>
<span id="cb131-51"><a href="tree_spatial.html#cb131-51" tabindex="-1"></a>    <span class="co"># convert to imperial units</span></span>
<span id="cb131-52"><a href="tree_spatial.html#cb131-52" tabindex="-1"></a>    <span class="fu">calc_imperial_units_fn</span>()</span>
<span id="cb131-53"><a href="tree_spatial.html#cb131-53" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb131-54"><a href="tree_spatial.html#cb131-54" tabindex="-1"></a>  <span class="fu">return</span>(dta)</span>
<span id="cb131-55"><a href="tree_spatial.html#cb131-55" tabindex="-1"></a>}</span>
<span id="cb131-56"><a href="tree_spatial.html#cb131-56" tabindex="-1"></a><span class="co"># call it</span></span>
<span id="cb131-57"><a href="tree_spatial.html#cb131-57" tabindex="-1"></a>clump_n_trees_grp_summary_temp <span class="ot">=</span> <span class="fu">get_clump_n_trees_grp_summary</span>(</span>
<span id="cb131-58"><a href="tree_spatial.html#cb131-58" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">get_tree_clumps</span>(<span class="at">my_suid =</span> my_suid, <span class="at">tree_clump_dist_m =</span> tree_clump_dist_m, <span class="at">ostory_dbh_cm =</span> ostory_dbh_cm)</span>
<span id="cb131-59"><a href="tree_spatial.html#cb131-59" tabindex="-1"></a>  , <span class="at">clumps =</span> <span class="fu">get_clump_summary</span>(</span>
<span id="cb131-60"><a href="tree_spatial.html#cb131-60" tabindex="-1"></a>    <span class="fu">get_tree_clumps</span>(<span class="at">my_suid =</span> my_suid, <span class="at">tree_clump_dist_m =</span> tree_clump_dist_m, <span class="at">ostory_dbh_cm =</span> ostory_dbh_cm)</span>
<span id="cb131-61"><a href="tree_spatial.html#cb131-61" tabindex="-1"></a>  )</span>
<span id="cb131-62"><a href="tree_spatial.html#cb131-62" tabindex="-1"></a>) </span>
<span id="cb131-63"><a href="tree_spatial.html#cb131-63" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb131-64"><a href="tree_spatial.html#cb131-64" tabindex="-1"></a>clump_n_trees_grp_summary_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 5
## Columns: 32
## $ suid                        &lt;chr&gt; &quot;0203088082660001000&quot;, &quot;020308808266000100…
## $ stand_area_ha               &lt;dbl&gt; 12.21615, 12.21615, 12.21615, 12.21615, 12…
## $ clump_n_trees_grp           &lt;ord&gt; Individual, 2-4 trees, 5-9 trees, 10-15 tr…
## $ n_trees                     &lt;int&gt; 197, 373, 453, 458, 646
## $ mean_dbh_cm                 &lt;dbl&gt; 24.56338, 26.51786, 25.03787, 24.59027, 22…
## $ mean_tree_height_m          &lt;dbl&gt; 12.02114, 12.83492, 12.22318, 12.06302, 11…
## $ loreys_height_m             &lt;dbl&gt; 14.88814, 15.16194, 13.81589, 13.59242, 12…
## $ basal_area_m2               &lt;dbl&gt; 10.69347, 22.98122, 24.12885, 23.37731, 27…
## $ clump_area_ha               &lt;dbl&gt; 0.5567499, 0.9128247, 1.0464888, 1.0144267…
## $ stand_n_clumps              &lt;int&gt; 197, 138, 67, 38, 24
## $ trees_per_ha                &lt;dbl&gt; 16.12620, 30.53336, 37.08207, 37.49137, 52…
## $ basal_area_m2_per_ha        &lt;dbl&gt; 0.8753553, 1.8812174, 1.9751603, 1.9136403…
## $ qmd_cm                      &lt;dbl&gt; 26.28943, 28.00833, 26.04199, 25.49292, 23…
## $ stand_trees_per_ha          &lt;dbl&gt; 174.1138, 174.1138, 174.1138, 174.1138, 17…
## $ stand_basal_area_m2         &lt;dbl&gt; 109.0022, 109.0022, 109.0022, 109.0022, 10…
## $ stand_basal_area_m2_per_ha  &lt;dbl&gt; 8.922796, 8.922796, 8.922796, 8.922796, 8.…
## $ pct_stand_basal_area        &lt;dbl&gt; 0.09810324, 0.21083272, 0.22136113, 0.2144…
## $ pct_stand_n_trees           &lt;dbl&gt; 0.09261871, 0.17536436, 0.21297602, 0.2153…
## $ stand_qmd_cm                &lt;dbl&gt; 25.544, 25.544, 25.544, 25.544, 25.544
## $ mean_dbh_in                 &lt;dbl&gt; 9.677971, 10.448039, 9.864919, 9.688568, 8…
## $ qmd_in                      &lt;dbl&gt; 10.358036, 11.035282, 10.260545, 10.044210…
## $ stand_qmd_in                &lt;dbl&gt; 10.06434, 10.06434, 10.06434, 10.06434, 10…
## $ mean_tree_height_ft         &lt;dbl&gt; 39.42935, 42.09854, 40.09203, 39.56671, 36…
## $ loreys_height_ft            &lt;dbl&gt; 48.83309, 49.73116, 45.31611, 44.58313, 41…
## $ basal_area_ft2_per_ac       &lt;dbl&gt; 3.815674, 8.200226, 8.609724, 8.341558, 9.…
## $ stand_basal_area_ft2_per_ac &lt;dbl&gt; 38.89447, 38.89447, 38.89447, 38.89447, 38…
## $ trees_per_ac                &lt;dbl&gt; 6.531111, 12.366012, 15.018240, 15.184004,…
## $ stand_trees_per_ac          &lt;dbl&gt; 70.51611, 70.51611, 70.51611, 70.51611, 70…
## $ stand_area_ac               &lt;dbl&gt; 30.1861, 30.1861, 30.1861, 30.1861, 30.1861
## $ clump_area_ac               &lt;dbl&gt; 1.375729, 2.255590, 2.585874, 2.506648, 3.…
## $ basal_area_ft2              &lt;dbl&gt; 115.1045, 247.3699, 259.7229, 251.6333, 29…
## $ stand_basal_area_ft2        &lt;dbl&gt; 1173.299, 1173.299, 1173.299, 1173.299, 11…</code></pre>
<p>summary table</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="tree_spatial.html#cb133-1" tabindex="-1"></a><span class="co"># table it</span></span>
<span id="cb133-2"><a href="tree_spatial.html#cb133-2" tabindex="-1"></a>clump_n_trees_grp_summary_temp <span class="sc">%&gt;%</span> </span>
<span id="cb133-3"><a href="tree_spatial.html#cb133-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb133-4"><a href="tree_spatial.html#cb133-4" tabindex="-1"></a>    clump_n_trees_grp, n_trees</span>
<span id="cb133-5"><a href="tree_spatial.html#cb133-5" tabindex="-1"></a>    , mean_dbh_in</span>
<span id="cb133-6"><a href="tree_spatial.html#cb133-6" tabindex="-1"></a>    , qmd_in</span>
<span id="cb133-7"><a href="tree_spatial.html#cb133-7" tabindex="-1"></a>    , mean_tree_height_ft</span>
<span id="cb133-8"><a href="tree_spatial.html#cb133-8" tabindex="-1"></a>    , loreys_height_ft</span>
<span id="cb133-9"><a href="tree_spatial.html#cb133-9" tabindex="-1"></a>    , trees_per_ac</span>
<span id="cb133-10"><a href="tree_spatial.html#cb133-10" tabindex="-1"></a>    , basal_area_ft2_per_ac, pct_stand_basal_area, pct_stand_n_trees</span>
<span id="cb133-11"><a href="tree_spatial.html#cb133-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb133-12"><a href="tree_spatial.html#cb133-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb133-13"><a href="tree_spatial.html#cb133-13" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb133-14"><a href="tree_spatial.html#cb133-14" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(pct_stand_basal_area, pct_stand_n_trees) </span>
<span id="cb133-15"><a href="tree_spatial.html#cb133-15" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb133-16"><a href="tree_spatial.html#cb133-16" tabindex="-1"></a>    )</span>
<span id="cb133-17"><a href="tree_spatial.html#cb133-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb133-18"><a href="tree_spatial.html#cb133-18" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb133-19"><a href="tree_spatial.html#cb133-19" tabindex="-1"></a>    <span class="at">digits =</span> <span class="dv">1</span></span>
<span id="cb133-20"><a href="tree_spatial.html#cb133-20" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb133-21"><a href="tree_spatial.html#cb133-21" tabindex="-1"></a>    , <span class="at">caption =</span> <span class="fu">paste0</span>(<span class="st">&quot;Overstory tree clump summary&lt;br&gt;&quot;</span>, <span class="st">&quot;stand suid: &quot;</span>, clump_n_trees_grp_summary_temp<span class="sc">$</span>suid[<span class="dv">1</span>])</span>
<span id="cb133-22"><a href="tree_spatial.html#cb133-22" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb133-23"><a href="tree_spatial.html#cb133-23" tabindex="-1"></a>      <span class="st">&quot;&quot;</span>, <span class="st">&quot;trees&quot;</span></span>
<span id="cb133-24"><a href="tree_spatial.html#cb133-24" tabindex="-1"></a>      , <span class="st">&quot;mean&lt;br&gt;DBH (in)&quot;</span></span>
<span id="cb133-25"><a href="tree_spatial.html#cb133-25" tabindex="-1"></a>      , <span class="st">&quot;QMD (in)&quot;</span></span>
<span id="cb133-26"><a href="tree_spatial.html#cb133-26" tabindex="-1"></a>      , <span class="st">&quot;mean&lt;br&gt;Ht. (ft)&quot;</span></span>
<span id="cb133-27"><a href="tree_spatial.html#cb133-27" tabindex="-1"></a>      , <span class="st">&quot;Loreys&lt;br&gt;Ht. (ft)&quot;</span></span>
<span id="cb133-28"><a href="tree_spatial.html#cb133-28" tabindex="-1"></a>      , <span class="st">&quot;TPA&quot;</span></span>
<span id="cb133-29"><a href="tree_spatial.html#cb133-29" tabindex="-1"></a>      , <span class="st">&quot;BA&lt;br&gt;ft&lt;sup&gt;2&lt;/sup&gt; ac&lt;sup&gt;-1&lt;/sup&gt;&quot;</span></span>
<span id="cb133-30"><a href="tree_spatial.html#cb133-30" tabindex="-1"></a>      , <span class="st">&quot;%&lt;br&gt;stand BA&quot;</span></span>
<span id="cb133-31"><a href="tree_spatial.html#cb133-31" tabindex="-1"></a>      , <span class="st">&quot;%&lt;br&gt;stand trees&quot;</span></span>
<span id="cb133-32"><a href="tree_spatial.html#cb133-32" tabindex="-1"></a>      )</span>
<span id="cb133-33"><a href="tree_spatial.html#cb133-33" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb133-34"><a href="tree_spatial.html#cb133-34" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-53">Table 9.1: </span>Overstory tree clump summary<br>stand suid: 0203088082660001000
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
trees
</th>
<th style="text-align:right;">
mean<br>DBH (in)
</th>
<th style="text-align:right;">
QMD (in)
</th>
<th style="text-align:right;">
mean<br>Ht. (ft)
</th>
<th style="text-align:right;">
Loreys<br>Ht. (ft)
</th>
<th style="text-align:right;">
TPA
</th>
<th style="text-align:right;">
BA<br>ft<sup>2</sup> ac<sup>-1</sup>
</th>
<th style="text-align:left;">
%<br>stand BA
</th>
<th style="text-align:left;">
%<br>stand trees
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Individual
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
9.7
</td>
<td style="text-align:right;">
10.4
</td>
<td style="text-align:right;">
39.4
</td>
<td style="text-align:right;">
48.8
</td>
<td style="text-align:right;">
6.5
</td>
<td style="text-align:right;">
3.8
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
9%
</td>
</tr>
<tr>
<td style="text-align:left;">
2-4 trees
</td>
<td style="text-align:right;">
373
</td>
<td style="text-align:right;">
10.4
</td>
<td style="text-align:right;">
11.0
</td>
<td style="text-align:right;">
42.1
</td>
<td style="text-align:right;">
49.7
</td>
<td style="text-align:right;">
12.4
</td>
<td style="text-align:right;">
8.2
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
18%
</td>
</tr>
<tr>
<td style="text-align:left;">
5-9 trees
</td>
<td style="text-align:right;">
453
</td>
<td style="text-align:right;">
9.9
</td>
<td style="text-align:right;">
10.3
</td>
<td style="text-align:right;">
40.1
</td>
<td style="text-align:right;">
45.3
</td>
<td style="text-align:right;">
15.0
</td>
<td style="text-align:right;">
8.6
</td>
<td style="text-align:left;">
22%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:left;">
10-15 trees
</td>
<td style="text-align:right;">
458
</td>
<td style="text-align:right;">
9.7
</td>
<td style="text-align:right;">
10.0
</td>
<td style="text-align:right;">
39.6
</td>
<td style="text-align:right;">
44.6
</td>
<td style="text-align:right;">
15.2
</td>
<td style="text-align:right;">
8.3
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
22%
</td>
</tr>
<tr>
<td style="text-align:left;">
&gt;15 trees
</td>
<td style="text-align:right;">
646
</td>
<td style="text-align:right;">
8.9
</td>
<td style="text-align:right;">
9.2
</td>
<td style="text-align:right;">
36.8
</td>
<td style="text-align:right;">
41.1
</td>
<td style="text-align:right;">
21.4
</td>
<td style="text-align:right;">
9.9
</td>
<td style="text-align:left;">
26%
</td>
<td style="text-align:left;">
30%
</td>
</tr>
</tbody>
</table>
<p>plot it</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="tree_spatial.html#cb134-1" tabindex="-1"></a>clump_n_trees_grp_summary_temp <span class="sc">%&gt;%</span> </span>
<span id="cb134-2"><a href="tree_spatial.html#cb134-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb134-3"><a href="tree_spatial.html#cb134-3" tabindex="-1"></a>    clump_n_trees_grp, n_trees</span>
<span id="cb134-4"><a href="tree_spatial.html#cb134-4" tabindex="-1"></a>    , mean_dbh_in</span>
<span id="cb134-5"><a href="tree_spatial.html#cb134-5" tabindex="-1"></a>    , qmd_in</span>
<span id="cb134-6"><a href="tree_spatial.html#cb134-6" tabindex="-1"></a>    , mean_tree_height_ft</span>
<span id="cb134-7"><a href="tree_spatial.html#cb134-7" tabindex="-1"></a>    , loreys_height_ft</span>
<span id="cb134-8"><a href="tree_spatial.html#cb134-8" tabindex="-1"></a>    , trees_per_ac</span>
<span id="cb134-9"><a href="tree_spatial.html#cb134-9" tabindex="-1"></a>    , basal_area_ft2_per_ac, pct_stand_basal_area</span>
<span id="cb134-10"><a href="tree_spatial.html#cb134-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb134-11"><a href="tree_spatial.html#cb134-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct_stand_basal_area =</span> pct_stand_basal_area<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb134-12"><a href="tree_spatial.html#cb134-12" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb134-13"><a href="tree_spatial.html#cb134-13" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(clump_n_trees_grp)</span>
<span id="cb134-14"><a href="tree_spatial.html#cb134-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb134-15"><a href="tree_spatial.html#cb134-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb134-16"><a href="tree_spatial.html#cb134-16" tabindex="-1"></a>    <span class="at">metric =</span> <span class="fu">factor</span>(</span>
<span id="cb134-17"><a href="tree_spatial.html#cb134-17" tabindex="-1"></a>        name</span>
<span id="cb134-18"><a href="tree_spatial.html#cb134-18" tabindex="-1"></a>        , <span class="at">ordered =</span> T</span>
<span id="cb134-19"><a href="tree_spatial.html#cb134-19" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb134-20"><a href="tree_spatial.html#cb134-20" tabindex="-1"></a>            <span class="st">&quot;n_trees&quot;</span></span>
<span id="cb134-21"><a href="tree_spatial.html#cb134-21" tabindex="-1"></a>            , <span class="st">&quot;mean_dbh_in&quot;</span></span>
<span id="cb134-22"><a href="tree_spatial.html#cb134-22" tabindex="-1"></a>            , <span class="st">&quot;qmd_in&quot;</span></span>
<span id="cb134-23"><a href="tree_spatial.html#cb134-23" tabindex="-1"></a>            , <span class="st">&quot;mean_tree_height_ft&quot;</span></span>
<span id="cb134-24"><a href="tree_spatial.html#cb134-24" tabindex="-1"></a>            , <span class="st">&quot;loreys_height_ft&quot;</span></span>
<span id="cb134-25"><a href="tree_spatial.html#cb134-25" tabindex="-1"></a>            , <span class="st">&quot;trees_per_ac&quot;</span></span>
<span id="cb134-26"><a href="tree_spatial.html#cb134-26" tabindex="-1"></a>            , <span class="st">&quot;basal_area_ft2_per_ac&quot;</span></span>
<span id="cb134-27"><a href="tree_spatial.html#cb134-27" tabindex="-1"></a>            , <span class="st">&quot;pct_stand_basal_area&quot;</span></span>
<span id="cb134-28"><a href="tree_spatial.html#cb134-28" tabindex="-1"></a>          )</span>
<span id="cb134-29"><a href="tree_spatial.html#cb134-29" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb134-30"><a href="tree_spatial.html#cb134-30" tabindex="-1"></a>            latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;Number of Trees&quot;</span>, <span class="at">output =</span> <span class="st">&quot;character&quot;</span>)</span>
<span id="cb134-31"><a href="tree_spatial.html#cb134-31" tabindex="-1"></a>            , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;Mean DBH (in)&quot;</span>, <span class="at">output =</span> <span class="st">&quot;character&quot;</span>)</span>
<span id="cb134-32"><a href="tree_spatial.html#cb134-32" tabindex="-1"></a>            , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;QMD (in)&quot;</span>, <span class="at">output =</span> <span class="st">&quot;character&quot;</span>)</span>
<span id="cb134-33"><a href="tree_spatial.html#cb134-33" tabindex="-1"></a>            , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;Mean Tree Height (ft)&quot;</span>, <span class="at">output =</span> <span class="st">&quot;character&quot;</span>)</span>
<span id="cb134-34"><a href="tree_spatial.html#cb134-34" tabindex="-1"></a>            , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;Lorey&#39;s Mean Height (ft)&quot;</span>, <span class="at">output =</span> <span class="st">&quot;character&quot;</span>)</span>
<span id="cb134-35"><a href="tree_spatial.html#cb134-35" tabindex="-1"></a>            , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;Trees $ac^{-1}$&quot;</span>)</span>
<span id="cb134-36"><a href="tree_spatial.html#cb134-36" tabindex="-1"></a>            , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;Basal Area $ft^{2} </span><span class="sc">\\</span><span class="st">cdot ac^{-1}$&quot;</span>)</span>
<span id="cb134-37"><a href="tree_spatial.html#cb134-37" tabindex="-1"></a>            , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;% stand BA&quot;</span>, <span class="at">output =</span> <span class="st">&quot;character&quot;</span>)</span>
<span id="cb134-38"><a href="tree_spatial.html#cb134-38" tabindex="-1"></a>          )</span>
<span id="cb134-39"><a href="tree_spatial.html#cb134-39" tabindex="-1"></a>      )</span>
<span id="cb134-40"><a href="tree_spatial.html#cb134-40" tabindex="-1"></a>    , <span class="at">clump_n_trees_grp =</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>(clump_n_trees_grp)</span>
<span id="cb134-41"><a href="tree_spatial.html#cb134-41" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb134-42"><a href="tree_spatial.html#cb134-42" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb134-43"><a href="tree_spatial.html#cb134-43" tabindex="-1"></a>      <span class="at">x =</span> value, <span class="at">y =</span> clump_n_trees_grp</span>
<span id="cb134-44"><a href="tree_spatial.html#cb134-44" tabindex="-1"></a>      , <span class="at">fill =</span> name, <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">number</span>(value, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb134-45"><a href="tree_spatial.html#cb134-45" tabindex="-1"></a>    )</span>
<span id="cb134-46"><a href="tree_spatial.html#cb134-46" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb134-47"><a href="tree_spatial.html#cb134-47" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb134-48"><a href="tree_spatial.html#cb134-48" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb134-49"><a href="tree_spatial.html#cb134-49" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(metric), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="at">labeller =</span> label_parsed) <span class="sc">+</span></span>
<span id="cb134-50"><a href="tree_spatial.html#cb134-50" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;cividis&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb134-51"><a href="tree_spatial.html#cb134-51" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.1</span>))) <span class="sc">+</span></span>
<span id="cb134-52"><a href="tree_spatial.html#cb134-52" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb134-53"><a href="tree_spatial.html#cb134-53" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb134-54"><a href="tree_spatial.html#cb134-54" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb134-55"><a href="tree_spatial.html#cb134-55" tabindex="-1"></a>      <span class="st">&quot;Overstory tree clump summary</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb134-56"><a href="tree_spatial.html#cb134-56" tabindex="-1"></a>      , <span class="st">&quot;stand suid: &quot;</span></span>
<span id="cb134-57"><a href="tree_spatial.html#cb134-57" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>suid[<span class="dv">1</span>])</span>
<span id="cb134-58"><a href="tree_spatial.html#cb134-58" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb134-59"><a href="tree_spatial.html#cb134-59" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb134-60"><a href="tree_spatial.html#cb134-60" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb134-61"><a href="tree_spatial.html#cb134-61" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb134-62"><a href="tree_spatial.html#cb134-62" tabindex="-1"></a>    , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb134-63"><a href="tree_spatial.html#cb134-63" tabindex="-1"></a>    , <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;gray88&quot;</span>)</span>
<span id="cb134-64"><a href="tree_spatial.html#cb134-64" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb134-65"><a href="tree_spatial.html#cb134-65" tabindex="-1"></a>    , <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb134-66"><a href="tree_spatial.html#cb134-66" tabindex="-1"></a>    , <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb134-67"><a href="tree_spatial.html#cb134-67" tabindex="-1"></a>    , <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb134-68"><a href="tree_spatial.html#cb134-68" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-54-1.png" width="1008" /></p>
</div>
</div>
<div id="ico-implementation" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> ICO Implementation<a href="tree_spatial.html#ico-implementation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><a href="https://scholarworks.umt.edu/ico/3">Churchill et al. (2016)</a> describe the full process for implementing the ICO approach in <em><a href="https://scholarworks.umt.edu/ico/3">The ICO Approach to Quantifying and Restoring Forest Spatial Pattern: Implementation Guide</a></em> in which the authors lay out the prescription development process:</p>
<ol style="list-style-type: decimal">
<li>Identify skips and other special treatment areas</li>
<li>Consider the need for openings</li>
<li>Determine the stand average density target</li>
<li>Determine the appropriate distance to define clumps</li>
<li>Obtain targets for clump proportions</li>
<li>Select target clump proportions for your stand</li>
<li>Generate clump targets for the whole unit</li>
<li>Combine clump and opening targets with leave tree criteria into marking guidelines</li>
</ol>
<p>The objective here is to: 1) provide the manager with the current conditions (completed above); 2) take the “targets” as set by the manager (steps 3, 5, 6, 7); 3) create the prescription with the leave tree marking.</p>
<p>Let’s implement this prescription development process with our UAS tree list</p>
<div id="determine-the-stand-average-density-target" class="section level3 hasAnchor" number="9.2.1">
<h3><span class="header-section-number">9.2.1</span> 3. Determine the stand average density target<a href="tree_spatial.html#determine-the-stand-average-density-target" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Step 3 in <a href="https://scholarworks.umt.edu/ico/3">Churchill et al. (2016)</a>:</p>
<blockquote>
<p>An average BA, TPA, or SDI target for the stand should be selected that is appropriate for the species, structure, site conditions, and management objectives. Expected mortality from prescribed fire should be factored in. Stand average targets can come from historical reference stands, plant association based stocking guides, density management tools, or a combination of both (see Franklin et al. (2013) for a full discussion of setting density targets). In dry forests, the number and size of old trees must be accounted in setting the density target. To use the ICO method, the target must be converted to TPA (see Table 1). A lower diameter cutoff also needs to be specified for the TPA target. This should be the lower limit in the contract or cutting guidelines given to the marking crew or contractor. (p.11)</p>
</blockquote>
<p>this is what Table 1 looks like with TPA values are derived from the formula:</p>
<p><span class="math display">\[
TPA = \frac{BA}{QMD^{2} \times 0.005454}
\]</span></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="tree_spatial.html#cb135-1" tabindex="-1"></a><span class="co"># function to get tpa from ba and qmd</span></span>
<span id="cb135-2"><a href="tree_spatial.html#cb135-2" tabindex="-1"></a>get_tpa <span class="ot">=</span> <span class="cf">function</span>(ba_ft2_ac, qmd_in){</span>
<span id="cb135-3"><a href="tree_spatial.html#cb135-3" tabindex="-1"></a>  tpa <span class="ot">=</span> <span class="fu">round</span>(ba_ft2_ac<span class="sc">/</span>((qmd_in<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span><span class="fl">0.005454</span>))</span>
<span id="cb135-4"><a href="tree_spatial.html#cb135-4" tabindex="-1"></a>  <span class="fu">return</span>(tpa)</span>
<span id="cb135-5"><a href="tree_spatial.html#cb135-5" tabindex="-1"></a>} </span>
<span id="cb135-6"><a href="tree_spatial.html#cb135-6" tabindex="-1"></a><span class="co"># table it</span></span>
<span id="cb135-7"><a href="tree_spatial.html#cb135-7" tabindex="-1"></a>tidyr<span class="sc">::</span><span class="fu">crossing</span>(</span>
<span id="cb135-8"><a href="tree_spatial.html#cb135-8" tabindex="-1"></a>    <span class="at">ba =</span> <span class="fu">seq</span>(<span class="dv">40</span>,<span class="dv">200</span>,<span class="dv">20</span>)</span>
<span id="cb135-9"><a href="tree_spatial.html#cb135-9" tabindex="-1"></a>    , <span class="at">qmd =</span> <span class="fu">seq</span>(<span class="dv">8</span>,<span class="dv">20</span>,<span class="dv">2</span>)</span>
<span id="cb135-10"><a href="tree_spatial.html#cb135-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-11"><a href="tree_spatial.html#cb135-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb135-12"><a href="tree_spatial.html#cb135-12" tabindex="-1"></a>    <span class="at">tpa =</span> <span class="fu">get_tpa</span>(ba,qmd)</span>
<span id="cb135-13"><a href="tree_spatial.html#cb135-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-14"><a href="tree_spatial.html#cb135-14" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> ba, <span class="at">values_from =</span> tpa) <span class="sc">%&gt;%</span> </span>
<span id="cb135-15"><a href="tree_spatial.html#cb135-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">l =</span> <span class="st">&quot;QMD (in)&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-16"><a href="tree_spatial.html#cb135-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(l) <span class="sc">%&gt;%</span> </span>
<span id="cb135-17"><a href="tree_spatial.html#cb135-17" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb135-18"><a href="tree_spatial.html#cb135-18" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">&quot;.&quot;</span>,<span class="st">&quot;&quot;</span>, <span class="fu">seq</span>(<span class="dv">40</span>,<span class="dv">200</span>,<span class="dv">20</span>))</span>
<span id="cb135-19"><a href="tree_spatial.html#cb135-19" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb135-20"><a href="tree_spatial.html#cb135-20" tabindex="-1"></a>    , <span class="at">caption =</span> <span class="st">&quot;Basal Area and QMD to TPA conversion chart&quot;</span></span>
<span id="cb135-21"><a href="tree_spatial.html#cb135-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-22"><a href="tree_spatial.html#cb135-22" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(</span>
<span id="cb135-23"><a href="tree_spatial.html#cb135-23" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot;&quot;</span>,<span class="st">&quot;&quot;</span>, <span class="st">&quot;Basal Area (ft2/ac)&quot;</span><span class="ot">=</span><span class="fu">length</span>(<span class="fu">seq</span>(<span class="dv">40</span>,<span class="dv">200</span>,<span class="dv">20</span>)))</span>
<span id="cb135-24"><a href="tree_spatial.html#cb135-24" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb135-25"><a href="tree_spatial.html#cb135-25" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb135-26"><a href="tree_spatial.html#cb135-26" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">column_spec</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">bold =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb135-27"><a href="tree_spatial.html#cb135-27" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;middle&quot;</span>)</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-55">Table 9.2: </span>Basal Area and QMD to TPA conversion chart
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1">
</th>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="9">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Basal Area (ft2/ac)
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
.
</th>
<th style="text-align:right;">
</th>
<th style="text-align:right;">
40
</th>
<th style="text-align:right;">
60
</th>
<th style="text-align:right;">
80
</th>
<th style="text-align:right;">
100
</th>
<th style="text-align:right;">
120
</th>
<th style="text-align:right;">
140
</th>
<th style="text-align:right;">
160
</th>
<th style="text-align:right;">
180
</th>
<th style="text-align:right;">
200
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;vertical-align: middle !important;" rowspan="7">
QMD (in)
</td>
<td style="text-align:right;font-weight: bold;">
8
</td>
<td style="text-align:right;">
115
</td>
<td style="text-align:right;">
172
</td>
<td style="text-align:right;">
229
</td>
<td style="text-align:right;">
286
</td>
<td style="text-align:right;">
344
</td>
<td style="text-align:right;">
401
</td>
<td style="text-align:right;">
458
</td>
<td style="text-align:right;">
516
</td>
<td style="text-align:right;">
573
</td>
</tr>
<tr>
<td style="text-align:right;font-weight: bold;">
10
</td>
<td style="text-align:right;">
73
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
147
</td>
<td style="text-align:right;">
183
</td>
<td style="text-align:right;">
220
</td>
<td style="text-align:right;">
257
</td>
<td style="text-align:right;">
293
</td>
<td style="text-align:right;">
330
</td>
<td style="text-align:right;">
367
</td>
</tr>
<tr>
<td style="text-align:right;font-weight: bold;">
12
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
76
</td>
<td style="text-align:right;">
102
</td>
<td style="text-align:right;">
127
</td>
<td style="text-align:right;">
153
</td>
<td style="text-align:right;">
178
</td>
<td style="text-align:right;">
204
</td>
<td style="text-align:right;">
229
</td>
<td style="text-align:right;">
255
</td>
</tr>
<tr>
<td style="text-align:right;font-weight: bold;">
14
</td>
<td style="text-align:right;">
37
</td>
<td style="text-align:right;">
56
</td>
<td style="text-align:right;">
75
</td>
<td style="text-align:right;">
94
</td>
<td style="text-align:right;">
112
</td>
<td style="text-align:right;">
131
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
168
</td>
<td style="text-align:right;">
187
</td>
</tr>
<tr>
<td style="text-align:right;font-weight: bold;">
16
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
43
</td>
<td style="text-align:right;">
57
</td>
<td style="text-align:right;">
72
</td>
<td style="text-align:right;">
86
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
115
</td>
<td style="text-align:right;">
129
</td>
<td style="text-align:right;">
143
</td>
</tr>
<tr>
<td style="text-align:right;font-weight: bold;">
18
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
34
</td>
<td style="text-align:right;">
45
</td>
<td style="text-align:right;">
57
</td>
<td style="text-align:right;">
68
</td>
<td style="text-align:right;">
79
</td>
<td style="text-align:right;">
91
</td>
<td style="text-align:right;">
102
</td>
<td style="text-align:right;">
113
</td>
</tr>
<tr>
<td style="text-align:right;font-weight: bold;">
20
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
28
</td>
<td style="text-align:right;">
37
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
55
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
73
</td>
<td style="text-align:right;">
83
</td>
<td style="text-align:right;">
92
</td>
</tr>
</tbody>
</table>
<div id="current-stand-conditions" class="section level4 hasAnchor" number="9.2.1.1">
<h4><span class="header-section-number">9.2.1.1</span> Current Stand Conditions<a href="tree_spatial.html#current-stand-conditions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>For determining targets, the silviculturist needs to know the current conditions. Provide the current stand conditions based on the UAS tree list for the selected stand that are required to set the targets:</p>
<ul>
<li>Current BA</li>
<li>Current QMD</li>
<li>Current proportion of trees by clump size</li>
</ul>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="tree_spatial.html#cb136-1" tabindex="-1"></a>clump_n_trees_grp_summary_temp <span class="sc">%&gt;%</span> </span>
<span id="cb136-2"><a href="tree_spatial.html#cb136-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(clump_n_trees_grp, pct_stand_n_trees) <span class="sc">%&gt;%</span> </span>
<span id="cb136-3"><a href="tree_spatial.html#cb136-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb136-4"><a href="tree_spatial.html#cb136-4" tabindex="-1"></a>    <span class="at">pct_stand_n_trees =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_stand_n_trees,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb136-5"><a href="tree_spatial.html#cb136-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb136-6"><a href="tree_spatial.html#cb136-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> clump_n_trees_grp, <span class="at">values_from =</span> pct_stand_n_trees) <span class="sc">%&gt;%</span> </span>
<span id="cb136-7"><a href="tree_spatial.html#cb136-7" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb136-8"><a href="tree_spatial.html#cb136-8" tabindex="-1"></a>    <span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb136-9"><a href="tree_spatial.html#cb136-9" tabindex="-1"></a>      <span class="st">&quot;Current stand BA (ft2/ac): &quot;</span></span>
<span id="cb136-10"><a href="tree_spatial.html#cb136-10" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_basal_area_ft2_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb136-11"><a href="tree_spatial.html#cb136-11" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;Current stand QMD (in): &quot;</span></span>
<span id="cb136-12"><a href="tree_spatial.html#cb136-12" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_qmd_in[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb136-13"><a href="tree_spatial.html#cb136-13" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;Current stand TPA: &quot;</span></span>
<span id="cb136-14"><a href="tree_spatial.html#cb136-14" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_trees_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb136-15"><a href="tree_spatial.html#cb136-15" tabindex="-1"></a>    )</span>
<span id="cb136-16"><a href="tree_spatial.html#cb136-16" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb136-17"><a href="tree_spatial.html#cb136-17" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">1</span></span>
<span id="cb136-18"><a href="tree_spatial.html#cb136-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb136-19"><a href="tree_spatial.html#cb136-19" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb136-20"><a href="tree_spatial.html#cb136-20" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">footnote</span>(<span class="at">general =</span> <span class="st">&quot;values are the percent of trees in each clump size&quot;</span>)</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;border-bottom: 0;">
<caption>
<span id="tab:unnamed-chunk-56">Table 9.3: </span><span id="tab:unnamed-chunk-56">Table 9.4: </span>Current stand BA (ft2/ac): 38.9<br>Current stand QMD (in): 10.1<br>Current stand TPA: 71
</caption>
<thead>
<tr>
<th style="text-align:left;">
Individual
</th>
<th style="text-align:left;">
2-4 trees
</th>
<th style="text-align:left;">
5-9 trees
</th>
<th style="text-align:left;">
10-15 trees
</th>
<th style="text-align:left;">
&gt;15 trees
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
9%
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
22%
</td>
<td style="text-align:left;">
30%
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<span style="font-style: italic;">Note: </span>
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> values are the percent of trees in each clump size
</td>
</tr>
</tfoot>
</table>
</div>
</div>
<div id="set_targets" class="section level3 hasAnchor" number="9.2.2">
<h3><span class="header-section-number">9.2.2</span> 5. Obtain targets for clump proportions<a href="tree_spatial.html#set_targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Step 5 in <a href="https://scholarworks.umt.edu/ico/3">Churchill et al. (2016)</a>:</p>
<blockquote>
<p>ICO prescriptions are based on a target proportion of trees in different sized clumps within a stand. Proportions are just the percentage of trees, or TPA, that are in different sized clumps. Basal area proportions can be used, but we have found TPA targets to be more straightforward to use. Ideally, a table summarizing clump proportions for a range of reference conditions in your area is available (Table 2). If not, instructions for developing one are provided in section VI. (p.12)</p>
</blockquote>
<p>Section VI of <a href="https://scholarworks.umt.edu/ico/3">Churchill et al. (2016)</a> notes that</p>
<blockquote>
<p>reference spatial information may already be available and summarized in a way that it can be directly incorporated into ICO prescriptions. Such data exist and have been published for areas in Arizona (Abella and Denton 2009, Sánchez Meador et al. 2011), the eastern Washington Cascades (Churchill et al. 2013), the northern Rockies (Larson et al. 2012), and the Sierra Nevada (Lydersen et al. 2013). Reference datasets for using ICO in other forest types, such as coastal Douglas-fir or Pacific silver fir, also exist (Larson and Churchill 2008). (p.28)</p>
</blockquote>
<p>Table 2 is:</p>
<p><img src="https://i.ibb.co/N1hpzLj/churchilletal2016-table2.jpg" width="70%" height="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="select-target-clump-proportions-for-your-stand" class="section level3 hasAnchor" number="9.2.3">
<h3><span class="header-section-number">9.2.3</span> 6. Select target clump proportions for your stand<a href="tree_spatial.html#select-target-clump-proportions-for-your-stand" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><em>Now set the desired BA, QMD, and proportion of trees in each clump size:</em></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="tree_spatial.html#cb137-1" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb137-2"><a href="tree_spatial.html#cb137-2" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb137-3"><a href="tree_spatial.html#cb137-3" tabindex="-1"></a><span class="co"># desired BA, QMD, and proportion of trees in each clump size</span></span>
<span id="cb137-4"><a href="tree_spatial.html#cb137-4" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb137-5"><a href="tree_spatial.html#cb137-5" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb137-6"><a href="tree_spatial.html#cb137-6" tabindex="-1"></a><span class="co"># desired BA</span></span>
<span id="cb137-7"><a href="tree_spatial.html#cb137-7" tabindex="-1"></a>  target_ba <span class="ot">=</span> <span class="dv">37</span> <span class="co"># cannot be &gt; current BA</span></span>
<span id="cb137-8"><a href="tree_spatial.html#cb137-8" tabindex="-1"></a><span class="co"># desired QMD</span></span>
<span id="cb137-9"><a href="tree_spatial.html#cb137-9" tabindex="-1"></a>  target_qmd <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb137-10"><a href="tree_spatial.html#cb137-10" tabindex="-1"></a><span class="co"># desired proportion (%) of trees in each clump size</span></span>
<span id="cb137-11"><a href="tree_spatial.html#cb137-11" tabindex="-1"></a>  <span class="co"># !cannot be create larger proportion of &quot;&gt;15 trees&quot; clump as this would require adding trees...</span></span>
<span id="cb137-12"><a href="tree_spatial.html#cb137-12" tabindex="-1"></a>  <span class="co"># c(&quot;Individual&quot;, &quot;2-4 trees&quot;,    &quot;5-9 trees&quot;,    &quot;10-15 trees&quot;, &quot;&gt;15 trees&quot;)</span></span>
<span id="cb137-13"><a href="tree_spatial.html#cb137-13" tabindex="-1"></a>  <span class="co"># c(.18, .33, .24, .10, .15)</span></span>
<span id="cb137-14"><a href="tree_spatial.html#cb137-14" tabindex="-1"></a>  target_pcts <span class="ot">=</span> <span class="fu">c</span>(.<span class="dv">18</span>, .<span class="dv">33</span>, .<span class="dv">24</span>, .<span class="dv">10</span>, .<span class="dv">15</span>)</span>
<span id="cb137-15"><a href="tree_spatial.html#cb137-15" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb137-16"><a href="tree_spatial.html#cb137-16" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb137-17"><a href="tree_spatial.html#cb137-17" tabindex="-1"></a><span class="co"># desired BA, QMD, and proportion of trees in each clump size</span></span>
<span id="cb137-18"><a href="tree_spatial.html#cb137-18" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb137-19"><a href="tree_spatial.html#cb137-19" tabindex="-1"></a><span class="do">########################################################################################</span></span></code></pre></div>
<p>Check set up and define data with targets</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="tree_spatial.html#cb138-1" tabindex="-1"></a>get_target_check_prescription <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb138-2"><a href="tree_spatial.html#cb138-2" tabindex="-1"></a>  clump_n_trees_grp_summary_dta</span>
<span id="cb138-3"><a href="tree_spatial.html#cb138-3" tabindex="-1"></a>  , <span class="at">target_ba =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb138-4"><a href="tree_spatial.html#cb138-4" tabindex="-1"></a>  , <span class="at">target_qmd =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb138-5"><a href="tree_spatial.html#cb138-5" tabindex="-1"></a>  , <span class="at">target_pcts =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb138-6"><a href="tree_spatial.html#cb138-6" tabindex="-1"></a>){</span>
<span id="cb138-7"><a href="tree_spatial.html#cb138-7" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb138-8"><a href="tree_spatial.html#cb138-8" tabindex="-1"></a>    <span class="fu">is.na</span>(target_ba) <span class="sc">|</span> <span class="fu">is.na</span>(target_qmd) <span class="sc">|</span> <span class="fu">max</span>(<span class="fu">is.na</span>(target_pcts))<span class="sc">==</span><span class="dv">1</span></span>
<span id="cb138-9"><a href="tree_spatial.html#cb138-9" tabindex="-1"></a>  ){</span>
<span id="cb138-10"><a href="tree_spatial.html#cb138-10" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;must set all of the function parameters:</span><span class="sc">\n</span><span class="st">`target_ba`, `target_qmd`, and `target_pcts`&quot;</span>)</span>
<span id="cb138-11"><a href="tree_spatial.html#cb138-11" tabindex="-1"></a>  }</span>
<span id="cb138-12"><a href="tree_spatial.html#cb138-12" tabindex="-1"></a>  <span class="do">#############################################</span></span>
<span id="cb138-13"><a href="tree_spatial.html#cb138-13" tabindex="-1"></a>  <span class="co"># check target BA and TPA</span></span>
<span id="cb138-14"><a href="tree_spatial.html#cb138-14" tabindex="-1"></a>  <span class="do">#############################################</span></span>
<span id="cb138-15"><a href="tree_spatial.html#cb138-15" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">as.numeric</span>(target_ba)<span class="sc">&gt;</span>clump_n_trees_grp_summary_dta<span class="sc">$</span>stand_basal_area_ft2_per_ac[<span class="dv">1</span>]){</span>
<span id="cb138-16"><a href="tree_spatial.html#cb138-16" tabindex="-1"></a>    <span class="fu">stop</span>(</span>
<span id="cb138-17"><a href="tree_spatial.html#cb138-17" tabindex="-1"></a>      <span class="st">&quot;target BA in `target_ba` of &quot;</span></span>
<span id="cb138-18"><a href="tree_spatial.html#cb138-18" tabindex="-1"></a>      , <span class="fu">round</span>(<span class="fu">as.numeric</span>(target_ba),<span class="dv">1</span>), <span class="st">&quot; is greater than current BA of &quot;</span></span>
<span id="cb138-19"><a href="tree_spatial.html#cb138-19" tabindex="-1"></a>      , clump_n_trees_grp_summary_dta<span class="sc">$</span>stand_basal_area_ft2_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb138-20"><a href="tree_spatial.html#cb138-20" tabindex="-1"></a>    )</span>
<span id="cb138-21"><a href="tree_spatial.html#cb138-21" tabindex="-1"></a>  }</span>
<span id="cb138-22"><a href="tree_spatial.html#cb138-22" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb138-23"><a href="tree_spatial.html#cb138-23" tabindex="-1"></a>    <span class="fu">get_tpa</span>(target_ba, target_qmd)<span class="sc">&gt;</span>clump_n_trees_grp_summary_dta<span class="sc">$</span>stand_trees_per_ac[<span class="dv">1</span>]</span>
<span id="cb138-24"><a href="tree_spatial.html#cb138-24" tabindex="-1"></a>  ){</span>
<span id="cb138-25"><a href="tree_spatial.html#cb138-25" tabindex="-1"></a>    <span class="fu">stop</span>(</span>
<span id="cb138-26"><a href="tree_spatial.html#cb138-26" tabindex="-1"></a>      <span class="st">&quot;target TPA in of &quot;</span></span>
<span id="cb138-27"><a href="tree_spatial.html#cb138-27" tabindex="-1"></a>      , <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="fu">get_tpa</span>(target_ba, target_qmd)),<span class="dv">1</span>), <span class="st">&quot; is greater than current TPA of &quot;</span></span>
<span id="cb138-28"><a href="tree_spatial.html#cb138-28" tabindex="-1"></a>      , clump_n_trees_grp_summary_dta<span class="sc">$</span>stand_trees_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb138-29"><a href="tree_spatial.html#cb138-29" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st"> adjust `target_ba` and/or `target_qmd` to get valid TPA&quot;</span></span>
<span id="cb138-30"><a href="tree_spatial.html#cb138-30" tabindex="-1"></a>    )</span>
<span id="cb138-31"><a href="tree_spatial.html#cb138-31" tabindex="-1"></a>  }</span>
<span id="cb138-32"><a href="tree_spatial.html#cb138-32" tabindex="-1"></a>  <span class="do">#############################################</span></span>
<span id="cb138-33"><a href="tree_spatial.html#cb138-33" tabindex="-1"></a>  <span class="co"># define data with current and target</span></span>
<span id="cb138-34"><a href="tree_spatial.html#cb138-34" tabindex="-1"></a>  <span class="co"># ... this is &quot;smart&quot; in that percentages are adj based on:</span></span>
<span id="cb138-35"><a href="tree_spatial.html#cb138-35" tabindex="-1"></a>  <span class="co"># ... 0) are there missing targets?</span></span>
<span id="cb138-36"><a href="tree_spatial.html#cb138-36" tabindex="-1"></a>  <span class="co"># ... ... if &lt; 5 numbers provided in `target_pcts` then the largest tree groups get targets of 0</span></span>
<span id="cb138-37"><a href="tree_spatial.html#cb138-37" tabindex="-1"></a>  <span class="co"># ... 1) do targets sum to 1? </span></span>
<span id="cb138-38"><a href="tree_spatial.html#cb138-38" tabindex="-1"></a>  <span class="co"># ... ... if not trees are distributed proportionally based on targets provided and trees available</span></span>
<span id="cb138-39"><a href="tree_spatial.html#cb138-39" tabindex="-1"></a>  <span class="co"># ... 2) is target in largest clump size &gt; current conditions?</span></span>
<span id="cb138-40"><a href="tree_spatial.html#cb138-40" tabindex="-1"></a>  <span class="co"># ... ... if yes, target is set to current condition</span></span>
<span id="cb138-41"><a href="tree_spatial.html#cb138-41" tabindex="-1"></a>  <span class="co"># ... 3) is target listed in clump size &gt; current largest clump with trees?</span></span>
<span id="cb138-42"><a href="tree_spatial.html#cb138-42" tabindex="-1"></a>  <span class="co"># ... ... if yes, target for largest clump size is shifted to current largest clump with trees</span></span>
<span id="cb138-43"><a href="tree_spatial.html#cb138-43" tabindex="-1"></a>  <span class="do">#############################################</span></span>
<span id="cb138-44"><a href="tree_spatial.html#cb138-44" tabindex="-1"></a>    target_data <span class="ot">=</span> </span>
<span id="cb138-45"><a href="tree_spatial.html#cb138-45" tabindex="-1"></a>      <span class="co"># create data for joining if missing clump groups</span></span>
<span id="cb138-46"><a href="tree_spatial.html#cb138-46" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb138-47"><a href="tree_spatial.html#cb138-47" tabindex="-1"></a>        <span class="at">suid =</span> <span class="fu">rep</span>(clump_n_trees_grp_summary_dta<span class="sc">$</span>suid[<span class="dv">1</span>],<span class="dv">5</span>)</span>
<span id="cb138-48"><a href="tree_spatial.html#cb138-48" tabindex="-1"></a>        , <span class="at">stand_area_ac =</span> <span class="fu">rep</span>(clump_n_trees_grp_summary_dta<span class="sc">$</span>stand_area_ac[<span class="dv">1</span>],<span class="dv">5</span>)</span>
<span id="cb138-49"><a href="tree_spatial.html#cb138-49" tabindex="-1"></a>        , <span class="at">clump_n_trees_grp =</span> <span class="fu">factor</span>(</span>
<span id="cb138-50"><a href="tree_spatial.html#cb138-50" tabindex="-1"></a>          <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb138-51"><a href="tree_spatial.html#cb138-51" tabindex="-1"></a>            <span class="co"># cuts : c(0,1,4,9,15,Inf)</span></span>
<span id="cb138-52"><a href="tree_spatial.html#cb138-52" tabindex="-1"></a>          , <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>, <span class="st">&quot;2-4 trees&quot;</span>,   <span class="st">&quot;5-9 trees&quot;</span>,    <span class="st">&quot;10-15 trees&quot;</span>, <span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb138-53"><a href="tree_spatial.html#cb138-53" tabindex="-1"></a>          , <span class="at">ordered =</span> T</span>
<span id="cb138-54"><a href="tree_spatial.html#cb138-54" tabindex="-1"></a>        )</span>
<span id="cb138-55"><a href="tree_spatial.html#cb138-55" tabindex="-1"></a>        , <span class="at">mean_clump_n_trees =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">7</span>,<span class="dv">12</span>,<span class="dv">20</span>)</span>
<span id="cb138-56"><a href="tree_spatial.html#cb138-56" tabindex="-1"></a>        , <span class="at">min_clump_n_trees =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">16</span>)</span>
<span id="cb138-57"><a href="tree_spatial.html#cb138-57" tabindex="-1"></a>        , <span class="at">max_clump_n_trees =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="dv">25</span>)</span>
<span id="cb138-58"><a href="tree_spatial.html#cb138-58" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-59"><a href="tree_spatial.html#cb138-59" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb138-60"><a href="tree_spatial.html#cb138-60" tabindex="-1"></a>        clump_n_trees_grp_summary_dta <span class="sc">%&gt;%</span> </span>
<span id="cb138-61"><a href="tree_spatial.html#cb138-61" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb138-62"><a href="tree_spatial.html#cb138-62" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(clump_n_trees_grp, pct_stand_n_trees, stand_n_clumps)</span>
<span id="cb138-63"><a href="tree_spatial.html#cb138-63" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-64"><a href="tree_spatial.html#cb138-64" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb138-65"><a href="tree_spatial.html#cb138-65" tabindex="-1"></a>        <span class="at">pct_stand_n_trees =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(pct_stand_n_trees,<span class="dv">0</span>)</span>
<span id="cb138-66"><a href="tree_spatial.html#cb138-66" tabindex="-1"></a>        , <span class="at">stand_n_clumps =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(stand_n_clumps,<span class="dv">0</span>)</span>
<span id="cb138-67"><a href="tree_spatial.html#cb138-67" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-68"><a href="tree_spatial.html#cb138-68" tabindex="-1"></a>      <span class="co"># add targets</span></span>
<span id="cb138-69"><a href="tree_spatial.html#cb138-69" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb138-70"><a href="tree_spatial.html#cb138-70" tabindex="-1"></a>        <span class="at">pct_stand_n_trees_target =</span> <span class="fu">c</span>(<span class="fu">as.numeric</span>(target_pcts), <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>))[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># pad target with 0&#39;s</span></span>
<span id="cb138-71"><a href="tree_spatial.html#cb138-71" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-72"><a href="tree_spatial.html#cb138-72" tabindex="-1"></a>      <span class="co"># adjust target based on difference from 1</span></span>
<span id="cb138-73"><a href="tree_spatial.html#cb138-73" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb138-74"><a href="tree_spatial.html#cb138-74" tabindex="-1"></a>        <span class="at">pct_stand_n_trees_target =</span> pct_stand_n_trees_target<span class="sc">*</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(pct_stand_n_trees_target))</span>
<span id="cb138-75"><a href="tree_spatial.html#cb138-75" tabindex="-1"></a>        <span class="co"># largest clump size with trees</span></span>
<span id="cb138-76"><a href="tree_spatial.html#cb138-76" tabindex="-1"></a>        , <span class="at">largest_w_trees =</span> <span class="fu">max</span>(<span class="fu">ifelse</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(pct_stand_n_trees)<span class="sc">&gt;</span><span class="dv">0</span>,clump_n_trees_grp,<span class="cn">NA</span>),<span class="at">na.rm =</span> T)</span>
<span id="cb138-77"><a href="tree_spatial.html#cb138-77" tabindex="-1"></a>        , <span class="at">largest_w_trees_target =</span> <span class="fu">max</span>(<span class="fu">ifelse</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(pct_stand_n_trees_target)<span class="sc">&gt;</span><span class="dv">0</span>,clump_n_trees_grp,<span class="cn">NA</span>),<span class="at">na.rm =</span> T)</span>
<span id="cb138-78"><a href="tree_spatial.html#cb138-78" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-79"><a href="tree_spatial.html#cb138-79" tabindex="-1"></a>      <span class="co"># move target for largest clump size to the largest current clump size </span></span>
<span id="cb138-80"><a href="tree_spatial.html#cb138-80" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb138-81"><a href="tree_spatial.html#cb138-81" tabindex="-1"></a>        <span class="at">pct_stand_n_trees_target =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb138-82"><a href="tree_spatial.html#cb138-82" tabindex="-1"></a>          <span class="fu">as.numeric</span>(clump_n_trees_grp)<span class="sc">==</span>largest_w_trees <span class="sc">&amp;</span></span>
<span id="cb138-83"><a href="tree_spatial.html#cb138-83" tabindex="-1"></a>            largest_w_trees_target<span class="sc">&gt;</span>largest_w_trees <span class="sc">~</span> <span class="fu">max</span>(</span>
<span id="cb138-84"><a href="tree_spatial.html#cb138-84" tabindex="-1"></a>              <span class="fu">ifelse</span>(<span class="fu">as.numeric</span>(clump_n_trees_grp)<span class="sc">==</span>largest_w_trees_target,pct_stand_n_trees_target,<span class="dv">0</span>)</span>
<span id="cb138-85"><a href="tree_spatial.html#cb138-85" tabindex="-1"></a>            )</span>
<span id="cb138-86"><a href="tree_spatial.html#cb138-86" tabindex="-1"></a>          , T <span class="sc">~</span> pct_stand_n_trees_target</span>
<span id="cb138-87"><a href="tree_spatial.html#cb138-87" tabindex="-1"></a>        )</span>
<span id="cb138-88"><a href="tree_spatial.html#cb138-88" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-89"><a href="tree_spatial.html#cb138-89" tabindex="-1"></a>      <span class="co"># adjust target based on current conditions</span></span>
<span id="cb138-90"><a href="tree_spatial.html#cb138-90" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb138-91"><a href="tree_spatial.html#cb138-91" tabindex="-1"></a>        <span class="at">pct_stand_n_trees_target =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb138-92"><a href="tree_spatial.html#cb138-92" tabindex="-1"></a>          <span class="fu">as.numeric</span>(clump_n_trees_grp)<span class="sc">&gt;</span>largest_w_trees <span class="sc">&amp;</span></span>
<span id="cb138-93"><a href="tree_spatial.html#cb138-93" tabindex="-1"></a>            pct_stand_n_trees_target <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb138-94"><a href="tree_spatial.html#cb138-94" tabindex="-1"></a>          , <span class="fu">as.numeric</span>(clump_n_trees_grp)<span class="sc">==</span>largest_w_trees <span class="sc">&amp;</span></span>
<span id="cb138-95"><a href="tree_spatial.html#cb138-95" tabindex="-1"></a>            pct_stand_n_trees_target <span class="sc">&gt;</span> pct_stand_n_trees <span class="sc">~</span> pct_stand_n_trees</span>
<span id="cb138-96"><a href="tree_spatial.html#cb138-96" tabindex="-1"></a>          , T <span class="sc">~</span> pct_stand_n_trees_target</span>
<span id="cb138-97"><a href="tree_spatial.html#cb138-97" tabindex="-1"></a>        )</span>
<span id="cb138-98"><a href="tree_spatial.html#cb138-98" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-99"><a href="tree_spatial.html#cb138-99" tabindex="-1"></a>      <span class="co"># finally, re-scale again based on adjustments</span></span>
<span id="cb138-100"><a href="tree_spatial.html#cb138-100" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb138-101"><a href="tree_spatial.html#cb138-101" tabindex="-1"></a>        <span class="at">pct_stand_n_trees_target =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb138-102"><a href="tree_spatial.html#cb138-102" tabindex="-1"></a>          <span class="fu">as.numeric</span>(clump_n_trees_grp)<span class="sc">==</span>largest_w_trees <span class="sc">~</span> pct_stand_n_trees_target</span>
<span id="cb138-103"><a href="tree_spatial.html#cb138-103" tabindex="-1"></a>          , T <span class="sc">~</span> pct_stand_n_trees_target <span class="sc">*</span> (</span>
<span id="cb138-104"><a href="tree_spatial.html#cb138-104" tabindex="-1"></a>            <span class="co"># pct remaining to scale to</span></span>
<span id="cb138-105"><a href="tree_spatial.html#cb138-105" tabindex="-1"></a>            (<span class="dv">1</span><span class="sc">-</span><span class="fu">max</span>(<span class="fu">ifelse</span>(<span class="fu">as.numeric</span>(clump_n_trees_grp)<span class="sc">==</span>largest_w_trees,pct_stand_n_trees_target,<span class="dv">0</span>))) <span class="sc">/</span></span>
<span id="cb138-106"><a href="tree_spatial.html#cb138-106" tabindex="-1"></a>            <span class="co"># current pct remaining total allocated</span></span>
<span id="cb138-107"><a href="tree_spatial.html#cb138-107" tabindex="-1"></a>            <span class="fu">sum</span>(</span>
<span id="cb138-108"><a href="tree_spatial.html#cb138-108" tabindex="-1"></a>              <span class="fu">ifelse</span>(<span class="fu">as.numeric</span>(clump_n_trees_grp)<span class="sc">!=</span>largest_w_trees,pct_stand_n_trees_target,<span class="dv">0</span>))</span>
<span id="cb138-109"><a href="tree_spatial.html#cb138-109" tabindex="-1"></a>            )</span>
<span id="cb138-110"><a href="tree_spatial.html#cb138-110" tabindex="-1"></a>        )</span>
<span id="cb138-111"><a href="tree_spatial.html#cb138-111" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-112"><a href="tree_spatial.html#cb138-112" tabindex="-1"></a>      <span class="co"># add other targets</span></span>
<span id="cb138-113"><a href="tree_spatial.html#cb138-113" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">pct_stand_n_trees_current =</span> pct_stand_n_trees) <span class="sc">%&gt;%</span> </span>
<span id="cb138-114"><a href="tree_spatial.html#cb138-114" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb138-115"><a href="tree_spatial.html#cb138-115" tabindex="-1"></a>        <span class="at">stand_trees_per_ac_current =</span> clump_n_trees_grp_summary_dta<span class="sc">$</span>stand_trees_per_ac[<span class="dv">1</span>]</span>
<span id="cb138-116"><a href="tree_spatial.html#cb138-116" tabindex="-1"></a>        , <span class="at">stand_trees_per_ac_target =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">get_tpa</span>(target_ba, target_qmd),<span class="dv">0</span>)</span>
<span id="cb138-117"><a href="tree_spatial.html#cb138-117" tabindex="-1"></a>        , <span class="at">trees_per_acre_current =</span> stand_trees_per_ac_current<span class="sc">*</span>pct_stand_n_trees_current</span>
<span id="cb138-118"><a href="tree_spatial.html#cb138-118" tabindex="-1"></a>        , <span class="at">trees_per_acre_target =</span> stand_trees_per_ac_target<span class="sc">*</span>pct_stand_n_trees_target</span>
<span id="cb138-119"><a href="tree_spatial.html#cb138-119" tabindex="-1"></a>        , <span class="at">clumps_per_acre_current =</span> trees_per_acre_current<span class="sc">/</span>mean_clump_n_trees</span>
<span id="cb138-120"><a href="tree_spatial.html#cb138-120" tabindex="-1"></a>        , <span class="at">clumps_per_acre_target =</span> trees_per_acre_target<span class="sc">/</span>mean_clump_n_trees</span>
<span id="cb138-121"><a href="tree_spatial.html#cb138-121" tabindex="-1"></a>        , <span class="at">stand_n_clumps_current =</span> stand_n_clumps</span>
<span id="cb138-122"><a href="tree_spatial.html#cb138-122" tabindex="-1"></a>        , <span class="at">stand_n_clumps_target =</span> (clumps_per_acre_target<span class="sc">*</span>stand_area_ac) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">0</span>)</span>
<span id="cb138-123"><a href="tree_spatial.html#cb138-123" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-124"><a href="tree_spatial.html#cb138-124" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;largest_w_trees&quot;</span>), stand_n_clumps))</span>
<span id="cb138-125"><a href="tree_spatial.html#cb138-125" tabindex="-1"></a>  <span class="co"># ????  </span></span>
<span id="cb138-126"><a href="tree_spatial.html#cb138-126" tabindex="-1"></a>  <span class="co"># target_data %&gt;% glimpse()</span></span>
<span id="cb138-127"><a href="tree_spatial.html#cb138-127" tabindex="-1"></a>  </span>
<span id="cb138-128"><a href="tree_spatial.html#cb138-128" tabindex="-1"></a>    <span class="co"># issue warning about targets</span></span>
<span id="cb138-129"><a href="tree_spatial.html#cb138-129" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">min</span>(target_data<span class="sc">$</span>pct_stand_n_trees_target <span class="sc">==</span> <span class="fu">c</span>(<span class="fu">as.numeric</span>(target_pcts), <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>))[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb138-130"><a href="tree_spatial.html#cb138-130" tabindex="-1"></a>      <span class="fu">warning</span>(</span>
<span id="cb138-131"><a href="tree_spatial.html#cb138-131" tabindex="-1"></a>        <span class="st">&quot;proportion of trees in each clump size target `target_pcts` adjusted!!!&quot;</span></span>
<span id="cb138-132"><a href="tree_spatial.html#cb138-132" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">from : &quot;</span>, <span class="fu">paste</span>(<span class="fu">round</span>(target_pcts,<span class="dv">2</span>),<span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb138-133"><a href="tree_spatial.html#cb138-133" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">to : &quot;</span>, <span class="fu">paste</span>(<span class="fu">round</span>(target_data<span class="sc">$</span>pct_stand_n_trees_target,<span class="dv">2</span>),<span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb138-134"><a href="tree_spatial.html#cb138-134" tabindex="-1"></a>      )</span>
<span id="cb138-135"><a href="tree_spatial.html#cb138-135" tabindex="-1"></a>    }</span>
<span id="cb138-136"><a href="tree_spatial.html#cb138-136" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb138-137"><a href="tree_spatial.html#cb138-137" tabindex="-1"></a>  <span class="fu">return</span>(target_data)</span>
<span id="cb138-138"><a href="tree_spatial.html#cb138-138" tabindex="-1"></a>}</span>
<span id="cb138-139"><a href="tree_spatial.html#cb138-139" tabindex="-1"></a><span class="co"># call it</span></span>
<span id="cb138-140"><a href="tree_spatial.html#cb138-140" tabindex="-1"></a>target_data_temp <span class="ot">=</span> <span class="fu">get_target_check_prescription</span>(</span>
<span id="cb138-141"><a href="tree_spatial.html#cb138-141" tabindex="-1"></a>  clump_n_trees_grp_summary_temp</span>
<span id="cb138-142"><a href="tree_spatial.html#cb138-142" tabindex="-1"></a>  , <span class="at">target_ba =</span> target_ba</span>
<span id="cb138-143"><a href="tree_spatial.html#cb138-143" tabindex="-1"></a>  , <span class="at">target_qmd =</span> target_qmd</span>
<span id="cb138-144"><a href="tree_spatial.html#cb138-144" tabindex="-1"></a>  , <span class="at">target_pcts =</span> target_pcts</span>
<span id="cb138-145"><a href="tree_spatial.html#cb138-145" tabindex="-1"></a>)</span>
<span id="cb138-146"><a href="tree_spatial.html#cb138-146" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb138-147"><a href="tree_spatial.html#cb138-147" tabindex="-1"></a>target_data_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 5
## Columns: 16
## $ suid                       &lt;chr&gt; &quot;0203088082660001000&quot;, &quot;0203088082660001000…
## $ stand_area_ac              &lt;dbl&gt; 30.1861, 30.1861, 30.1861, 30.1861, 30.1861
## $ clump_n_trees_grp          &lt;ord&gt; Individual, 2-4 trees, 5-9 trees, 10-15 tre…
## $ mean_clump_n_trees         &lt;dbl&gt; 1, 3, 7, 12, 20
## $ min_clump_n_trees          &lt;dbl&gt; 1, 2, 5, 10, 16
## $ max_clump_n_trees          &lt;dbl&gt; 1, 4, 9, 15, 25
## $ pct_stand_n_trees_current  &lt;dbl&gt; 0.09261871, 0.17536436, 0.21297602, 0.21532…
## $ pct_stand_n_trees_target   &lt;dbl&gt; 0.18, 0.33, 0.24, 0.10, 0.15
## $ stand_trees_per_ac_current &lt;dbl&gt; 70.51611, 70.51611, 70.51611, 70.51611, 70.…
## $ stand_trees_per_ac_target  &lt;dbl&gt; 56, 56, 56, 56, 56
## $ trees_per_acre_current     &lt;dbl&gt; 6.531111, 12.366012, 15.018240, 15.184004, …
## $ trees_per_acre_target      &lt;dbl&gt; 10.08, 18.48, 13.44, 5.60, 8.40
## $ clumps_per_acre_current    &lt;dbl&gt; 6.531111, 4.122004, 2.145463, 1.265334, 1.0…
## $ clumps_per_acre_target     &lt;dbl&gt; 10.0800000, 6.1600000, 1.9200000, 0.4666667…
## $ stand_n_clumps_current     &lt;dbl&gt; 197, 138, 67, 38, 24
## $ stand_n_clumps_target      &lt;dbl&gt; 304, 186, 58, 14, 13</code></pre>
<p>current vs target</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="tree_spatial.html#cb140-1" tabindex="-1"></a>target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb140-2"><a href="tree_spatial.html#cb140-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb140-3"><a href="tree_spatial.html#cb140-3" tabindex="-1"></a>    clump_n_trees_grp</span>
<span id="cb140-4"><a href="tree_spatial.html#cb140-4" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_stand_n_trees&quot;</span>)</span>
<span id="cb140-5"><a href="tree_spatial.html#cb140-5" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;trees_per_acre_&quot;</span>)</span>
<span id="cb140-6"><a href="tree_spatial.html#cb140-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-7"><a href="tree_spatial.html#cb140-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb140-8"><a href="tree_spatial.html#cb140-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb140-9"><a href="tree_spatial.html#cb140-9" tabindex="-1"></a>      tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_stand_n_trees&quot;</span>)</span>
<span id="cb140-10"><a href="tree_spatial.html#cb140-10" tabindex="-1"></a>      , <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb140-11"><a href="tree_spatial.html#cb140-11" tabindex="-1"></a>    )</span>
<span id="cb140-12"><a href="tree_spatial.html#cb140-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-13"><a href="tree_spatial.html#cb140-13" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb140-14"><a href="tree_spatial.html#cb140-14" tabindex="-1"></a>    <span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb140-15"><a href="tree_spatial.html#cb140-15" tabindex="-1"></a>      <span class="st">&quot;Current stand BA (ft2/ac): &quot;</span></span>
<span id="cb140-16"><a href="tree_spatial.html#cb140-16" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_basal_area_ft2_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb140-17"><a href="tree_spatial.html#cb140-17" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;Current stand QMD (in): &quot;</span></span>
<span id="cb140-18"><a href="tree_spatial.html#cb140-18" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_qmd_in[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb140-19"><a href="tree_spatial.html#cb140-19" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;Current stand TPA: &quot;</span></span>
<span id="cb140-20"><a href="tree_spatial.html#cb140-20" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_trees_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb140-21"><a href="tree_spatial.html#cb140-21" tabindex="-1"></a>    )</span>
<span id="cb140-22"><a href="tree_spatial.html#cb140-22" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb140-23"><a href="tree_spatial.html#cb140-23" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">1</span></span>
<span id="cb140-24"><a href="tree_spatial.html#cb140-24" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb140-25"><a href="tree_spatial.html#cb140-25" tabindex="-1"></a>      <span class="st">&quot;&quot;</span>, <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;current&quot;</span>,<span class="st">&quot;target&quot;</span>),<span class="dv">2</span>)</span>
<span id="cb140-26"><a href="tree_spatial.html#cb140-26" tabindex="-1"></a>    )</span>
<span id="cb140-27"><a href="tree_spatial.html#cb140-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-28"><a href="tree_spatial.html#cb140-28" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb140-29"><a href="tree_spatial.html#cb140-29" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(</span>
<span id="cb140-30"><a href="tree_spatial.html#cb140-30" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">&quot;% Trees&quot;</span><span class="ot">=</span><span class="dv">2</span>, <span class="st">&quot;TPA&quot;</span><span class="ot">=</span><span class="dv">2</span>)</span>
<span id="cb140-31"><a href="tree_spatial.html#cb140-31" tabindex="-1"></a>  )</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-61">Table 9.5: </span><span id="tab:unnamed-chunk-61">Table 9.6: </span>Current stand BA (ft2/ac): 38.9<br>Current stand QMD (in): 10.1<br>Current stand TPA: 71
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
% Trees
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
TPA
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
current
</th>
<th style="text-align:left;">
target
</th>
<th style="text-align:right;">
current
</th>
<th style="text-align:right;">
target
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Individual
</td>
<td style="text-align:left;">
9%
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:right;">
6.5
</td>
<td style="text-align:right;">
10.1
</td>
</tr>
<tr>
<td style="text-align:left;">
2-4 trees
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
33%
</td>
<td style="text-align:right;">
12.4
</td>
<td style="text-align:right;">
18.5
</td>
</tr>
<tr>
<td style="text-align:left;">
5-9 trees
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
24%
</td>
<td style="text-align:right;">
15.0
</td>
<td style="text-align:right;">
13.4
</td>
</tr>
<tr>
<td style="text-align:left;">
10-15 trees
</td>
<td style="text-align:left;">
22%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:right;">
15.2
</td>
<td style="text-align:right;">
5.6
</td>
</tr>
<tr>
<td style="text-align:left;">
&gt;15 trees
</td>
<td style="text-align:left;">
30%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:right;">
21.4
</td>
<td style="text-align:right;">
8.4
</td>
</tr>
</tbody>
</table>
</div>
<div id="combine-clump-and-opening-targets-with-leave-tree-criteria-into-marking-guidelines" class="section level3 hasAnchor" number="9.2.4">
<h3><span class="header-section-number">9.2.4</span> 8. Combine clump and opening targets with leave tree criteria into marking guidelines<a href="tree_spatial.html#combine-clump-and-opening-targets-with-leave-tree-criteria-into-marking-guidelines" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Use our UAS tree list to generate the prescription:</p>
<ul>
<li>start with the largest clump size currently with trees</li>
<li>cut trees to the next largest clump size until desired # clumps is reached</li>
<li>repeat with each successive clump size through to individual tree selection</li>
<li>if possible, cut in same clump until desired proportions are reached to minimize machine time</li>
</ul>
<div id="example-for-one-clump" class="section level4 hasAnchor" number="9.2.4.1">
<h4><span class="header-section-number">9.2.4.1</span> Example for one clump<a href="tree_spatial.html#example-for-one-clump" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Example for one clump where we identify the “narrow” areas of the clump polygon and cut trees in those areas to achieve desired clump level with minimum cutting</p>
<p>example clump</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="tree_spatial.html#cb141-1" tabindex="-1"></a><span class="co"># clump_polys_temp %&gt;% dplyr::filter(clump_n_trees_grp == &quot;&gt;15 trees&quot;) %&gt;% mapview()</span></span>
<span id="cb141-2"><a href="tree_spatial.html#cb141-2" tabindex="-1"></a><span class="do">###### !!!!!!!!!!!!!!!!! CUT BY NARROW AREAS?</span></span>
<span id="cb141-3"><a href="tree_spatial.html#cb141-3" tabindex="-1"></a><span class="co"># just one clump example</span></span>
<span id="cb141-4"><a href="tree_spatial.html#cb141-4" tabindex="-1"></a>id_temp <span class="ot">=</span> <span class="co"># 141</span></span>
<span id="cb141-5"><a href="tree_spatial.html#cb141-5" tabindex="-1"></a>  clump_polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb141-6"><a href="tree_spatial.html#cb141-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;&gt;15 trees&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb141-7"><a href="tree_spatial.html#cb141-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">prop =</span> .<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb141-8"><a href="tree_spatial.html#cb141-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n_trees)) <span class="sc">%&gt;%</span> </span>
<span id="cb141-9"><a href="tree_spatial.html#cb141-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb141-10"><a href="tree_spatial.html#cb141-10" tabindex="-1"></a>  .[<span class="dv">1</span>]</span>
<span id="cb141-11"><a href="tree_spatial.html#cb141-11" tabindex="-1"></a><span class="co"># data for passing to function with nest()</span></span>
<span id="cb141-12"><a href="tree_spatial.html#cb141-12" tabindex="-1"></a>x <span class="ot">=</span> ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb141-13"><a href="tree_spatial.html#cb141-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;&gt;15 trees&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-14"><a href="tree_spatial.html#cb141-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id <span class="sc">==</span> id_temp)</span>
<span id="cb141-15"><a href="tree_spatial.html#cb141-15" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb141-16"><a href="tree_spatial.html#cb141-16" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb141-17"><a href="tree_spatial.html#cb141-17" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id<span class="sc">==</span>x<span class="sc">$</span>clump_id[<span class="dv">1</span>]), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb141-18"><a href="tree_spatial.html#cb141-18" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> x, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb141-19"><a href="tree_spatial.html#cb141-19" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;example &quot;</span>, x<span class="sc">$</span>clump_n_trees_grp[<span class="dv">1</span>], <span class="st">&quot; clump group&quot;</span>)) <span class="sc">+</span></span>
<span id="cb141-20"><a href="tree_spatial.html#cb141-20" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-62-1.png" width="1008" /></p>
<p>identify the tree points that are furthest apart and draw a line which we’ll use to make cuts perpendicular to the clump</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="tree_spatial.html#cb142-1" tabindex="-1"></a><span class="co"># find the next group size for target</span></span>
<span id="cb142-2"><a href="tree_spatial.html#cb142-2" tabindex="-1"></a><span class="co"># !!! going to have to change the process for clump_n_trees_grp == &quot;Individual&quot;</span></span>
<span id="cb142-3"><a href="tree_spatial.html#cb142-3" tabindex="-1"></a>ntree_target_temp <span class="ot">=</span> target_data_temp <span class="sc">%&gt;%</span></span>
<span id="cb142-4"><a href="tree_spatial.html#cb142-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">l =</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(clump_n_trees_grp)) <span class="sc">%&gt;%</span></span>
<span id="cb142-5"><a href="tree_spatial.html#cb142-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> x<span class="sc">$</span>clump_n_trees_grp[<span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb142-6"><a href="tree_spatial.html#cb142-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(l)</span>
<span id="cb142-7"><a href="tree_spatial.html#cb142-7" tabindex="-1"></a></span>
<span id="cb142-8"><a href="tree_spatial.html#cb142-8" tabindex="-1"></a><span class="co"># find farthest distance between points</span></span>
<span id="cb142-9"><a href="tree_spatial.html#cb142-9" tabindex="-1"></a>dist_temp <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(x)</span>
<span id="cb142-10"><a href="tree_spatial.html#cb142-10" tabindex="-1"></a><span class="co"># get the points</span></span>
<span id="cb142-11"><a href="tree_spatial.html#cb142-11" tabindex="-1"></a>f_pts_temp <span class="ot">=</span> </span>
<span id="cb142-12"><a href="tree_spatial.html#cb142-12" tabindex="-1"></a>  x <span class="sc">%&gt;%</span> </span>
<span id="cb142-13"><a href="tree_spatial.html#cb142-13" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb142-14"><a href="tree_spatial.html#cb142-14" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(</span>
<span id="cb142-15"><a href="tree_spatial.html#cb142-15" tabindex="-1"></a>      <span class="co"># get the farthest points from distance matrix</span></span>
<span id="cb142-16"><a href="tree_spatial.html#cb142-16" tabindex="-1"></a>      <span class="fu">which</span>(dist_temp <span class="sc">==</span> <span class="fu">max</span>(dist_temp), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>,]</span>
<span id="cb142-17"><a href="tree_spatial.html#cb142-17" tabindex="-1"></a>    )</span>
<span id="cb142-18"><a href="tree_spatial.html#cb142-18" tabindex="-1"></a></span>
<span id="cb142-19"><a href="tree_spatial.html#cb142-19" tabindex="-1"></a><span class="co"># draw a line between the farthest two points</span></span>
<span id="cb142-20"><a href="tree_spatial.html#cb142-20" tabindex="-1"></a>f_line_temp <span class="ot">=</span> f_pts_temp <span class="sc">%&gt;%</span> </span>
<span id="cb142-21"><a href="tree_spatial.html#cb142-21" tabindex="-1"></a>    <span class="co"># convert to linestring</span></span>
<span id="cb142-22"><a href="tree_spatial.html#cb142-22" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb142-23"><a href="tree_spatial.html#cb142-23" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n=</span>dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb142-24"><a href="tree_spatial.html#cb142-24" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;LINESTRING&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb142-25"><a href="tree_spatial.html#cb142-25" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb142-26"><a href="tree_spatial.html#cb142-26" tabindex="-1"></a><span class="co"># we need to extend the line...</span></span>
<span id="cb142-27"><a href="tree_spatial.html#cb142-27" tabindex="-1"></a><span class="co"># borrowing from https://github.com/metafor-ulaval/ALSroads/blob/main/R/line_tools.R</span></span>
<span id="cb142-28"><a href="tree_spatial.html#cb142-28" tabindex="-1"></a>  <span class="co"># Get heading of both ends of a line</span></span>
<span id="cb142-29"><a href="tree_spatial.html#cb142-29" tabindex="-1"></a>  st_ends_heading <span class="ot">&lt;-</span> <span class="cf">function</span>(line){</span>
<span id="cb142-30"><a href="tree_spatial.html#cb142-30" tabindex="-1"></a>    M <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(line)</span>
<span id="cb142-31"><a href="tree_spatial.html#cb142-31" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fu">nrow</span>(M) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb142-32"><a href="tree_spatial.html#cb142-32" tabindex="-1"></a>    j <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb142-33"><a href="tree_spatial.html#cb142-33" tabindex="-1"></a>    </span>
<span id="cb142-34"><a href="tree_spatial.html#cb142-34" tabindex="-1"></a>    headings <span class="ot">&lt;-</span> <span class="fu">mapply</span>(i, j, <span class="at">FUN =</span> <span class="cf">function</span>(i, j) {</span>
<span id="cb142-35"><a href="tree_spatial.html#cb142-35" tabindex="-1"></a>      Ax <span class="ot">=</span> M[i<span class="sc">-</span>j,<span class="dv">1</span>]</span>
<span id="cb142-36"><a href="tree_spatial.html#cb142-36" tabindex="-1"></a>      Ay <span class="ot">=</span> M[i<span class="sc">-</span>j,<span class="dv">2</span>]</span>
<span id="cb142-37"><a href="tree_spatial.html#cb142-37" tabindex="-1"></a>      Bx <span class="ot">=</span> M[i,<span class="dv">1</span>]</span>
<span id="cb142-38"><a href="tree_spatial.html#cb142-38" tabindex="-1"></a>      By <span class="ot">=</span> M[i,<span class="dv">2</span>]</span>
<span id="cb142-39"><a href="tree_spatial.html#cb142-39" tabindex="-1"></a>      <span class="fu">atan2</span>(Ay<span class="sc">-</span>By, Ax<span class="sc">-</span>Bx)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi</span>
<span id="cb142-40"><a href="tree_spatial.html#cb142-40" tabindex="-1"></a>    })</span>
<span id="cb142-41"><a href="tree_spatial.html#cb142-41" tabindex="-1"></a>    <span class="fu">names</span>(headings) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;head&quot;</span>, <span class="st">&quot;tail&quot;</span>)</span>
<span id="cb142-42"><a href="tree_spatial.html#cb142-42" tabindex="-1"></a>    <span class="fu">return</span>(headings)</span>
<span id="cb142-43"><a href="tree_spatial.html#cb142-43" tabindex="-1"></a>  }</span>
<span id="cb142-44"><a href="tree_spatial.html#cb142-44" tabindex="-1"></a>  </span>
<span id="cb142-45"><a href="tree_spatial.html#cb142-45" tabindex="-1"></a>  <span class="co"># extend the line on both ends</span></span>
<span id="cb142-46"><a href="tree_spatial.html#cb142-46" tabindex="-1"></a>  st_extend_line <span class="ot">&lt;-</span> <span class="cf">function</span>(line, distance, <span class="at">end =</span> <span class="st">&quot;BOTH&quot;</span>){</span>
<span id="cb142-47"><a href="tree_spatial.html#cb142-47" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>(end <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;BOTH&quot;</span>, <span class="st">&quot;HEAD&quot;</span>, <span class="st">&quot;TAIL&quot;</span>)) <span class="sc">|</span> <span class="fu">length</span>(end) <span class="sc">!=</span> <span class="dv">1</span>) <span class="fu">stop</span>(<span class="st">&quot;&#39;end&#39; must be &#39;BOTH&#39;, &#39;HEAD&#39; or &#39;TAIL&#39;&quot;</span>)</span>
<span id="cb142-48"><a href="tree_spatial.html#cb142-48" tabindex="-1"></a>  </span>
<span id="cb142-49"><a href="tree_spatial.html#cb142-49" tabindex="-1"></a>    M <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(line)[,<span class="sc">-</span><span class="dv">3</span>]</span>
<span id="cb142-50"><a href="tree_spatial.html#cb142-50" tabindex="-1"></a>    keep <span class="ot">&lt;-</span> <span class="sc">!</span>(end <span class="sc">==</span> <span class="fu">c</span>(<span class="st">&quot;TAIL&quot;</span>, <span class="st">&quot;HEAD&quot;</span>))</span>
<span id="cb142-51"><a href="tree_spatial.html#cb142-51" tabindex="-1"></a>    </span>
<span id="cb142-52"><a href="tree_spatial.html#cb142-52" tabindex="-1"></a>    ends <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(M))[keep]</span>
<span id="cb142-53"><a href="tree_spatial.html#cb142-53" tabindex="-1"></a>    headings <span class="ot">&lt;-</span> <span class="fu">st_ends_heading</span>(line)[keep] <span class="sc">/</span> <span class="dv">180</span> <span class="sc">*</span> pi</span>
<span id="cb142-54"><a href="tree_spatial.html#cb142-54" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(distance) <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">rep</span>(distance, <span class="dv">2</span>) <span class="cf">else</span> distance[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb142-55"><a href="tree_spatial.html#cb142-55" tabindex="-1"></a>    </span>
<span id="cb142-56"><a href="tree_spatial.html#cb142-56" tabindex="-1"></a>    M[ends, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> M[ends, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">+</span> distances[keep] <span class="sc">*</span> <span class="fu">c</span>(<span class="fu">cos</span>(headings), <span class="fu">sin</span>(headings))</span>
<span id="cb142-57"><a href="tree_spatial.html#cb142-57" tabindex="-1"></a>    newline <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_linestring</span>(M)</span>
<span id="cb142-58"><a href="tree_spatial.html#cb142-58" tabindex="-1"></a>  </span>
<span id="cb142-59"><a href="tree_spatial.html#cb142-59" tabindex="-1"></a>    <span class="co"># If input is sfc_LINESTRING and not sfg_LINESTRING</span></span>
<span id="cb142-60"><a href="tree_spatial.html#cb142-60" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.list</span>(line)) newline <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_sfc</span>(newline, <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(line))</span>
<span id="cb142-61"><a href="tree_spatial.html#cb142-61" tabindex="-1"></a>    </span>
<span id="cb142-62"><a href="tree_spatial.html#cb142-62" tabindex="-1"></a>    <span class="fu">return</span>(newline)</span>
<span id="cb142-63"><a href="tree_spatial.html#cb142-63" tabindex="-1"></a>  }</span>
<span id="cb142-64"><a href="tree_spatial.html#cb142-64" tabindex="-1"></a></span>
<span id="cb142-65"><a href="tree_spatial.html#cb142-65" tabindex="-1"></a><span class="co"># and apply the line extension</span></span>
<span id="cb142-66"><a href="tree_spatial.html#cb142-66" tabindex="-1"></a>  f_line_temp <span class="ot">=</span> <span class="fu">st_extend_line</span>(f_line_temp, <span class="at">distance =</span> tree_clump_dist_m)</span>
<span id="cb142-67"><a href="tree_spatial.html#cb142-67" tabindex="-1"></a>  </span>
<span id="cb142-68"><a href="tree_spatial.html#cb142-68" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb142-69"><a href="tree_spatial.html#cb142-69" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> f_line_temp, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb142-70"><a href="tree_spatial.html#cb142-70" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id<span class="sc">==</span>x<span class="sc">$</span>clump_id[<span class="dv">1</span>]), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb142-71"><a href="tree_spatial.html#cb142-71" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> x, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb142-72"><a href="tree_spatial.html#cb142-72" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;example &quot;</span>, x<span class="sc">$</span>clump_n_trees_grp[<span class="dv">1</span>], <span class="st">&quot; clump group&quot;</span>)) <span class="sc">+</span></span>
<span id="cb142-73"><a href="tree_spatial.html#cb142-73" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-63-1.png" width="1008" /></p>
<p>now draw the lines perpendicular to this furthest line which represent potential cut lines</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="tree_spatial.html#cb143-1" tabindex="-1"></a><span class="do">#### draw lines perpendicular to current line</span></span>
<span id="cb143-2"><a href="tree_spatial.html#cb143-2" tabindex="-1"></a><span class="co"># 1) points along the f line</span></span>
<span id="cb143-3"><a href="tree_spatial.html#cb143-3" tabindex="-1"></a>  line_pts_temp <span class="ot">=</span> f_line_temp <span class="sc">%&gt;%</span> </span>
<span id="cb143-4"><a href="tree_spatial.html#cb143-4" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_line_sample</span>(</span>
<span id="cb143-5"><a href="tree_spatial.html#cb143-5" tabindex="-1"></a>      <span class="at">density =</span> <span class="dv">1</span> <span class="co"># density (points per distance unit) of the sampling: 2=0.5m</span></span>
<span id="cb143-6"><a href="tree_spatial.html#cb143-6" tabindex="-1"></a>      , <span class="at">type =</span> <span class="st">&quot;regular&quot;</span></span>
<span id="cb143-7"><a href="tree_spatial.html#cb143-7" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb143-8"><a href="tree_spatial.html#cb143-8" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POINT&quot;</span>)</span>
<span id="cb143-9"><a href="tree_spatial.html#cb143-9" tabindex="-1"></a></span>
<span id="cb143-10"><a href="tree_spatial.html#cb143-10" tabindex="-1"></a><span class="do">### https://stackoverflow.com/questions/56771058/perpendicular-lines-at-regular-intervals-along-lines-with-multiple-nodes</span></span>
<span id="cb143-11"><a href="tree_spatial.html#cb143-11" tabindex="-1"></a><span class="co"># Function to calculate Euclidean distance between 2 points</span></span>
<span id="cb143-12"><a href="tree_spatial.html#cb143-12" tabindex="-1"></a>euclidean_distance <span class="ot">=</span> <span class="cf">function</span>(p1,p2) {</span>
<span id="cb143-13"><a href="tree_spatial.html#cb143-13" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sqrt</span>((p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb143-14"><a href="tree_spatial.html#cb143-14" tabindex="-1"></a>}</span>
<span id="cb143-15"><a href="tree_spatial.html#cb143-15" tabindex="-1"></a><span class="co"># euclidean_distance(</span></span>
<span id="cb143-16"><a href="tree_spatial.html#cb143-16" tabindex="-1"></a><span class="co">#   sf::st_coordinates(f_pts_temp)[1,], sf::st_coordinates(f_pts_temp)[2,] # end points on f line</span></span>
<span id="cb143-17"><a href="tree_spatial.html#cb143-17" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb143-18"><a href="tree_spatial.html#cb143-18" tabindex="-1"></a></span>
<span id="cb143-19"><a href="tree_spatial.html#cb143-19" tabindex="-1"></a><span class="co"># Function to calculate 2 points on a line perpendicular to another defined by 2 points p1,p2</span></span>
<span id="cb143-20"><a href="tree_spatial.html#cb143-20" tabindex="-1"></a><span class="co"># For point at interval, which can be a proportion of the segment length, or a constant</span></span>
<span id="cb143-21"><a href="tree_spatial.html#cb143-21" tabindex="-1"></a>get_perp_line <span class="ot">=</span> <span class="cf">function</span>(<span class="at">interval=</span><span class="fl">0.5</span>, my_line, <span class="at">proportion=</span><span class="cn">TRUE</span>) {</span>
<span id="cb143-22"><a href="tree_spatial.html#cb143-22" tabindex="-1"></a>    <span class="co"># get end points of line</span></span>
<span id="cb143-23"><a href="tree_spatial.html#cb143-23" tabindex="-1"></a>    p1 <span class="ot">=</span> my_line <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POINT&quot;</span>) <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> .[<span class="dv">1</span>,]</span>
<span id="cb143-24"><a href="tree_spatial.html#cb143-24" tabindex="-1"></a>    p2 <span class="ot">=</span> my_line <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POINT&quot;</span>) <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> .[<span class="dv">2</span>,]</span>
<span id="cb143-25"><a href="tree_spatial.html#cb143-25" tabindex="-1"></a>    <span class="co"># get length of line to return equal length line</span></span>
<span id="cb143-26"><a href="tree_spatial.html#cb143-26" tabindex="-1"></a>    line_len <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_length</span>(my_line) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">/</span><span class="st">`</span>(<span class="dv">2</span>)      </span>
<span id="cb143-27"><a href="tree_spatial.html#cb143-27" tabindex="-1"></a>    <span class="co"># get crs of line</span></span>
<span id="cb143-28"><a href="tree_spatial.html#cb143-28" tabindex="-1"></a>    my_crs <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(my_line)</span>
<span id="cb143-29"><a href="tree_spatial.html#cb143-29" tabindex="-1"></a>    </span>
<span id="cb143-30"><a href="tree_spatial.html#cb143-30" tabindex="-1"></a>    <span class="co"># Calculate x and y distances</span></span>
<span id="cb143-31"><a href="tree_spatial.html#cb143-31" tabindex="-1"></a>    x_len <span class="ot">&lt;-</span> p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]</span>
<span id="cb143-32"><a href="tree_spatial.html#cb143-32" tabindex="-1"></a>    y_len <span class="ot">&lt;-</span> p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>]</span>
<span id="cb143-33"><a href="tree_spatial.html#cb143-33" tabindex="-1"></a></span>
<span id="cb143-34"><a href="tree_spatial.html#cb143-34" tabindex="-1"></a>    <span class="co"># If proportion calculate reference point from tot_length</span></span>
<span id="cb143-35"><a href="tree_spatial.html#cb143-35" tabindex="-1"></a>    <span class="cf">if</span> (proportion) {</span>
<span id="cb143-36"><a href="tree_spatial.html#cb143-36" tabindex="-1"></a>        point <span class="ot">&lt;-</span> <span class="fu">c</span>(p1[<span class="dv">1</span>]<span class="sc">+</span>x_len<span class="sc">*</span>interval,p1[<span class="dv">2</span>]<span class="sc">+</span>y_len<span class="sc">*</span>interval)</span>
<span id="cb143-37"><a href="tree_spatial.html#cb143-37" tabindex="-1"></a>    }<span class="cf">else</span> { <span class="co"># Else use the constant value</span></span>
<span id="cb143-38"><a href="tree_spatial.html#cb143-38" tabindex="-1"></a>        tot_len <span class="ot">&lt;-</span> <span class="fu">euclidean_distance</span>(p1,p2)</span>
<span id="cb143-39"><a href="tree_spatial.html#cb143-39" tabindex="-1"></a>        point <span class="ot">&lt;-</span> <span class="fu">c</span>(p1[<span class="dv">1</span>]<span class="sc">+</span>x_len<span class="sc">/</span>tot_len<span class="sc">*</span>interval,p1[<span class="dv">2</span>]<span class="sc">+</span>y_len<span class="sc">/</span>tot_len<span class="sc">*</span>interval)</span>
<span id="cb143-40"><a href="tree_spatial.html#cb143-40" tabindex="-1"></a>    }    </span>
<span id="cb143-41"><a href="tree_spatial.html#cb143-41" tabindex="-1"></a></span>
<span id="cb143-42"><a href="tree_spatial.html#cb143-42" tabindex="-1"></a>    <span class="co"># Calculate the x and y distances from reference point to point on line line_len distance away    </span></span>
<span id="cb143-43"><a href="tree_spatial.html#cb143-43" tabindex="-1"></a>    ref_len <span class="ot">&lt;-</span> <span class="fu">euclidean_distance</span>(point,p2)</span>
<span id="cb143-44"><a href="tree_spatial.html#cb143-44" tabindex="-1"></a>    xn_len <span class="ot">&lt;-</span> (line_len <span class="sc">/</span> ref_len) <span class="sc">*</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> point[<span class="dv">1</span>])</span>
<span id="cb143-45"><a href="tree_spatial.html#cb143-45" tabindex="-1"></a>    yn_len <span class="ot">&lt;-</span> (line_len <span class="sc">/</span> ref_len) <span class="sc">*</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> point[<span class="dv">2</span>])</span>
<span id="cb143-46"><a href="tree_spatial.html#cb143-46" tabindex="-1"></a></span>
<span id="cb143-47"><a href="tree_spatial.html#cb143-47" tabindex="-1"></a>    <span class="co"># fix for identical </span></span>
<span id="cb143-48"><a href="tree_spatial.html#cb143-48" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">identical</span>(point,p2) <span class="sc">&amp;</span> x_len<span class="sc">&gt;</span>y_len){ <span class="co"># this works for horizontal line</span></span>
<span id="cb143-49"><a href="tree_spatial.html#cb143-49" tabindex="-1"></a>      xn_len <span class="ot">&lt;-</span> line_len<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb143-50"><a href="tree_spatial.html#cb143-50" tabindex="-1"></a>      yn_len <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb143-51"><a href="tree_spatial.html#cb143-51" tabindex="-1"></a>    }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">identical</span>(point,p2) <span class="sc">&amp;</span> x_len<span class="sc">&lt;</span>y_len){ <span class="co"># this works for vertical line</span></span>
<span id="cb143-52"><a href="tree_spatial.html#cb143-52" tabindex="-1"></a>      xn_len <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb143-53"><a href="tree_spatial.html#cb143-53" tabindex="-1"></a>      yn_len <span class="ot">&lt;-</span> line_len<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb143-54"><a href="tree_spatial.html#cb143-54" tabindex="-1"></a>    }</span>
<span id="cb143-55"><a href="tree_spatial.html#cb143-55" tabindex="-1"></a>    </span>
<span id="cb143-56"><a href="tree_spatial.html#cb143-56" tabindex="-1"></a>    <span class="co"># Invert the x and y lengths and add/subtract from the refrence point</span></span>
<span id="cb143-57"><a href="tree_spatial.html#cb143-57" tabindex="-1"></a>    <span class="co"># ref_points &lt;- rbind(point,c(point[1] + yn_len,point[2] - xn_len),c(point[1] - yn_len,point[2] + xn_len))</span></span>
<span id="cb143-58"><a href="tree_spatial.html#cb143-58" tabindex="-1"></a>    ref_points <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(point[<span class="dv">1</span>] <span class="sc">+</span> yn_len,point[<span class="dv">2</span>] <span class="sc">-</span> xn_len),<span class="fu">c</span>(point[<span class="dv">1</span>] <span class="sc">-</span> yn_len,point[<span class="dv">2</span>] <span class="sc">+</span> xn_len))</span>
<span id="cb143-59"><a href="tree_spatial.html#cb143-59" tabindex="-1"></a></span>
<span id="cb143-60"><a href="tree_spatial.html#cb143-60" tabindex="-1"></a>    <span class="co"># use the reference points to return a line</span></span>
<span id="cb143-61"><a href="tree_spatial.html#cb143-61" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb143-62"><a href="tree_spatial.html#cb143-62" tabindex="-1"></a>      ref_points <span class="sc">%&gt;%</span> </span>
<span id="cb143-63"><a href="tree_spatial.html#cb143-63" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb143-64"><a href="tree_spatial.html#cb143-64" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span> </span>
<span id="cb143-65"><a href="tree_spatial.html#cb143-65" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> my_crs, <span class="at">remove =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb143-66"><a href="tree_spatial.html#cb143-66" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n=</span>dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb143-67"><a href="tree_spatial.html#cb143-67" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;LINESTRING&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-68"><a href="tree_spatial.html#cb143-68" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb143-69"><a href="tree_spatial.html#cb143-69" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(n))</span>
<span id="cb143-70"><a href="tree_spatial.html#cb143-70" tabindex="-1"></a>    )</span>
<span id="cb143-71"><a href="tree_spatial.html#cb143-71" tabindex="-1"></a>}</span>
<span id="cb143-72"><a href="tree_spatial.html#cb143-72" tabindex="-1"></a><span class="co"># get_perp_line(my_line = f_line_temp, interval = 0, proportion = F)</span></span>
<span id="cb143-73"><a href="tree_spatial.html#cb143-73" tabindex="-1"></a></span>
<span id="cb143-74"><a href="tree_spatial.html#cb143-74" tabindex="-1"></a><span class="co"># 5) now get perpendicular lines in dataset which we can iterate over to make cuts</span></span>
<span id="cb143-75"><a href="tree_spatial.html#cb143-75" tabindex="-1"></a>perp_line_sf_temp <span class="ot">=</span> </span>
<span id="cb143-76"><a href="tree_spatial.html#cb143-76" tabindex="-1"></a>  <span class="co"># for every 1 m along line length, get a new perp line</span></span>
<span id="cb143-77"><a href="tree_spatial.html#cb143-77" tabindex="-1"></a>  <span class="fu">seq</span>(</span>
<span id="cb143-78"><a href="tree_spatial.html#cb143-78" tabindex="-1"></a>      <span class="at">from =</span> <span class="dv">0</span></span>
<span id="cb143-79"><a href="tree_spatial.html#cb143-79" tabindex="-1"></a>      , <span class="at">to =</span> sf<span class="sc">::</span><span class="fu">st_length</span>(f_line_temp) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span> <span class="fu">floor</span>()</span>
<span id="cb143-80"><a href="tree_spatial.html#cb143-80" tabindex="-1"></a>      , <span class="at">by =</span> <span class="dv">1</span></span>
<span id="cb143-81"><a href="tree_spatial.html#cb143-81" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb143-82"><a href="tree_spatial.html#cb143-82" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb143-83"><a href="tree_spatial.html#cb143-83" tabindex="-1"></a>    get_perp_line</span>
<span id="cb143-84"><a href="tree_spatial.html#cb143-84" tabindex="-1"></a>    , <span class="at">my_line =</span> f_line_temp, <span class="at">proportion =</span> F</span>
<span id="cb143-85"><a href="tree_spatial.html#cb143-85" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb143-86"><a href="tree_spatial.html#cb143-86" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb143-87"><a href="tree_spatial.html#cb143-87" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">line_n =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb143-88"><a href="tree_spatial.html#cb143-88" tabindex="-1"></a></span>
<span id="cb143-89"><a href="tree_spatial.html#cb143-89" tabindex="-1"></a>perp_line_sf_temp <span class="sc">%&gt;%</span> </span>
<span id="cb143-90"><a href="tree_spatial.html#cb143-90" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb143-91"><a href="tree_spatial.html#cb143-91" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb143-92"><a href="tree_spatial.html#cb143-92" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> f_line_temp, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb143-93"><a href="tree_spatial.html#cb143-93" tabindex="-1"></a>    <span class="co"># geom_sf(data = line_pts_temp, color = &quot;red&quot;, size = 1.5, fill = NA, shape = 21) +</span></span>
<span id="cb143-94"><a href="tree_spatial.html#cb143-94" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id<span class="sc">==</span>x<span class="sc">$</span>clump_id[<span class="dv">1</span>]), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb143-95"><a href="tree_spatial.html#cb143-95" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> x, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb143-96"><a href="tree_spatial.html#cb143-96" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb143-97"><a href="tree_spatial.html#cb143-97" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;example &quot;</span>, x<span class="sc">$</span>clump_n_trees_grp[<span class="dv">1</span>], <span class="st">&quot; clump group&quot;</span>)</span>
<span id="cb143-98"><a href="tree_spatial.html#cb143-98" tabindex="-1"></a>      , <span class="at">caption =</span> <span class="st">&quot;*potential cut lines shown in light blue&quot;</span></span>
<span id="cb143-99"><a href="tree_spatial.html#cb143-99" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb143-100"><a href="tree_spatial.html#cb143-100" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-64-1.png" width="1008" /></p>
<p>intersect the potential cut lines with the clump polygon to identify the length of the line intersection</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="tree_spatial.html#cb144-1" tabindex="-1"></a><span class="co"># 6) find intersection of lines with the polygon and add length of intersection to perp line data</span></span>
<span id="cb144-2"><a href="tree_spatial.html#cb144-2" tabindex="-1"></a>perp_line_sf_temp <span class="ot">=</span> perp_line_sf_temp <span class="sc">%&gt;%</span> </span>
<span id="cb144-3"><a href="tree_spatial.html#cb144-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb144-4"><a href="tree_spatial.html#cb144-4" tabindex="-1"></a>    <span class="co"># intersect and calc len</span></span>
<span id="cb144-5"><a href="tree_spatial.html#cb144-5" tabindex="-1"></a>    perp_line_sf_temp <span class="sc">%&gt;%</span> </span>
<span id="cb144-6"><a href="tree_spatial.html#cb144-6" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb144-7"><a href="tree_spatial.html#cb144-7" tabindex="-1"></a>        clump_polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb144-8"><a href="tree_spatial.html#cb144-8" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb144-9"><a href="tree_spatial.html#cb144-9" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb144-10"><a href="tree_spatial.html#cb144-10" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id <span class="sc">==</span> x<span class="sc">$</span>clump_id[<span class="dv">1</span>])</span>
<span id="cb144-11"><a href="tree_spatial.html#cb144-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb144-12"><a href="tree_spatial.html#cb144-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">len_m =</span> sf<span class="sc">::</span><span class="fu">st_length</span>(geometry) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb144-13"><a href="tree_spatial.html#cb144-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb144-14"><a href="tree_spatial.html#cb144-14" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;line_n&quot;</span></span>
<span id="cb144-15"><a href="tree_spatial.html#cb144-15" tabindex="-1"></a>  )</span>
<span id="cb144-16"><a href="tree_spatial.html#cb144-16" tabindex="-1"></a></span>
<span id="cb144-17"><a href="tree_spatial.html#cb144-17" tabindex="-1"></a>perp_line_sf_temp <span class="sc">%&gt;%</span> </span>
<span id="cb144-18"><a href="tree_spatial.html#cb144-18" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb144-19"><a href="tree_spatial.html#cb144-19" tabindex="-1"></a>    clump_polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb144-20"><a href="tree_spatial.html#cb144-20" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb144-21"><a href="tree_spatial.html#cb144-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb144-22"><a href="tree_spatial.html#cb144-22" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id <span class="sc">==</span> x<span class="sc">$</span>clump_id[<span class="dv">1</span>])</span>
<span id="cb144-23"><a href="tree_spatial.html#cb144-23" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb144-24"><a href="tree_spatial.html#cb144-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">len_m =</span> sf<span class="sc">::</span><span class="fu">st_length</span>(geometry) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb144-25"><a href="tree_spatial.html#cb144-25" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb144-26"><a href="tree_spatial.html#cb144-26" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> len_m), <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb144-27"><a href="tree_spatial.html#cb144-27" tabindex="-1"></a>    <span class="fu">scale_color_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Greys&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb144-28"><a href="tree_spatial.html#cb144-28" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> f_line_temp, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb144-29"><a href="tree_spatial.html#cb144-29" tabindex="-1"></a>    <span class="co"># geom_sf(data = line_pts_temp, color = &quot;red&quot;, size = 1.5, fill = NA, shape = 21) +</span></span>
<span id="cb144-30"><a href="tree_spatial.html#cb144-30" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id<span class="sc">==</span>x<span class="sc">$</span>clump_id[<span class="dv">1</span>]), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb144-31"><a href="tree_spatial.html#cb144-31" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> x, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb144-32"><a href="tree_spatial.html#cb144-32" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb144-33"><a href="tree_spatial.html#cb144-33" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;example &quot;</span>, x<span class="sc">$</span>clump_n_trees_grp[<span class="dv">1</span>], <span class="st">&quot; clump group&quot;</span>)</span>
<span id="cb144-34"><a href="tree_spatial.html#cb144-34" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;cut line</span><span class="sc">\n</span><span class="st">length (m)&quot;</span></span>
<span id="cb144-35"><a href="tree_spatial.html#cb144-35" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb144-36"><a href="tree_spatial.html#cb144-36" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-66-1.png" width="1008" /></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="tree_spatial.html#cb145-1" tabindex="-1"></a>  <span class="co"># perp_line_sf_temp %&gt;% ggplot(aes(x = len_m)) + geom_histogram()</span></span></code></pre></div>
<p>start cutting at the narrowest places using the shortest cut line intersection length until we get the desired clump size group(s) (i.e. the next smallest clump size)</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="tree_spatial.html#cb146-1" tabindex="-1"></a><span class="co"># 7) make cuts at the points where there is the least overlap with the clump polygon</span></span>
<span id="cb146-2"><a href="tree_spatial.html#cb146-2" tabindex="-1"></a>  <span class="co"># list of potential line cut + tree combinations</span></span>
<span id="cb146-3"><a href="tree_spatial.html#cb146-3" tabindex="-1"></a>  <span class="co"># aggregate the mean length of the intersecting cut lines to the tree level</span></span>
<span id="cb146-4"><a href="tree_spatial.html#cb146-4" tabindex="-1"></a>  <span class="co"># prioritize trees for removal that have smallest length</span></span>
<span id="cb146-5"><a href="tree_spatial.html#cb146-5" tabindex="-1"></a>  cut_tree_lines_temp <span class="ot">=</span> </span>
<span id="cb146-6"><a href="tree_spatial.html#cb146-6" tabindex="-1"></a>    x <span class="sc">%&gt;%</span> </span>
<span id="cb146-7"><a href="tree_spatial.html#cb146-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_buffer</span>(tree_clump_dist_m<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb146-8"><a href="tree_spatial.html#cb146-8" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_join</span>(perp_line_sf_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb146-9"><a href="tree_spatial.html#cb146-9" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-10"><a href="tree_spatial.html#cb146-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb146-11"><a href="tree_spatial.html#cb146-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">len_m =</span> <span class="fu">mean</span>(len_m, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb146-12"><a href="tree_spatial.html#cb146-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-13"><a href="tree_spatial.html#cb146-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(len_m, treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb146-14"><a href="tree_spatial.html#cb146-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb146-15"><a href="tree_spatial.html#cb146-15" tabindex="-1"></a>  <span class="do">###############################################################</span></span>
<span id="cb146-16"><a href="tree_spatial.html#cb146-16" tabindex="-1"></a>  <span class="co"># while</span></span>
<span id="cb146-17"><a href="tree_spatial.html#cb146-17" tabindex="-1"></a>  <span class="do">###############################################################</span></span>
<span id="cb146-18"><a href="tree_spatial.html#cb146-18" tabindex="-1"></a>  <span class="co"># cut until the desired clump size is achieved</span></span>
<span id="cb146-19"><a href="tree_spatial.html#cb146-19" tabindex="-1"></a>  while_temp <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb146-20"><a href="tree_spatial.html#cb146-20" tabindex="-1"></a>  i <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb146-21"><a href="tree_spatial.html#cb146-21" tabindex="-1"></a>  <span class="cf">while</span>(while_temp<span class="sc">==</span><span class="dv">1</span>) {</span>
<span id="cb146-22"><a href="tree_spatial.html#cb146-22" tabindex="-1"></a>    <span class="co"># cut trees</span></span>
<span id="cb146-23"><a href="tree_spatial.html#cb146-23" tabindex="-1"></a>    cut_trees_temp <span class="ot">=</span> cut_tree_lines_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-24"><a href="tree_spatial.html#cb146-24" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>i) <span class="sc">%&gt;%</span> </span>
<span id="cb146-25"><a href="tree_spatial.html#cb146-25" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(treeID)</span>
<span id="cb146-26"><a href="tree_spatial.html#cb146-26" tabindex="-1"></a>    </span>
<span id="cb146-27"><a href="tree_spatial.html#cb146-27" tabindex="-1"></a>    <span class="co"># get the remaining trees not cut</span></span>
<span id="cb146-28"><a href="tree_spatial.html#cb146-28" tabindex="-1"></a>    trees_remain_temp <span class="ot">=</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb146-29"><a href="tree_spatial.html#cb146-29" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">anti_join</span>(cut_trees_temp, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb146-30"><a href="tree_spatial.html#cb146-30" tabindex="-1"></a>    </span>
<span id="cb146-31"><a href="tree_spatial.html#cb146-31" tabindex="-1"></a>    <span class="co"># ensure that there are trees</span></span>
<span id="cb146-32"><a href="tree_spatial.html#cb146-32" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(trees_remain_temp)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb146-33"><a href="tree_spatial.html#cb146-33" tabindex="-1"></a>      <span class="co"># there are no more possible cuts :/</span></span>
<span id="cb146-34"><a href="tree_spatial.html#cb146-34" tabindex="-1"></a>      best_cuts <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">treeID =</span> <span class="fu">character</span>())</span>
<span id="cb146-35"><a href="tree_spatial.html#cb146-35" tabindex="-1"></a>      <span class="co"># stop it</span></span>
<span id="cb146-36"><a href="tree_spatial.html#cb146-36" tabindex="-1"></a>      while_temp <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb146-37"><a href="tree_spatial.html#cb146-37" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb146-38"><a href="tree_spatial.html#cb146-38" tabindex="-1"></a>        <span class="co"># count the groups remaining after cuts</span></span>
<span id="cb146-39"><a href="tree_spatial.html#cb146-39" tabindex="-1"></a>        desired_grps_n_temp <span class="ot">=</span> trees_remain_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-40"><a href="tree_spatial.html#cb146-40" tabindex="-1"></a>          <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> tree_clump_dist_m) <span class="sc">%&gt;%</span> </span>
<span id="cb146-41"><a href="tree_spatial.html#cb146-41" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-42"><a href="tree_spatial.html#cb146-42" tabindex="-1"></a>          <span class="co"># do we have group sizes we want?</span></span>
<span id="cb146-43"><a href="tree_spatial.html#cb146-43" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> ntree_target_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb146-44"><a href="tree_spatial.html#cb146-44" tabindex="-1"></a>          <span class="fu">nrow</span>()</span>
<span id="cb146-45"><a href="tree_spatial.html#cb146-45" tabindex="-1"></a>        <span class="do">### store best cut list</span></span>
<span id="cb146-46"><a href="tree_spatial.html#cb146-46" tabindex="-1"></a>        <span class="cf">if</span>(i<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb146-47"><a href="tree_spatial.html#cb146-47" tabindex="-1"></a>          best_cuts <span class="ot">=</span> cut_trees_temp</span>
<span id="cb146-48"><a href="tree_spatial.html#cb146-48" tabindex="-1"></a>          best_desired_grps_n_temp <span class="ot">=</span> desired_grps_n_temp</span>
<span id="cb146-49"><a href="tree_spatial.html#cb146-49" tabindex="-1"></a>        }<span class="cf">else</span> <span class="cf">if</span>(desired_grps_n_temp<span class="sc">&gt;</span>best_desired_grps_n_temp){ <span class="co"># is this better than the best</span></span>
<span id="cb146-50"><a href="tree_spatial.html#cb146-50" tabindex="-1"></a>          best_cuts <span class="ot">=</span> cut_trees_temp</span>
<span id="cb146-51"><a href="tree_spatial.html#cb146-51" tabindex="-1"></a>          best_desired_grps_n_temp <span class="ot">=</span> desired_grps_n_temp</span>
<span id="cb146-52"><a href="tree_spatial.html#cb146-52" tabindex="-1"></a>        }<span class="cf">else</span> <span class="cf">if</span>(</span>
<span id="cb146-53"><a href="tree_spatial.html#cb146-53" tabindex="-1"></a>          best_desired_grps_n_temp<span class="sc">&gt;</span><span class="dv">0</span> </span>
<span id="cb146-54"><a href="tree_spatial.html#cb146-54" tabindex="-1"></a>          <span class="sc">&amp;</span> desired_grps_n_temp<span class="sc">&lt;</span>best_desired_grps_n_temp</span>
<span id="cb146-55"><a href="tree_spatial.html#cb146-55" tabindex="-1"></a>        ){ <span class="co"># is this worse than the best which was successful?</span></span>
<span id="cb146-56"><a href="tree_spatial.html#cb146-56" tabindex="-1"></a>          <span class="do">###############################</span></span>
<span id="cb146-57"><a href="tree_spatial.html#cb146-57" tabindex="-1"></a>          <span class="co"># add trees back in until gets worse</span></span>
<span id="cb146-58"><a href="tree_spatial.html#cb146-58" tabindex="-1"></a>          <span class="do">###############################</span></span>
<span id="cb146-59"><a href="tree_spatial.html#cb146-59" tabindex="-1"></a>          j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb146-60"><a href="tree_spatial.html#cb146-60" tabindex="-1"></a>          while_add <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb146-61"><a href="tree_spatial.html#cb146-61" tabindex="-1"></a>          <span class="cf">while</span>(while_add<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb146-62"><a href="tree_spatial.html#cb146-62" tabindex="-1"></a>            <span class="co"># cut trees</span></span>
<span id="cb146-63"><a href="tree_spatial.html#cb146-63" tabindex="-1"></a>            cut_trees_temp <span class="ot">=</span> best_cuts <span class="sc">%&gt;%</span> </span>
<span id="cb146-64"><a href="tree_spatial.html#cb146-64" tabindex="-1"></a>              <span class="co"># add trees back in (i.e. remove them from the cut trees)</span></span>
<span id="cb146-65"><a href="tree_spatial.html#cb146-65" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb146-66"><a href="tree_spatial.html#cb146-66" tabindex="-1"></a>                cut_tree_lines_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-67"><a href="tree_spatial.html#cb146-67" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>j) <span class="sc">%&gt;%</span> </span>
<span id="cb146-68"><a href="tree_spatial.html#cb146-68" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">distinct</span>(treeID)</span>
<span id="cb146-69"><a href="tree_spatial.html#cb146-69" tabindex="-1"></a>                , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb146-70"><a href="tree_spatial.html#cb146-70" tabindex="-1"></a>              )</span>
<span id="cb146-71"><a href="tree_spatial.html#cb146-71" tabindex="-1"></a>            <span class="co"># get the remaining trees not cut</span></span>
<span id="cb146-72"><a href="tree_spatial.html#cb146-72" tabindex="-1"></a>            trees_remain_temp <span class="ot">=</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb146-73"><a href="tree_spatial.html#cb146-73" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">anti_join</span>(cut_trees_temp, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb146-74"><a href="tree_spatial.html#cb146-74" tabindex="-1"></a>            </span>
<span id="cb146-75"><a href="tree_spatial.html#cb146-75" tabindex="-1"></a>            <span class="co"># count the groups remaining after cuts</span></span>
<span id="cb146-76"><a href="tree_spatial.html#cb146-76" tabindex="-1"></a>            desired_grps_n_temp <span class="ot">=</span> trees_remain_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-77"><a href="tree_spatial.html#cb146-77" tabindex="-1"></a>              <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> tree_clump_dist_m) <span class="sc">%&gt;%</span> </span>
<span id="cb146-78"><a href="tree_spatial.html#cb146-78" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-79"><a href="tree_spatial.html#cb146-79" tabindex="-1"></a>              <span class="co"># do we have group sizes we want?</span></span>
<span id="cb146-80"><a href="tree_spatial.html#cb146-80" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> ntree_target_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb146-81"><a href="tree_spatial.html#cb146-81" tabindex="-1"></a>              <span class="fu">nrow</span>()</span>
<span id="cb146-82"><a href="tree_spatial.html#cb146-82" tabindex="-1"></a>            </span>
<span id="cb146-83"><a href="tree_spatial.html#cb146-83" tabindex="-1"></a>            <span class="cf">if</span>(desired_grps_n_temp<span class="sc">&gt;=</span>best_desired_grps_n_temp){ <span class="co"># is this better than the best</span></span>
<span id="cb146-84"><a href="tree_spatial.html#cb146-84" tabindex="-1"></a>              best_cuts <span class="ot">=</span> cut_trees_temp</span>
<span id="cb146-85"><a href="tree_spatial.html#cb146-85" tabindex="-1"></a>              best_desired_grps_n_temp <span class="ot">=</span> desired_grps_n_temp</span>
<span id="cb146-86"><a href="tree_spatial.html#cb146-86" tabindex="-1"></a>            }<span class="cf">else</span>(</span>
<span id="cb146-87"><a href="tree_spatial.html#cb146-87" tabindex="-1"></a>              <span class="co"># stop it</span></span>
<span id="cb146-88"><a href="tree_spatial.html#cb146-88" tabindex="-1"></a>              <span class="at">while_add =</span> <span class="dv">0</span>  </span>
<span id="cb146-89"><a href="tree_spatial.html#cb146-89" tabindex="-1"></a>            )</span>
<span id="cb146-90"><a href="tree_spatial.html#cb146-90" tabindex="-1"></a>            <span class="co"># increment</span></span>
<span id="cb146-91"><a href="tree_spatial.html#cb146-91" tabindex="-1"></a>            j <span class="ot">=</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb146-92"><a href="tree_spatial.html#cb146-92" tabindex="-1"></a>          }</span>
<span id="cb146-93"><a href="tree_spatial.html#cb146-93" tabindex="-1"></a>          <span class="co"># stop it</span></span>
<span id="cb146-94"><a href="tree_spatial.html#cb146-94" tabindex="-1"></a>          while_temp <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb146-95"><a href="tree_spatial.html#cb146-95" tabindex="-1"></a>        }<span class="cf">else</span> <span class="cf">if</span>( <span class="co"># is this the end?</span></span>
<span id="cb146-96"><a href="tree_spatial.html#cb146-96" tabindex="-1"></a>          i<span class="sc">==</span><span class="fu">nrow</span>(cut_tree_lines_temp)</span>
<span id="cb146-97"><a href="tree_spatial.html#cb146-97" tabindex="-1"></a>        ){</span>
<span id="cb146-98"><a href="tree_spatial.html#cb146-98" tabindex="-1"></a>          <span class="co"># stop it</span></span>
<span id="cb146-99"><a href="tree_spatial.html#cb146-99" tabindex="-1"></a>          while_temp <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb146-100"><a href="tree_spatial.html#cb146-100" tabindex="-1"></a>        }</span>
<span id="cb146-101"><a href="tree_spatial.html#cb146-101" tabindex="-1"></a>        <span class="do">### increment</span></span>
<span id="cb146-102"><a href="tree_spatial.html#cb146-102" tabindex="-1"></a>        i <span class="ot">=</span> i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb146-103"><a href="tree_spatial.html#cb146-103" tabindex="-1"></a>    }</span>
<span id="cb146-104"><a href="tree_spatial.html#cb146-104" tabindex="-1"></a>  }</span>
<span id="cb146-105"><a href="tree_spatial.html#cb146-105" tabindex="-1"></a>  </span>
<span id="cb146-106"><a href="tree_spatial.html#cb146-106" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb146-107"><a href="tree_spatial.html#cb146-107" tabindex="-1"></a>  x <span class="sc">%&gt;%</span> </span>
<span id="cb146-108"><a href="tree_spatial.html#cb146-108" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(best_cuts, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb146-109"><a href="tree_spatial.html#cb146-109" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb146-110"><a href="tree_spatial.html#cb146-110" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb146-111"><a href="tree_spatial.html#cb146-111" tabindex="-1"></a>      <span class="at">data =</span> <span class="co"># cut line segs</span></span>
<span id="cb146-112"><a href="tree_spatial.html#cb146-112" tabindex="-1"></a>        perp_line_sf_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-113"><a href="tree_spatial.html#cb146-113" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb146-114"><a href="tree_spatial.html#cb146-114" tabindex="-1"></a>          clump_polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-115"><a href="tree_spatial.html#cb146-115" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-116"><a href="tree_spatial.html#cb146-116" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb146-117"><a href="tree_spatial.html#cb146-117" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id <span class="sc">==</span> x<span class="sc">$</span>clump_id[<span class="dv">1</span>])</span>
<span id="cb146-118"><a href="tree_spatial.html#cb146-118" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb146-119"><a href="tree_spatial.html#cb146-119" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">len_m =</span> sf<span class="sc">::</span><span class="fu">st_length</span>(geometry) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>())</span>
<span id="cb146-120"><a href="tree_spatial.html#cb146-120" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> len_m), <span class="at">lwd =</span> <span class="fl">0.8</span></span>
<span id="cb146-121"><a href="tree_spatial.html#cb146-121" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb146-122"><a href="tree_spatial.html#cb146-122" tabindex="-1"></a>    <span class="fu">scale_color_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Greys&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb146-123"><a href="tree_spatial.html#cb146-123" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> f_line_temp, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb146-124"><a href="tree_spatial.html#cb146-124" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id<span class="sc">==</span>x<span class="sc">$</span>clump_id[<span class="dv">1</span>]), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb146-125"><a href="tree_spatial.html#cb146-125" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> x, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb146-126"><a href="tree_spatial.html#cb146-126" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb146-127"><a href="tree_spatial.html#cb146-127" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb146-128"><a href="tree_spatial.html#cb146-128" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;example &quot;</span>, x<span class="sc">$</span>clump_n_trees_grp[<span class="dv">1</span>], <span class="st">&quot; clump group&quot;</span>)</span>
<span id="cb146-129"><a href="tree_spatial.html#cb146-129" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;cut line</span><span class="sc">\n</span><span class="st">length (m)&quot;</span></span>
<span id="cb146-130"><a href="tree_spatial.html#cb146-130" tabindex="-1"></a>      , <span class="at">caption =</span> <span class="st">&quot;*cut trees shown in red&quot;</span></span>
<span id="cb146-131"><a href="tree_spatial.html#cb146-131" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb146-132"><a href="tree_spatial.html#cb146-132" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-68-1.png" width="1008" /></p>
<p>and here are the remaining clump sizes after cutting</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="tree_spatial.html#cb147-1" tabindex="-1"></a><span class="co"># get dbscan</span></span>
<span id="cb147-2"><a href="tree_spatial.html#cb147-2" tabindex="-1"></a>  my_dbscan_temp <span class="ot">=</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb147-3"><a href="tree_spatial.html#cb147-3" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb147-4"><a href="tree_spatial.html#cb147-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">anti_join</span>(best_cuts, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-5"><a href="tree_spatial.html#cb147-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y) <span class="sc">%&gt;%</span> </span>
<span id="cb147-6"><a href="tree_spatial.html#cb147-6" tabindex="-1"></a>      dbscan<span class="sc">::</span><span class="fu">dbscan</span>(<span class="at">eps =</span> tree_clump_dist_m, <span class="at">minPts =</span> <span class="dv">2</span>)</span>
<span id="cb147-7"><a href="tree_spatial.html#cb147-7" tabindex="-1"></a><span class="co"># attach dbscan</span></span>
<span id="cb147-8"><a href="tree_spatial.html#cb147-8" tabindex="-1"></a>t_temp <span class="ot">=</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb147-9"><a href="tree_spatial.html#cb147-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">anti_join</span>(best_cuts, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-10"><a href="tree_spatial.html#cb147-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dbscan_cluster =</span> my_dbscan_temp<span class="sc">$</span>cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb147-11"><a href="tree_spatial.html#cb147-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(dbscan_cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb147-12"><a href="tree_spatial.html#cb147-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb147-13"><a href="tree_spatial.html#cb147-13" tabindex="-1"></a>    <span class="co"># unique dbscan_cluster for individuals</span></span>
<span id="cb147-14"><a href="tree_spatial.html#cb147-14" tabindex="-1"></a>    <span class="at">clump_id =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb147-15"><a href="tree_spatial.html#cb147-15" tabindex="-1"></a>      dbscan_cluster <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">max</span>(my_dbscan_temp<span class="sc">$</span>cluster)<span class="sc">+</span>dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb147-16"><a href="tree_spatial.html#cb147-16" tabindex="-1"></a>      , T <span class="sc">~</span> dbscan_cluster</span>
<span id="cb147-17"><a href="tree_spatial.html#cb147-17" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb147-18"><a href="tree_spatial.html#cb147-18" tabindex="-1"></a>    <span class="fu">factor</span>()</span>
<span id="cb147-19"><a href="tree_spatial.html#cb147-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb147-20"><a href="tree_spatial.html#cb147-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb147-21"><a href="tree_spatial.html#cb147-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb147-22"><a href="tree_spatial.html#cb147-22" tabindex="-1"></a>    <span class="at">dbscan_cluster =</span> <span class="fu">factor</span>(dbscan_cluster)</span>
<span id="cb147-23"><a href="tree_spatial.html#cb147-23" tabindex="-1"></a>    , <span class="at">clump_n_trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb147-24"><a href="tree_spatial.html#cb147-24" tabindex="-1"></a>    , <span class="at">clump_n_trees_grp =</span> <span class="fu">cut</span>(</span>
<span id="cb147-25"><a href="tree_spatial.html#cb147-25" tabindex="-1"></a>        clump_n_trees</span>
<span id="cb147-26"><a href="tree_spatial.html#cb147-26" tabindex="-1"></a>        ,<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="cn">Inf</span>)</span>
<span id="cb147-27"><a href="tree_spatial.html#cb147-27" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>,<span class="st">&quot;2-4 trees&quot;</span>,<span class="st">&quot;5-9 trees&quot;</span>,<span class="st">&quot;10-15 trees&quot;</span>,<span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb147-28"><a href="tree_spatial.html#cb147-28" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb147-29"><a href="tree_spatial.html#cb147-29" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb147-30"><a href="tree_spatial.html#cb147-30" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb147-31"><a href="tree_spatial.html#cb147-31" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>,<span class="st">&quot;2-4 trees&quot;</span>,<span class="st">&quot;5-9 trees&quot;</span>,<span class="st">&quot;10-15 trees&quot;</span>,<span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb147-32"><a href="tree_spatial.html#cb147-32" tabindex="-1"></a>      )</span>
<span id="cb147-33"><a href="tree_spatial.html#cb147-33" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb147-34"><a href="tree_spatial.html#cb147-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb147-35"><a href="tree_spatial.html#cb147-35" tabindex="-1"></a></span>
<span id="cb147-36"><a href="tree_spatial.html#cb147-36" tabindex="-1"></a></span>
<span id="cb147-37"><a href="tree_spatial.html#cb147-37" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb147-38"><a href="tree_spatial.html#cb147-38" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb147-39"><a href="tree_spatial.html#cb147-39" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> f_line_temp, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb147-40"><a href="tree_spatial.html#cb147-40" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb147-41"><a href="tree_spatial.html#cb147-41" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">get_clump_summary</span>(t_temp)</span>
<span id="cb147-42"><a href="tree_spatial.html#cb147-42" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_n_trees_grp)</span>
<span id="cb147-43"><a href="tree_spatial.html#cb147-43" tabindex="-1"></a>      , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb147-44"><a href="tree_spatial.html#cb147-44" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb147-45"><a href="tree_spatial.html#cb147-45" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_d</span>(<span class="at">option=</span><span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">&quot;clump size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb147-46"><a href="tree_spatial.html#cb147-46" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id<span class="sc">==</span>x<span class="sc">$</span>clump_id[<span class="dv">1</span>]), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb147-47"><a href="tree_spatial.html#cb147-47" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> t_temp, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-48"><a href="tree_spatial.html#cb147-48" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb147-49"><a href="tree_spatial.html#cb147-49" tabindex="-1"></a>      <span class="at">data =</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb147-50"><a href="tree_spatial.html#cb147-50" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(best_cuts, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb147-51"><a href="tree_spatial.html#cb147-51" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb147-52"><a href="tree_spatial.html#cb147-52" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb147-53"><a href="tree_spatial.html#cb147-53" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb147-54"><a href="tree_spatial.html#cb147-54" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;example &quot;</span>, x<span class="sc">$</span>clump_n_trees_grp[<span class="dv">1</span>], <span class="st">&quot; clump group</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;*Residual clump groups highlighted&quot;</span>)</span>
<span id="cb147-55"><a href="tree_spatial.html#cb147-55" tabindex="-1"></a>      <span class="co"># , color = &quot;cut line\nlength (m)&quot;</span></span>
<span id="cb147-56"><a href="tree_spatial.html#cb147-56" tabindex="-1"></a>      , <span class="at">caption =</span> <span class="st">&quot;*cut trees shown in red&quot;</span></span>
<span id="cb147-57"><a href="tree_spatial.html#cb147-57" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb147-58"><a href="tree_spatial.html#cb147-58" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-69-1.png" width="1008" /></p>
</div>
<div id="cut_clump_ex" class="section level4 hasAnchor" number="9.2.4.2">
<h4><span class="header-section-number">9.2.4.2</span> Function to cut clumps<a href="tree_spatial.html#cut_clump_ex" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>put the entire process outlined immediately above into a function to use with the tree list which we’ll nest by <code>clump_id</code> to cut each clump and then we’ll select the desired proportion of clumps</p>
<div id="define-intermediate-functions" class="section level5 hasAnchor" number="9.2.4.2.1">
<h5><span class="header-section-number">9.2.4.2.1</span> define intermediate functions<a href="tree_spatial.html#define-intermediate-functions" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>define intermediate functions</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="tree_spatial.html#cb148-1" tabindex="-1"></a><span class="do">##############################################</span></span>
<span id="cb148-2"><a href="tree_spatial.html#cb148-2" tabindex="-1"></a><span class="co"># working with sf LINESTRINGS</span></span>
<span id="cb148-3"><a href="tree_spatial.html#cb148-3" tabindex="-1"></a><span class="do">##############################################</span></span>
<span id="cb148-4"><a href="tree_spatial.html#cb148-4" tabindex="-1"></a>  <span class="co"># first two functions borrowed from https://github.com/metafor-ulaval/ALSroads/blob/main/R/line_tools.R</span></span>
<span id="cb148-5"><a href="tree_spatial.html#cb148-5" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-6"><a href="tree_spatial.html#cb148-6" tabindex="-1"></a>  <span class="co"># Get heading of both ends of a line</span></span>
<span id="cb148-7"><a href="tree_spatial.html#cb148-7" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-8"><a href="tree_spatial.html#cb148-8" tabindex="-1"></a>    st_ends_heading <span class="ot">&lt;-</span> <span class="cf">function</span>(line){</span>
<span id="cb148-9"><a href="tree_spatial.html#cb148-9" tabindex="-1"></a>      M <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(line)</span>
<span id="cb148-10"><a href="tree_spatial.html#cb148-10" tabindex="-1"></a>      i <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fu">nrow</span>(M) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb148-11"><a href="tree_spatial.html#cb148-11" tabindex="-1"></a>      j <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb148-12"><a href="tree_spatial.html#cb148-12" tabindex="-1"></a>      </span>
<span id="cb148-13"><a href="tree_spatial.html#cb148-13" tabindex="-1"></a>      headings <span class="ot">&lt;-</span> <span class="fu">mapply</span>(i, j, <span class="at">FUN =</span> <span class="cf">function</span>(i, j) {</span>
<span id="cb148-14"><a href="tree_spatial.html#cb148-14" tabindex="-1"></a>        Ax <span class="ot">=</span> M[i<span class="sc">-</span>j,<span class="dv">1</span>]</span>
<span id="cb148-15"><a href="tree_spatial.html#cb148-15" tabindex="-1"></a>        Ay <span class="ot">=</span> M[i<span class="sc">-</span>j,<span class="dv">2</span>]</span>
<span id="cb148-16"><a href="tree_spatial.html#cb148-16" tabindex="-1"></a>        Bx <span class="ot">=</span> M[i,<span class="dv">1</span>]</span>
<span id="cb148-17"><a href="tree_spatial.html#cb148-17" tabindex="-1"></a>        By <span class="ot">=</span> M[i,<span class="dv">2</span>]</span>
<span id="cb148-18"><a href="tree_spatial.html#cb148-18" tabindex="-1"></a>        <span class="fu">atan2</span>(Ay<span class="sc">-</span>By, Ax<span class="sc">-</span>Bx)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi</span>
<span id="cb148-19"><a href="tree_spatial.html#cb148-19" tabindex="-1"></a>      })</span>
<span id="cb148-20"><a href="tree_spatial.html#cb148-20" tabindex="-1"></a>      <span class="fu">names</span>(headings) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;head&quot;</span>, <span class="st">&quot;tail&quot;</span>)</span>
<span id="cb148-21"><a href="tree_spatial.html#cb148-21" tabindex="-1"></a>      <span class="fu">return</span>(headings)</span>
<span id="cb148-22"><a href="tree_spatial.html#cb148-22" tabindex="-1"></a>    }</span>
<span id="cb148-23"><a href="tree_spatial.html#cb148-23" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-24"><a href="tree_spatial.html#cb148-24" tabindex="-1"></a>  <span class="co"># extend the line on both ends</span></span>
<span id="cb148-25"><a href="tree_spatial.html#cb148-25" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-26"><a href="tree_spatial.html#cb148-26" tabindex="-1"></a>    st_extend_line <span class="ot">&lt;-</span> <span class="cf">function</span>(line, distance, <span class="at">end =</span> <span class="st">&quot;BOTH&quot;</span>){</span>
<span id="cb148-27"><a href="tree_spatial.html#cb148-27" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>(end <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;BOTH&quot;</span>, <span class="st">&quot;HEAD&quot;</span>, <span class="st">&quot;TAIL&quot;</span>)) <span class="sc">|</span> <span class="fu">length</span>(end) <span class="sc">!=</span> <span class="dv">1</span>) <span class="fu">stop</span>(<span class="st">&quot;&#39;end&#39; must be &#39;BOTH&#39;, &#39;HEAD&#39; or &#39;TAIL&#39;&quot;</span>)</span>
<span id="cb148-28"><a href="tree_spatial.html#cb148-28" tabindex="-1"></a>    </span>
<span id="cb148-29"><a href="tree_spatial.html#cb148-29" tabindex="-1"></a>      M <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(line)[,<span class="sc">-</span><span class="dv">3</span>]</span>
<span id="cb148-30"><a href="tree_spatial.html#cb148-30" tabindex="-1"></a>      keep <span class="ot">&lt;-</span> <span class="sc">!</span>(end <span class="sc">==</span> <span class="fu">c</span>(<span class="st">&quot;TAIL&quot;</span>, <span class="st">&quot;HEAD&quot;</span>))</span>
<span id="cb148-31"><a href="tree_spatial.html#cb148-31" tabindex="-1"></a>      </span>
<span id="cb148-32"><a href="tree_spatial.html#cb148-32" tabindex="-1"></a>      ends <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(M))[keep]</span>
<span id="cb148-33"><a href="tree_spatial.html#cb148-33" tabindex="-1"></a>      headings <span class="ot">&lt;-</span> <span class="fu">st_ends_heading</span>(line)[keep] <span class="sc">/</span> <span class="dv">180</span> <span class="sc">*</span> pi</span>
<span id="cb148-34"><a href="tree_spatial.html#cb148-34" tabindex="-1"></a>      distances <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(distance) <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">rep</span>(distance, <span class="dv">2</span>) <span class="cf">else</span> distance[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb148-35"><a href="tree_spatial.html#cb148-35" tabindex="-1"></a>      </span>
<span id="cb148-36"><a href="tree_spatial.html#cb148-36" tabindex="-1"></a>      M[ends, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> M[ends, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">+</span> distances[keep] <span class="sc">*</span> <span class="fu">c</span>(<span class="fu">cos</span>(headings), <span class="fu">sin</span>(headings))</span>
<span id="cb148-37"><a href="tree_spatial.html#cb148-37" tabindex="-1"></a>      newline <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_linestring</span>(M)</span>
<span id="cb148-38"><a href="tree_spatial.html#cb148-38" tabindex="-1"></a>    </span>
<span id="cb148-39"><a href="tree_spatial.html#cb148-39" tabindex="-1"></a>      <span class="co"># If input is sfc_LINESTRING and not sfg_LINESTRING</span></span>
<span id="cb148-40"><a href="tree_spatial.html#cb148-40" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.list</span>(line)) newline <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_sfc</span>(newline, <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(line))</span>
<span id="cb148-41"><a href="tree_spatial.html#cb148-41" tabindex="-1"></a>      </span>
<span id="cb148-42"><a href="tree_spatial.html#cb148-42" tabindex="-1"></a>      <span class="fu">return</span>(newline)</span>
<span id="cb148-43"><a href="tree_spatial.html#cb148-43" tabindex="-1"></a>    }</span>
<span id="cb148-44"><a href="tree_spatial.html#cb148-44" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-45"><a href="tree_spatial.html#cb148-45" tabindex="-1"></a>  <span class="co"># pass an sf dataframe of points and return a line between the farthest points</span></span>
<span id="cb148-46"><a href="tree_spatial.html#cb148-46" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-47"><a href="tree_spatial.html#cb148-47" tabindex="-1"></a>    st_points_to_line <span class="ot">&lt;-</span> <span class="cf">function</span>(pts, <span class="at">line_ext=</span><span class="dv">0</span>) {</span>
<span id="cb148-48"><a href="tree_spatial.html#cb148-48" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">max</span>(<span class="fu">class</span>(ttops_temp) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;sf&quot;</span>))<span class="sc">!=</span><span class="dv">1</span>){</span>
<span id="cb148-49"><a href="tree_spatial.html#cb148-49" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;must provide an object of class `sf`&quot;</span>)</span>
<span id="cb148-50"><a href="tree_spatial.html#cb148-50" tabindex="-1"></a>      }</span>
<span id="cb148-51"><a href="tree_spatial.html#cb148-51" tabindex="-1"></a>      <span class="co"># find farthest distance between points</span></span>
<span id="cb148-52"><a href="tree_spatial.html#cb148-52" tabindex="-1"></a>      dist_temp <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(pts)</span>
<span id="cb148-53"><a href="tree_spatial.html#cb148-53" tabindex="-1"></a>      </span>
<span id="cb148-54"><a href="tree_spatial.html#cb148-54" tabindex="-1"></a>      <span class="co"># get the points</span></span>
<span id="cb148-55"><a href="tree_spatial.html#cb148-55" tabindex="-1"></a>      f_pts_temp <span class="ot">=</span> </span>
<span id="cb148-56"><a href="tree_spatial.html#cb148-56" tabindex="-1"></a>        pts <span class="sc">%&gt;%</span> </span>
<span id="cb148-57"><a href="tree_spatial.html#cb148-57" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-58"><a href="tree_spatial.html#cb148-58" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">slice</span>(</span>
<span id="cb148-59"><a href="tree_spatial.html#cb148-59" tabindex="-1"></a>            <span class="co"># get the farthest points from distance matrix</span></span>
<span id="cb148-60"><a href="tree_spatial.html#cb148-60" tabindex="-1"></a>            <span class="fu">which</span>(dist_temp <span class="sc">==</span> <span class="fu">max</span>(dist_temp), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>,]</span>
<span id="cb148-61"><a href="tree_spatial.html#cb148-61" tabindex="-1"></a>          )</span>
<span id="cb148-62"><a href="tree_spatial.html#cb148-62" tabindex="-1"></a>      </span>
<span id="cb148-63"><a href="tree_spatial.html#cb148-63" tabindex="-1"></a>      <span class="co"># draw a line between the farthest two points</span></span>
<span id="cb148-64"><a href="tree_spatial.html#cb148-64" tabindex="-1"></a>      f_line_temp <span class="ot">=</span> f_pts_temp <span class="sc">%&gt;%</span> </span>
<span id="cb148-65"><a href="tree_spatial.html#cb148-65" tabindex="-1"></a>          <span class="co"># convert to linestring</span></span>
<span id="cb148-66"><a href="tree_spatial.html#cb148-66" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-67"><a href="tree_spatial.html#cb148-67" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n=</span>dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb148-68"><a href="tree_spatial.html#cb148-68" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;LINESTRING&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-69"><a href="tree_spatial.html#cb148-69" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-70"><a href="tree_spatial.html#cb148-70" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(n))</span>
<span id="cb148-71"><a href="tree_spatial.html#cb148-71" tabindex="-1"></a>      </span>
<span id="cb148-72"><a href="tree_spatial.html#cb148-72" tabindex="-1"></a>      <span class="co"># and apply the line extension</span></span>
<span id="cb148-73"><a href="tree_spatial.html#cb148-73" tabindex="-1"></a>        farthest_line <span class="ot">=</span> <span class="fu">st_extend_line</span>(f_line_temp, <span class="at">distance =</span> line_ext)</span>
<span id="cb148-74"><a href="tree_spatial.html#cb148-74" tabindex="-1"></a>      <span class="co"># return</span></span>
<span id="cb148-75"><a href="tree_spatial.html#cb148-75" tabindex="-1"></a>        <span class="fu">return</span>(farthest_line)</span>
<span id="cb148-76"><a href="tree_spatial.html#cb148-76" tabindex="-1"></a>    }</span>
<span id="cb148-77"><a href="tree_spatial.html#cb148-77" tabindex="-1"></a>    <span class="co"># st_points_to_line(ttops_temp %&gt;% dplyr::slice_head(prop = .1), line_ext = 6) %&gt;% </span></span>
<span id="cb148-78"><a href="tree_spatial.html#cb148-78" tabindex="-1"></a>    <span class="co">#   ggplot() + geom_sf() + geom_sf(data = ttops_temp %&gt;% dplyr::slice_head(prop = .1)) + theme_void()</span></span>
<span id="cb148-79"><a href="tree_spatial.html#cb148-79" tabindex="-1"></a></span>
<span id="cb148-80"><a href="tree_spatial.html#cb148-80" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-81"><a href="tree_spatial.html#cb148-81" tabindex="-1"></a>  <span class="co"># Function to calculate Euclidean distance between 2 points</span></span>
<span id="cb148-82"><a href="tree_spatial.html#cb148-82" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-83"><a href="tree_spatial.html#cb148-83" tabindex="-1"></a>    st_euclidean_distance <span class="ot">&lt;-</span> <span class="cf">function</span>(p1,p2) {</span>
<span id="cb148-84"><a href="tree_spatial.html#cb148-84" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">sqrt</span>((p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb148-85"><a href="tree_spatial.html#cb148-85" tabindex="-1"></a>    }</span>
<span id="cb148-86"><a href="tree_spatial.html#cb148-86" tabindex="-1"></a></span>
<span id="cb148-87"><a href="tree_spatial.html#cb148-87" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-88"><a href="tree_spatial.html#cb148-88" tabindex="-1"></a>  <span class="co"># return a line perpendicular to current line</span></span>
<span id="cb148-89"><a href="tree_spatial.html#cb148-89" tabindex="-1"></a>  <span class="do">########</span></span>
<span id="cb148-90"><a href="tree_spatial.html#cb148-90" tabindex="-1"></a>  <span class="do">### https://stackoverflow.com/questions/56771058/perpendicular-lines-at-regular-intervals-along-lines-with-multiple-nodes</span></span>
<span id="cb148-91"><a href="tree_spatial.html#cb148-91" tabindex="-1"></a>    <span class="co"># Function to calculate 2 points on a line perpendicular to another defined by 2 points p1,p2</span></span>
<span id="cb148-92"><a href="tree_spatial.html#cb148-92" tabindex="-1"></a>    <span class="co"># For point at interval, which can be a proportion of the segment length, or a constant</span></span>
<span id="cb148-93"><a href="tree_spatial.html#cb148-93" tabindex="-1"></a>    st_perp_line <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">interval=</span><span class="fl">0.5</span>, my_line, <span class="at">proportion=</span><span class="cn">TRUE</span>) {</span>
<span id="cb148-94"><a href="tree_spatial.html#cb148-94" tabindex="-1"></a>      <span class="co"># get end points of line</span></span>
<span id="cb148-95"><a href="tree_spatial.html#cb148-95" tabindex="-1"></a>      p1 <span class="ot">=</span> my_line <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POINT&quot;</span>) <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> .[<span class="dv">1</span>,]</span>
<span id="cb148-96"><a href="tree_spatial.html#cb148-96" tabindex="-1"></a>      p2 <span class="ot">=</span> my_line <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POINT&quot;</span>) <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> .[<span class="dv">2</span>,]</span>
<span id="cb148-97"><a href="tree_spatial.html#cb148-97" tabindex="-1"></a>      <span class="co"># get length of line to return equal length line</span></span>
<span id="cb148-98"><a href="tree_spatial.html#cb148-98" tabindex="-1"></a>      line_len <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_length</span>(my_line) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">/</span><span class="st">`</span>(<span class="dv">2</span>)      </span>
<span id="cb148-99"><a href="tree_spatial.html#cb148-99" tabindex="-1"></a>      <span class="co"># get crs of line</span></span>
<span id="cb148-100"><a href="tree_spatial.html#cb148-100" tabindex="-1"></a>      my_crs <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(my_line)</span>
<span id="cb148-101"><a href="tree_spatial.html#cb148-101" tabindex="-1"></a>      </span>
<span id="cb148-102"><a href="tree_spatial.html#cb148-102" tabindex="-1"></a>      <span class="co"># Calculate x and y distances</span></span>
<span id="cb148-103"><a href="tree_spatial.html#cb148-103" tabindex="-1"></a>      x_len <span class="ot">&lt;-</span> p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]</span>
<span id="cb148-104"><a href="tree_spatial.html#cb148-104" tabindex="-1"></a>      y_len <span class="ot">&lt;-</span> p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>]</span>
<span id="cb148-105"><a href="tree_spatial.html#cb148-105" tabindex="-1"></a>      </span>
<span id="cb148-106"><a href="tree_spatial.html#cb148-106" tabindex="-1"></a>      <span class="co"># If proportion calculate reference point from tot_length</span></span>
<span id="cb148-107"><a href="tree_spatial.html#cb148-107" tabindex="-1"></a>      <span class="cf">if</span> (proportion) {</span>
<span id="cb148-108"><a href="tree_spatial.html#cb148-108" tabindex="-1"></a>          point <span class="ot">&lt;-</span> <span class="fu">c</span>(p1[<span class="dv">1</span>]<span class="sc">+</span>x_len<span class="sc">*</span>interval,p1[<span class="dv">2</span>]<span class="sc">+</span>y_len<span class="sc">*</span>interval)</span>
<span id="cb148-109"><a href="tree_spatial.html#cb148-109" tabindex="-1"></a>      }</span>
<span id="cb148-110"><a href="tree_spatial.html#cb148-110" tabindex="-1"></a>      <span class="co"># Else use the constant value</span></span>
<span id="cb148-111"><a href="tree_spatial.html#cb148-111" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb148-112"><a href="tree_spatial.html#cb148-112" tabindex="-1"></a>          tot_len <span class="ot">&lt;-</span> <span class="fu">st_euclidean_distance</span>(p1,p2)</span>
<span id="cb148-113"><a href="tree_spatial.html#cb148-113" tabindex="-1"></a>          point <span class="ot">&lt;-</span> <span class="fu">c</span>(p1[<span class="dv">1</span>]<span class="sc">+</span>x_len<span class="sc">/</span>tot_len<span class="sc">*</span>interval,p1[<span class="dv">2</span>]<span class="sc">+</span>y_len<span class="sc">/</span>tot_len<span class="sc">*</span>interval)</span>
<span id="cb148-114"><a href="tree_spatial.html#cb148-114" tabindex="-1"></a>      }    </span>
<span id="cb148-115"><a href="tree_spatial.html#cb148-115" tabindex="-1"></a>      </span>
<span id="cb148-116"><a href="tree_spatial.html#cb148-116" tabindex="-1"></a>      <span class="co"># Calculate the x and y distances from reference point to point on line line_len distance away    </span></span>
<span id="cb148-117"><a href="tree_spatial.html#cb148-117" tabindex="-1"></a>      ref_len <span class="ot">&lt;-</span> <span class="fu">st_euclidean_distance</span>(point,p2)</span>
<span id="cb148-118"><a href="tree_spatial.html#cb148-118" tabindex="-1"></a>      xn_len <span class="ot">&lt;-</span> (line_len <span class="sc">/</span> ref_len) <span class="sc">*</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> point[<span class="dv">1</span>])</span>
<span id="cb148-119"><a href="tree_spatial.html#cb148-119" tabindex="-1"></a>      yn_len <span class="ot">&lt;-</span> (line_len <span class="sc">/</span> ref_len) <span class="sc">*</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> point[<span class="dv">2</span>])</span>
<span id="cb148-120"><a href="tree_spatial.html#cb148-120" tabindex="-1"></a>      </span>
<span id="cb148-121"><a href="tree_spatial.html#cb148-121" tabindex="-1"></a>      <span class="co"># fix for identical </span></span>
<span id="cb148-122"><a href="tree_spatial.html#cb148-122" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">identical</span>(point,p2) <span class="sc">&amp;</span> x_len<span class="sc">&gt;</span>y_len){ <span class="co"># this works for horizontal line</span></span>
<span id="cb148-123"><a href="tree_spatial.html#cb148-123" tabindex="-1"></a>        xn_len <span class="ot">&lt;-</span> line_len<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb148-124"><a href="tree_spatial.html#cb148-124" tabindex="-1"></a>        yn_len <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb148-125"><a href="tree_spatial.html#cb148-125" tabindex="-1"></a>      }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">identical</span>(point,p2) <span class="sc">&amp;</span> x_len<span class="sc">&lt;</span>y_len){ <span class="co"># this works for vertical line</span></span>
<span id="cb148-126"><a href="tree_spatial.html#cb148-126" tabindex="-1"></a>        xn_len <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb148-127"><a href="tree_spatial.html#cb148-127" tabindex="-1"></a>        yn_len <span class="ot">&lt;-</span> line_len<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb148-128"><a href="tree_spatial.html#cb148-128" tabindex="-1"></a>      }</span>
<span id="cb148-129"><a href="tree_spatial.html#cb148-129" tabindex="-1"></a>      </span>
<span id="cb148-130"><a href="tree_spatial.html#cb148-130" tabindex="-1"></a>      <span class="co"># Invert the x and y lengths and add/subtract from the refrence point</span></span>
<span id="cb148-131"><a href="tree_spatial.html#cb148-131" tabindex="-1"></a>      <span class="co"># ref_points &lt;- rbind(point,c(point[1] + yn_len,point[2] - xn_len),c(point[1] - yn_len,point[2] + xn_len))</span></span>
<span id="cb148-132"><a href="tree_spatial.html#cb148-132" tabindex="-1"></a>      ref_points <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(point[<span class="dv">1</span>] <span class="sc">+</span> yn_len,point[<span class="dv">2</span>] <span class="sc">-</span> xn_len),<span class="fu">c</span>(point[<span class="dv">1</span>] <span class="sc">-</span> yn_len,point[<span class="dv">2</span>] <span class="sc">+</span> xn_len))</span>
<span id="cb148-133"><a href="tree_spatial.html#cb148-133" tabindex="-1"></a>      </span>
<span id="cb148-134"><a href="tree_spatial.html#cb148-134" tabindex="-1"></a>      <span class="co"># use the reference points to return a line</span></span>
<span id="cb148-135"><a href="tree_spatial.html#cb148-135" tabindex="-1"></a>      <span class="fu">return</span>(</span>
<span id="cb148-136"><a href="tree_spatial.html#cb148-136" tabindex="-1"></a>        ref_points <span class="sc">%&gt;%</span> </span>
<span id="cb148-137"><a href="tree_spatial.html#cb148-137" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-138"><a href="tree_spatial.html#cb148-138" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span> </span>
<span id="cb148-139"><a href="tree_spatial.html#cb148-139" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> my_crs, <span class="at">remove =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb148-140"><a href="tree_spatial.html#cb148-140" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n=</span>dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb148-141"><a href="tree_spatial.html#cb148-141" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;LINESTRING&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-142"><a href="tree_spatial.html#cb148-142" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-143"><a href="tree_spatial.html#cb148-143" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(n))</span>
<span id="cb148-144"><a href="tree_spatial.html#cb148-144" tabindex="-1"></a>      )</span>
<span id="cb148-145"><a href="tree_spatial.html#cb148-145" tabindex="-1"></a>    }</span>
<span id="cb148-146"><a href="tree_spatial.html#cb148-146" tabindex="-1"></a>    <span class="co"># st_perp_line(</span></span>
<span id="cb148-147"><a href="tree_spatial.html#cb148-147" tabindex="-1"></a>    <span class="co">#   my_line = st_points_to_line(ttops_temp %&gt;% dplyr::slice_head(prop = .1), line_ext = 6)</span></span>
<span id="cb148-148"><a href="tree_spatial.html#cb148-148" tabindex="-1"></a>    <span class="co"># ) %&gt;% </span></span>
<span id="cb148-149"><a href="tree_spatial.html#cb148-149" tabindex="-1"></a>    <span class="co">#   ggplot() + </span></span>
<span id="cb148-150"><a href="tree_spatial.html#cb148-150" tabindex="-1"></a>    <span class="co">#     geom_sf(data = ttops_temp %&gt;% dplyr::slice_head(prop = .1)) + # points</span></span>
<span id="cb148-151"><a href="tree_spatial.html#cb148-151" tabindex="-1"></a>    <span class="co">#     geom_sf(color = &quot;blue&quot;) + # perp line</span></span>
<span id="cb148-152"><a href="tree_spatial.html#cb148-152" tabindex="-1"></a>    <span class="co">#     geom_sf( # farthest line</span></span>
<span id="cb148-153"><a href="tree_spatial.html#cb148-153" tabindex="-1"></a>    <span class="co">#       data = st_points_to_line(ttops_temp %&gt;% dplyr::slice_head(prop = .1), line_ext = 6)</span></span>
<span id="cb148-154"><a href="tree_spatial.html#cb148-154" tabindex="-1"></a>    <span class="co">#       , color = &quot;black&quot;</span></span>
<span id="cb148-155"><a href="tree_spatial.html#cb148-155" tabindex="-1"></a>    <span class="co">#     ) + </span></span>
<span id="cb148-156"><a href="tree_spatial.html#cb148-156" tabindex="-1"></a>    <span class="co">#     theme_void()</span></span></code></pre></div>
</div>
<div id="function-to-pass-a-clump" class="section level5 hasAnchor" number="9.2.4.2.2">
<h5><span class="header-section-number">9.2.4.2.2</span> function to pass a clump<a href="tree_spatial.html#function-to-pass-a-clump" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>generate data using clumping functions above, pass that data, return tree list with cut/keep flag based on the target clump group size</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="tree_spatial.html#cb149-1" tabindex="-1"></a><span class="co"># function to cut a single clump</span></span>
<span id="cb149-2"><a href="tree_spatial.html#cb149-2" tabindex="-1"></a>cut_clump_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb149-3"><a href="tree_spatial.html#cb149-3" tabindex="-1"></a>      c <span class="co"># clump id from need_cut_trees data </span></span>
<span id="cb149-4"><a href="tree_spatial.html#cb149-4" tabindex="-1"></a>      , need_cut_trees <span class="co"># data with clumps already defined returned by sp_clump_points()</span></span>
<span id="cb149-5"><a href="tree_spatial.html#cb149-5" tabindex="-1"></a>      , <span class="at">tgt =</span> tgt <span class="co"># select one level of input passed to sp_clump_points() ...</span></span>
<span id="cb149-6"><a href="tree_spatial.html#cb149-6" tabindex="-1"></a>          <span class="co"># ... clump_labels = c(&quot;Individual&quot;,&quot;2-4 trees&quot;,&quot;5-9 trees&quot;,&quot;10-15 trees&quot;,&quot;&gt;15 trees&quot;) </span></span>
<span id="cb149-7"><a href="tree_spatial.html#cb149-7" tabindex="-1"></a>){</span>
<span id="cb149-8"><a href="tree_spatial.html#cb149-8" tabindex="-1"></a>  <span class="co"># use only the current clump</span></span>
<span id="cb149-9"><a href="tree_spatial.html#cb149-9" tabindex="-1"></a>  curr_dta <span class="ot">=</span> need_cut_trees <span class="sc">%&gt;%</span> </span>
<span id="cb149-10"><a href="tree_spatial.html#cb149-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id <span class="sc">==</span> c)</span>
<span id="cb149-11"><a href="tree_spatial.html#cb149-11" tabindex="-1"></a>  </span>
<span id="cb149-12"><a href="tree_spatial.html#cb149-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(curr_dta)<span class="sc">&lt;</span><span class="dv">1</span>){</span>
<span id="cb149-13"><a href="tree_spatial.html#cb149-13" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;cannot find data with the clump_id == `c` in `need_cut_trees` data&quot;</span>)</span>
<span id="cb149-14"><a href="tree_spatial.html#cb149-14" tabindex="-1"></a>  }</span>
<span id="cb149-15"><a href="tree_spatial.html#cb149-15" tabindex="-1"></a>  </span>
<span id="cb149-16"><a href="tree_spatial.html#cb149-16" tabindex="-1"></a>  <span class="co"># get distance used to create clumps in sp_clump_points()</span></span>
<span id="cb149-17"><a href="tree_spatial.html#cb149-17" tabindex="-1"></a>  dist_temp <span class="ot">=</span> curr_dta<span class="sc">$</span>tree_clump_dist_m[<span class="dv">1</span>]</span>
<span id="cb149-18"><a href="tree_spatial.html#cb149-18" tabindex="-1"></a>  </span>
<span id="cb149-19"><a href="tree_spatial.html#cb149-19" tabindex="-1"></a>  <span class="co"># do we even need to cut?</span></span>
<span id="cb149-20"><a href="tree_spatial.html#cb149-20" tabindex="-1"></a>  reclump <span class="ot">=</span> <span class="fu">sp_clump_points</span>(<span class="at">x =</span> curr_dta, <span class="at">clump_dist_m =</span> dist_temp)</span>
<span id="cb149-21"><a href="tree_spatial.html#cb149-21" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb149-22"><a href="tree_spatial.html#cb149-22" tabindex="-1"></a>    (</span>
<span id="cb149-23"><a href="tree_spatial.html#cb149-23" tabindex="-1"></a>      reclump <span class="sc">%&gt;%</span> </span>
<span id="cb149-24"><a href="tree_spatial.html#cb149-24" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb149-25"><a href="tree_spatial.html#cb149-25" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-26"><a href="tree_spatial.html#cb149-26" tabindex="-1"></a>        <span class="fu">length</span>()</span>
<span id="cb149-27"><a href="tree_spatial.html#cb149-27" tabindex="-1"></a>    ) <span class="sc">!=</span> <span class="dv">1</span></span>
<span id="cb149-28"><a href="tree_spatial.html#cb149-28" tabindex="-1"></a>  ){</span>
<span id="cb149-29"><a href="tree_spatial.html#cb149-29" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;this is not a clump...send the `need_cut_trees` data through the sp_clump_points function again&quot;</span>)</span>
<span id="cb149-30"><a href="tree_spatial.html#cb149-30" tabindex="-1"></a>  }</span>
<span id="cb149-31"><a href="tree_spatial.html#cb149-31" tabindex="-1"></a>  <span class="co"># do we even need to cut?</span></span>
<span id="cb149-32"><a href="tree_spatial.html#cb149-32" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb149-33"><a href="tree_spatial.html#cb149-33" tabindex="-1"></a>    <span class="fu">unique</span>(reclump<span class="sc">$</span>clump_n_trees_grp) <span class="sc">==</span> tgt</span>
<span id="cb149-34"><a href="tree_spatial.html#cb149-34" tabindex="-1"></a>  ){</span>
<span id="cb149-35"><a href="tree_spatial.html#cb149-35" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb149-36"><a href="tree_spatial.html#cb149-36" tabindex="-1"></a>      reclump <span class="sc">%&gt;%</span> </span>
<span id="cb149-37"><a href="tree_spatial.html#cb149-37" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-38"><a href="tree_spatial.html#cb149-38" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, is_keep_tree)</span>
<span id="cb149-39"><a href="tree_spatial.html#cb149-39" tabindex="-1"></a>    )</span>
<span id="cb149-40"><a href="tree_spatial.html#cb149-40" tabindex="-1"></a>  }</span>
<span id="cb149-41"><a href="tree_spatial.html#cb149-41" tabindex="-1"></a>  </span>
<span id="cb149-42"><a href="tree_spatial.html#cb149-42" tabindex="-1"></a>  <span class="co"># create clump polygon</span></span>
<span id="cb149-43"><a href="tree_spatial.html#cb149-43" tabindex="-1"></a>  clumps <span class="ot">=</span> <span class="fu">get_clump_summary</span>(curr_dta)</span>
<span id="cb149-44"><a href="tree_spatial.html#cb149-44" tabindex="-1"></a>  </span>
<span id="cb149-45"><a href="tree_spatial.html#cb149-45" tabindex="-1"></a>  <span class="co"># get the farthest line between points</span></span>
<span id="cb149-46"><a href="tree_spatial.html#cb149-46" tabindex="-1"></a>  f_line_temp <span class="ot">=</span> <span class="fu">st_points_to_line</span>(curr_dta, <span class="at">line_ext =</span> dist_temp)</span>
<span id="cb149-47"><a href="tree_spatial.html#cb149-47" tabindex="-1"></a>  </span>
<span id="cb149-48"><a href="tree_spatial.html#cb149-48" tabindex="-1"></a>  <span class="co"># get perpendicular lines in dataset which we can iterate over to make cuts</span></span>
<span id="cb149-49"><a href="tree_spatial.html#cb149-49" tabindex="-1"></a>  perp_line_sf_temp <span class="ot">=</span> </span>
<span id="cb149-50"><a href="tree_spatial.html#cb149-50" tabindex="-1"></a>    <span class="co"># for every 1 m along line length, get a new perp line</span></span>
<span id="cb149-51"><a href="tree_spatial.html#cb149-51" tabindex="-1"></a>    <span class="fu">seq</span>(</span>
<span id="cb149-52"><a href="tree_spatial.html#cb149-52" tabindex="-1"></a>        <span class="at">from =</span> <span class="dv">0</span></span>
<span id="cb149-53"><a href="tree_spatial.html#cb149-53" tabindex="-1"></a>        , <span class="at">to =</span> sf<span class="sc">::</span><span class="fu">st_length</span>(f_line_temp) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span> <span class="fu">floor</span>()</span>
<span id="cb149-54"><a href="tree_spatial.html#cb149-54" tabindex="-1"></a>        , <span class="at">by =</span> <span class="dv">1</span></span>
<span id="cb149-55"><a href="tree_spatial.html#cb149-55" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb149-56"><a href="tree_spatial.html#cb149-56" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb149-57"><a href="tree_spatial.html#cb149-57" tabindex="-1"></a>      st_perp_line</span>
<span id="cb149-58"><a href="tree_spatial.html#cb149-58" tabindex="-1"></a>      , <span class="at">my_line =</span> f_line_temp</span>
<span id="cb149-59"><a href="tree_spatial.html#cb149-59" tabindex="-1"></a>      , <span class="at">proportion =</span> F</span>
<span id="cb149-60"><a href="tree_spatial.html#cb149-60" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb149-61"><a href="tree_spatial.html#cb149-61" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-62"><a href="tree_spatial.html#cb149-62" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">line_n =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb149-63"><a href="tree_spatial.html#cb149-63" tabindex="-1"></a>  </span>
<span id="cb149-64"><a href="tree_spatial.html#cb149-64" tabindex="-1"></a>  <span class="co"># find intersection of lines with the polygon and add length of intersection to perp line data</span></span>
<span id="cb149-65"><a href="tree_spatial.html#cb149-65" tabindex="-1"></a>  perp_line_sf_temp <span class="ot">=</span> perp_line_sf_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-66"><a href="tree_spatial.html#cb149-66" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb149-67"><a href="tree_spatial.html#cb149-67" tabindex="-1"></a>      <span class="co"># intersect and calc len</span></span>
<span id="cb149-68"><a href="tree_spatial.html#cb149-68" tabindex="-1"></a>      perp_line_sf_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-69"><a href="tree_spatial.html#cb149-69" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb149-70"><a href="tree_spatial.html#cb149-70" tabindex="-1"></a>          clumps <span class="sc">%&gt;%</span> </span>
<span id="cb149-71"><a href="tree_spatial.html#cb149-71" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-72"><a href="tree_spatial.html#cb149-72" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb149-73"><a href="tree_spatial.html#cb149-73" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_id <span class="sc">==</span> c)</span>
<span id="cb149-74"><a href="tree_spatial.html#cb149-74" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb149-75"><a href="tree_spatial.html#cb149-75" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">len_m =</span> sf<span class="sc">::</span><span class="fu">st_length</span>(geometry) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb149-76"><a href="tree_spatial.html#cb149-76" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb149-77"><a href="tree_spatial.html#cb149-77" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;line_n&quot;</span></span>
<span id="cb149-78"><a href="tree_spatial.html#cb149-78" tabindex="-1"></a>    )</span>
<span id="cb149-79"><a href="tree_spatial.html#cb149-79" tabindex="-1"></a>  </span>
<span id="cb149-80"><a href="tree_spatial.html#cb149-80" tabindex="-1"></a>  <span class="co"># make cuts at the points where there is the least overlap with the clump polygon</span></span>
<span id="cb149-81"><a href="tree_spatial.html#cb149-81" tabindex="-1"></a>    <span class="co"># list of potential line cut + tree combinations</span></span>
<span id="cb149-82"><a href="tree_spatial.html#cb149-82" tabindex="-1"></a>    <span class="co"># aggregate the mean length of the intersecting cut lines to the tree level</span></span>
<span id="cb149-83"><a href="tree_spatial.html#cb149-83" tabindex="-1"></a>    <span class="co"># prioritize trees for removal that have smallest length</span></span>
<span id="cb149-84"><a href="tree_spatial.html#cb149-84" tabindex="-1"></a>    cut_tree_lines_temp <span class="ot">=</span> </span>
<span id="cb149-85"><a href="tree_spatial.html#cb149-85" tabindex="-1"></a>      curr_dta <span class="sc">%&gt;%</span> </span>
<span id="cb149-86"><a href="tree_spatial.html#cb149-86" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(dist_temp<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb149-87"><a href="tree_spatial.html#cb149-87" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_join</span>(perp_line_sf_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb149-88"><a href="tree_spatial.html#cb149-88" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-89"><a href="tree_spatial.html#cb149-89" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb149-90"><a href="tree_spatial.html#cb149-90" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">len_m =</span> <span class="fu">mean</span>(len_m, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb149-91"><a href="tree_spatial.html#cb149-91" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-92"><a href="tree_spatial.html#cb149-92" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">arrange</span>(len_m, treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb149-93"><a href="tree_spatial.html#cb149-93" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb149-94"><a href="tree_spatial.html#cb149-94" tabindex="-1"></a>  <span class="do">###############################################################</span></span>
<span id="cb149-95"><a href="tree_spatial.html#cb149-95" tabindex="-1"></a>  <span class="co"># while</span></span>
<span id="cb149-96"><a href="tree_spatial.html#cb149-96" tabindex="-1"></a>  <span class="do">###############################################################</span></span>
<span id="cb149-97"><a href="tree_spatial.html#cb149-97" tabindex="-1"></a>  <span class="co"># cut until the desired clump size is achieved based on these cut lines</span></span>
<span id="cb149-98"><a href="tree_spatial.html#cb149-98" tabindex="-1"></a>  while_temp <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb149-99"><a href="tree_spatial.html#cb149-99" tabindex="-1"></a>  i <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb149-100"><a href="tree_spatial.html#cb149-100" tabindex="-1"></a>  <span class="cf">while</span>(while_temp<span class="sc">==</span><span class="dv">1</span>) {</span>
<span id="cb149-101"><a href="tree_spatial.html#cb149-101" tabindex="-1"></a>    <span class="co"># cut trees</span></span>
<span id="cb149-102"><a href="tree_spatial.html#cb149-102" tabindex="-1"></a>    cut_trees_temp <span class="ot">=</span> cut_tree_lines_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-103"><a href="tree_spatial.html#cb149-103" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>i) <span class="sc">%&gt;%</span> </span>
<span id="cb149-104"><a href="tree_spatial.html#cb149-104" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(treeID)</span>
<span id="cb149-105"><a href="tree_spatial.html#cb149-105" tabindex="-1"></a>    </span>
<span id="cb149-106"><a href="tree_spatial.html#cb149-106" tabindex="-1"></a>    <span class="co"># get the remaining trees not cut</span></span>
<span id="cb149-107"><a href="tree_spatial.html#cb149-107" tabindex="-1"></a>    trees_remain_temp <span class="ot">=</span> curr_dta <span class="sc">%&gt;%</span> </span>
<span id="cb149-108"><a href="tree_spatial.html#cb149-108" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">anti_join</span>(cut_trees_temp, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb149-109"><a href="tree_spatial.html#cb149-109" tabindex="-1"></a>    </span>
<span id="cb149-110"><a href="tree_spatial.html#cb149-110" tabindex="-1"></a>    <span class="co"># ensure that there are trees</span></span>
<span id="cb149-111"><a href="tree_spatial.html#cb149-111" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(trees_remain_temp)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb149-112"><a href="tree_spatial.html#cb149-112" tabindex="-1"></a>      <span class="cf">if</span>(best_desired_grps_n_temp<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb149-113"><a href="tree_spatial.html#cb149-113" tabindex="-1"></a>        <span class="co"># there are no more possible cuts :/</span></span>
<span id="cb149-114"><a href="tree_spatial.html#cb149-114" tabindex="-1"></a>        best_cuts <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">treeID =</span> <span class="fu">character</span>())</span>
<span id="cb149-115"><a href="tree_spatial.html#cb149-115" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;could not find any solution to this cutting problem ;/&quot;</span>)</span>
<span id="cb149-116"><a href="tree_spatial.html#cb149-116" tabindex="-1"></a>      }<span class="cf">else</span> <span class="cf">if</span>(</span>
<span id="cb149-117"><a href="tree_spatial.html#cb149-117" tabindex="-1"></a>        best_desired_grps_n_temp<span class="sc">&gt;</span><span class="dv">0</span> </span>
<span id="cb149-118"><a href="tree_spatial.html#cb149-118" tabindex="-1"></a>      ){ </span>
<span id="cb149-119"><a href="tree_spatial.html#cb149-119" tabindex="-1"></a>        <span class="do">###############################</span></span>
<span id="cb149-120"><a href="tree_spatial.html#cb149-120" tabindex="-1"></a>        <span class="co"># add trees back in until gets worse</span></span>
<span id="cb149-121"><a href="tree_spatial.html#cb149-121" tabindex="-1"></a>        <span class="do">###############################</span></span>
<span id="cb149-122"><a href="tree_spatial.html#cb149-122" tabindex="-1"></a>        j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb149-123"><a href="tree_spatial.html#cb149-123" tabindex="-1"></a>        while_add <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb149-124"><a href="tree_spatial.html#cb149-124" tabindex="-1"></a>        <span class="cf">while</span>(while_add<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb149-125"><a href="tree_spatial.html#cb149-125" tabindex="-1"></a>          <span class="co"># cut trees</span></span>
<span id="cb149-126"><a href="tree_spatial.html#cb149-126" tabindex="-1"></a>          cut_trees_temp <span class="ot">=</span> best_cuts <span class="sc">%&gt;%</span> </span>
<span id="cb149-127"><a href="tree_spatial.html#cb149-127" tabindex="-1"></a>            <span class="co"># add trees back in (i.e. remove them from the cut trees)</span></span>
<span id="cb149-128"><a href="tree_spatial.html#cb149-128" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb149-129"><a href="tree_spatial.html#cb149-129" tabindex="-1"></a>              cut_tree_lines_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-130"><a href="tree_spatial.html#cb149-130" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>j) <span class="sc">%&gt;%</span> </span>
<span id="cb149-131"><a href="tree_spatial.html#cb149-131" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">distinct</span>(treeID)</span>
<span id="cb149-132"><a href="tree_spatial.html#cb149-132" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb149-133"><a href="tree_spatial.html#cb149-133" tabindex="-1"></a>            )</span>
<span id="cb149-134"><a href="tree_spatial.html#cb149-134" tabindex="-1"></a>          <span class="co"># get the remaining trees not cut</span></span>
<span id="cb149-135"><a href="tree_spatial.html#cb149-135" tabindex="-1"></a>          trees_remain_temp <span class="ot">=</span> curr_dta <span class="sc">%&gt;%</span> </span>
<span id="cb149-136"><a href="tree_spatial.html#cb149-136" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">anti_join</span>(cut_trees_temp, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb149-137"><a href="tree_spatial.html#cb149-137" tabindex="-1"></a>          </span>
<span id="cb149-138"><a href="tree_spatial.html#cb149-138" tabindex="-1"></a>          <span class="co"># count the groups remaining after cuts</span></span>
<span id="cb149-139"><a href="tree_spatial.html#cb149-139" tabindex="-1"></a>          desired_grps_n_temp <span class="ot">=</span> trees_remain_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-140"><a href="tree_spatial.html#cb149-140" tabindex="-1"></a>            <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> dist_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb149-141"><a href="tree_spatial.html#cb149-141" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-142"><a href="tree_spatial.html#cb149-142" tabindex="-1"></a>            <span class="co"># do we have group sizes we want?</span></span>
<span id="cb149-143"><a href="tree_spatial.html#cb149-143" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> tgt) <span class="sc">%&gt;%</span> </span>
<span id="cb149-144"><a href="tree_spatial.html#cb149-144" tabindex="-1"></a>            <span class="fu">nrow</span>()</span>
<span id="cb149-145"><a href="tree_spatial.html#cb149-145" tabindex="-1"></a>          </span>
<span id="cb149-146"><a href="tree_spatial.html#cb149-146" tabindex="-1"></a>          <span class="cf">if</span>(desired_grps_n_temp<span class="sc">&gt;=</span>best_desired_grps_n_temp){ <span class="co"># is this better than the best</span></span>
<span id="cb149-147"><a href="tree_spatial.html#cb149-147" tabindex="-1"></a>            best_cuts <span class="ot">=</span> cut_trees_temp</span>
<span id="cb149-148"><a href="tree_spatial.html#cb149-148" tabindex="-1"></a>            best_desired_grps_n_temp <span class="ot">=</span> desired_grps_n_temp</span>
<span id="cb149-149"><a href="tree_spatial.html#cb149-149" tabindex="-1"></a>          }<span class="cf">else</span>{</span>
<span id="cb149-150"><a href="tree_spatial.html#cb149-150" tabindex="-1"></a>            <span class="co"># stop it</span></span>
<span id="cb149-151"><a href="tree_spatial.html#cb149-151" tabindex="-1"></a>            while_add <span class="ot">=</span> <span class="dv">0</span>  </span>
<span id="cb149-152"><a href="tree_spatial.html#cb149-152" tabindex="-1"></a>          }</span>
<span id="cb149-153"><a href="tree_spatial.html#cb149-153" tabindex="-1"></a>          <span class="co"># increment</span></span>
<span id="cb149-154"><a href="tree_spatial.html#cb149-154" tabindex="-1"></a>          j <span class="ot">=</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb149-155"><a href="tree_spatial.html#cb149-155" tabindex="-1"></a>        } <span class="co"># while(while_add==1)</span></span>
<span id="cb149-156"><a href="tree_spatial.html#cb149-156" tabindex="-1"></a>      } <span class="co"># best_desired_grps_n_temp&gt;0 </span></span>
<span id="cb149-157"><a href="tree_spatial.html#cb149-157" tabindex="-1"></a>      <span class="co"># done so stop the whole stop it</span></span>
<span id="cb149-158"><a href="tree_spatial.html#cb149-158" tabindex="-1"></a>        while_temp <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb149-159"><a href="tree_spatial.html#cb149-159" tabindex="-1"></a>    }<span class="cf">else</span>{ <span class="co"># if(nrow(trees_remain_temp)==0)</span></span>
<span id="cb149-160"><a href="tree_spatial.html#cb149-160" tabindex="-1"></a>      <span class="co"># count the groups remaining after cuts</span></span>
<span id="cb149-161"><a href="tree_spatial.html#cb149-161" tabindex="-1"></a>      desired_grps_n_temp <span class="ot">=</span> trees_remain_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-162"><a href="tree_spatial.html#cb149-162" tabindex="-1"></a>        <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> dist_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb149-163"><a href="tree_spatial.html#cb149-163" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-164"><a href="tree_spatial.html#cb149-164" tabindex="-1"></a>        <span class="co"># do we have group sizes we want?</span></span>
<span id="cb149-165"><a href="tree_spatial.html#cb149-165" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> tgt) <span class="sc">%&gt;%</span> </span>
<span id="cb149-166"><a href="tree_spatial.html#cb149-166" tabindex="-1"></a>        <span class="fu">nrow</span>()</span>
<span id="cb149-167"><a href="tree_spatial.html#cb149-167" tabindex="-1"></a>      <span class="do">### store best cut list</span></span>
<span id="cb149-168"><a href="tree_spatial.html#cb149-168" tabindex="-1"></a>      <span class="cf">if</span>(i<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb149-169"><a href="tree_spatial.html#cb149-169" tabindex="-1"></a>        best_cuts <span class="ot">=</span> cut_trees_temp</span>
<span id="cb149-170"><a href="tree_spatial.html#cb149-170" tabindex="-1"></a>        best_desired_grps_n_temp <span class="ot">=</span> desired_grps_n_temp</span>
<span id="cb149-171"><a href="tree_spatial.html#cb149-171" tabindex="-1"></a>      }<span class="cf">else</span> <span class="cf">if</span>(desired_grps_n_temp<span class="sc">&gt;</span>best_desired_grps_n_temp){ <span class="co"># is this better than the best</span></span>
<span id="cb149-172"><a href="tree_spatial.html#cb149-172" tabindex="-1"></a>        best_cuts <span class="ot">=</span> cut_trees_temp</span>
<span id="cb149-173"><a href="tree_spatial.html#cb149-173" tabindex="-1"></a>        best_desired_grps_n_temp <span class="ot">=</span> desired_grps_n_temp</span>
<span id="cb149-174"><a href="tree_spatial.html#cb149-174" tabindex="-1"></a>      }<span class="cf">else</span> <span class="cf">if</span>(</span>
<span id="cb149-175"><a href="tree_spatial.html#cb149-175" tabindex="-1"></a>        desired_grps_n_temp<span class="sc">==</span>best_desired_grps_n_temp</span>
<span id="cb149-176"><a href="tree_spatial.html#cb149-176" tabindex="-1"></a>        <span class="sc">&amp;</span> i<span class="sc">!=</span><span class="fu">nrow</span>(cut_tree_lines_temp)</span>
<span id="cb149-177"><a href="tree_spatial.html#cb149-177" tabindex="-1"></a>      ){</span>
<span id="cb149-178"><a href="tree_spatial.html#cb149-178" tabindex="-1"></a>        best_cuts <span class="ot">=</span> best_cuts</span>
<span id="cb149-179"><a href="tree_spatial.html#cb149-179" tabindex="-1"></a>        best_desired_grps_n_temp <span class="ot">=</span> best_desired_grps_n_temp</span>
<span id="cb149-180"><a href="tree_spatial.html#cb149-180" tabindex="-1"></a>      }<span class="cf">else</span> <span class="cf">if</span>(</span>
<span id="cb149-181"><a href="tree_spatial.html#cb149-181" tabindex="-1"></a>        best_desired_grps_n_temp<span class="sc">&gt;</span><span class="dv">0</span> </span>
<span id="cb149-182"><a href="tree_spatial.html#cb149-182" tabindex="-1"></a>        <span class="sc">&amp;</span> desired_grps_n_temp<span class="sc">&lt;</span>best_desired_grps_n_temp</span>
<span id="cb149-183"><a href="tree_spatial.html#cb149-183" tabindex="-1"></a>      ){ <span class="co"># is this worse than the best which was successful?</span></span>
<span id="cb149-184"><a href="tree_spatial.html#cb149-184" tabindex="-1"></a>        <span class="do">###############################</span></span>
<span id="cb149-185"><a href="tree_spatial.html#cb149-185" tabindex="-1"></a>        <span class="co"># add trees back in until gets worse</span></span>
<span id="cb149-186"><a href="tree_spatial.html#cb149-186" tabindex="-1"></a>        <span class="do">###############################</span></span>
<span id="cb149-187"><a href="tree_spatial.html#cb149-187" tabindex="-1"></a>        j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb149-188"><a href="tree_spatial.html#cb149-188" tabindex="-1"></a>        while_add <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb149-189"><a href="tree_spatial.html#cb149-189" tabindex="-1"></a>        <span class="cf">while</span>(while_add<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb149-190"><a href="tree_spatial.html#cb149-190" tabindex="-1"></a>          <span class="co"># cut trees</span></span>
<span id="cb149-191"><a href="tree_spatial.html#cb149-191" tabindex="-1"></a>          cut_trees_temp <span class="ot">=</span> best_cuts <span class="sc">%&gt;%</span> </span>
<span id="cb149-192"><a href="tree_spatial.html#cb149-192" tabindex="-1"></a>            <span class="co"># add trees back in (i.e. remove them from the cut trees)</span></span>
<span id="cb149-193"><a href="tree_spatial.html#cb149-193" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb149-194"><a href="tree_spatial.html#cb149-194" tabindex="-1"></a>              cut_tree_lines_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-195"><a href="tree_spatial.html#cb149-195" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>j) <span class="sc">%&gt;%</span> </span>
<span id="cb149-196"><a href="tree_spatial.html#cb149-196" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">distinct</span>(treeID)</span>
<span id="cb149-197"><a href="tree_spatial.html#cb149-197" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb149-198"><a href="tree_spatial.html#cb149-198" tabindex="-1"></a>            )</span>
<span id="cb149-199"><a href="tree_spatial.html#cb149-199" tabindex="-1"></a>          <span class="co"># get the remaining trees not cut</span></span>
<span id="cb149-200"><a href="tree_spatial.html#cb149-200" tabindex="-1"></a>          trees_remain_temp <span class="ot">=</span> curr_dta <span class="sc">%&gt;%</span> </span>
<span id="cb149-201"><a href="tree_spatial.html#cb149-201" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">anti_join</span>(cut_trees_temp, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb149-202"><a href="tree_spatial.html#cb149-202" tabindex="-1"></a>          </span>
<span id="cb149-203"><a href="tree_spatial.html#cb149-203" tabindex="-1"></a>          <span class="co"># count the groups remaining after cuts</span></span>
<span id="cb149-204"><a href="tree_spatial.html#cb149-204" tabindex="-1"></a>          desired_grps_n_temp <span class="ot">=</span> trees_remain_temp <span class="sc">%&gt;%</span> </span>
<span id="cb149-205"><a href="tree_spatial.html#cb149-205" tabindex="-1"></a>            <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> dist_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb149-206"><a href="tree_spatial.html#cb149-206" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb149-207"><a href="tree_spatial.html#cb149-207" tabindex="-1"></a>            <span class="co"># do we have group sizes we want?</span></span>
<span id="cb149-208"><a href="tree_spatial.html#cb149-208" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> tgt) <span class="sc">%&gt;%</span> </span>
<span id="cb149-209"><a href="tree_spatial.html#cb149-209" tabindex="-1"></a>            <span class="fu">nrow</span>()</span>
<span id="cb149-210"><a href="tree_spatial.html#cb149-210" tabindex="-1"></a>          </span>
<span id="cb149-211"><a href="tree_spatial.html#cb149-211" tabindex="-1"></a>          <span class="cf">if</span>(desired_grps_n_temp<span class="sc">&gt;=</span>best_desired_grps_n_temp){ <span class="co"># is this better than the best</span></span>
<span id="cb149-212"><a href="tree_spatial.html#cb149-212" tabindex="-1"></a>            best_cuts <span class="ot">=</span> cut_trees_temp</span>
<span id="cb149-213"><a href="tree_spatial.html#cb149-213" tabindex="-1"></a>            best_desired_grps_n_temp <span class="ot">=</span> desired_grps_n_temp</span>
<span id="cb149-214"><a href="tree_spatial.html#cb149-214" tabindex="-1"></a>          }<span class="cf">else</span>{</span>
<span id="cb149-215"><a href="tree_spatial.html#cb149-215" tabindex="-1"></a>            <span class="co"># stop it</span></span>
<span id="cb149-216"><a href="tree_spatial.html#cb149-216" tabindex="-1"></a>            while_add <span class="ot">=</span> <span class="dv">0</span>  </span>
<span id="cb149-217"><a href="tree_spatial.html#cb149-217" tabindex="-1"></a>          }</span>
<span id="cb149-218"><a href="tree_spatial.html#cb149-218" tabindex="-1"></a>          <span class="co"># increment</span></span>
<span id="cb149-219"><a href="tree_spatial.html#cb149-219" tabindex="-1"></a>          j <span class="ot">=</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb149-220"><a href="tree_spatial.html#cb149-220" tabindex="-1"></a>        } <span class="co"># while(while_add==1)</span></span>
<span id="cb149-221"><a href="tree_spatial.html#cb149-221" tabindex="-1"></a>        <span class="co"># done so stop the whole stop it</span></span>
<span id="cb149-222"><a href="tree_spatial.html#cb149-222" tabindex="-1"></a>        while_temp <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb149-223"><a href="tree_spatial.html#cb149-223" tabindex="-1"></a>      }<span class="cf">else</span> <span class="cf">if</span>( i<span class="sc">==</span><span class="fu">nrow</span>(cut_tree_lines_temp) ){ <span class="co"># is this the end?</span></span>
<span id="cb149-224"><a href="tree_spatial.html#cb149-224" tabindex="-1"></a>        <span class="co"># stop it</span></span>
<span id="cb149-225"><a href="tree_spatial.html#cb149-225" tabindex="-1"></a>        while_temp <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb149-226"><a href="tree_spatial.html#cb149-226" tabindex="-1"></a>      }</span>
<span id="cb149-227"><a href="tree_spatial.html#cb149-227" tabindex="-1"></a>      <span class="do">### increment</span></span>
<span id="cb149-228"><a href="tree_spatial.html#cb149-228" tabindex="-1"></a>      i <span class="ot">=</span> i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb149-229"><a href="tree_spatial.html#cb149-229" tabindex="-1"></a>    } <span class="co"># else if(nrow(trees_remain_temp)==0)</span></span>
<span id="cb149-230"><a href="tree_spatial.html#cb149-230" tabindex="-1"></a>  } <span class="co"># while(while_temp==1)</span></span>
<span id="cb149-231"><a href="tree_spatial.html#cb149-231" tabindex="-1"></a>  </span>
<span id="cb149-232"><a href="tree_spatial.html#cb149-232" tabindex="-1"></a>  <span class="co"># return it</span></span>
<span id="cb149-233"><a href="tree_spatial.html#cb149-233" tabindex="-1"></a>  <span class="co"># return treelist with cut/keep</span></span>
<span id="cb149-234"><a href="tree_spatial.html#cb149-234" tabindex="-1"></a>  <span class="co"># join to original data and pull</span></span>
<span id="cb149-235"><a href="tree_spatial.html#cb149-235" tabindex="-1"></a>  d_temp <span class="ot">=</span> curr_dta <span class="sc">%&gt;%</span></span>
<span id="cb149-236"><a href="tree_spatial.html#cb149-236" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb149-237"><a href="tree_spatial.html#cb149-237" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb149-238"><a href="tree_spatial.html#cb149-238" tabindex="-1"></a>      best_cuts <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> <span class="dv">0</span>)</span>
<span id="cb149-239"><a href="tree_spatial.html#cb149-239" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(<span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb149-240"><a href="tree_spatial.html#cb149-240" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb149-241"><a href="tree_spatial.html#cb149-241" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_keep_tree, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb149-242"><a href="tree_spatial.html#cb149-242" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, is_keep_tree)</span>
<span id="cb149-243"><a href="tree_spatial.html#cb149-243" tabindex="-1"></a>  <span class="co"># returns treeID and keep tree flag data frame</span></span>
<span id="cb149-244"><a href="tree_spatial.html#cb149-244" tabindex="-1"></a>  <span class="fu">return</span>(d_temp)</span>
<span id="cb149-245"><a href="tree_spatial.html#cb149-245" tabindex="-1"></a>}</span>
<span id="cb149-246"><a href="tree_spatial.html#cb149-246" tabindex="-1"></a><span class="co"># # example</span></span>
<span id="cb149-247"><a href="tree_spatial.html#cb149-247" tabindex="-1"></a><span class="co"># # pass it a clump id in the data</span></span>
<span id="cb149-248"><a href="tree_spatial.html#cb149-248" tabindex="-1"></a><span class="co"># ttops_temp %&gt;%</span></span>
<span id="cb149-249"><a href="tree_spatial.html#cb149-249" tabindex="-1"></a><span class="co">#   dplyr::filter(clump_n_trees_grp == &quot;2-4 trees&quot;) %&gt;%</span></span>
<span id="cb149-250"><a href="tree_spatial.html#cb149-250" tabindex="-1"></a><span class="co">#   dplyr::arrange(desc(clump_n_trees)) %&gt;%</span></span>
<span id="cb149-251"><a href="tree_spatial.html#cb149-251" tabindex="-1"></a><span class="co">#   dplyr::slice(1) %&gt;%</span></span>
<span id="cb149-252"><a href="tree_spatial.html#cb149-252" tabindex="-1"></a><span class="co">#   dplyr::pull(clump_id) %&gt;%</span></span>
<span id="cb149-253"><a href="tree_spatial.html#cb149-253" tabindex="-1"></a><span class="co">#   cut_clump_fn(</span></span>
<span id="cb149-254"><a href="tree_spatial.html#cb149-254" tabindex="-1"></a><span class="co">#     need_cut_trees = ttops_temp</span></span>
<span id="cb149-255"><a href="tree_spatial.html#cb149-255" tabindex="-1"></a><span class="co">#     , tgt = &quot;Individual&quot;</span></span>
<span id="cb149-256"><a href="tree_spatial.html#cb149-256" tabindex="-1"></a><span class="co">#   )</span></span></code></pre></div>
<p>there are some cases where the <code>cut_clumps_fn</code> may not return the desired tree clumps based on a single pass using the initial cut lines…iterate over the function until all clumps are in the desired clump size or smaller.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="tree_spatial.html#cb150-1" tabindex="-1"></a>get_cut_clump <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb150-2"><a href="tree_spatial.html#cb150-2" tabindex="-1"></a>  c <span class="co"># clump id from need_cut_trees data </span></span>
<span id="cb150-3"><a href="tree_spatial.html#cb150-3" tabindex="-1"></a>  , need_cut_trees <span class="co"># data with clumps already defined returned by sp_clump_points()</span></span>
<span id="cb150-4"><a href="tree_spatial.html#cb150-4" tabindex="-1"></a>  , <span class="at">tgt =</span> tgt <span class="co"># select one level of input passed to sp_clump_points() ...</span></span>
<span id="cb150-5"><a href="tree_spatial.html#cb150-5" tabindex="-1"></a>      <span class="co"># ... clump_labels = c(&quot;Individual&quot;,&quot;2-4 trees&quot;,&quot;5-9 trees&quot;,&quot;10-15 trees&quot;,&quot;&gt;15 trees&quot;) </span></span>
<span id="cb150-6"><a href="tree_spatial.html#cb150-6" tabindex="-1"></a>) {</span>
<span id="cb150-7"><a href="tree_spatial.html#cb150-7" tabindex="-1"></a>  <span class="co"># what if we need to keep cutting because could not find a solution based on initial cut lines?</span></span>
<span id="cb150-8"><a href="tree_spatial.html#cb150-8" tabindex="-1"></a>  cuts_first <span class="ot">=</span> <span class="fu">cut_clump_fn</span>(</span>
<span id="cb150-9"><a href="tree_spatial.html#cb150-9" tabindex="-1"></a>    <span class="at">c =</span> c</span>
<span id="cb150-10"><a href="tree_spatial.html#cb150-10" tabindex="-1"></a>    , <span class="at">need_cut_trees =</span> need_cut_trees</span>
<span id="cb150-11"><a href="tree_spatial.html#cb150-11" tabindex="-1"></a>    , <span class="at">tgt =</span> tgt</span>
<span id="cb150-12"><a href="tree_spatial.html#cb150-12" tabindex="-1"></a>  )</span>
<span id="cb150-13"><a href="tree_spatial.html#cb150-13" tabindex="-1"></a>  <span class="co"># did we get the target?</span></span>
<span id="cb150-14"><a href="tree_spatial.html#cb150-14" tabindex="-1"></a>  new_clumps <span class="ot">=</span> </span>
<span id="cb150-15"><a href="tree_spatial.html#cb150-15" tabindex="-1"></a>    need_cut_trees <span class="sc">%&gt;%</span> </span>
<span id="cb150-16"><a href="tree_spatial.html#cb150-16" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb150-17"><a href="tree_spatial.html#cb150-17" tabindex="-1"></a>        cuts_first <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb150-18"><a href="tree_spatial.html#cb150-18" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb150-19"><a href="tree_spatial.html#cb150-19" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb150-20"><a href="tree_spatial.html#cb150-20" tabindex="-1"></a>      <span class="fu">sp_clump_points</span>()</span>
<span id="cb150-21"><a href="tree_spatial.html#cb150-21" tabindex="-1"></a>  <span class="co"># new_clumps %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(clump_n_trees_grp)</span></span>
<span id="cb150-22"><a href="tree_spatial.html#cb150-22" tabindex="-1"></a>  </span>
<span id="cb150-23"><a href="tree_spatial.html#cb150-23" tabindex="-1"></a>  <span class="cf">while</span>(</span>
<span id="cb150-24"><a href="tree_spatial.html#cb150-24" tabindex="-1"></a>    (</span>
<span id="cb150-25"><a href="tree_spatial.html#cb150-25" tabindex="-1"></a>      new_clumps <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">&gt;</span> tgt) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb150-26"><a href="tree_spatial.html#cb150-26" tabindex="-1"></a>    ) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb150-27"><a href="tree_spatial.html#cb150-27" tabindex="-1"></a>  ){</span>
<span id="cb150-28"><a href="tree_spatial.html#cb150-28" tabindex="-1"></a>    <span class="co"># redo the cut clump</span></span>
<span id="cb150-29"><a href="tree_spatial.html#cb150-29" tabindex="-1"></a>    <span class="co"># redo the cut clump</span></span>
<span id="cb150-30"><a href="tree_spatial.html#cb150-30" tabindex="-1"></a>    cuts_again <span class="ot">=</span> new_clumps <span class="sc">%&gt;%</span> </span>
<span id="cb150-31"><a href="tree_spatial.html#cb150-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">&gt;</span> tgt) <span class="sc">%&gt;%</span></span>
<span id="cb150-32"><a href="tree_spatial.html#cb150-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb150-33"><a href="tree_spatial.html#cb150-33" tabindex="-1"></a>      <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb150-34"><a href="tree_spatial.html#cb150-34" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(cut_clump_fn, <span class="at">need_cut_trees =</span> new_clumps, <span class="at">tgt =</span> tgt) <span class="sc">%&gt;%</span> </span>
<span id="cb150-35"><a href="tree_spatial.html#cb150-35" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb150-36"><a href="tree_spatial.html#cb150-36" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">updt =</span> is_keep_tree)</span>
<span id="cb150-37"><a href="tree_spatial.html#cb150-37" tabindex="-1"></a>    </span>
<span id="cb150-38"><a href="tree_spatial.html#cb150-38" tabindex="-1"></a>    <span class="co"># update the original cut data</span></span>
<span id="cb150-39"><a href="tree_spatial.html#cb150-39" tabindex="-1"></a>    cuts_first <span class="ot">=</span> cuts_first <span class="sc">%&gt;%</span></span>
<span id="cb150-40"><a href="tree_spatial.html#cb150-40" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb150-41"><a href="tree_spatial.html#cb150-41" tabindex="-1"></a>        cuts_again</span>
<span id="cb150-42"><a href="tree_spatial.html#cb150-42" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb150-43"><a href="tree_spatial.html#cb150-43" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb150-44"><a href="tree_spatial.html#cb150-44" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(updt, is_keep_tree)) <span class="sc">%&gt;%</span> </span>
<span id="cb150-45"><a href="tree_spatial.html#cb150-45" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(updt))</span>
<span id="cb150-46"><a href="tree_spatial.html#cb150-46" tabindex="-1"></a>    </span>
<span id="cb150-47"><a href="tree_spatial.html#cb150-47" tabindex="-1"></a>    <span class="co"># reset the new clumps</span></span>
<span id="cb150-48"><a href="tree_spatial.html#cb150-48" tabindex="-1"></a>    new_clumps <span class="ot">=</span> </span>
<span id="cb150-49"><a href="tree_spatial.html#cb150-49" tabindex="-1"></a>      need_cut_trees <span class="sc">%&gt;%</span> </span>
<span id="cb150-50"><a href="tree_spatial.html#cb150-50" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb150-51"><a href="tree_spatial.html#cb150-51" tabindex="-1"></a>          cuts_first <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb150-52"><a href="tree_spatial.html#cb150-52" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb150-53"><a href="tree_spatial.html#cb150-53" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb150-54"><a href="tree_spatial.html#cb150-54" tabindex="-1"></a>        <span class="fu">sp_clump_points</span>()</span>
<span id="cb150-55"><a href="tree_spatial.html#cb150-55" tabindex="-1"></a>    <span class="co"># new_clumps %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(clump_n_trees_grp)</span></span>
<span id="cb150-56"><a href="tree_spatial.html#cb150-56" tabindex="-1"></a>  } <span class="co"># end while</span></span>
<span id="cb150-57"><a href="tree_spatial.html#cb150-57" tabindex="-1"></a>  <span class="fu">return</span>(cuts_first) </span>
<span id="cb150-58"><a href="tree_spatial.html#cb150-58" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="function-to-pass-a-tree-list" class="section level5 hasAnchor" number="9.2.4.2.3">
<h5><span class="header-section-number">9.2.4.2.3</span> function to pass a tree list<a href="tree_spatial.html#function-to-pass-a-tree-list" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>function to pass a whole tree list of sf point data</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="tree_spatial.html#cb151-1" tabindex="-1"></a><span class="do">##############################################</span></span>
<span id="cb151-2"><a href="tree_spatial.html#cb151-2" tabindex="-1"></a><span class="co"># get cut keep tree flag</span></span>
<span id="cb151-3"><a href="tree_spatial.html#cb151-3" tabindex="-1"></a><span class="do">##############################################</span></span>
<span id="cb151-4"><a href="tree_spatial.html#cb151-4" tabindex="-1"></a>get_keep_tree_flag <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb151-5"><a href="tree_spatial.html#cb151-5" tabindex="-1"></a>  x <span class="co"># x = sf point data</span></span>
<span id="cb151-6"><a href="tree_spatial.html#cb151-6" tabindex="-1"></a>  , tgt <span class="co"># tgt = clump_n_trees_grp level defined in sp_clump_points: ...</span></span>
<span id="cb151-7"><a href="tree_spatial.html#cb151-7" tabindex="-1"></a>    <span class="do">## ... clump_labels = c(&quot;Individual&quot;,&quot;2-4 trees&quot;,&quot;5-9 trees&quot;,&quot;10-15 trees&quot;,&quot;&gt;15 trees&quot;)</span></span>
<span id="cb151-8"><a href="tree_spatial.html#cb151-8" tabindex="-1"></a>  , <span class="at">clump_dist_m =</span> <span class="dv">6</span> <span class="co"># size (radius) of the epsilon neighborhood = maximum distance between points to add to clump</span></span>
<span id="cb151-9"><a href="tree_spatial.html#cb151-9" tabindex="-1"></a>) {</span>
<span id="cb151-10"><a href="tree_spatial.html#cb151-10" tabindex="-1"></a>  <span class="co"># MAKE CUTS INDEPENDENT OF CURRENT CLUMP GROUPING...</span></span>
<span id="cb151-11"><a href="tree_spatial.html#cb151-11" tabindex="-1"></a>  <span class="co"># what if we pass a tree list with trees already cut? and thus, potentially different clump group sizes than is </span></span>
<span id="cb151-12"><a href="tree_spatial.html#cb151-12" tabindex="-1"></a>  <span class="co"># currently defined in clump_n_trees_grp?</span></span>
<span id="cb151-13"><a href="tree_spatial.html#cb151-13" tabindex="-1"></a>  <span class="co"># 1) apply the clump grouping </span></span>
<span id="cb151-14"><a href="tree_spatial.html#cb151-14" tabindex="-1"></a>  <span class="co"># 2) only go through the cut alg for clumps that need cutting to the target</span></span>
<span id="cb151-15"><a href="tree_spatial.html#cb151-15" tabindex="-1"></a>  <span class="co"># 3) append the trees in target clump or lower to the list at the end</span></span>
<span id="cb151-16"><a href="tree_spatial.html#cb151-16" tabindex="-1"></a>  </span>
<span id="cb151-17"><a href="tree_spatial.html#cb151-17" tabindex="-1"></a>  <span class="do">#############################</span></span>
<span id="cb151-18"><a href="tree_spatial.html#cb151-18" tabindex="-1"></a>  <span class="co"># 1) apply the clump grouping </span></span>
<span id="cb151-19"><a href="tree_spatial.html#cb151-19" tabindex="-1"></a>  <span class="do">#############################</span></span>
<span id="cb151-20"><a href="tree_spatial.html#cb151-20" tabindex="-1"></a>  new_clump_trees <span class="ot">=</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb151-21"><a href="tree_spatial.html#cb151-21" tabindex="-1"></a>    <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> clump_dist_m)</span>
<span id="cb151-22"><a href="tree_spatial.html#cb151-22" tabindex="-1"></a>    </span>
<span id="cb151-23"><a href="tree_spatial.html#cb151-23" tabindex="-1"></a>  <span class="co"># need cutting still</span></span>
<span id="cb151-24"><a href="tree_spatial.html#cb151-24" tabindex="-1"></a>  need_cut_trees <span class="ot">=</span> new_clump_trees <span class="sc">%&gt;%</span> </span>
<span id="cb151-25"><a href="tree_spatial.html#cb151-25" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">&gt;</span> tgt)</span>
<span id="cb151-26"><a href="tree_spatial.html#cb151-26" tabindex="-1"></a>  </span>
<span id="cb151-27"><a href="tree_spatial.html#cb151-27" tabindex="-1"></a>  <span class="do">#############################</span></span>
<span id="cb151-28"><a href="tree_spatial.html#cb151-28" tabindex="-1"></a>  <span class="co"># 2) only go through the cut alg for clumps that need cutting to the target</span></span>
<span id="cb151-29"><a href="tree_spatial.html#cb151-29" tabindex="-1"></a>  <span class="do">#############################</span></span>
<span id="cb151-30"><a href="tree_spatial.html#cb151-30" tabindex="-1"></a>  <span class="co"># for each clump that still needs cutting, iterate over and return keep/cut flag</span></span>
<span id="cb151-31"><a href="tree_spatial.html#cb151-31" tabindex="-1"></a>  compl_need_cut_trees <span class="ot">=</span> need_cut_trees <span class="sc">%&gt;%</span> </span>
<span id="cb151-32"><a href="tree_spatial.html#cb151-32" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb151-33"><a href="tree_spatial.html#cb151-33" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb151-34"><a href="tree_spatial.html#cb151-34" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(get_cut_clump, <span class="at">need_cut_trees =</span> need_cut_trees, <span class="at">tgt =</span> tgt) <span class="sc">%&gt;%</span>  <span class="co"># purrr:map fn</span></span>
<span id="cb151-35"><a href="tree_spatial.html#cb151-35" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb151-36"><a href="tree_spatial.html#cb151-36" tabindex="-1"></a>  </span>
<span id="cb151-37"><a href="tree_spatial.html#cb151-37" tabindex="-1"></a>  <span class="do">#############################</span></span>
<span id="cb151-38"><a href="tree_spatial.html#cb151-38" tabindex="-1"></a>  <span class="co"># 4) append the trees in target clump or lower to the list at the end</span></span>
<span id="cb151-39"><a href="tree_spatial.html#cb151-39" tabindex="-1"></a>  <span class="do">#############################</span></span>
<span id="cb151-40"><a href="tree_spatial.html#cb151-40" tabindex="-1"></a>  compl_need_cut_trees <span class="ot">=</span> compl_need_cut_trees <span class="sc">%&gt;%</span> </span>
<span id="cb151-41"><a href="tree_spatial.html#cb151-41" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb151-42"><a href="tree_spatial.html#cb151-42" tabindex="-1"></a>      new_clump_trees <span class="sc">%&gt;%</span> </span>
<span id="cb151-43"><a href="tree_spatial.html#cb151-43" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb151-44"><a href="tree_spatial.html#cb151-44" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">&lt;=</span> tgt) <span class="sc">%&gt;%</span> </span>
<span id="cb151-45"><a href="tree_spatial.html#cb151-45" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-46"><a href="tree_spatial.html#cb151-46" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, is_keep_tree)</span>
<span id="cb151-47"><a href="tree_spatial.html#cb151-47" tabindex="-1"></a>    )</span>
<span id="cb151-48"><a href="tree_spatial.html#cb151-48" tabindex="-1"></a>  </span>
<span id="cb151-49"><a href="tree_spatial.html#cb151-49" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb151-50"><a href="tree_spatial.html#cb151-50" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb151-51"><a href="tree_spatial.html#cb151-51" tabindex="-1"></a>    <span class="co"># original data so that order is preserved</span></span>
<span id="cb151-52"><a href="tree_spatial.html#cb151-52" tabindex="-1"></a>    x <span class="sc">%&gt;%</span> </span>
<span id="cb151-53"><a href="tree_spatial.html#cb151-53" tabindex="-1"></a>      <span class="co"># add on trees that got cut with trees already good</span></span>
<span id="cb151-54"><a href="tree_spatial.html#cb151-54" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb151-55"><a href="tree_spatial.html#cb151-55" tabindex="-1"></a>        compl_need_cut_trees</span>
<span id="cb151-56"><a href="tree_spatial.html#cb151-56" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb151-57"><a href="tree_spatial.html#cb151-57" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb151-58"><a href="tree_spatial.html#cb151-58" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(is_keep_tree)</span>
<span id="cb151-59"><a href="tree_spatial.html#cb151-59" tabindex="-1"></a>  )</span>
<span id="cb151-60"><a href="tree_spatial.html#cb151-60" tabindex="-1"></a>  </span>
<span id="cb151-61"><a href="tree_spatial.html#cb151-61" tabindex="-1"></a>} <span class="co"># get_keep_tree_flag</span></span></code></pre></div>
<p>example for random sample of trees</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="tree_spatial.html#cb152-1" tabindex="-1"></a><span class="co"># ex</span></span>
<span id="cb152-2"><a href="tree_spatial.html#cb152-2" tabindex="-1"></a><span class="co"># random sample the data</span></span>
<span id="cb152-3"><a href="tree_spatial.html#cb152-3" tabindex="-1"></a>rand_trees <span class="ot">=</span> ttops_temp <span class="sc">%&gt;%</span></span>
<span id="cb152-4"><a href="tree_spatial.html#cb152-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="fl">0.55</span>) <span class="sc">%&gt;%</span></span>
<span id="cb152-5"><a href="tree_spatial.html#cb152-5" tabindex="-1"></a>  <span class="fu">sp_clump_points</span>()</span>
<span id="cb152-6"><a href="tree_spatial.html#cb152-6" tabindex="-1"></a><span class="co"># check these grps</span></span>
<span id="cb152-7"><a href="tree_spatial.html#cb152-7" tabindex="-1"></a>rand_trees <span class="sc">%&gt;%</span></span>
<span id="cb152-8"><a href="tree_spatial.html#cb152-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb152-9"><a href="tree_spatial.html#cb152-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(clump_n_trees_grp)</span></code></pre></div>
<pre><code>## # A tibble: 5 × 2
##   clump_n_trees_grp     n
##   &lt;ord&gt;             &lt;int&gt;
## 1 Individual          336
## 2 2-4 trees           515
## 3 5-9 trees           238
## 4 10-15 trees          61
## 5 &gt;15 trees            19</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="tree_spatial.html#cb154-1" tabindex="-1"></a><span class="co"># get the flag</span></span>
<span id="cb154-2"><a href="tree_spatial.html#cb154-2" tabindex="-1"></a>rand_trees<span class="sc">$</span>is_keep_tree <span class="ot">=</span> <span class="fu">get_keep_tree_flag</span>(</span>
<span id="cb154-3"><a href="tree_spatial.html#cb154-3" tabindex="-1"></a>    <span class="at">x =</span> rand_trees</span>
<span id="cb154-4"><a href="tree_spatial.html#cb154-4" tabindex="-1"></a>    , <span class="at">tgt =</span> <span class="st">&quot;5-9 trees&quot;</span></span>
<span id="cb154-5"><a href="tree_spatial.html#cb154-5" tabindex="-1"></a>    , <span class="at">clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb154-6"><a href="tree_spatial.html#cb154-6" tabindex="-1"></a>  )</span>
<span id="cb154-7"><a href="tree_spatial.html#cb154-7" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb154-8"><a href="tree_spatial.html#cb154-8" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb154-9"><a href="tree_spatial.html#cb154-9" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">get_clump_summary</span>(rand_trees), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb154-10"><a href="tree_spatial.html#cb154-10" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb154-11"><a href="tree_spatial.html#cb154-11" tabindex="-1"></a>    <span class="at">data =</span> rand_trees <span class="sc">%&gt;%</span></span>
<span id="cb154-12"><a href="tree_spatial.html#cb154-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb154-13"><a href="tree_spatial.html#cb154-13" tabindex="-1"></a>      <span class="fu">sp_clump_points</span>() <span class="sc">%&gt;%</span></span>
<span id="cb154-14"><a href="tree_spatial.html#cb154-14" tabindex="-1"></a>      <span class="fu">get_clump_summary</span>()</span>
<span id="cb154-15"><a href="tree_spatial.html#cb154-15" tabindex="-1"></a>    , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_n_trees_grp)</span>
<span id="cb154-16"><a href="tree_spatial.html#cb154-16" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb154-17"><a href="tree_spatial.html#cb154-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb154-18"><a href="tree_spatial.html#cb154-18" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rand_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree<span class="sc">==</span><span class="dv">0</span>), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">&quot;cut tree&quot;</span>), <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb154-19"><a href="tree_spatial.html#cb154-19" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-75-1.png" width="1008" /></p>
</div>
</div>
<div id="cut-one-group-size-example" class="section level4 hasAnchor" number="9.2.4.3">
<h4><span class="header-section-number">9.2.4.3</span> Cut one group size example<a href="tree_spatial.html#cut-one-group-size-example" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="tree_spatial.html#cb155-1" tabindex="-1"></a><span class="co"># use target data to get cut trees by clump size group</span></span>
<span id="cb155-2"><a href="tree_spatial.html#cb155-2" tabindex="-1"></a><span class="co"># !!!! need this first:</span></span>
<span id="cb155-3"><a href="tree_spatial.html#cb155-3" tabindex="-1"></a>  <span class="co"># target_data_temp = get_target_check_prescription(</span></span>
<span id="cb155-4"><a href="tree_spatial.html#cb155-4" tabindex="-1"></a>  <span class="co">#   clump_n_trees_grp_summary_temp</span></span>
<span id="cb155-5"><a href="tree_spatial.html#cb155-5" tabindex="-1"></a>  <span class="co">#   , target_ba = target_ba</span></span>
<span id="cb155-6"><a href="tree_spatial.html#cb155-6" tabindex="-1"></a>  <span class="co">#   , target_qmd = target_qmd</span></span>
<span id="cb155-7"><a href="tree_spatial.html#cb155-7" tabindex="-1"></a>  <span class="co">#   , target_pcts = target_pcts</span></span>
<span id="cb155-8"><a href="tree_spatial.html#cb155-8" tabindex="-1"></a>  <span class="co"># )</span></span>
<span id="cb155-9"><a href="tree_spatial.html#cb155-9" tabindex="-1"></a>cut_grp_ex_temp <span class="ot">=</span> ttops_temp <span class="sc">%&gt;%</span></span>
<span id="cb155-10"><a href="tree_spatial.html#cb155-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;&gt;15 trees&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-11"><a href="tree_spatial.html#cb155-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb155-12"><a href="tree_spatial.html#cb155-12" tabindex="-1"></a></span>
<span id="cb155-13"><a href="tree_spatial.html#cb155-13" tabindex="-1"></a><span class="co"># get the flag</span></span>
<span id="cb155-14"><a href="tree_spatial.html#cb155-14" tabindex="-1"></a>cut_grp_ex_temp<span class="sc">$</span>is_keep_tree <span class="ot">=</span> <span class="fu">get_keep_tree_flag</span>(</span>
<span id="cb155-15"><a href="tree_spatial.html#cb155-15" tabindex="-1"></a>    <span class="at">x =</span> cut_grp_ex_temp</span>
<span id="cb155-16"><a href="tree_spatial.html#cb155-16" tabindex="-1"></a>    , <span class="at">tgt =</span> <span class="st">&quot;10-15 trees&quot;</span></span>
<span id="cb155-17"><a href="tree_spatial.html#cb155-17" tabindex="-1"></a>    , <span class="at">clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb155-18"><a href="tree_spatial.html#cb155-18" tabindex="-1"></a>  )</span>
<span id="cb155-19"><a href="tree_spatial.html#cb155-19" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb155-20"><a href="tree_spatial.html#cb155-20" tabindex="-1"></a><span class="co"># cut_grp_ex_temp %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>example group cut and keep trees</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="tree_spatial.html#cb156-1" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb156-2"><a href="tree_spatial.html#cb156-2" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid <span class="sc">==</span> my_suid), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb156-3"><a href="tree_spatial.html#cb156-3" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb156-4"><a href="tree_spatial.html#cb156-4" tabindex="-1"></a>      <span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb156-5"><a href="tree_spatial.html#cb156-5" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_id)</span>
<span id="cb156-6"><a href="tree_spatial.html#cb156-6" tabindex="-1"></a>      , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb156-7"><a href="tree_spatial.html#cb156-7" tabindex="-1"></a>      , <span class="at">show.legend =</span> F</span>
<span id="cb156-8"><a href="tree_spatial.html#cb156-8" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb156-9"><a href="tree_spatial.html#cb156-9" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb156-10"><a href="tree_spatial.html#cb156-10" tabindex="-1"></a>      <span class="at">values =</span> </span>
<span id="cb156-11"><a href="tree_spatial.html#cb156-11" tabindex="-1"></a>        viridis<span class="sc">::</span><span class="fu">turbo</span>(</span>
<span id="cb156-12"><a href="tree_spatial.html#cb156-12" tabindex="-1"></a>          clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;&gt;15 trees&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb156-13"><a href="tree_spatial.html#cb156-13" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb156-14"><a href="tree_spatial.html#cb156-14" tabindex="-1"></a>          <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb156-15"><a href="tree_spatial.html#cb156-15" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> <span class="fu">sample</span>()</span>
<span id="cb156-16"><a href="tree_spatial.html#cb156-16" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb156-17"><a href="tree_spatial.html#cb156-17" tabindex="-1"></a>    <span class="co"># tree points</span></span>
<span id="cb156-18"><a href="tree_spatial.html#cb156-18" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> cut_grp_ex_temp, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(is_keep_tree)), <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb156-19"><a href="tree_spatial.html#cb156-19" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray&quot;</span>, <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb156-20"><a href="tree_spatial.html#cb156-20" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;is keep tree?&quot;</span>, <span class="at">caption =</span> <span class="st">&quot;*existing clumps distinguished by color&quot;</span>) <span class="sc">+</span></span>
<span id="cb156-21"><a href="tree_spatial.html#cb156-21" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span> </span>
<span id="cb156-22"><a href="tree_spatial.html#cb156-22" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)))</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-78-1.png" width="1008" /></p>
<p>residual clump group size</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="tree_spatial.html#cb157-1" tabindex="-1"></a><span class="co"># get dbscan</span></span>
<span id="cb157-2"><a href="tree_spatial.html#cb157-2" tabindex="-1"></a>  my_dbscan_temp <span class="ot">=</span> cut_grp_ex_temp <span class="sc">%&gt;%</span> </span>
<span id="cb157-3"><a href="tree_spatial.html#cb157-3" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb157-4"><a href="tree_spatial.html#cb157-4" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb157-5"><a href="tree_spatial.html#cb157-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y) <span class="sc">%&gt;%</span> </span>
<span id="cb157-6"><a href="tree_spatial.html#cb157-6" tabindex="-1"></a>      dbscan<span class="sc">::</span><span class="fu">dbscan</span>(<span class="at">eps =</span> tree_clump_dist_m, <span class="at">minPts =</span> <span class="dv">2</span>)</span>
<span id="cb157-7"><a href="tree_spatial.html#cb157-7" tabindex="-1"></a><span class="co"># attach dbscan</span></span>
<span id="cb157-8"><a href="tree_spatial.html#cb157-8" tabindex="-1"></a>t_temp <span class="ot">=</span> cut_grp_ex_temp <span class="sc">%&gt;%</span> </span>
<span id="cb157-9"><a href="tree_spatial.html#cb157-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb157-10"><a href="tree_spatial.html#cb157-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dbscan_cluster =</span> my_dbscan_temp<span class="sc">$</span>cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb157-11"><a href="tree_spatial.html#cb157-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(dbscan_cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb157-12"><a href="tree_spatial.html#cb157-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb157-13"><a href="tree_spatial.html#cb157-13" tabindex="-1"></a>    <span class="co"># unique dbscan_cluster for individuals</span></span>
<span id="cb157-14"><a href="tree_spatial.html#cb157-14" tabindex="-1"></a>    <span class="at">clump_id =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb157-15"><a href="tree_spatial.html#cb157-15" tabindex="-1"></a>      dbscan_cluster <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">max</span>(my_dbscan_temp<span class="sc">$</span>cluster)<span class="sc">+</span>dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb157-16"><a href="tree_spatial.html#cb157-16" tabindex="-1"></a>      , T <span class="sc">~</span> dbscan_cluster</span>
<span id="cb157-17"><a href="tree_spatial.html#cb157-17" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb157-18"><a href="tree_spatial.html#cb157-18" tabindex="-1"></a>    <span class="fu">factor</span>()</span>
<span id="cb157-19"><a href="tree_spatial.html#cb157-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb157-20"><a href="tree_spatial.html#cb157-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb157-21"><a href="tree_spatial.html#cb157-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb157-22"><a href="tree_spatial.html#cb157-22" tabindex="-1"></a>    <span class="at">dbscan_cluster =</span> <span class="fu">factor</span>(dbscan_cluster)</span>
<span id="cb157-23"><a href="tree_spatial.html#cb157-23" tabindex="-1"></a>    , <span class="at">clump_n_trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb157-24"><a href="tree_spatial.html#cb157-24" tabindex="-1"></a>    , <span class="at">clump_n_trees_grp =</span> <span class="fu">cut</span>(</span>
<span id="cb157-25"><a href="tree_spatial.html#cb157-25" tabindex="-1"></a>        clump_n_trees</span>
<span id="cb157-26"><a href="tree_spatial.html#cb157-26" tabindex="-1"></a>        ,<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="cn">Inf</span>)</span>
<span id="cb157-27"><a href="tree_spatial.html#cb157-27" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>,<span class="st">&quot;2-4 trees&quot;</span>,<span class="st">&quot;5-9 trees&quot;</span>,<span class="st">&quot;10-15 trees&quot;</span>,<span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb157-28"><a href="tree_spatial.html#cb157-28" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb157-29"><a href="tree_spatial.html#cb157-29" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb157-30"><a href="tree_spatial.html#cb157-30" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb157-31"><a href="tree_spatial.html#cb157-31" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Individual&quot;</span>,<span class="st">&quot;2-4 trees&quot;</span>,<span class="st">&quot;5-9 trees&quot;</span>,<span class="st">&quot;10-15 trees&quot;</span>,<span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb157-32"><a href="tree_spatial.html#cb157-32" tabindex="-1"></a>      )</span>
<span id="cb157-33"><a href="tree_spatial.html#cb157-33" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb157-34"><a href="tree_spatial.html#cb157-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb157-35"><a href="tree_spatial.html#cb157-35" tabindex="-1"></a></span>
<span id="cb157-36"><a href="tree_spatial.html#cb157-36" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb157-37"><a href="tree_spatial.html#cb157-37" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb157-38"><a href="tree_spatial.html#cb157-38" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> harvests <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(suid <span class="sc">==</span> my_suid), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb157-39"><a href="tree_spatial.html#cb157-39" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb157-40"><a href="tree_spatial.html#cb157-40" tabindex="-1"></a>      <span class="at">data =</span> clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;&gt;15 trees&quot;</span>)</span>
<span id="cb157-41"><a href="tree_spatial.html#cb157-41" tabindex="-1"></a>      , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb157-42"><a href="tree_spatial.html#cb157-42" tabindex="-1"></a>      , <span class="at">show.legend =</span> F</span>
<span id="cb157-43"><a href="tree_spatial.html#cb157-43" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb157-44"><a href="tree_spatial.html#cb157-44" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb157-45"><a href="tree_spatial.html#cb157-45" tabindex="-1"></a>      <span class="at">data =</span> t_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(tree_clump_dist_m<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb157-46"><a href="tree_spatial.html#cb157-46" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_n_trees_grp)</span>
<span id="cb157-47"><a href="tree_spatial.html#cb157-47" tabindex="-1"></a>      , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb157-48"><a href="tree_spatial.html#cb157-48" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb157-49"><a href="tree_spatial.html#cb157-49" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_d</span>(</span>
<span id="cb157-50"><a href="tree_spatial.html#cb157-50" tabindex="-1"></a>      <span class="at">option=</span><span class="st">&quot;mako&quot;</span></span>
<span id="cb157-51"><a href="tree_spatial.html#cb157-51" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb157-52"><a href="tree_spatial.html#cb157-52" tabindex="-1"></a>      , <span class="at">name =</span> <span class="st">&quot;Residual</span><span class="sc">\n</span><span class="st">clump size&quot;</span></span>
<span id="cb157-53"><a href="tree_spatial.html#cb157-53" tabindex="-1"></a>      , <span class="at">drop =</span> F</span>
<span id="cb157-54"><a href="tree_spatial.html#cb157-54" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb157-55"><a href="tree_spatial.html#cb157-55" tabindex="-1"></a>    <span class="co"># tree points</span></span>
<span id="cb157-56"><a href="tree_spatial.html#cb157-56" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> cut_grp_ex_temp <span class="sc">%&gt;%</span> </span>
<span id="cb157-57"><a href="tree_spatial.html#cb157-57" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb157-58"><a href="tree_spatial.html#cb157-58" tabindex="-1"></a>        , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">&quot;cut trees&quot;</span>)</span>
<span id="cb157-59"><a href="tree_spatial.html#cb157-59" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">0.5</span></span>
<span id="cb157-60"><a href="tree_spatial.html#cb157-60" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb157-61"><a href="tree_spatial.html#cb157-61" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>), <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb157-62"><a href="tree_spatial.html#cb157-62" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb157-63"><a href="tree_spatial.html#cb157-63" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">&quot;cut trees in clumps sized &gt;15 trees&quot;</span></span>
<span id="cb157-64"><a href="tree_spatial.html#cb157-64" tabindex="-1"></a>      <span class="co"># caption = &quot;*cut trees shown in red&quot;</span></span>
<span id="cb157-65"><a href="tree_spatial.html#cb157-65" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb157-66"><a href="tree_spatial.html#cb157-66" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb157-67"><a href="tree_spatial.html#cb157-67" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">4</span>)))</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-79-1.png" width="1008" /></p>
</div>
<div id="process-to-cut-groups-incrementally" class="section level4 hasAnchor" number="9.2.4.4">
<h4><span class="header-section-number">9.2.4.4</span> Process to cut groups incrementally<a href="tree_spatial.html#process-to-cut-groups-incrementally" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><em>cut groups incrementally to achieve target tree clump group size proportions</em></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="tree_spatial.html#cb158-1" tabindex="-1"></a><span class="co"># must first have target data</span></span>
<span id="cb158-2"><a href="tree_spatial.html#cb158-2" tabindex="-1"></a><span class="co"># target_data_temp = get_target_check_prescription(</span></span>
<span id="cb158-3"><a href="tree_spatial.html#cb158-3" tabindex="-1"></a><span class="co">#   clump_n_trees_grp_summary_temp</span></span>
<span id="cb158-4"><a href="tree_spatial.html#cb158-4" tabindex="-1"></a><span class="co">#   , target_ba = target_ba</span></span>
<span id="cb158-5"><a href="tree_spatial.html#cb158-5" tabindex="-1"></a><span class="co">#   , target_qmd = target_qmd</span></span>
<span id="cb158-6"><a href="tree_spatial.html#cb158-6" tabindex="-1"></a><span class="co">#   , target_pcts = target_pcts</span></span>
<span id="cb158-7"><a href="tree_spatial.html#cb158-7" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb158-8"><a href="tree_spatial.html#cb158-8" tabindex="-1"></a></span>
<span id="cb158-9"><a href="tree_spatial.html#cb158-9" tabindex="-1"></a><span class="co"># what is the smallest group with a target?</span></span>
<span id="cb158-10"><a href="tree_spatial.html#cb158-10" tabindex="-1"></a>sm_grp_temp <span class="ot">=</span> target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-11"><a href="tree_spatial.html#cb158-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_stand_n_trees_target<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-12"><a href="tree_spatial.html#cb158-12" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_n_trees_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-13"><a href="tree_spatial.html#cb158-13" tabindex="-1"></a>    <span class="fu">min</span>()</span>
<span id="cb158-14"><a href="tree_spatial.html#cb158-14" tabindex="-1"></a></span>
<span id="cb158-15"><a href="tree_spatial.html#cb158-15" tabindex="-1"></a><span class="co"># start with the largest group in target data currently with trees</span></span>
<span id="cb158-16"><a href="tree_spatial.html#cb158-16" tabindex="-1"></a>grp_temp <span class="ot">=</span> target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-17"><a href="tree_spatial.html#cb158-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(clump_n_trees_grp)) <span class="sc">%&gt;%</span> </span>
<span id="cb158-18"><a href="tree_spatial.html#cb158-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_stand_n_trees_current<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-19"><a href="tree_spatial.html#cb158-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-20"><a href="tree_spatial.html#cb158-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_n_trees_grp)</span>
<span id="cb158-21"><a href="tree_spatial.html#cb158-21" tabindex="-1"></a></span>
<span id="cb158-22"><a href="tree_spatial.html#cb158-22" tabindex="-1"></a><span class="co"># identify clumps to leave untouched</span></span>
<span id="cb158-23"><a href="tree_spatial.html#cb158-23" tabindex="-1"></a><span class="co"># clump_polys_temp = get_clump_summary(ttops_temp)</span></span>
<span id="cb158-24"><a href="tree_spatial.html#cb158-24" tabindex="-1"></a>keep_clumps_temp <span class="ot">=</span> </span>
<span id="cb158-25"><a href="tree_spatial.html#cb158-25" tabindex="-1"></a>  clump_polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-26"><a href="tree_spatial.html#cb158-26" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-27"><a href="tree_spatial.html#cb158-27" tabindex="-1"></a>    <span class="co">#keep only trees in current group</span></span>
<span id="cb158-28"><a href="tree_spatial.html#cb158-28" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb158-29"><a href="tree_spatial.html#cb158-29" tabindex="-1"></a>      target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-30"><a href="tree_spatial.html#cb158-30" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-31"><a href="tree_spatial.html#cb158-31" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb158-32"><a href="tree_spatial.html#cb158-32" tabindex="-1"></a>          clump_n_trees_grp, mean_clump_n_trees, min_clump_n_trees, max_clump_n_trees</span>
<span id="cb158-33"><a href="tree_spatial.html#cb158-33" tabindex="-1"></a>          , stand_n_clumps_target</span>
<span id="cb158-34"><a href="tree_spatial.html#cb158-34" tabindex="-1"></a>        )</span>
<span id="cb158-35"><a href="tree_spatial.html#cb158-35" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;clump_n_trees_grp&quot;</span></span>
<span id="cb158-36"><a href="tree_spatial.html#cb158-36" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-37"><a href="tree_spatial.html#cb158-37" tabindex="-1"></a>    <span class="co"># keep only clumps that meet criteria</span></span>
<span id="cb158-38"><a href="tree_spatial.html#cb158-38" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb158-39"><a href="tree_spatial.html#cb158-39" tabindex="-1"></a>      n_trees <span class="sc">&gt;=</span> min_clump_n_trees</span>
<span id="cb158-40"><a href="tree_spatial.html#cb158-40" tabindex="-1"></a>      <span class="sc">&amp;</span> n_trees <span class="sc">&lt;=</span> max_clump_n_trees</span>
<span id="cb158-41"><a href="tree_spatial.html#cb158-41" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-42"><a href="tree_spatial.html#cb158-42" tabindex="-1"></a>    <span class="co"># keep clumps closest the mean number in target</span></span>
<span id="cb158-43"><a href="tree_spatial.html#cb158-43" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb158-44"><a href="tree_spatial.html#cb158-44" tabindex="-1"></a>      <span class="at">pct_to_target =</span> <span class="fu">abs</span>( (n_trees<span class="sc">-</span>mean_clump_n_trees)<span class="sc">/</span>mean_clump_n_trees )</span>
<span id="cb158-45"><a href="tree_spatial.html#cb158-45" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-46"><a href="tree_spatial.html#cb158-46" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(pct_to_target, <span class="fu">desc</span>(qmd_cm), n_trees, clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb158-47"><a href="tree_spatial.html#cb158-47" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span>stand_n_clumps_target) <span class="sc">%&gt;%</span> </span>
<span id="cb158-48"><a href="tree_spatial.html#cb158-48" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(clump_id)</span>
<span id="cb158-49"><a href="tree_spatial.html#cb158-49" tabindex="-1"></a></span>
<span id="cb158-50"><a href="tree_spatial.html#cb158-50" tabindex="-1"></a><span class="co"># !!!!!!!!!!FIX: WHAT IF WE HAVE CLUMPS OF THIS SIZE BUT THE N_TREES&gt;MAX_TREES AND NEED TO GET CLUMPS OF THIS SIZE?</span></span>
<span id="cb158-51"><a href="tree_spatial.html#cb158-51" tabindex="-1"></a><span class="co">#   ... UPDATE CUTTING ALG TO CUT CLUMP DOWN TO MIN-MAX TREE RANGE FOR CLUMPS WITH INF UPPER LIMIT</span></span>
<span id="cb158-52"><a href="tree_spatial.html#cb158-52" tabindex="-1"></a></span>
<span id="cb158-53"><a href="tree_spatial.html#cb158-53" tabindex="-1"></a><span class="co"># start building tree list with keep/cut flag</span></span>
<span id="cb158-54"><a href="tree_spatial.html#cb158-54" tabindex="-1"></a><span class="co"># ttops_temp = get_tree_clumps(</span></span>
<span id="cb158-55"><a href="tree_spatial.html#cb158-55" tabindex="-1"></a><span class="co">#   my_suid = my_suid</span></span>
<span id="cb158-56"><a href="tree_spatial.html#cb158-56" tabindex="-1"></a><span class="co">#   , tree_clump_dist_m = tree_clump_dist_m</span></span>
<span id="cb158-57"><a href="tree_spatial.html#cb158-57" tabindex="-1"></a><span class="co">#   , ostory_dbh_cm = ostory_dbh_cm</span></span>
<span id="cb158-58"><a href="tree_spatial.html#cb158-58" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb158-59"><a href="tree_spatial.html#cb158-59" tabindex="-1"></a><span class="co"># build tree list </span></span>
<span id="cb158-60"><a href="tree_spatial.html#cb158-60" tabindex="-1"></a>keep_trees <span class="ot">=</span></span>
<span id="cb158-61"><a href="tree_spatial.html#cb158-61" tabindex="-1"></a>  ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-62"><a href="tree_spatial.html#cb158-62" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-63"><a href="tree_spatial.html#cb158-63" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-64"><a href="tree_spatial.html#cb158-64" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(keep_clumps_temp, <span class="at">by =</span> <span class="st">&quot;clump_id&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-65"><a href="tree_spatial.html#cb158-65" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb158-66"><a href="tree_spatial.html#cb158-66" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> <span class="dv">1</span>)</span>
<span id="cb158-67"><a href="tree_spatial.html#cb158-67" tabindex="-1"></a></span>
<span id="cb158-68"><a href="tree_spatial.html#cb158-68" tabindex="-1"></a><span class="co"># did we keep all of the clumps?</span></span>
<span id="cb158-69"><a href="tree_spatial.html#cb158-69" tabindex="-1"></a><span class="cf">if</span>( </span>
<span id="cb158-70"><a href="tree_spatial.html#cb158-70" tabindex="-1"></a>  <span class="fu">nrow</span>(keep_clumps_temp) <span class="sc">==</span> </span>
<span id="cb158-71"><a href="tree_spatial.html#cb158-71" tabindex="-1"></a>  ( clump_polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() )</span>
<span id="cb158-72"><a href="tree_spatial.html#cb158-72" tabindex="-1"></a>){</span>
<span id="cb158-73"><a href="tree_spatial.html#cb158-73" tabindex="-1"></a>  remaining_trees <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb158-74"><a href="tree_spatial.html#cb158-74" tabindex="-1"></a>    <span class="at">treeID =</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb158-75"><a href="tree_spatial.html#cb158-75" tabindex="-1"></a>    , <span class="at">is_keep_tree =</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb158-76"><a href="tree_spatial.html#cb158-76" tabindex="-1"></a>  )</span>
<span id="cb158-77"><a href="tree_spatial.html#cb158-77" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb158-78"><a href="tree_spatial.html#cb158-78" tabindex="-1"></a>  <span class="co"># determine keep/cut for the remaining trees in that group type </span></span>
<span id="cb158-79"><a href="tree_spatial.html#cb158-79" tabindex="-1"></a>  remaining_trees <span class="ot">=</span> </span>
<span id="cb158-80"><a href="tree_spatial.html#cb158-80" tabindex="-1"></a>    ttops_temp <span class="sc">%&gt;%</span></span>
<span id="cb158-81"><a href="tree_spatial.html#cb158-81" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-82"><a href="tree_spatial.html#cb158-82" tabindex="-1"></a>      <span class="co"># keep only trees in current grp</span></span>
<span id="cb158-83"><a href="tree_spatial.html#cb158-83" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-84"><a href="tree_spatial.html#cb158-84" tabindex="-1"></a>      <span class="co"># remove keep trees</span></span>
<span id="cb158-85"><a href="tree_spatial.html#cb158-85" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">anti_join</span>(keep_trees, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb158-86"><a href="tree_spatial.html#cb158-86" tabindex="-1"></a>  </span>
<span id="cb158-87"><a href="tree_spatial.html#cb158-87" tabindex="-1"></a>  <span class="co"># apply the cutting algorithm</span></span>
<span id="cb158-88"><a href="tree_spatial.html#cb158-88" tabindex="-1"></a>  <span class="co"># get the flag</span></span>
<span id="cb158-89"><a href="tree_spatial.html#cb158-89" tabindex="-1"></a>  remaining_trees<span class="sc">$</span>is_keep_tree <span class="ot">=</span> <span class="fu">get_keep_tree_flag</span>(</span>
<span id="cb158-90"><a href="tree_spatial.html#cb158-90" tabindex="-1"></a>      <span class="at">x =</span> remaining_trees</span>
<span id="cb158-91"><a href="tree_spatial.html#cb158-91" tabindex="-1"></a>      , <span class="at">tgt =</span> target_data_temp <span class="sc">%&gt;%</span>  </span>
<span id="cb158-92"><a href="tree_spatial.html#cb158-92" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb158-93"><a href="tree_spatial.html#cb158-93" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">arrange</span>(clump_n_trees_grp) <span class="sc">%&gt;%</span></span>
<span id="cb158-94"><a href="tree_spatial.html#cb158-94" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">l =</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(clump_n_trees_grp)) <span class="sc">%&gt;%</span></span>
<span id="cb158-95"><a href="tree_spatial.html#cb158-95" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span></span>
<span id="cb158-96"><a href="tree_spatial.html#cb158-96" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(l)</span>
<span id="cb158-97"><a href="tree_spatial.html#cb158-97" tabindex="-1"></a>      , <span class="at">clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb158-98"><a href="tree_spatial.html#cb158-98" tabindex="-1"></a>    ) </span>
<span id="cb158-99"><a href="tree_spatial.html#cb158-99" tabindex="-1"></a>  </span>
<span id="cb158-100"><a href="tree_spatial.html#cb158-100" tabindex="-1"></a>  <span class="co"># select relevant columns</span></span>
<span id="cb158-101"><a href="tree_spatial.html#cb158-101" tabindex="-1"></a>  remaining_trees <span class="ot">=</span> remaining_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-102"><a href="tree_spatial.html#cb158-102" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-103"><a href="tree_spatial.html#cb158-103" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-104"><a href="tree_spatial.html#cb158-104" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, is_keep_tree)</span>
<span id="cb158-105"><a href="tree_spatial.html#cb158-105" tabindex="-1"></a>}</span>
<span id="cb158-106"><a href="tree_spatial.html#cb158-106" tabindex="-1"></a><span class="do">###############################################</span></span>
<span id="cb158-107"><a href="tree_spatial.html#cb158-107" tabindex="-1"></a><span class="co"># now process to go on to the next groups</span></span>
<span id="cb158-108"><a href="tree_spatial.html#cb158-108" tabindex="-1"></a><span class="do">###############################################</span></span>
<span id="cb158-109"><a href="tree_spatial.html#cb158-109" tabindex="-1"></a><span class="co"># get the next group</span></span>
<span id="cb158-110"><a href="tree_spatial.html#cb158-110" tabindex="-1"></a>  grp_temp <span class="ot">=</span> target_data_temp <span class="sc">%&gt;%</span></span>
<span id="cb158-111"><a href="tree_spatial.html#cb158-111" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp<span class="sc">&lt;</span>grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-112"><a href="tree_spatial.html#cb158-112" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(clump_n_trees_grp)) <span class="sc">%&gt;%</span> </span>
<span id="cb158-113"><a href="tree_spatial.html#cb158-113" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-114"><a href="tree_spatial.html#cb158-114" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_n_trees_grp)</span>
<span id="cb158-115"><a href="tree_spatial.html#cb158-115" tabindex="-1"></a></span>
<span id="cb158-116"><a href="tree_spatial.html#cb158-116" tabindex="-1"></a><span class="cf">while</span>(grp_temp<span class="sc">&gt;=</span>sm_grp_temp <span class="sc">&amp;</span> grp_temp <span class="sc">!=</span> <span class="st">&quot;Individual&quot;</span>){</span>
<span id="cb158-117"><a href="tree_spatial.html#cb158-117" tabindex="-1"></a>  <span class="co"># print(</span></span>
<span id="cb158-118"><a href="tree_spatial.html#cb158-118" tabindex="-1"></a>  <span class="co">#   paste(&quot;starting: &quot;, grp_temp, Sys.time())</span></span>
<span id="cb158-119"><a href="tree_spatial.html#cb158-119" tabindex="-1"></a>  <span class="co"># )</span></span>
<span id="cb158-120"><a href="tree_spatial.html#cb158-120" tabindex="-1"></a>  <span class="co"># identify clumps to leave untouched</span></span>
<span id="cb158-121"><a href="tree_spatial.html#cb158-121" tabindex="-1"></a>  <span class="co"># clump_polys_temp = get_clump_summary(ttops_temp)</span></span>
<span id="cb158-122"><a href="tree_spatial.html#cb158-122" tabindex="-1"></a>  keep_clumps_temp <span class="ot">=</span></span>
<span id="cb158-123"><a href="tree_spatial.html#cb158-123" tabindex="-1"></a>    clump_polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-124"><a href="tree_spatial.html#cb158-124" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-125"><a href="tree_spatial.html#cb158-125" tabindex="-1"></a>      <span class="co">#keep only trees in current group</span></span>
<span id="cb158-126"><a href="tree_spatial.html#cb158-126" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb158-127"><a href="tree_spatial.html#cb158-127" tabindex="-1"></a>        target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-128"><a href="tree_spatial.html#cb158-128" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-129"><a href="tree_spatial.html#cb158-129" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb158-130"><a href="tree_spatial.html#cb158-130" tabindex="-1"></a>            clump_n_trees_grp, mean_clump_n_trees, min_clump_n_trees, max_clump_n_trees</span>
<span id="cb158-131"><a href="tree_spatial.html#cb158-131" tabindex="-1"></a>            , stand_n_clumps_target</span>
<span id="cb158-132"><a href="tree_spatial.html#cb158-132" tabindex="-1"></a>          )</span>
<span id="cb158-133"><a href="tree_spatial.html#cb158-133" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;clump_n_trees_grp&quot;</span></span>
<span id="cb158-134"><a href="tree_spatial.html#cb158-134" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-135"><a href="tree_spatial.html#cb158-135" tabindex="-1"></a>      <span class="co"># keep only clumps that meet criteria</span></span>
<span id="cb158-136"><a href="tree_spatial.html#cb158-136" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb158-137"><a href="tree_spatial.html#cb158-137" tabindex="-1"></a>        n_trees <span class="sc">&gt;=</span> min_clump_n_trees</span>
<span id="cb158-138"><a href="tree_spatial.html#cb158-138" tabindex="-1"></a>        <span class="sc">&amp;</span> n_trees <span class="sc">&lt;=</span> max_clump_n_trees</span>
<span id="cb158-139"><a href="tree_spatial.html#cb158-139" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-140"><a href="tree_spatial.html#cb158-140" tabindex="-1"></a>      <span class="co"># keep clumps closest the mean number in target group</span></span>
<span id="cb158-141"><a href="tree_spatial.html#cb158-141" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb158-142"><a href="tree_spatial.html#cb158-142" tabindex="-1"></a>        <span class="at">pct_to_target =</span> <span class="fu">abs</span>( (n_trees<span class="sc">-</span>mean_clump_n_trees)<span class="sc">/</span>mean_clump_n_trees )</span>
<span id="cb158-143"><a href="tree_spatial.html#cb158-143" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-144"><a href="tree_spatial.html#cb158-144" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(pct_to_target, <span class="fu">desc</span>(qmd_cm), n_trees, clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb158-145"><a href="tree_spatial.html#cb158-145" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span>stand_n_clumps_target) <span class="sc">%&gt;%</span> </span>
<span id="cb158-146"><a href="tree_spatial.html#cb158-146" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(clump_id)</span>
<span id="cb158-147"><a href="tree_spatial.html#cb158-147" tabindex="-1"></a>  </span>
<span id="cb158-148"><a href="tree_spatial.html#cb158-148" tabindex="-1"></a>  <span class="co"># add to tree list with keep/cut flag</span></span>
<span id="cb158-149"><a href="tree_spatial.html#cb158-149" tabindex="-1"></a>  keep_trees <span class="ot">=</span> keep_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-150"><a href="tree_spatial.html#cb158-150" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb158-151"><a href="tree_spatial.html#cb158-151" tabindex="-1"></a>      ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-152"><a href="tree_spatial.html#cb158-152" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-153"><a href="tree_spatial.html#cb158-153" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-154"><a href="tree_spatial.html#cb158-154" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(keep_clumps_temp, <span class="at">by =</span> <span class="st">&quot;clump_id&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-155"><a href="tree_spatial.html#cb158-155" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb158-156"><a href="tree_spatial.html#cb158-156" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> <span class="dv">1</span>)</span>
<span id="cb158-157"><a href="tree_spatial.html#cb158-157" tabindex="-1"></a>    )</span>
<span id="cb158-158"><a href="tree_spatial.html#cb158-158" tabindex="-1"></a></span>
<span id="cb158-159"><a href="tree_spatial.html#cb158-159" tabindex="-1"></a>  <span class="co"># check if the desired clump number was met and add the remaining trees from previous group if needed</span></span>
<span id="cb158-160"><a href="tree_spatial.html#cb158-160" tabindex="-1"></a>  more_clumps_target <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb158-161"><a href="tree_spatial.html#cb158-161" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb158-162"><a href="tree_spatial.html#cb158-162" tabindex="-1"></a>    <span class="fu">nrow</span>(keep_clumps_temp) <span class="sc">&lt;</span></span>
<span id="cb158-163"><a href="tree_spatial.html#cb158-163" tabindex="-1"></a>    ( </span>
<span id="cb158-164"><a href="tree_spatial.html#cb158-164" tabindex="-1"></a>      target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-165"><a href="tree_spatial.html#cb158-165" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-166"><a href="tree_spatial.html#cb158-166" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(stand_n_clumps_target) </span>
<span id="cb158-167"><a href="tree_spatial.html#cb158-167" tabindex="-1"></a>    )</span>
<span id="cb158-168"><a href="tree_spatial.html#cb158-168" tabindex="-1"></a>  ){</span>
<span id="cb158-169"><a href="tree_spatial.html#cb158-169" tabindex="-1"></a>    <span class="co"># how many more clumps are needed?</span></span>
<span id="cb158-170"><a href="tree_spatial.html#cb158-170" tabindex="-1"></a>    more_clumps_target <span class="ot">=</span> </span>
<span id="cb158-171"><a href="tree_spatial.html#cb158-171" tabindex="-1"></a>      ( </span>
<span id="cb158-172"><a href="tree_spatial.html#cb158-172" tabindex="-1"></a>        target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-173"><a href="tree_spatial.html#cb158-173" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-174"><a href="tree_spatial.html#cb158-174" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(stand_n_clumps_target) </span>
<span id="cb158-175"><a href="tree_spatial.html#cb158-175" tabindex="-1"></a>      ) <span class="sc">-</span> <span class="fu">nrow</span>(keep_clumps_temp)</span>
<span id="cb158-176"><a href="tree_spatial.html#cb158-176" tabindex="-1"></a>    </span>
<span id="cb158-177"><a href="tree_spatial.html#cb158-177" tabindex="-1"></a>    <span class="co"># determine group size of remaining trees in the group prior that were not in a group selected and were not cut</span></span>
<span id="cb158-178"><a href="tree_spatial.html#cb158-178" tabindex="-1"></a>    potential_trees <span class="ot">=</span> </span>
<span id="cb158-179"><a href="tree_spatial.html#cb158-179" tabindex="-1"></a>      ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-180"><a href="tree_spatial.html#cb158-180" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-181"><a href="tree_spatial.html#cb158-181" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb158-182"><a href="tree_spatial.html#cb158-182" tabindex="-1"></a>          remaining_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb158-183"><a href="tree_spatial.html#cb158-183" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb158-184"><a href="tree_spatial.html#cb158-184" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-185"><a href="tree_spatial.html#cb158-185" tabindex="-1"></a>        <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> tree_clump_dist_m) <span class="sc">%&gt;%</span> </span>
<span id="cb158-186"><a href="tree_spatial.html#cb158-186" tabindex="-1"></a>        <span class="co"># ggplot() + geom_sf(aes(fill = clump_n_trees_grp)) + theme_void()</span></span>
<span id="cb158-187"><a href="tree_spatial.html#cb158-187" tabindex="-1"></a>        <span class="co"># get the original clump id to prioritize new clump groups in the same area</span></span>
<span id="cb158-188"><a href="tree_spatial.html#cb158-188" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb158-189"><a href="tree_spatial.html#cb158-189" tabindex="-1"></a>          ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-190"><a href="tree_spatial.html#cb158-190" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-191"><a href="tree_spatial.html#cb158-191" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-192"><a href="tree_spatial.html#cb158-192" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb158-193"><a href="tree_spatial.html#cb158-193" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">orig_clump_id =</span> clump_id)</span>
<span id="cb158-194"><a href="tree_spatial.html#cb158-194" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb158-195"><a href="tree_spatial.html#cb158-195" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-196"><a href="tree_spatial.html#cb158-196" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(orig_clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb158-197"><a href="tree_spatial.html#cb158-197" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb158-198"><a href="tree_spatial.html#cb158-198" tabindex="-1"></a>          <span class="at">pct_desired_grp =</span> </span>
<span id="cb158-199"><a href="tree_spatial.html#cb158-199" tabindex="-1"></a>            <span class="fu">sum</span>(<span class="fu">ifelse</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">/</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb158-200"><a href="tree_spatial.html#cb158-200" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-201"><a href="tree_spatial.html#cb158-201" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-202"><a href="tree_spatial.html#cb158-202" tabindex="-1"></a>        <span class="co"># keep only the current group</span></span>
<span id="cb158-203"><a href="tree_spatial.html#cb158-203" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp)</span>
<span id="cb158-204"><a href="tree_spatial.html#cb158-204" tabindex="-1"></a>    </span>
<span id="cb158-205"><a href="tree_spatial.html#cb158-205" tabindex="-1"></a>    <span class="co"># pick trees from potential trees based on clump summary</span></span>
<span id="cb158-206"><a href="tree_spatial.html#cb158-206" tabindex="-1"></a>    keep_trees <span class="ot">=</span> keep_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-207"><a href="tree_spatial.html#cb158-207" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb158-208"><a href="tree_spatial.html#cb158-208" tabindex="-1"></a>        potential_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-209"><a href="tree_spatial.html#cb158-209" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-210"><a href="tree_spatial.html#cb158-210" tabindex="-1"></a>          <span class="co"># filter trees based on clumps needed</span></span>
<span id="cb158-211"><a href="tree_spatial.html#cb158-211" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb158-212"><a href="tree_spatial.html#cb158-212" tabindex="-1"></a>            <span class="fu">get_clump_summary</span>(potential_trees) <span class="sc">%&gt;%</span> </span>
<span id="cb158-213"><a href="tree_spatial.html#cb158-213" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-214"><a href="tree_spatial.html#cb158-214" tabindex="-1"></a>              <span class="co"># join with original clump id metrics to prioritize </span></span>
<span id="cb158-215"><a href="tree_spatial.html#cb158-215" tabindex="-1"></a>              <span class="co"># keeping clumps in the same area and minimize cutting time</span></span>
<span id="cb158-216"><a href="tree_spatial.html#cb158-216" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb158-217"><a href="tree_spatial.html#cb158-217" tabindex="-1"></a>                potential_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-218"><a href="tree_spatial.html#cb158-218" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-219"><a href="tree_spatial.html#cb158-219" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">group_by</span>(clump_id, orig_clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb158-220"><a href="tree_spatial.html#cb158-220" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">pct_desired_grp =</span> <span class="fu">max</span>(pct_desired_grp))</span>
<span id="cb158-221"><a href="tree_spatial.html#cb158-221" tabindex="-1"></a>                , <span class="at">by =</span> <span class="st">&quot;clump_id&quot;</span></span>
<span id="cb158-222"><a href="tree_spatial.html#cb158-222" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-223"><a href="tree_spatial.html#cb158-223" tabindex="-1"></a>              <span class="co"># keep the number of clumps needed</span></span>
<span id="cb158-224"><a href="tree_spatial.html#cb158-224" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(pct_desired_grp), orig_clump_id, <span class="fu">desc</span>(qmd_cm), n_trees, clump_id) <span class="sc">%&gt;%</span> </span>
<span id="cb158-225"><a href="tree_spatial.html#cb158-225" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span>more_clumps_target) <span class="sc">%&gt;%</span></span>
<span id="cb158-226"><a href="tree_spatial.html#cb158-226" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(clump_id)</span>
<span id="cb158-227"><a href="tree_spatial.html#cb158-227" tabindex="-1"></a>            , <span class="at">by =</span> <span class="st">&quot;clump_id&quot;</span></span>
<span id="cb158-228"><a href="tree_spatial.html#cb158-228" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-229"><a href="tree_spatial.html#cb158-229" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb158-230"><a href="tree_spatial.html#cb158-230" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> <span class="dv">1</span>)</span>
<span id="cb158-231"><a href="tree_spatial.html#cb158-231" tabindex="-1"></a>      )</span>
<span id="cb158-232"><a href="tree_spatial.html#cb158-232" tabindex="-1"></a>  } <span class="co"># end if don&#39;t have enough clumps</span></span>
<span id="cb158-233"><a href="tree_spatial.html#cb158-233" tabindex="-1"></a>  <span class="do">####################################################</span></span>
<span id="cb158-234"><a href="tree_spatial.html#cb158-234" tabindex="-1"></a>  <span class="co"># determine keep/cut for the remaining trees in that group type and higher groups </span></span>
<span id="cb158-235"><a href="tree_spatial.html#cb158-235" tabindex="-1"></a>  <span class="do">####################################################</span></span>
<span id="cb158-236"><a href="tree_spatial.html#cb158-236" tabindex="-1"></a>  remaining_trees <span class="ot">=</span></span>
<span id="cb158-237"><a href="tree_spatial.html#cb158-237" tabindex="-1"></a>    ttops_temp <span class="sc">%&gt;%</span></span>
<span id="cb158-238"><a href="tree_spatial.html#cb158-238" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-239"><a href="tree_spatial.html#cb158-239" tabindex="-1"></a>      <span class="co"># REMOVE TREES FROM PREVIOUS TREES REMAINING that got cut to make this group size</span></span>
<span id="cb158-240"><a href="tree_spatial.html#cb158-240" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb158-241"><a href="tree_spatial.html#cb158-241" tabindex="-1"></a>        remaining_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb158-242"><a href="tree_spatial.html#cb158-242" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb158-243"><a href="tree_spatial.html#cb158-243" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb158-244"><a href="tree_spatial.html#cb158-244" tabindex="-1"></a>      <span class="co"># keep only trees in current grp or prior grp</span></span>
<span id="cb158-245"><a href="tree_spatial.html#cb158-245" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">&gt;=</span> grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-246"><a href="tree_spatial.html#cb158-246" tabindex="-1"></a>      <span class="co"># remove keep trees</span></span>
<span id="cb158-247"><a href="tree_spatial.html#cb158-247" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">anti_join</span>(keep_trees, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb158-248"><a href="tree_spatial.html#cb158-248" tabindex="-1"></a>  </span>
<span id="cb158-249"><a href="tree_spatial.html#cb158-249" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(remaining_trees) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb158-250"><a href="tree_spatial.html#cb158-250" tabindex="-1"></a>    <span class="co"># apply the cutting algorithm</span></span>
<span id="cb158-251"><a href="tree_spatial.html#cb158-251" tabindex="-1"></a>    <span class="co"># get the flag</span></span>
<span id="cb158-252"><a href="tree_spatial.html#cb158-252" tabindex="-1"></a>    remaining_trees<span class="sc">$</span>is_keep_tree <span class="ot">=</span> <span class="fu">get_keep_tree_flag</span>(</span>
<span id="cb158-253"><a href="tree_spatial.html#cb158-253" tabindex="-1"></a>        <span class="at">x =</span> remaining_trees</span>
<span id="cb158-254"><a href="tree_spatial.html#cb158-254" tabindex="-1"></a>        , <span class="at">tgt =</span> target_data_temp <span class="sc">%&gt;%</span>  </span>
<span id="cb158-255"><a href="tree_spatial.html#cb158-255" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb158-256"><a href="tree_spatial.html#cb158-256" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">arrange</span>(clump_n_trees_grp) <span class="sc">%&gt;%</span></span>
<span id="cb158-257"><a href="tree_spatial.html#cb158-257" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">l =</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(clump_n_trees_grp)) <span class="sc">%&gt;%</span></span>
<span id="cb158-258"><a href="tree_spatial.html#cb158-258" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> grp_temp) <span class="sc">%&gt;%</span></span>
<span id="cb158-259"><a href="tree_spatial.html#cb158-259" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(l)</span>
<span id="cb158-260"><a href="tree_spatial.html#cb158-260" tabindex="-1"></a>        , <span class="at">clump_dist_m =</span> tree_clump_dist_m</span>
<span id="cb158-261"><a href="tree_spatial.html#cb158-261" tabindex="-1"></a>      ) </span>
<span id="cb158-262"><a href="tree_spatial.html#cb158-262" tabindex="-1"></a>    </span>
<span id="cb158-263"><a href="tree_spatial.html#cb158-263" tabindex="-1"></a>    <span class="co"># select relevant columns</span></span>
<span id="cb158-264"><a href="tree_spatial.html#cb158-264" tabindex="-1"></a>    remaining_trees <span class="ot">=</span> remaining_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-265"><a href="tree_spatial.html#cb158-265" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-266"><a href="tree_spatial.html#cb158-266" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-267"><a href="tree_spatial.html#cb158-267" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, is_keep_tree)</span>
<span id="cb158-268"><a href="tree_spatial.html#cb158-268" tabindex="-1"></a>  }</span>
<span id="cb158-269"><a href="tree_spatial.html#cb158-269" tabindex="-1"></a>  </span>
<span id="cb158-270"><a href="tree_spatial.html#cb158-270" tabindex="-1"></a>  <span class="co"># increment</span></span>
<span id="cb158-271"><a href="tree_spatial.html#cb158-271" tabindex="-1"></a>    <span class="co"># print(</span></span>
<span id="cb158-272"><a href="tree_spatial.html#cb158-272" tabindex="-1"></a>    <span class="co">#   paste(&quot;done: &quot;, grp_temp, Sys.time())</span></span>
<span id="cb158-273"><a href="tree_spatial.html#cb158-273" tabindex="-1"></a>    <span class="co"># )</span></span>
<span id="cb158-274"><a href="tree_spatial.html#cb158-274" tabindex="-1"></a>  <span class="co"># get the next group</span></span>
<span id="cb158-275"><a href="tree_spatial.html#cb158-275" tabindex="-1"></a>  grp_temp <span class="ot">=</span> target_data_temp <span class="sc">%&gt;%</span></span>
<span id="cb158-276"><a href="tree_spatial.html#cb158-276" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp<span class="sc">&lt;</span>grp_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-277"><a href="tree_spatial.html#cb158-277" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(clump_n_trees_grp)) <span class="sc">%&gt;%</span> </span>
<span id="cb158-278"><a href="tree_spatial.html#cb158-278" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-279"><a href="tree_spatial.html#cb158-279" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(clump_n_trees_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-280"><a href="tree_spatial.html#cb158-280" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="st">&quot;Individual&quot;</span>)</span>
<span id="cb158-281"><a href="tree_spatial.html#cb158-281" tabindex="-1"></a>}</span>
<span id="cb158-282"><a href="tree_spatial.html#cb158-282" tabindex="-1"></a><span class="co"># now individuals</span></span>
<span id="cb158-283"><a href="tree_spatial.html#cb158-283" tabindex="-1"></a><span class="cf">if</span>(sm_grp_temp <span class="sc">==</span> <span class="st">&quot;Individual&quot;</span>){</span>
<span id="cb158-284"><a href="tree_spatial.html#cb158-284" tabindex="-1"></a>  potential_trees <span class="ot">=</span> </span>
<span id="cb158-285"><a href="tree_spatial.html#cb158-285" tabindex="-1"></a>    <span class="co"># original data</span></span>
<span id="cb158-286"><a href="tree_spatial.html#cb158-286" tabindex="-1"></a>    ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-287"><a href="tree_spatial.html#cb158-287" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;Individual&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-288"><a href="tree_spatial.html#cb158-288" tabindex="-1"></a>    <span class="co"># remaining trees</span></span>
<span id="cb158-289"><a href="tree_spatial.html#cb158-289" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb158-290"><a href="tree_spatial.html#cb158-290" tabindex="-1"></a>      ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-291"><a href="tree_spatial.html#cb158-291" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-292"><a href="tree_spatial.html#cb158-292" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb158-293"><a href="tree_spatial.html#cb158-293" tabindex="-1"></a>          remaining_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb158-294"><a href="tree_spatial.html#cb158-294" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb158-295"><a href="tree_spatial.html#cb158-295" tabindex="-1"></a>        )</span>
<span id="cb158-296"><a href="tree_spatial.html#cb158-296" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-297"><a href="tree_spatial.html#cb158-297" tabindex="-1"></a>    <span class="co"># make sure that these are all individuals</span></span>
<span id="cb158-298"><a href="tree_spatial.html#cb158-298" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_orig =</span> <span class="fu">ifelse</span>(clump_n_trees_grp<span class="sc">==</span><span class="st">&quot;Individual&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb158-299"><a href="tree_spatial.html#cb158-299" tabindex="-1"></a>    <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> tree_clump_dist_m) <span class="sc">%&gt;%</span> </span>
<span id="cb158-300"><a href="tree_spatial.html#cb158-300" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;Individual&quot;</span>)</span>
<span id="cb158-301"><a href="tree_spatial.html#cb158-301" tabindex="-1"></a>  </span>
<span id="cb158-302"><a href="tree_spatial.html#cb158-302" tabindex="-1"></a>    <span class="co"># pick trees from potential trees based on target</span></span>
<span id="cb158-303"><a href="tree_spatial.html#cb158-303" tabindex="-1"></a>    keep_trees <span class="ot">=</span> keep_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-304"><a href="tree_spatial.html#cb158-304" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb158-305"><a href="tree_spatial.html#cb158-305" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb158-306"><a href="tree_spatial.html#cb158-306" tabindex="-1"></a>        potential_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-307"><a href="tree_spatial.html#cb158-307" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-308"><a href="tree_spatial.html#cb158-308" tabindex="-1"></a>          <span class="co"># keep the number of clumps needed</span></span>
<span id="cb158-309"><a href="tree_spatial.html#cb158-309" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(is_orig), <span class="fu">desc</span>(dbh_cm), <span class="fu">desc</span>(tree_height_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb158-310"><a href="tree_spatial.html#cb158-310" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb158-311"><a href="tree_spatial.html#cb158-311" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">row_number</span>() <span class="sc">&lt;=</span></span>
<span id="cb158-312"><a href="tree_spatial.html#cb158-312" tabindex="-1"></a>              target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-313"><a href="tree_spatial.html#cb158-313" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(clump_n_trees_grp <span class="sc">==</span> <span class="st">&quot;Individual&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-314"><a href="tree_spatial.html#cb158-314" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">pull</span>(stand_n_clumps_target)</span>
<span id="cb158-315"><a href="tree_spatial.html#cb158-315" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-316"><a href="tree_spatial.html#cb158-316" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb158-317"><a href="tree_spatial.html#cb158-317" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-318"><a href="tree_spatial.html#cb158-318" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_keep_tree =</span> <span class="dv">1</span>)</span>
<span id="cb158-319"><a href="tree_spatial.html#cb158-319" tabindex="-1"></a>}</span>
<span id="cb158-320"><a href="tree_spatial.html#cb158-320" tabindex="-1"></a><span class="co"># get the final prescription</span></span>
<span id="cb158-321"><a href="tree_spatial.html#cb158-321" tabindex="-1"></a>prescription_trees <span class="ot">=</span> ttops_temp <span class="sc">%&gt;%</span> </span>
<span id="cb158-322"><a href="tree_spatial.html#cb158-322" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-323"><a href="tree_spatial.html#cb158-323" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb158-324"><a href="tree_spatial.html#cb158-324" tabindex="-1"></a>    keep_trees</span>
<span id="cb158-325"><a href="tree_spatial.html#cb158-325" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb158-326"><a href="tree_spatial.html#cb158-326" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-327"><a href="tree_spatial.html#cb158-327" tabindex="-1"></a>  <span class="co"># tracking vars</span></span>
<span id="cb158-328"><a href="tree_spatial.html#cb158-328" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb158-329"><a href="tree_spatial.html#cb158-329" tabindex="-1"></a>    <span class="co"># fill in keep tree flag</span></span>
<span id="cb158-330"><a href="tree_spatial.html#cb158-330" tabindex="-1"></a>    <span class="at">is_keep_tree =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_keep_tree, <span class="dv">0</span>)</span>
<span id="cb158-331"><a href="tree_spatial.html#cb158-331" tabindex="-1"></a>    , <span class="at">orig_clump_n_trees_grp =</span> clump_n_trees_grp</span>
<span id="cb158-332"><a href="tree_spatial.html#cb158-332" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-333"><a href="tree_spatial.html#cb158-333" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(clump_n_trees_grp))</span>
<span id="cb158-334"><a href="tree_spatial.html#cb158-334" tabindex="-1"></a></span>
<span id="cb158-335"><a href="tree_spatial.html#cb158-335" tabindex="-1"></a><span class="co"># attach the new clumping to the trees</span></span>
<span id="cb158-336"><a href="tree_spatial.html#cb158-336" tabindex="-1"></a>prescription_trees <span class="ot">=</span> prescription_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-337"><a href="tree_spatial.html#cb158-337" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb158-338"><a href="tree_spatial.html#cb158-338" tabindex="-1"></a>    <span class="co"># reclump</span></span>
<span id="cb158-339"><a href="tree_spatial.html#cb158-339" tabindex="-1"></a>    prescription_trees <span class="sc">%&gt;%</span> </span>
<span id="cb158-340"><a href="tree_spatial.html#cb158-340" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb158-341"><a href="tree_spatial.html#cb158-341" tabindex="-1"></a>      <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> tree_clump_dist_m) <span class="sc">%&gt;%</span> </span>
<span id="cb158-342"><a href="tree_spatial.html#cb158-342" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb158-343"><a href="tree_spatial.html#cb158-343" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, clump_n_trees_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb158-344"><a href="tree_spatial.html#cb158-344" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">new_clump_n_trees_grp =</span> clump_n_trees_grp)</span>
<span id="cb158-345"><a href="tree_spatial.html#cb158-345" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb158-346"><a href="tree_spatial.html#cb158-346" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-347"><a href="tree_spatial.html#cb158-347" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb158-348"><a href="tree_spatial.html#cb158-348" tabindex="-1"></a>    <span class="at">new_clump_n_trees_grp =</span> forcats<span class="sc">::</span><span class="fu">fct_na_value_to_level</span>(new_clump_n_trees_grp, <span class="at">level =</span> <span class="st">&quot;Cut tree&quot;</span>)</span>
<span id="cb158-349"><a href="tree_spatial.html#cb158-349" tabindex="-1"></a>  )</span></code></pre></div>
<p>check the distribution of current vs prescription trees</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="tree_spatial.html#cb159-1" tabindex="-1"></a>prescription_trees <span class="sc">%&gt;%</span> </span>
<span id="cb159-2"><a href="tree_spatial.html#cb159-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb159-3"><a href="tree_spatial.html#cb159-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(</span>
<span id="cb159-4"><a href="tree_spatial.html#cb159-4" tabindex="-1"></a>    orig_clump_n_trees_grp, new_clump_n_trees_grp</span>
<span id="cb159-5"><a href="tree_spatial.html#cb159-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb159-6"><a href="tree_spatial.html#cb159-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> orig_clump_n_trees_grp, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb159-7"><a href="tree_spatial.html#cb159-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(new_clump_n_trees_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb159-8"><a href="tree_spatial.html#cb159-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">`</span><span class="at">New</span><span class="st">`</span> <span class="ot">=</span> new_clump_n_trees_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb159-9"><a href="tree_spatial.html#cb159-9" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb159-10"><a href="tree_spatial.html#cb159-10" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb159-11"><a href="tree_spatial.html#cb159-11" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(</span>
<span id="cb159-12"><a href="tree_spatial.html#cb159-12" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">&quot;Old&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb159-13"><a href="tree_spatial.html#cb159-13" tabindex="-1"></a>  )</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="5">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Old
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
New
</th>
<th style="text-align:right;">
Individual
</th>
<th style="text-align:right;">
2-4 trees
</th>
<th style="text-align:right;">
5-9 trees
</th>
<th style="text-align:right;">
10-15 trees
</th>
<th style="text-align:right;">
&gt;15 trees
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Individual
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:right;">
35
</td>
</tr>
<tr>
<td style="text-align:left;">
2-4 trees
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
373
</td>
<td style="text-align:right;">
28
</td>
<td style="text-align:right;">
32
</td>
<td style="text-align:right;">
62
</td>
</tr>
<tr>
<td style="text-align:left;">
5-9 trees
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
392
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
32
</td>
</tr>
<tr>
<td style="text-align:left;">
10-15 trees
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
167
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
&gt;15 trees
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
254
</td>
</tr>
<tr>
<td style="text-align:left;">
Cut tree
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
194
</td>
<td style="text-align:right;">
263
</td>
</tr>
</tbody>
</table>
<p>plot the prescription</p>
<p>plot the distance raster and openings vector data we just got with overlaid tree clumps and tree points</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="tree_spatial.html#cb160-1" tabindex="-1"></a>ttops_temp2 <span class="ot">=</span> prescription_trees <span class="sc">%&gt;%</span> </span>
<span id="cb160-2"><a href="tree_spatial.html#cb160-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(is_keep_tree <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb160-3"><a href="tree_spatial.html#cb160-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(suid, stand_area_ha, treeID, dbh_cm, tree_height_m, basal_area_m2) <span class="sc">%&gt;%</span> </span>
<span id="cb160-4"><a href="tree_spatial.html#cb160-4" tabindex="-1"></a>  <span class="fu">sp_clump_points</span>(<span class="at">clump_dist_m =</span> tree_clump_dist_m)</span>
<span id="cb160-5"><a href="tree_spatial.html#cb160-5" tabindex="-1"></a>clump_polys_temp2 <span class="ot">=</span> <span class="fu">get_clump_summary</span>(ttops_temp2)</span>
<span id="cb160-6"><a href="tree_spatial.html#cb160-6" tabindex="-1"></a>dist_rast_temp2 <span class="ot">=</span> <span class="fu">get_clump_dist_rast</span>(clump_polys_temp2)</span>
<span id="cb160-7"><a href="tree_spatial.html#cb160-7" tabindex="-1"></a></span>
<span id="cb160-8"><a href="tree_spatial.html#cb160-8" tabindex="-1"></a>plt_fnl_temp2 <span class="ot">=</span> </span>
<span id="cb160-9"><a href="tree_spatial.html#cb160-9" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb160-10"><a href="tree_spatial.html#cb160-10" tabindex="-1"></a>    <span class="co"># distance</span></span>
<span id="cb160-11"><a href="tree_spatial.html#cb160-11" tabindex="-1"></a>    <span class="fu">geom_tile</span>(</span>
<span id="cb160-12"><a href="tree_spatial.html#cb160-12" tabindex="-1"></a>      <span class="at">data =</span> dist_rast_temp2<span class="sc">$</span>dist_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="dv">2</span>, <span class="at">cores =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb160-13"><a href="tree_spatial.html#cb160-13" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">fill =</span> f)</span>
<span id="cb160-14"><a href="tree_spatial.html#cb160-14" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb160-15"><a href="tree_spatial.html#cb160-15" tabindex="-1"></a>    <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb160-16"><a href="tree_spatial.html#cb160-16" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;YlOrRd&quot;</span></span>
<span id="cb160-17"><a href="tree_spatial.html#cb160-17" tabindex="-1"></a>      , <span class="at">na.value =</span> <span class="st">&quot;transparent&quot;</span></span>
<span id="cb160-18"><a href="tree_spatial.html#cb160-18" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb160-19"><a href="tree_spatial.html#cb160-19" tabindex="-1"></a>      , <span class="at">name =</span> <span class="st">&quot;distance to</span><span class="sc">\n</span><span class="st">nearest tree (m)&quot;</span></span>
<span id="cb160-20"><a href="tree_spatial.html#cb160-20" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb160-21"><a href="tree_spatial.html#cb160-21" tabindex="-1"></a>    <span class="co"># openings</span></span>
<span id="cb160-22"><a href="tree_spatial.html#cb160-22" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> dist_rast_temp2<span class="sc">$</span>openings_vect, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> openining_area_m2), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb160-23"><a href="tree_spatial.html#cb160-23" tabindex="-1"></a>    <span class="fu">scale_color_gradient</span>(</span>
<span id="cb160-24"><a href="tree_spatial.html#cb160-24" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">&quot;gray77&quot;</span>, <span class="at">high =</span> <span class="st">&quot;gray11&quot;</span></span>
<span id="cb160-25"><a href="tree_spatial.html#cb160-25" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb160-26"><a href="tree_spatial.html#cb160-26" tabindex="-1"></a>      , <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;opening</span><span class="sc">\n</span><span class="st">area ($</span><span class="sc">\\</span><span class="st">m^2$)&quot;</span>)</span>
<span id="cb160-27"><a href="tree_spatial.html#cb160-27" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">11500</span>)</span>
<span id="cb160-28"><a href="tree_spatial.html#cb160-28" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb160-29"><a href="tree_spatial.html#cb160-29" tabindex="-1"></a>    <span class="co"># clumps</span></span>
<span id="cb160-30"><a href="tree_spatial.html#cb160-30" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb160-31"><a href="tree_spatial.html#cb160-31" tabindex="-1"></a>    <span class="fu">geom_sf</span>(</span>
<span id="cb160-32"><a href="tree_spatial.html#cb160-32" tabindex="-1"></a>      <span class="at">data =</span> clump_polys_temp2</span>
<span id="cb160-33"><a href="tree_spatial.html#cb160-33" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_n_trees_grp)</span>
<span id="cb160-34"><a href="tree_spatial.html#cb160-34" tabindex="-1"></a>      , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb160-35"><a href="tree_spatial.html#cb160-35" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb160-36"><a href="tree_spatial.html#cb160-36" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_d</span>(<span class="at">option=</span><span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">&quot;clump size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb160-37"><a href="tree_spatial.html#cb160-37" tabindex="-1"></a>    <span class="co"># tree points</span></span>
<span id="cb160-38"><a href="tree_spatial.html#cb160-38" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> ttops_temp2, <span class="at">color =</span> <span class="st">&quot;gray88&quot;</span>, <span class="at">shape =</span> <span class="st">&quot;.&quot;</span>) <span class="sc">+</span></span>
<span id="cb160-39"><a href="tree_spatial.html#cb160-39" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="tree_spatial.html#cb162-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb162-2"><a href="tree_spatial.html#cb162-2" tabindex="-1"></a>plt_fnl_temp2</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-85-1.png" width="1008" /></p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="tree_spatial.html#cb163-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb163-2"><a href="tree_spatial.html#cb163-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_21.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>highlight the openings</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="tree_spatial.html#cb164-1" tabindex="-1"></a>plt_open_temp2 <span class="ot">=</span> </span>
<span id="cb164-2"><a href="tree_spatial.html#cb164-2" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb164-3"><a href="tree_spatial.html#cb164-3" tabindex="-1"></a>      <span class="co"># clumps</span></span>
<span id="cb164-4"><a href="tree_spatial.html#cb164-4" tabindex="-1"></a>      <span class="fu">geom_sf</span>(</span>
<span id="cb164-5"><a href="tree_spatial.html#cb164-5" tabindex="-1"></a>        <span class="at">data =</span> clump_polys_temp2</span>
<span id="cb164-6"><a href="tree_spatial.html#cb164-6" tabindex="-1"></a>        , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> clump_n_trees_grp)</span>
<span id="cb164-7"><a href="tree_spatial.html#cb164-7" tabindex="-1"></a>        , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb164-8"><a href="tree_spatial.html#cb164-8" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb164-9"><a href="tree_spatial.html#cb164-9" tabindex="-1"></a>      <span class="fu">scale_fill_viridis_d</span>(<span class="at">option=</span><span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">&quot;clump size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb164-10"><a href="tree_spatial.html#cb164-10" tabindex="-1"></a>      <span class="co"># openings</span></span>
<span id="cb164-11"><a href="tree_spatial.html#cb164-11" tabindex="-1"></a>      ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb164-12"><a href="tree_spatial.html#cb164-12" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> dist_rast_temp2<span class="sc">$</span>openings_vect, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> openining_area_m2), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb164-13"><a href="tree_spatial.html#cb164-13" tabindex="-1"></a>      <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb164-14"><a href="tree_spatial.html#cb164-14" tabindex="-1"></a>        <span class="at">low =</span> <span class="st">&quot;gray77&quot;</span>, <span class="at">high =</span> <span class="st">&quot;gray11&quot;</span></span>
<span id="cb164-15"><a href="tree_spatial.html#cb164-15" tabindex="-1"></a>        , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb164-16"><a href="tree_spatial.html#cb164-16" tabindex="-1"></a>        , <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;opening</span><span class="sc">\n</span><span class="st">area ($</span><span class="sc">\\</span><span class="st">m^2$)&quot;</span>)</span>
<span id="cb164-17"><a href="tree_spatial.html#cb164-17" tabindex="-1"></a>        , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">11500</span>)</span>
<span id="cb164-18"><a href="tree_spatial.html#cb164-18" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb164-19"><a href="tree_spatial.html#cb164-19" tabindex="-1"></a>      <span class="co"># tree points</span></span>
<span id="cb164-20"><a href="tree_spatial.html#cb164-20" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> ttops_temp2, <span class="at">color =</span> <span class="st">&quot;gray88&quot;</span>, <span class="at">shape =</span> <span class="st">&quot;.&quot;</span>) <span class="sc">+</span></span>
<span id="cb164-21"><a href="tree_spatial.html#cb164-21" tabindex="-1"></a>      <span class="fu">theme_void</span>()</span>
<span id="cb164-22"><a href="tree_spatial.html#cb164-22" tabindex="-1"></a>plt_open_temp2</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-86-1.png" width="1008" /></p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="tree_spatial.html#cb165-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb165-2"><a href="tree_spatial.html#cb165-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_22.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="fl">5.8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>combine them?</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="tree_spatial.html#cb166-1" tabindex="-1"></a>plt_fnl_temp2 <span class="sc">+</span> (plt_open_temp2 <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>))</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-87-1.png" width="1008" /></p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="tree_spatial.html#cb167-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb167-2"><a href="tree_spatial.html#cb167-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_23.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>combine old vs new</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="tree_spatial.html#cb168-1" tabindex="-1"></a>(plt_fnl_temp <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Pre-Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb168-2"><a href="tree_spatial.html#cb168-2" tabindex="-1"></a>  (plt_fnl_temp2  <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Post-Treatment&quot;</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>))</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-88-1.png" width="1008" /></p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="tree_spatial.html#cb169-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb169-2"><a href="tree_spatial.html#cb169-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_24.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>combine old vs new openings highlight</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="tree_spatial.html#cb170-1" tabindex="-1"></a>(plt_open_temp <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Pre-Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb170-2"><a href="tree_spatial.html#cb170-2" tabindex="-1"></a>  (plt_open_temp2  <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Post-Treatment&quot;</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>))</span></code></pre></div>
<p><img src="bhef_uas_202306_files/figure-html/unnamed-chunk-89-1.png" width="1008" /></p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="tree_spatial.html#cb171-1" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb171-2"><a href="tree_spatial.html#cb171-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/NSW_25.jpeg&quot;</span>, <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span>, <span class="at">height =</span> <span class="dv">11</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">device =</span> <span class="st">&quot;jpeg&quot;</span>)</span></code></pre></div>
<p>table comparison</p>
<p>current vs target vs prescription</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="tree_spatial.html#cb172-1" tabindex="-1"></a>clump_n_trees_grp_summary_temp2 <span class="ot">=</span> <span class="fu">get_clump_n_trees_grp_summary</span>(</span>
<span id="cb172-2"><a href="tree_spatial.html#cb172-2" tabindex="-1"></a>  <span class="at">trees =</span> ttops_temp2, <span class="at">clumps =</span> clump_polys_temp2</span>
<span id="cb172-3"><a href="tree_spatial.html#cb172-3" tabindex="-1"></a>)</span>
<span id="cb172-4"><a href="tree_spatial.html#cb172-4" tabindex="-1"></a>clump_n_trees_grp_summary_temp2 <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 5
## Columns: 32
## $ suid                        &lt;chr&gt; &quot;0203088082660001000&quot;, &quot;020308808266000100…
## $ stand_area_ha               &lt;dbl&gt; 12.21615, 12.21615, 12.21615, 12.21615, 12…
## $ clump_n_trees_grp           &lt;ord&gt; Individual, 2-4 trees, 5-9 trees, 10-15 tr…
## $ n_trees                     &lt;int&gt; 292, 495, 435, 167, 254
## $ mean_dbh_cm                 &lt;dbl&gt; 24.97068, 25.45406, 25.79630, 26.02168, 23…
## $ mean_tree_height_m          &lt;dbl&gt; 12.18919, 12.40888, 12.52068, 12.69708, 11…
## $ loreys_height_m             &lt;dbl&gt; 14.43523, 14.66566, 14.18918, 14.49684, 12…
## $ basal_area_m2               &lt;dbl&gt; 15.861180, 28.043935, 24.677387, 9.635634,…
## $ clump_area_ha               &lt;dbl&gt; 0.8252334, 1.2034742, 1.0069020, 0.3832532…
## $ stand_n_clumps              &lt;int&gt; 292, 175, 65, 14, 13
## $ trees_per_ha                &lt;dbl&gt; 23.90279, 40.52015, 35.60861, 13.67043, 20…
## $ basal_area_m2_per_ha        &lt;dbl&gt; 1.2983784, 2.2956451, 2.0200633, 0.7887622…
## $ qmd_cm                      &lt;dbl&gt; 26.29852, 26.85789, 26.87571, 27.10422, 24…
## $ stand_trees_per_ha          &lt;dbl&gt; 134.4941, 134.4941, 134.4941, 134.4941, 13…
## $ stand_basal_area_m2         &lt;dbl&gt; 89.95739, 89.95739, 89.95739, 89.95739, 89…
## $ stand_basal_area_m2_per_ha  &lt;dbl&gt; 7.363811, 7.363811, 7.363811, 7.363811, 7.…
## $ pct_stand_basal_area        &lt;dbl&gt; 0.1763188, 0.3117469, 0.2743231, 0.1071133…
## $ pct_stand_n_trees           &lt;dbl&gt; 0.1777237, 0.3012781, 0.2647596, 0.1016433…
## $ stand_qmd_cm                &lt;dbl&gt; 26.40309, 26.40309, 26.40309, 26.40309, 26…
## $ mean_dbh_in                 &lt;dbl&gt; 9.838447, 10.028901, 10.163741, 10.252542,…
## $ qmd_in                      &lt;dbl&gt; 10.361619, 10.582010, 10.589032, 10.679064…
## $ stand_qmd_in                &lt;dbl&gt; 10.40282, 10.40282, 10.40282, 10.40282, 10…
## $ mean_tree_height_ft         &lt;dbl&gt; 39.98054, 40.70112, 41.06782, 41.64643, 38…
## $ loreys_height_ft            &lt;dbl&gt; 47.34756, 48.10336, 46.54052, 47.54965, 41…
## $ basal_area_ft2_per_ac       &lt;dbl&gt; 5.659632, 10.006717, 8.805456, 3.438214, 4…
## $ stand_basal_area_ft2_per_ac &lt;dbl&gt; 32.09885, 32.09885, 32.09885, 32.09885, 32…
## $ trees_per_ac                &lt;dbl&gt; 9.680631, 16.410659, 14.421488, 5.536525, …
## $ stand_trees_per_ac          &lt;dbl&gt; 54.47013, 54.47013, 54.47013, 54.47013, 54…
## $ stand_area_ac               &lt;dbl&gt; 30.1861, 30.1861, 30.1861, 30.1861, 30.1861
## $ clump_area_ac               &lt;dbl&gt; 2.0391516, 2.9737849, 2.4880548, 0.9470188…
## $ basal_area_ft2              &lt;dbl&gt; 170.7297, 301.8649, 265.6274, 103.7180, 12…
## $ stand_basal_area_ft2        &lt;dbl&gt; 968.3013, 968.3013, 968.3013, 968.3013, 96…</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="tree_spatial.html#cb174-1" tabindex="-1"></a>target_data_temp <span class="sc">%&gt;%</span> </span>
<span id="cb174-2"><a href="tree_spatial.html#cb174-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb174-3"><a href="tree_spatial.html#cb174-3" tabindex="-1"></a>    clump_n_trees_grp</span>
<span id="cb174-4"><a href="tree_spatial.html#cb174-4" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_stand_n_trees&quot;</span>)</span>
<span id="cb174-5"><a href="tree_spatial.html#cb174-5" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;trees_per_acre_&quot;</span>)</span>
<span id="cb174-6"><a href="tree_spatial.html#cb174-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb174-7"><a href="tree_spatial.html#cb174-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb174-8"><a href="tree_spatial.html#cb174-8" tabindex="-1"></a>    clump_n_trees_grp_summary_temp2 <span class="sc">%&gt;%</span> </span>
<span id="cb174-9"><a href="tree_spatial.html#cb174-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(clump_n_trees_grp, pct_stand_n_trees, trees_per_ac) <span class="sc">%&gt;%</span> </span>
<span id="cb174-10"><a href="tree_spatial.html#cb174-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb174-11"><a href="tree_spatial.html#cb174-11" tabindex="-1"></a>        <span class="at">pct_stand_n_trees_presc =</span> pct_stand_n_trees</span>
<span id="cb174-12"><a href="tree_spatial.html#cb174-12" tabindex="-1"></a>        , <span class="at">trees_per_acre_presc =</span> trees_per_ac</span>
<span id="cb174-13"><a href="tree_spatial.html#cb174-13" tabindex="-1"></a>      )</span>
<span id="cb174-14"><a href="tree_spatial.html#cb174-14" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;clump_n_trees_grp&quot;</span></span>
<span id="cb174-15"><a href="tree_spatial.html#cb174-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb174-16"><a href="tree_spatial.html#cb174-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(</span>
<span id="cb174-17"><a href="tree_spatial.html#cb174-17" tabindex="-1"></a>    pct_stand_n_trees_presc</span>
<span id="cb174-18"><a href="tree_spatial.html#cb174-18" tabindex="-1"></a>    , <span class="at">.after =</span> pct_stand_n_trees_target  </span>
<span id="cb174-19"><a href="tree_spatial.html#cb174-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb174-20"><a href="tree_spatial.html#cb174-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(</span>
<span id="cb174-21"><a href="tree_spatial.html#cb174-21" tabindex="-1"></a>    trees_per_acre_presc</span>
<span id="cb174-22"><a href="tree_spatial.html#cb174-22" tabindex="-1"></a>    , <span class="at">.after =</span> trees_per_acre_target  </span>
<span id="cb174-23"><a href="tree_spatial.html#cb174-23" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb174-24"><a href="tree_spatial.html#cb174-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb174-25"><a href="tree_spatial.html#cb174-25" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb174-26"><a href="tree_spatial.html#cb174-26" tabindex="-1"></a>      tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_stand_n_trees&quot;</span>)</span>
<span id="cb174-27"><a href="tree_spatial.html#cb174-27" tabindex="-1"></a>      , <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb174-28"><a href="tree_spatial.html#cb174-28" tabindex="-1"></a>    )</span>
<span id="cb174-29"><a href="tree_spatial.html#cb174-29" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb174-30"><a href="tree_spatial.html#cb174-30" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb174-31"><a href="tree_spatial.html#cb174-31" tabindex="-1"></a>    <span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb174-32"><a href="tree_spatial.html#cb174-32" tabindex="-1"></a>      <span class="st">&quot;Current stand BA (ft2/ac): &quot;</span></span>
<span id="cb174-33"><a href="tree_spatial.html#cb174-33" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_basal_area_ft2_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb174-34"><a href="tree_spatial.html#cb174-34" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;Current stand QMD (in): &quot;</span></span>
<span id="cb174-35"><a href="tree_spatial.html#cb174-35" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_qmd_in[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb174-36"><a href="tree_spatial.html#cb174-36" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;Current stand TPA: &quot;</span></span>
<span id="cb174-37"><a href="tree_spatial.html#cb174-37" tabindex="-1"></a>      , clump_n_trees_grp_summary_temp<span class="sc">$</span>stand_trees_per_ac[<span class="dv">1</span>] <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">number</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb174-38"><a href="tree_spatial.html#cb174-38" tabindex="-1"></a>    )</span>
<span id="cb174-39"><a href="tree_spatial.html#cb174-39" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb174-40"><a href="tree_spatial.html#cb174-40" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">1</span></span>
<span id="cb174-41"><a href="tree_spatial.html#cb174-41" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb174-42"><a href="tree_spatial.html#cb174-42" tabindex="-1"></a>      <span class="st">&quot;&quot;</span>, <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;current&quot;</span>,<span class="st">&quot;target&quot;</span>,<span class="st">&quot;prescription&quot;</span>),<span class="dv">2</span>)</span>
<span id="cb174-43"><a href="tree_spatial.html#cb174-43" tabindex="-1"></a>    )</span>
<span id="cb174-44"><a href="tree_spatial.html#cb174-44" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb174-45"><a href="tree_spatial.html#cb174-45" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb174-46"><a href="tree_spatial.html#cb174-46" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(</span>
<span id="cb174-47"><a href="tree_spatial.html#cb174-47" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">&quot;% Trees&quot;</span><span class="ot">=</span><span class="dv">3</span>, <span class="st">&quot;TPA&quot;</span><span class="ot">=</span><span class="dv">3</span>)</span>
<span id="cb174-48"><a href="tree_spatial.html#cb174-48" tabindex="-1"></a>  )</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-90">Table 9.7: </span><span id="tab:unnamed-chunk-90">Table 9.8: </span>Current stand BA (ft2/ac): 38.9<br>Current stand QMD (in): 10.1<br>Current stand TPA: 71
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
% Trees
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
TPA
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
current
</th>
<th style="text-align:left;">
target
</th>
<th style="text-align:left;">
prescription
</th>
<th style="text-align:right;">
current
</th>
<th style="text-align:right;">
target
</th>
<th style="text-align:right;">
prescription
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Individual
</td>
<td style="text-align:left;">
9%
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:right;">
6.5
</td>
<td style="text-align:right;">
10.1
</td>
<td style="text-align:right;">
9.7
</td>
</tr>
<tr>
<td style="text-align:left;">
2-4 trees
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
33%
</td>
<td style="text-align:left;">
30%
</td>
<td style="text-align:right;">
12.4
</td>
<td style="text-align:right;">
18.5
</td>
<td style="text-align:right;">
16.4
</td>
</tr>
<tr>
<td style="text-align:left;">
5-9 trees
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
24%
</td>
<td style="text-align:left;">
26%
</td>
<td style="text-align:right;">
15.0
</td>
<td style="text-align:right;">
13.4
</td>
<td style="text-align:right;">
14.4
</td>
</tr>
<tr>
<td style="text-align:left;">
10-15 trees
</td>
<td style="text-align:left;">
22%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:right;">
15.2
</td>
<td style="text-align:right;">
5.6
</td>
<td style="text-align:right;">
5.5
</td>
</tr>
<tr>
<td style="text-align:left;">
&gt;15 trees
</td>
<td style="text-align:left;">
30%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:right;">
21.4
</td>
<td style="text-align:right;">
8.4
</td>
<td style="text-align:right;">
8.4
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="implement" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Full ICO Prescription Process<a href="tree_spatial.html#implement" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Above we outlined the individual steps needed to start with a UAS tree list, identify tree clump grouping, set prescription targets and generate cut/leave trees to define a prescription. Now, we’ll put all of those steps together into a single flow.</p>
<ul>
<li>identify current stand clump groupings:
<ul>
<li><a href="tree_spatial.html#clump_trees">clump individual trees</a></li>
<li>generate clump <a href="tree_spatial.html#clump_sum">vectors</a> and <a href="tree_spatial.html#clump_metrics">summary metrics</a></li>
</ul></li>
<li><a href="tree_spatial.html#set_targets">set ICO targets</a></li>
<li><a href="tree_spatial.html#cut_clump_ex">implement the prescription</a>
<ul>
<li>start with the largest clump size currently with trees</li>
<li>cut trees to the next largest clump size until desired # clumps is reached</li>
<li>repeat with each successive clump size through to individual tree selection</li>
<li>if possible, cut in same clump until desired proportions are reached to minimize machine time</li>
</ul></li>
</ul>
<hr />

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="silv.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
